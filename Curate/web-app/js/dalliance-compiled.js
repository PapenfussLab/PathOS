var BAM_MAGIC=21840194,BAI_MAGIC=21578050;function BamFile(){}function Vob(a,b){this.block=a;this.offset=b}Vob.prototype.toString=function(){return""+this.block+":"+this.offset};function Chunk(a,b){this.minv=a;this.maxv=b}
function makeBam(a,b,c){var d=new BamFile;d.data=a;d.bai=b;d.bai.fetch(function(e){if(!e)return dlog("Couldn't access BAI");var h=new Uint8Array(e);if(readInt(h,0)!=BAI_MAGIC)return dlog("Not a BAI file");var j=readInt(h,4);d.indices=[];for(var i=8,l=1E9,m=0;m<j;++m){var o=i,q=readInt(h,i);i+=4;for(var p=0;p<q;++p){readInt(h,i);var s=readInt(h,i+4);i+=8+s*16}p=readInt(h,i);i+=4;for(var r=i,t=0;t<p;++t){s=readVob(h,r);r+=8;if(s){r=s.block;if(s.offset>0)r+=65536;if(r<l)l=r;break}}i+=p*8;if(q>0)d.indices[m]=
new Uint8Array(e,o,i-o)}d.data.slice(0,l).fetch(function(v){if(!v)return dlog("Couldn't access BAM");v=unbgzf(v,v.byteLength);v=new Uint8Array(v);readInt(v,0);for(var u=readInt(v,4),x="",z=0;z<u;++z)x+=String.fromCharCode(v[z+8]);x=readInt(v,u+8);u=u+12;d.chrToIndex={};d.indexToChr=[];for(z=0;z<x;++z){for(var H=readInt(v,u),C="",A=0;A<H-1;++A)C+=String.fromCharCode(v[u+4+A]);readInt(v,u+H+4);d.chrToIndex[C]=z;if(C.indexOf("chr")==0)d.chrToIndex[C.substring(3)]=z;else d.chrToIndex["chr"+C]=z;d.indexToChr.push(C);
u=u+8+H}if(d.indices)return c(d)})})}
BamFile.prototype.blocksForRange=function(a,b,c){var d=this.indices[a];if(!d)return[];a=reg2bins(b,c);for(var e=[],h=0;h<a.length;++h)e[a[h]]=true;a=[];var j=[];h=readInt(d,0);for(var i=4,l=0;l<h;++l){var m=readInt(d,i),o=readInt(d,i+4);i+=8;if(e[m])for(var q=0;q<o;++q){var p=readVob(d,i),s=readVob(d,i+8);(m<4681?j:a).push(new Chunk(p,s));i+=16}else i+=o*16}h=readInt(d,i);e=null;b=Math.min(b>>14,h-1);c=Math.min(c>>14,h-1);for(h=b;h<=c;++h)if(b=readVob(d,i+4+h*8))if(!e||b.block<e.block||b.offset<e.offset)e=
b;d=[];if(e!=null)for(h=0;h<j.length;++h){c=j[h];c.maxv.block>=e.block&&c.maxv.offset>=e.offset&&d.push(c)}j=d;d=[];for(h=0;h<j.length;++h)d.push(j[h]);for(h=0;h<a.length;++h)d.push(a[h]);d.sort(function(r,t){var v=r.minv.block-t.minv.block;return v!=0?v:r.minv.offset-t.minv.offset});a=[];if(d.length>0){j=d[0];for(h=1;h<d.length;++h){c=d[h];if(c.minv.block==j.maxv.block)j=new Chunk(j.minv,c.maxv);else{a.push(j);j=c}}a.push(j)}return a};
BamFile.prototype.fetch=function(a,b,c,d){function e(){if(m>=i.length)return d(l);else if(o){var q=new Uint8Array(o);h.readBamRecords(q,i[m].minv.offset,l,b,c,j);o=null;++m;return e()}else{var p=i[m];q=p.minv.block;h.data.slice(q,p.maxv.block+65536-q).fetch(function(s){o=unbgzf(s,p.maxv.block-p.minv.block+1);return e()})}}var h=this,j=this.chrToIndex[a],i;if(j===undefined)i=[];else(i=this.blocksForRange(j,b,c))||d(null,"Error in index fetch");var l=[],m=0,o;e()};
var SEQRET_DECODER=["=","A","C","x","G","x","x","x","T","x","x","x","x","x","x","N"],CIGAR_DECODER=["M","I","D","N","S","H","P","=","X","?","?","?","?","?","?","?"];function BamRecord(){}
BamFile.prototype.readBamRecords=function(a,b,c,d,e,h){for(;;){var j=readInt(a,b);j=b+j+4;if(j>=a.length)return c;var i=new BamRecord,l=readInt(a,b+4),m=readInt(a,b+8),o=readInt(a,b+12),q=(o&65280)>>8,p=o&255;o=readInt(a,b+16);var s=(o&4294901760)>>16,r=o&65535;o=readInt(a,b+20);readInt(a,b+24);readInt(a,b+28);readInt(a,b+32);for(var t="",v=0;v<p-1;++v)t+=String.fromCharCode(a[b+36+v]);b=b+36+p;v="";for(p=0;p<r;++p){var u=readInt(a,b);v=v+(u>>4)+CIGAR_DECODER[u&15];b+=4}i.cigar=v;r="";p=o+1>>1;for(v=
0;v<p;++v){u=a[b+v];r+=SEQRET_DECODER[(u&240)>>4];r+=SEQRET_DECODER[u&15]}b+=p;i.seq=r;r="";for(v=0;v<o;++v)r+=String.fromCharCode(a[b+v]+33);b+=o;i.quals=r;i.pos=m;i.mq=q;i.readName=t;i.segment=this.indexToChr[l];for(i.flag=s;b<j;){m=String.fromCharCode(a[b])+String.fromCharCode(a[b+1]);q=String.fromCharCode(a[b+2]);if(q=="A"){q=String.fromCharCode(a[b+3]);b+=4}else if(q=="i"||q=="I"){q=readInt(a,b+3);b+=7}else if(q=="c"||q=="C"){q=a[b+3];b+=4}else if(q=="s"||q=="S"){q=readShort(a,b+3);b+=5}else if(q==
"f")throw"FIXME need floats";else if(q=="Z"||q=="H"){b+=3;for(q="";;){s=a[b++];if(s==0)break;else q+=String.fromCharCode(s)}}else if(q=="B"){q=String.fromCharCode(a[b+3]);s=readInt(a,b+4);if(q=="i"||q=="I"||q=="f"){t=4;v=q=="f"?readFloat:readInt}else if(q=="s"||q=="S"){t=2;v=readShort}else if(q=="c"||q=="C"){t=1;v=readByte}else throw"Unknown array type "+q;b+=8;q=[];for(r=0;r<s;++r){q.push(v(a,b));b+=t}}else throw"Unknown type "+q;i[m]=q}if(!d||i.pos<=e&&i.pos+o>=d)if(h===undefined||l==h)c.push(i);
b=j}};(function(){var a=new ArrayBuffer(8),b=new Uint8Array(a),c=new Float32Array(a);window.readFloat=function(d,e){b[0]=d[e];b[1]=d[e+1];b[2]=d[e+2];b[3]=d[e+3];return c[0]}})();function readInt64(a,b){return a[b+7]<<24|a[b+6]<<16|a[b+5]<<8|a[b+4]}function readInt(a,b){return a[b+3]<<24|a[b+2]<<16|a[b+1]<<8|a[b]}function readIntBE(a,b){return a[b]<<24|a[b+1]<<16|a[b+2]<<8|a[b+3]}function readShort(a,b){return a[b+1]<<8|a[b]}function readByte(a,b){return a[b]}
function readVob(a,b){var c=(a[b+6]&255)*4294967296+(a[b+5]&255)*16777216+(a[b+4]&255)*65536+(a[b+3]&255)*256+(a[b+2]&255),d=a[b+1]<<8|a[b];return c==0&&d==0?null:new Vob(c,d)}
function unbgzf(a,b){b=Math.min(b||1,a.byteLength-50);for(var c=[],d=[0],e=0;d[0]<b;){var h=new Uint8Array(a,d[0],12);h=h[11]<<8|h[10];h=jszlib_inflate_buffer(a,12+h+d[0],Math.min(65536,a.byteLength-12-h-d[0]),d);d[0]+=8;e+=h.byteLength;c.push(h)}if(c.length==1)return c[0];else{d=new Uint8Array(e);for(h=e=0;h<c.length;++h){var j=new Uint8Array(c[h]);arrayCopy(j,0,d,e,j.length);e+=j.length}return d.buffer}}
function reg2bin(a,b){--b;if(a>>14==b>>14)return 4681+(a>>14);if(a>>17==b>>17)return 585+(a>>17);if(a>>20==b>>20)return 73+(a>>20);if(a>>23==b>>23)return 9+(a>>23);if(a>>26==b>>26)return 1+(a>>26);return 0}var MAX_BIN=37449;
function reg2bins(a,b){var c,d=[];--b;d.push(0);for(c=1+(a>>26);c<=1+(b>>26);++c)d.push(c);for(c=9+(a>>23);c<=9+(b>>23);++c)d.push(c);for(c=73+(a>>20);c<=73+(b>>20);++c)d.push(c);for(c=585+(a>>17);c<=585+(b>>17);++c)d.push(c);for(c=4681+(a>>14);c<=4681+(b>>14);++c)d.push(c);return d}var BIG_WIG_MAGIC=-2003829722,BIG_BED_MAGIC=-2021002517,BIG_WIG_TYPE_GRAPH=1,BIG_WIG_TYPE_VSTEP=2,BIG_WIG_TYPE_FSTEP=3,M1=256,M2=65536,M3=16777216,M4=4294967296;
function bwg_readOffset(a,b){return a[b]+a[b+1]*M1+a[b+2]*M2+a[b+3]*M3+a[b+4]*M4}function BigWig(){}
BigWig.prototype.readChromTree=function(a){var b=this;this.chromsToIDs={};this.idsToChroms={};this.maxID=0;var c=this.unzoomedDataOffset;c=c+4-(c-this.chromTreeOffset&3);this.data.slice(this.chromTreeOffset,c-this.chromTreeOffset).fetch(function(d){var e=new Uint8Array(d),h=new Int16Array(d),j=(new Int32Array(d))[2];bwg_readOffset(e,16);var i=function(l){var m=e[l],o=h[l/2+1];l+=4;for(var q=0;q<o;++q)if(m==0){l+=j;var p=bwg_readOffset(e,l);l+=8;p-=b.chromTreeOffset;i(p)}else{p="";for(var s=0;s<j;++s){var r=
e[l++];if(r!=0)p+=String.fromCharCode(r)}s=e[l+3]<<24|e[l+2]<<16|e[l+1]<<8|e[l+0];l+=8;b.chromsToIDs[p]=s;if(p.indexOf("chr")==0)b.chromsToIDs[p.substr(3)]=s;b.idsToChroms[s]=p;b.maxID=Math.max(b.maxID,s)}};i(32);a(b)})};function BigWigView(a,b,c,d){this.bwg=a;this.cirTreeOffset=b;this.cirTreeLength=c;this.isSummary=d}BED_COLOR_REGEXP=/^[0-9]+,[0-9]+,[0-9]+/;BigWigView.prototype.readWigData=function(a,b,c,d){a=this.bwg.chromsToIDs[a];if(a===undefined)return d([]);else this.readWigDataById(a,b,c,d)};
BigWigView.prototype.readWigDataById=function(a,b,c,d){var e=this;if(this.cirHeader){var h=[],j=0;Date.now();var i=function(o,q,p){return(a<0||o==a)&&q<=c&&p>=b},l=function(o,q){j+=o.length;for(var p=4+e.cirBlockSize*32,s,r=0;r<o.length;++r){var t=new Range(o[r],o[r]+p);s=s?union(s,t):t}p=s.ranges();for(s=0;s<p.length;++s)m(o,p[s],q)},m=function(o,q,p){q.max();q.min();e.bwg.data.slice(q.min(),q.max()-q.min()).fetch(function(s){for(var r=0;r<o.length;++r)if(q.contains(o[r])){var t=s,v=o[r]-q.min(),
u=p,x=new Uint8Array(t),z=new Int16Array(t);t=new Int32Array(t);var H=x[v];z=z[v/2+1];v+=4;if(H!=0)for(H=0;H<z;++H){var C=v/4,A=t[C],D=t[C+1],O=t[C+2];C=t[C+3];var B=bwg_readOffset(x,v+16);u=bwg_readOffset(x,v+24);if((a<0||A<a||A==a&&D<=c)&&(a<0||O>a||O==a&&C>=b))h.push({offset:B,size:u});v+=32}else{var G=[];for(H=0;H<z;++H){C=v/4;A=t[C];D=t[C+1];O=t[C+2];C=t[C+3];B=bwg_readOffset(x,v+16);if((a<0||A<a||A==a&&D<=c)&&(a<0||O>a||O==a&&C>=b))G.push(B);v+=24}G.length>0&&l(G,u+1)}--j;j==0&&e.fetchFeatures(i,
h,d)}})};l([e.cirTreeOffset+48],1)}else this.bwg.data.slice(this.cirTreeOffset,48).fetch(function(o){e.cirHeader=o;o=new Int32Array(e.cirHeader);e.cirBlockSize=o[1];e.readWigDataById(a,b,c,d)})};
BigWigView.prototype.fetchFeatures=function(a,b,c){var d=this;b.sort(function(i,l){return(i.offset|0)-(l.offset|0)});if(b.length==0)c([]);else{var e=[],h=function(i,l,m,o){o||(o={});var q=new DASFeature;q._chromId=i;q.segment=d.bwg.idsToChroms[i];q.min=l;q.max=m;q.type="bigwig";for(k in o)q[k]=o[k];e.push(q)},j=function(){if(b.length==0){Date.now();c(e)}else{var i=b[0];if(i.data){d.parseFeatures(i.data,h,a);b.splice(0,1);j()}else{var l=i.offset,m=i.size;for(i=1;i<b.length&&b[i].offset==l+m;){m+=b[i].size;
++i}d.bwg.data.slice(l,m).fetch(function(o){for(var q=0,p=0;q<m;){var s=b[p],r;if(d.bwg.uncompressBufSize>0)r=jszlib_inflate_buffer(o,q+2,s.size-2);else{r=new Uint8Array(s.size);arrayCopy(new Uint8Array(o,q,s.size),0,r,0,s.size);r=r.buffer}s.data=r;q+=s.size;++p}j()})}}};j()}};
BigWigView.prototype.parseFeatures=function(a,b,c){var d=new Uint8Array(a);if(this.isSummary){var e=new Int16Array(a),h=new Int32Array(a),j=new Float32Array(a);d=a.byteLength/32;for(e=0;e<d;++e){a=h[e*8];var i=h[e*8+1],l=h[e*8+2],m=h[e*8+3],o=j[e*8+5],q=j[e*8+6];if(c(a,i+1,l)){m={type:"bigwig",score:q/m,maxScore:o};if(this.bwg.type=="bigbed")m.type="density";b(a,i+1,l,m)}}}else if(this.bwg.type=="bigwig"){e=new Int16Array(a);h=new Int32Array(a);j=new Float32Array(a);a=h[0];i=h[1];o=h[3];m=h[4];l=
d[20];d=e[11];if(l==BIG_WIG_TYPE_FSTEP)for(e=0;e<d;++e){q=j[e+6];h=i+e*o+1;l=i+e*o+m;c(a,h,l)&&b(a,h,l,{score:q})}else if(l==BIG_WIG_TYPE_VSTEP)for(e=0;e<d;++e){i=h[e*2+6]+1;l=i+m-1;q=j[e*2+7];c(a,i,l)&&b(a,i,l,{score:q})}else if(l==BIG_WIG_TYPE_GRAPH)for(e=0;e<d;++e){i=h[e*3+6]+1;l=h[e*3+7];q=j[e*3+8];if(i>l)i=l;c(a,i,l)&&b(a,i,l,{score:q})}else console.log("Currently not handling bwgType="+l)}else if(this.bwg.type=="bigbed"){h=0;e=this.bwg.definedFieldCount;for(m=this.bwg.schema;h<d.length;){a=
d[h+3]<<24|d[h+2]<<16|d[h+1]<<8|d[h+0];i=d[h+7]<<24|d[h+6]<<16|d[h+5]<<8|d[h+4];l=d[h+11]<<24|d[h+10]<<16|d[h+9]<<8|d[h+8];h+=12;for(q="";;){o=d[h++];if(o!=0)q+=String.fromCharCode(o);else break}o={};var p;p=q.length>0?q.split("\t"):[];if(p.length>0&&e>3)o.label=p[0];if(p.length>1&&e>4)o.score=stringToInt(p[1]);if(p.length>2&&e>5)o.orientation=p[2];if(p.length>5&&e>8){q=p[5];if(BED_COLOR_REGEXP.test(q))o.itemRgb="rgb("+q+")"}if(p.length>e-3&&m)for(q=e-3;q<p.length;++q)o[m.fields[q+3].name]=p[q];if(c(a,
i+1,l,p))if(e<12)b(a,i+1,l,o);else{q=p[3]|0;var s=p[4]|0,r=p[6]|0,t=p[7].split(","),v=p[8].split(",");o.type="bb-transcript";var u=new DASGroup;for(j in o)u[j]=o[j];u.id=p[0];u.segment=this.bwg.idsToChroms[a];u.min=i+1;u.max=l;u.notes=[];o.groups=[u];if(p.length>9){var x=l=p[9];if(p.length>10)x=p[10];p=shallowCopy(u);p.id=l;p.label=x;p.type="gene";o.groups.push(p)}l=null;for(p=0;p<r;++p){u=(v[p]|0)+i;u=new Range(u,u+(t[p]|0));l=l?union(l,u):u}t=l.ranges();for(i=0;i<t.length;++i){r=t[i];b(a,r.min()+
1,r.max(),o)}if(s>q)if(i=intersection(l,new Range(q,s))){o.type="bb-translation";l=i.ranges();for(i=0;i<l.length;++i){r=l[i];b(a,r.min()+1,r.max(),o)}}}}}else dlog("Don't know what to do with "+this.bwg.type)};BigWigView.prototype.getFirstAdjacent=function(a,b,c,d){a=this.bwg.chromsToIDs[a];if(a===undefined)return d([]);else this.getFirstAdjacentById(a,b,c,d)};
BigWigView.prototype.getFirstAdjacentById=function(a,b,c,d){var e=this;if(this.cirHeader){var h=null,j=-1,i=-1,l=0;Date.now();var m=function(p,s){l+=p.length;for(var r=4+e.cirBlockSize*32,t,v=0;v<p.length;++v){var u=new Range(p[v],p[v]+r);t=t?union(t,u):u}r=t.ranges();for(t=0;t<r.length;++t)o(p,r[t],s)},o=function(p,s,r){s.max();s.min();e.bwg.data.slice(s.min(),s.max()-s.min()).fetch(function(t){for(var v=0;v<p.length;++v)if(s.contains(p[v])){q(t,p[v]-s.min(),r);--l;if(l==0){if(!h){if(c>0&&(a!=0||
b>0))return e.getFirstAdjacentById(0,0,c,d);else if(c<0&&(a!=e.bwg.maxID||b<1E9))return e.getFirstAdjacentById(e.bwg.maxID,1E9,c,d);return d([])}e.fetchFeatures(function(u,x,z){return c<0&&(u<a||z<b)||c>0&&(u>a||x>b)},[h],function(u){for(var x=null,z=-1,H=-1,C=0;C<u.length;++C){var A=u[C],D=A._chromId,O=A.min,B=A.max;if(x==null||c<0&&(D>z||B>H)||c>0&&(D<z||O<H)){x=A;H=c<0?B:O;z=D}}return x!=null?d([x]):d([])})}}})},q=function(p,s,r){var t=new Uint8Array(p),v=new Int16Array(p);p=new Int32Array(p);
var u=t[s];v=v[s/2+1];s+=4;if(u!=0)for(u=0;u<v;++u){var x=s/4,z=p[x],H=p[x+1],C=p[x+2],A=p[x+3];x=bwg_readOffset(t,s+16);r=bwg_readOffset(t,s+24);if(c<0&&(z<a||z==a&&H<=b)||c>0&&(C>a||C==a&&A>=b))if(!/_random/.exec(e.bwg.idsToChroms[z]))if(h==null||c<0&&(C>j||C==j&&A>i)||c>0&&(z<j||z==j&&H<i)){h={offset:x,size:r};i=c<0?A:H;j=c<0?C:z}s+=32}else{var D=t=-1;for(u=0;u<v;++u){x=s/4;z=p[x];H=p[x+1];C=p[x+2];A=p[x+3];x=p[x+4]<<32|p[x+5];if(c<0&&(z<a||z==a&&H<=b)&&C>=a||c>0&&(C>a||C==a&&A>=b)&&z<=a)if(t<
0||A>D){t=x;D=c<0?A:H}s+=24}t>=0&&m([t],r+1)}};m([e.cirTreeOffset+48],1)}else this.bwg.data.slice(this.cirTreeOffset,48).fetch(function(p){e.cirHeader=p;p=new Int32Array(e.cirHeader);e.cirBlockSize=p[1];e.getFirstAdjacentById(a,b,c,d)})};BigWig.prototype.readWigData=function(a,b,c,d){this.getUnzoomedView().readWigData(a,b,c,d)};
BigWig.prototype.getUnzoomedView=function(){if(!this.unzoomedView){var a=4E3;if(this.zoomLevels[0])a=this.zoomLevels[0].dataOffset-this.unzoomedIndexOffset;this.unzoomedView=new BigWigView(this,this.unzoomedIndexOffset,a,false)}return this.unzoomedView};BigWig.prototype.getZoomedView=function(a){a=this.zoomLevels[a];if(!a.view)a.view=new BigWigView(this,a.indexOffset,4E3,true);return a.view};function makeBwgFromURL(a,b,c){makeBwg(new URLFetchable(a,{credentials:c}),b,a)}
function makeBwgFromFile(a,b){makeBwg(new BlobFetchable(a),b,"file")}
function makeBwg(a,b,c){var d=new BigWig;d.data=a;d.name=c;d.data.slice(0,512).salted().fetch(function(e){if(!e)return b(null,"Couldn't fetch file");var h=new Uint8Array(e),j=new Int16Array(e);e=new Int32Array(e);if(e[0]==BIG_WIG_MAGIC)d.type="bigwig";else if(e[0]==BIG_BED_MAGIC)d.type="bigbed";else b(null,"Not a supported format");d.version=j[2];d.numZoomLevels=j[3];d.chromTreeOffset=bwg_readOffset(h,8);d.unzoomedDataOffset=bwg_readOffset(h,16);d.unzoomedIndexOffset=bwg_readOffset(h,24);d.fieldCount=
j[16];d.definedFieldCount=j[17];d.asOffset=bwg_readOffset(h,36);d.totalSummaryOffset=bwg_readOffset(h,44);d.uncompressBufSize=e[13];d.extHeaderOffset=bwg_readOffset(h,56);d.zoomLevels=[];for(j=0;j<d.numZoomLevels;++j){var i=e[j*6+16],l=bwg_readOffset(h,j*24+72),m=bwg_readOffset(h,j*24+80);d.zoomLevels.push({reduction:i,dataOffset:l,indexOffset:m})}d.readChromTree(function(){d.getAutoSQL(function(o){d.schema=o;return b(d)})})})}
BigWig.prototype._tsFetch=function(a,b,c,d,e){var h=this;if(a>=this.zoomLevels.length-1)if(this.topLevelReductionCache){for(var j=[],i=this.topLevelReductionCache,l=0;l<i.length;++l)i[l]._chromId==b&&j.push(i[l]);return e(j)}else this.getZoomedView(this.zoomLevels.length-1).readWigDataById(-1,0,3E8,function(m){h.topLevelReductionCache=m;return h._tsFetch(a,b,c,d,e)});else return(a<0?this.getUnzoomedView():this.getZoomedView(a)).readWigDataById(b,c,d,e)};
BigWig.prototype.thresholdSearch=function(a,b,c,d,e){function h(){if(i.length==0)return e(null);i.sort(function(q,p){var s=q.zoom-p.zoom;if(s!=0)return s;s=q.chrOrd-p.chrOrd;return s!=0?s:q.min-p.min*c});var o=i.splice(0,1)[0];j._tsFetch(o.zoom,o.chr,o.min,o.max,function(q){var p=c>0?0:3E8;if(o.fromRef)p=b;for(var s=0;s<q.length;++s){var r=q[s],t;t=r.maxScore!=undefined?r.maxScore:r.score;if(c>0){if(t>d)if(o.zoom<0){if(r.min>p)return e(r)}else r.max>p&&i.push({chr:o.chr,chrOrd:o.chrOrd,zoom:o.zoom-
2,min:r.min,max:r.max,fromRef:o.fromRef})}else if(t>d)if(o.zoom<0){if(r.max<p)return e(r)}else r.min<p&&i.push({chr:o.chr,chrOrd:o.chrOrd,zoom:o.zoom-2,min:r.min,max:r.max,fromRef:o.fromRef})}h()})}c=c<0?-1:1;var j=this;a=this.chromsToIDs[a];for(var i=[{chrOrd:0,chr:a,zoom:j.zoomLevels.length-4,min:0,max:3E8,fromRef:true}],l=1;l<=this.maxID+1;++l){var m=(a+c*l)%(this.maxID+1);if(m<0)m+=this.maxID+1;i.push({chrOrd:l,chr:m,zoom:j.zoomLevels.length-1,min:0,max:3E8})}h()};
BigWig.prototype.getAutoSQL=function(a){if(!this.asOffset)return a(null);this.data.slice(this.asOffset,2048).fetch(function(b){var c=new Uint8Array(b);b="";for(var d=0;d<c.length;++d){if(c[d]==0)break;b+=String.fromCharCode(c[d])}c=/([\w\[\]]+)\s+(\w+)\s*;\s*("([^"]+)")?\s*/g;var e=/(\w+)\s+(\w+)\s+("([^"]+)")?\s+\(\s*/.exec(b);if(e){d={declType:e[1],name:e[2],comment:e[4],fields:[]};b=b.substring(e[0]);for(e=c.exec(b);e!=null;e=c.exec(b))d.fields.push({type:e[1],name:e[2],comment:e[4]});return a(d)}})};
BigWig.prototype.getExtraIndices=function(a){var b=this;if(this.version<4||this.extHeaderOffset==0||this.type!="bigbed")return a(null);else this.data.slice(this.extHeaderOffset,64).fetch(function(c){if(!c)return a(null,"Couldn't fetch extension header");var d=new Uint8Array(c),e=new Int16Array(c);new Int32Array(c);var h=e[1];c=bwg_readOffset(d,4);if(h==0)return a(null);b.data.slice(c,h*20).fetch(function(j){if(!j)return a(null,"Couldn't fetch index info");var i=new Uint8Array(j),l=new Int16Array(j);
new Int32Array(j);j=[];for(var m=0;m<h;++m){var o=l[m*10],q=l[m*10+1],p=bwg_readOffset(i,m*20+4);o=new BBIExtraIndex(b,o,q,p,l[m*10+8]);j.push(o)}a(j)})})};function BBIExtraIndex(a,b,c,d,e){this.bbi=a;this.type=b;this.fieldCount=c;this.offset=d;this.field=e}
BBIExtraIndex.prototype.lookup=function(a,b){var c=this;this.bbi.data.slice(this.offset,32).fetch(function(d){function e(m){c.bbi.data.slice(m,4+j*(i+l)).fetch(function(o){var q=new Uint8Array(o),p=new Uint16Array(o);new Uint32Array(o);p=p[1];o=4;if(q[0]==0){for(var s=null,r=0;r<p;++r){for(var t="",v=0;v<i;++v){var u=q[o++];if(u!=0)t+=String.fromCharCode(u)}v=bwg_readOffset(q,o);o+=8;if(a.localeCompare(t)<0&&s){e(s);return}s=v}e(s)}else{for(r=0;r<p;++r){t="";for(v=0;v<i;++v){u=q[o++];if(u!=0)t+=String.fromCharCode(u)}if(t==
a){p=bwg_readOffset(q,o);q=readInt(q,o+8);return c.bbi.getUnzoomedView().fetchFeatures(function(x,z,H,C){if(C&&C.length>c.field-3)return C[c.field-3]==a},[{offset:p,size:q}],b)}o+=l}return b([])}})}var h=new Uint8Array(d);new Int16Array(d);d=new Int32Array(d);var j=d[1],i=d[2],l=d[3];bwg_readOffset(h,16);e(c.offset+32)})};function BlobFetchable(a){this.blob=a}
BlobFetchable.prototype.slice=function(a,b){var c;c=this.blob.slice?b?this.blob.slice(a,a+b):this.blob.slice(a):b?this.blob.webkitSlice(a,a+b):this.blob.webkitSlice(a);return new BlobFetchable(c)};BlobFetchable.prototype.salted=function(){return this};BlobFetchable.prototype.fetch=function(a){var b=new FileReader;b.onloadend=function(){a(bstringToBuffer(b.result))};b.readAsBinaryString(this.blob)};
function URLFetchable(a,b,c,d){if(!d)if(typeof b==="object"){d=b;b=undefined}else d={};this.url=a;this.start=b||0;if(c)this.end=c;this.opts=d}URLFetchable.prototype.slice=function(a,b){if(a<0)throw"Bad slice "+a;var c=this.start,d=this.end;c=c&&a?c+a:a||c;d=b&&c?c+b-1:d||b-1;return new URLFetchable(this.url,c,d,this.opts)};var seed=0,isSafari=navigator.userAgent.indexOf("Safari")>=0&&navigator.userAgent.indexOf("Chrome")<0;
URLFetchable.prototype.fetchAsText=function(a){var b=new XMLHttpRequest,c=this.url;if(isSafari||this.opts.salt){c=saltURL(c);c=c+"?salt="+b64_sha1(""+Date.now()+","+ ++seed)}b.open("GET",c,true);if(this.end){if(this.end-this.start>1E8)throw"Monster fetch!";b.setRequestHeader("Range","bytes="+this.start+"-"+this.end)}b.onreadystatechange=function(){if(b.readyState==4)return b.status==200||b.status==206?a(b.responseText):a(null)};if(this.opts.credentials)b.withCredentials=true;b.send("")};
URLFetchable.prototype.salted=function(){var a=shallowCopy(this.opts);a.salt=true;return new URLFetchable(this.url,this.start,this.end,a)};
URLFetchable.prototype.fetch=function(a,b,c){var d=this;b=b||1;if(b>3)return a(null);var e=new XMLHttpRequest,h,j=this.url;if(isSafari||this.opts.salt)j=j+"?salt="+b64_sha1(""+Date.now()+","+ ++seed);e.open("GET",j,true);e.overrideMimeType("text/plain; charset=x-user-defined");if(this.end){if(this.end-this.start>1E8)throw"Monster fetch!";e.setRequestHeader("Range","bytes="+this.start+"-"+this.end);h=this.end-this.start+1}e.responseType="arraybuffer";e.onreadystatechange=function(){if(e.readyState==
4)if(e.status==200||e.status==206)if(e.response){var i=e.response.byteLength;return h&&h!=i&&(!c||i!=c)?d.fetch(a,b+1,i):a(e.response)}else if(e.mozResponseArrayBuffer)return a(e.mozResponseArrayBuffer);else{i=e.responseText;return h&&h!=i.length&&(!c||i.length!=c)?d.fetch(a,b+1,i.length):a(bstringToBuffer(e.responseText))}else return d.fetch(a,b+1)};if(this.opts.credentials)e.withCredentials=true;e.send("")};
function bstringToBuffer(a){if(!a)return null;for(var b=new Uint8Array(a.length),c=0;c<b.length;++c)b[c]=a.charCodeAt(c);return b.buffer}var NS_SVG="http://www.w3.org/2000/svg",NS_HTML="http://www.w3.org/1999/xhtml",NS_XLINK="http://www.w3.org/1999/xlink";function Region(a,b,c){this.min=b;this.max=c;this.chr=a}
function Browser(a){a||(a={});this.uiPrefix="//www.biodalliance.org/release-0.11/";this.sources=[];this.tiers=[];this.featureListeners=[];this.featureHoverListeners=[];this.viewListeners=[];this.regionSelectListeners=[];this.tierListeners=[];this.tierSelectionListeners=[];this.tierSelectionWrapListeners=[];this.cookieKey="browser";this.karyoEndpoint=new DASSource("http://www.derkholm.net:8080/das/hsa_54_36p/");this.registry="http://www.dasregistry.org/das/sources";this.coordSystem={speciesName:"Human",
taxon:9606,auth:"NCBI",version:"36",ucscName:"hg18"};this.chains={};this.pageName="svgHolder";this.maxExtra=2.5;this.minExtra=0.5;this.zoomFactor=1;this.zoomMin=10;this.origin=0;this.targetQuantRes=5;this.featurePanelWidth=750;this.zoomBase=100;this.zoomExpt=30;this.zoomSliderValue=100;this.entryPoints=null;this.currentSeqMax=-1;this.highlights=[];this.selectedTiers=[1];this.placards=[];this.maxViewWidth=5E5;this.reverseScrolling=false;this.rulerLocation="center";this.defaultHighlightFill="red";this.defaultHighlightAlpha=
0.3;this.exportRuler=this.exportHighlights=true;this.tierBackgroundColors=["rgb(245,245,245)","white"];this.minTierHeight=30;this.availableSources=new Observed;this.defaultSources=[];this.mappableSources={};this.hubs=[];this.hubObjects=[];this.sourceCache=new SourceCache;this.retina=true;for(var b in a)this[b]=a[b];var c=this;window.addEventListener("load",function(){c.realInit()},false)}
Browser.prototype.realInit=function(){this.defaultChr=this.chr;this.defaultStart=this.viewStart;this.defaultEnd=this.viewEnd;this.defaultSources=[];for(var a=0;a<this.sources.length;++a)this.defaultSources.push(this.sources[a]);if(this.restoreStatus)this.statusRestored=this.restoreStatus();var b=this;this.browserHolderHolder=document.getElementById(this.pageName);this.browserHolder=makeElement("div",null,{tabIndex:-1},{outline:"none",display:"inline-block",width:"100%"});removeChildren(this.browserHolderHolder);
this.browserHolderHolder.appendChild(this.browserHolder);this.svgHolder=makeElement("div",null,{className:"main-holder"});this.initUI(this.browserHolder,this.svgHolder);this.tierHolder=makeElement("div",makeElement("img",null,{src:this.uiPrefix+"img/loader.gif"}),{className:"tier-holder"});this.svgHolder.appendChild(this.tierHolder);this.bhtmlRoot=makeElement("div");this.disablePoweredBy||this.bhtmlRoot.appendChild(makeElement("span",["Powered by ",makeElement("a","Dalliance",{href:"http://www.biodalliance.org/"}),
" "+VERSION],{className:"powered-by"}));this.browserHolder.appendChild(this.bhtmlRoot);window.addEventListener("resize",function(){b.resizeViewer()},false);this.ruler=makeElement("div",null,{className:"guideline"});this.ruler2=makeElement("div",null,{className:"guideline"},{backgroundColor:"gray",opacity:"0.5",zIndex:899});this.svgHolder.appendChild(this.ruler);this.svgHolder.appendChild(this.ruler2);if(window.getComputedStyle(this.browserHolderHolder).display!="none")setTimeout(function(){b.realInit2()},
1);else var c=setInterval(function(){if(window.getComputedStyle(b.browserHolderHolder).display!="none"){clearInterval(c);b.realInit2()}},300)};
Browser.prototype.realInit2=function(){var a=this;removeChildren(this.tierHolder);this.featurePanelWidth=this.tierHolder.getBoundingClientRect().width|0;this.scale=this.featurePanelWidth/(this.viewEnd-this.viewStart);if(!this.zoomMax){this.zoomMax=this.zoomExpt*Math.log(this.maxViewWidth/this.zoomBase);this.zoomMin=this.zoomExpt*Math.log(this.featurePanelWidth/10/this.zoomBase)}this.zoomSliderValue=this.zoomExpt*Math.log((this.viewEnd-this.viewStart+1)/this.zoomBase);this.tierHolder.addEventListener("mousewheel",
function(i){if(i.wheelDeltaX){i.stopPropagation();i.preventDefault();i=i.wheelDeltaX/5;a.reverseScrolling||(i=-i);a.move(i)}},false);this.tierHolder.addEventListener("MozMousePixelScroll",function(i){if(i.axis==1){i.stopPropagation();i.preventDefault();if(i.detail!=0){i=i.detail/4;if(a.reverseScrolling)i=-i;a.move(i)}}},false);var b=function(i){if(i.keyCode==13){var l=false;for(i=0;i<a.tiers.length;++i){var m=a.tiers[i];if(m.wantedLayoutHeight&&m.wantedLayoutHeight!=m.layoutHeight){m.layoutHeight=
m.wantedLayoutHeight;m.placard=null;m.clipTier();l=true}}l&&a.arrangeTiers()}else if(i.keyCode==32||i.charCode==32){if(a.isSnapZooming){a.isSnapZooming=false;l=(a.savedZoom||20)+a.zoomMin}else{a.isSnapZooming=true;l=(a.savedZoom||0)+a.zoomMin}a.savedZoom=a.zoomSliderValue-a.zoomMin;a.zoomSliderValue=l;a.zoom(Math.exp(1*l/a.zoomExpt));a.snapZoomLockout=true;i.stopPropagation();i.preventDefault()}else if(i.keyCode==39){i.stopPropagation();i.preventDefault();a.scrollArrowKey(i,-1)}else if(i.keyCode==
37){i.stopPropagation();i.preventDefault();a.scrollArrowKey(i,1)}else if(i.keyCode==38||i.keyCode==87){i.stopPropagation();i.preventDefault();if(i.shiftKey){i=a.getSelectedTier();if(!(i<0)){i=a.tiers[i];l=i.forceHeight||i.subtiers[0].height;l>=40&&i.mergeConfig({height:l-10})}}else if(i.ctrlKey||i.metaKey){i=a.getSelectedTier();if(!(i<0)){i=a.tiers[i];if(i.quantLeapThreshold){m=i.subtiers[0].height;var o=i.subtiers[0].quant;if(o){l=1*o.min;o=1*o.max;m=(o-l)/m;i.mergeConfig({quantLeapThreshold:l+((Math.round((i.quantLeapThreshold-
l)/m)|0)+1)*m});i.notify("Threshold: "+formatQuantLabel(i.quantLeapThreshold))}}}}else if(i.altKey){o=a.selectedTiers.length;if(o!=0){i=a.selectedTiers[0];var q=true;l=[];for(m=0;m<a.selectedTiers.length;++m){l.push(a.tiers[a.selectedTiers[m]]);if(m>0&&a.selectedTiers[m]-a.selectedTiers[m-1]!=1)q=false}if(!(q&&i<=0)){for(m=a.selectedTiers.length-1;m>=0;--m)a.tiers.splice(a.selectedTiers[m],1);a.selectedTiers.splice(0,o);i=q?i-1:i;for(m=0;m<l.length;++m){a.tiers.splice(i+m,0,l[m]);a.selectedTiers.push(i+
m)}a.markSelectedTiers();a.notifyTierSelection();a.reorderTiers();a.notifyTier()}}}else{i=a.getSelectedTier();if(i>0){a.setSelectedTier(i-1);i=a.tiers[a.getSelectedTier()];l=i.holder.getBoundingClientRect();if(l.bottom-l.height<0||l.botton>window.innerHeight)i.holder.scrollIntoView(true)}else a.notifyTierSelectionWrap(-1)}}else if(i.keyCode==40||i.keyCode==83){i.stopPropagation();i.preventDefault();if(i.shiftKey){i=a.getSelectedTier();if(!(i<0)){i=a.tiers[i];l=i.forceHeight||i.subtiers[0].height;
i.mergeConfig({height:l+10})}}else if(i.ctrlKey||i.metaKey){i=a.getSelectedTier();if(!(i<0)){i=a.tiers[i];if(i.quantLeapThreshold){m=i.subtiers[0].height;if(o=i.subtiers[0].quant){l=1*o.min;o=1*o.max;m=(o-l)/m;o=Math.round((i.quantLeapThreshold-l)/m)|0;if(o>1){i.mergeConfig({quantLeapThreshold:l+(o-1)*m});i.notify("Threshold: "+formatQuantLabel(i.quantLeapThreshold))}}}}}else if(i.altKey){o=a.selectedTiers.length;if(o!=0){i=a.selectedTiers[0];var p=0;l=[];for(m=0;m<a.selectedTiers.length;++m){l.push(a.tiers[a.selectedTiers[m]]);
if(m>0)p+=a.selectedTiers[m]-a.selectedTiers[m-1]-1}q=p==0;if(!(q&&i+o>=a.tiers.length)){for(m=a.selectedTiers.length-1;m>=0;--m)a.tiers.splice(a.selectedTiers[m],1);a.selectedTiers.splice(0,o);i=q?i+1:i+p;for(m=0;m<l.length;++m){a.tiers.splice(i+m,0,l[m]);a.selectedTiers.push(i+m)}a.markSelectedTiers();a.notifyTierSelection();a.reorderTiers();a.notifyTier()}}}else{i=a.getSelectedTier();if(i<a.tiers.length-1){a.setSelectedTier(i+1);i=a.tiers[a.getSelectedTier()];l=i.holder.getBoundingClientRect();
if(l.bottom-l.height<0||l.bottom>window.innerHeight)i.holder.scrollIntoView(l.height>window.innerHeight)}}}else if(i.keyCode==187||i.keyCode==61){i.stopPropagation();i.preventDefault();a.zoomStep(-10)}else if(i.keyCode==189||i.keyCode==173){i.stopPropagation();i.preventDefault();a.zoomStep(10)}else if(i.keyCode==73||i.keyCode==105){i.stopPropagation();i.preventDefault();i=a.getSelectedTier();if(!(i<0)){m=a.tiers[i];if(m.infoVisible){m.infoElement.style.display="none";m.updateHeight();m.infoVisible=
false}else{m.infoElement.style.display="block";m.updateHeight();m.infoVisible=true}}}else if(i.keyCode==84||i.keyCode==116)if(i.shiftKey){i.stopPropagation();i.preventDefault();for(i=0;i<a.tiers.length;++i){m=a.tiers[i];if(m.dasSource.collapseSuperGroups){if(l===undefined)l=!m.bumped;m.bumped=l;m.layoutWasDone=false;m.draw();m.updateLabel()}}}else{if(!i.ctrlKey&&!i.metaKey){i.stopPropagation();i.preventDefault();i=a.getSelectedTier();if(!(i<0)){m=a.tiers[i];if(m.dasSource.collapseSuperGroups){if(l===
undefined)l=!m.bumped;m.bumped=l;m.layoutWasDone=false;m.draw();m.updateLabel()}}}}else if(i.keyCode==77||i.keyCode==109){i.stopPropagation();i.preventDefault();if((i.ctrlKey||i.metaKey)&&a.selectedTiers.length>1)a.mergeSelectedTiers()}else if(i.keyCode==68||i.keyCode==100){i.stopPropagation();i.preventDefault();if(i.ctrlKey||i.metaKey){i=a.getSelectedTier();i<0||a.addTier(a.tiers[i].dasSource)}}};this.browserHolder.addEventListener("focus",function(){a.browserHolder.addEventListener("keydown",b,
false)},false);this.browserHolder.addEventListener("blur",function(){a.browserHolder.removeEventListener("keydown",b,false)},false);this.hPopupHolder=makeElement("div");this.hPopupHolder.style["font-family"]="helvetica";this.hPopupHolder.style["font-size"]="12pt";this.hPopupHolder.classList.add("dalliance");document.body.appendChild(this.hPopupHolder);for(var c=[],d=0;d<this.sources.length;++d){var e=this.sources[d],h={};if(this.restoredConfigs)h=this.restoredConfigs[d];if(!e.disabled){c.push(e);
this.makeTier(e,h)}}this.sources=c;a.arrangeTiers();a.refresh();a.setSelectedTier(1);a.positionRuler();for(c=0;c<this.tiers.length;++c){d=this.tiers[c];if(d.sequenceSource){d.sequenceSource.getSeqInfo(this.chr,function(i){if(i)a.currentSeqMax=i.length});break}}this.queryRegistry();for(var j in this.chains)this.queryRegistry(j,true);if(this.hubs)for(d=0;d<this.hubs.length;++d){j=this.hubs[d];if(typeof j=="string")j={url:j};(function(i){connectTrackHub(i.url,function(l,m){if(m)console.log(m);else{var o;
if(o=i.genome?l.genomes[i.genome]:l.genomes[a.coordSystem.ucscName]){if(i.mapping)o.mapping=i.mapping;a.hubObjects.push(o)}}},i)})(j)}!this.statusRestored&&this.storeStatus&&this.storeStatus()};Browser.prototype.touchStartHandler=function(a){a.stopPropagation();a.preventDefault();this.touchOriginX=a.touches[0].pageX;if(a.touches.length==2){a=Math.abs(a.touches[0].pageX-a.touches[1].pageX);this.zooming=true;this.zoomLastSep=this.zoomInitialSep=a;this.zoomInitialScale=this.scale}};
Browser.prototype.touchMoveHandler=function(a){a.stopPropagation();a.preventDefault();if(a.touches.length==1){var b=a.touches[0].pageX;this.touchOriginX&&b!=this.touchOriginX&&this.move(b-this.touchOriginX);this.touchOriginX=b}else if(this.zooming&&a.touches.length==2){b=Math.abs(a.touches[0].pageX-a.touches[1].pageX);if(b!=this.zoomLastSep){a=(a.touches[0].pageX+a.touches[1].pageX)/2;var c=this.viewStart+a/this.scale|0;this.scale=this.zoomInitialScale*(b/this.zoomInitialSep);this.viewStart=c-a/this.scale|
0;for(a=0;a<this.tiers.length;++a)this.tiers[a].draw()}this.zoomLastSep=b}};Browser.prototype.touchEndHandler=function(a){a.stopPropagation();a.preventDefault()};Browser.prototype.touchCancelHandler=function(){};Browser.prototype.makeTier=function(a,b){try{this.realMakeTier(a,b)}catch(c){console.log(c.stack||c)}};
Browser.prototype.realMakeTier=function(a,b){var c=this,d=this.tierBackgroundColors[this.tiers.length%this.tierBackgroundColors.length],e=makeElement("canvas",null,{width:""+((this.featurePanelWidth|0)+2E3),height:"30",className:"viewport"}),h=makeElement("canvas",null,{width:+((this.featurePanelWidth|0)+2E3),height:"30",className:"viewport-overlay"}),j=makeElement("span",""),i=makeElement("div",[makeElement("i",null,{className:"fa fa-warning"})," ",j],{className:"placard"},{display:"none"}),l=makeElement("div",
"Exciting message",{},{backgroundColor:"black",color:"white",zIndex:5E3,position:"relative",top:"-25px",opacity:0,padding:"6px",borderRadius:"4px",display:"inline-block",transition:"opacity 0.6s ease-in-out",pointerEvents:"none"}),m=makeElement("div",[e,h],{className:"view-holder"});m.style.background=d;m.addEventListener("touchstart",function(B){return c.touchStartHandler(B)},false);m.addEventListener("touchmove",function(B){return c.touchMoveHandler(B)},false);m.addEventListener("touchend",function(B){return c.touchEndHandler(B)},
false);m.addEventListener("touchcancel",function(B){return c.touchCancelHandler(B)},false);var o=new DasTier(this,a,e,m,h,i,j,l,b);o.oorigin=this.viewStart;o.background=d;o.quantOverlay=makeElement("canvas",null,{width:"50",height:"56",className:"quant-overlay"});o.holder.appendChild(o.quantOverlay);var q=false,p,s,r,t=function(B,G){var L=o.subtiers;if(L){var M=0;for(G-=MIN_PADDING;M<L.length&&G>L[M].height&&M<L.length-1;){G=G-L[M].height-MIN_PADDING;++M}if(!(M>=L.length)){L=L[M].glyphs;B-=(o.glyphCacheOrigin-
c.viewStart)*c.scale;return glyphLookup(L,B,G)}}},v=function(B){B.preventDefault();B.stopPropagation();B=B.clientX;if(o.dasSource.tier_type!=="sequence"&&B!=s){c.move(B-s);s=B}c.isDragging=true},u=function(){window.removeEventListener("mousemove",v,true);window.removeEventListener("mouseup",u,true)};m.addEventListener("mousedown",function(B){c.browserHolder.focus();B.preventDefault();m.getBoundingClientRect();B=B.clientX;window.addEventListener("mousemove",v,true);window.addEventListener("mouseup",
u,true);p=s=B;c.isDragging=false},false);m.addEventListener("mousemove",function(B){var G=m.getBoundingClientRect(),L=B.clientX-G.left,M=B.clientY-G.top;r&&clearTimeout(r);q||(r=setTimeout(function(){var S=t(L,M);S&&S.length>0&&c.notifyFeatureHover(B,S[S.length-1],S,o)},1E3))});var x=null;m.addEventListener("mouseup",function(B){var G=m.getBoundingClientRect(),L=B.clientX-G.left;G=B.clientY-G.top;var M=t(L,G);if(M&&M.length>0&&!c.isDragging)if(x){clearTimeout(x);x=null;c.featureDoubleClick(M,L,G)}else x=
setTimeout(function(){x=null;c.notifyFeature(B,M[M.length-1],M,o)},500);if(c.isDragging&&L!=p&&o.dasSource.tier_type==="sequence"){G=c.viewStart+L/c.scale;var S=c.viewStart+p/c.scale;if(G<S){L=G|0;G=S|0}else{L=S|0;G=G|0}c.notifyRegionSelect(c.chr,L,G)}c.isDragging=false},false);m.addEventListener("mouseout",function(){q=false});o.removeButton=makeElement("i",null,{className:"fa fa-times"});o.bumpButton=makeElement("i",null,{className:"fa fa-plus-circle"});o.loaderButton=makeElement("img",null,{src:this.uiPrefix+
"img/loader.gif"},{display:"none"});o.infoElement=makeElement("div",o.dasSource.desc,{},{display:"none",maxWidth:"200px",whiteSpace:"normal",color:"rgb(100,100,100)"});o.nameButton=makeElement("div",[],{className:"tier-tab"});o.nameButton.appendChild(o.removeButton);a.pennant&&o.nameButton.appendChild(makeElement("img",null,{src:a.pennant,width:"16",height:"16"}));o.nameElement=makeElement("span",a.name);o.nameButton.appendChild(makeElement("span",[o.nameElement,o.infoElement],{},{display:"inline-block",
marginLeft:"5px",marginRight:"5px"}));o.nameButton.appendChild(o.bumpButton);o.nameButton.appendChild(o.loaderButton);o.label=makeElement("span",[o.nameButton],{className:"btn-group"},{zIndex:1001,position:"absolute",left:"2px",top:"2px",opacity:0.8,display:"inline-block"});d=makeElement("div",[m,i,o.label,l],{},{position:"relative",display:"block",textAlign:"center"});o.row=d;o.removeButton.addEventListener("click",function(B){B.stopPropagation();B.preventDefault();for(B=0;B<c.tiers.length;++B)if(c.tiers[B]===
o){c.removeTier({index:B});break}},false);o.nameButton.addEventListener("click",function(B){B.stopPropagation();B.preventDefault();if(B.shiftKey){B=-1;for(var G=0;G<c.tiers.length;++G)if(c.tiers[G]===o){B=G;break}if(B>=0){G=c.selectedTiers.indexOf(B);if(G>=0)c.selectedTiers.splice(G,1);else{c.selectedTiers.push(B);c.selectedTiers.sort()}c.markSelectedTiers();c.notifyTierSelection();c.selectedTiers.length>0?c.browserHolder.focus():c.notifyTierSelectionWrap(-1)}}else{for(G=0;G<c.tiers.length;++G)if(c.tiers[G]===
o){c.browserHolder.focus();if(c.selectedTiers.length!=1||c.selectedTiers[0]!=G){c.setSelectedTier(G);return}}if(o.infoVisible){o.infoElement.style.display="none";o.updateHeight();o.infoVisible=false}else{o.infoElement.style.display="block";o.updateHeight();o.infoVisible=true}}},false);o.bumpButton.addEventListener("click",function(B){B.stopPropagation();B.preventDefault();var G;if(o.dasSource.collapseSuperGroups){if(G===undefined)G=!o.bumped;o.bumped=G;o.layoutWasDone=false;o.draw();o.updateLabel()}},
false);var z,H,C,A=false,D=function(B){var G=o.label;B.stopPropagation();B.preventDefault();if(!z){z=G.cloneNode(true);z.style.cursor="pointer";c.svgHolder.appendChild(z);G.style.visibility="hidden";for(var L=0;L<c.tiers.length;++L)if(c.tiers[L]===o){H=L;break}C=B.clientY}L=c.svgHolder.getBoundingClientRect();z.style.left=G.getBoundingClientRect().left-L.left+"px";z.style.top=B.clientY-L.top-10+"px";G=B.clientY-c.tierHolder.getBoundingClientRect().top;for(L=0;L<c.tiers.length;++L){var M=c.tiers[L].row.getBoundingClientRect();
G-=M.bottom-M.top;if(G<0){if(L<H&&B.clientY<C||L>H&&B.clientY>C){G=[];for(M=0;M<c.selectedTiers.length;++M)G.push(c.tiers[c.selectedTiers[M]]);c.tiers.splice(H,1);c.tiers.splice(L,0,o);c.selectedTiers=[];for(M=0;M<c.tiers.length;++M)G.indexOf(c.tiers[M])>=0&&c.selectedTiers.push(M);H=L;C=B.clientY;c.reorderTiers();A=true}break}}B=z.getBoundingClientRect();if(B.bottom-B.height<0)z.scrollIntoView(true);else B.bottom>window.innerHeight&&z.scrollIntoView(false)},O=function(B){var G=o.label;B.stopPropagation();
B.preventDefault();if(z){z.style.cursor="auto";c.svgHolder.removeChild(z);z=null;G.style.visibility=null}document.removeEventListener("mousemove",D,false);document.removeEventListener("mouseup",O,false);if(A){for(B=0;B<c.tiers.length;++B)if(c.tiers[B]==o){c.setSelectedTier(B);break}c.notifyTier()}};o.label.addEventListener("mousedown",function(B){B.stopPropagation();B.preventDefault();A=false;document.addEventListener("mousemove",D,false);document.addEventListener("mouseup",O,false)},false);this.tierHolder.appendChild(d);
this.tiers.push(o);o.init();o.currentlyHeight=50;this.updateHeight();o.updateLabel();o.featureSource&&o.featureSource.addActivityListener&&o.featureSource.addActivityListener(function(B){o.loaderButton.style.display=B>0?"inline-block":"none"});o._updateFromConfig()};
Browser.prototype.reorderTiers=function(){removeChildren(this.tierHolder);for(var a=0;a<this.tiers.length;++a)this.tierHolder.appendChild(this.tiers[a].row);this.tierHolder.appendChild(this.ruler);this.tierHolder.appendChild(this.ruler2);this.arrangeTiers()};Browser.prototype.refreshTier=function(a){this.knownSpace&&this.knownSpace.invalidate(a)};
Browser.prototype.arrangeTiers=function(){for(var a=0;a<this.tiers.length;++a){var b=this.tiers[a];b.background=this.tierBackgroundColors[a%this.tierBackgroundColors.length];b.holder.style.background=b.background}};
Browser.prototype.refresh=function(){this.notifyLocation();var a=100/this.scale|0,b=1E3/this.scale|0,c=(this.viewStart+this.viewEnd)/2,d=c-this.origin;this.origin=c;this.scaleAtLastRedraw=this.scale;for(c=0;c<this.tiers.length;++c){var e=d;if(this.tiers[c].originHaxx)e+=this.tiers[c].originHaxx;this.tiers[c].originHaxx=e}d=this.targetQuantRes/this.scale;c=Math.max(1,(this.viewStart|0)-a);a=Math.min((this.viewEnd|0)+a,(this.currentSeqMax|0)>0?this.currentSeqMax|0:1E9);e=Math.max(1,(this.viewStart|
0)-b);b=Math.min((this.viewEnd|0)+b,(this.currentSeqMax|0)>0?this.currentSeqMax|0:1E9);if(!this.knownSpace||this.knownSpace.chr!==this.chr){for(var h=null,j=0;j<this.tiers.length;++j)if(this.tiers[j].sequenceSource){h=this.tiers[j].sequenceSource;break}this.knownSpace=new KnownSpace(this.tiers,this.chr,e,b,d,h)}if((h=this.knownSpace.bestCacheOverlapping(this.chr,c,a))&&h.min<=c&&h.max>=a){this.drawnStart=Math.max(h.min,e);this.drawnEnd=Math.min(h.max,b)}else{this.drawnStart=e;this.drawnEnd=b}this.knownSpace.viewFeatures(this.chr,
this.drawnStart,this.drawnEnd,d);this.drawOverlays()};function setSources(a,b,c){if(c)for(var d=0;d<b.length;++d)b[d].mapping=c;a.set(b)}
Browser.prototype.queryRegistry=function(a,b){var c,d;if(a){c=this.chains[a].coords;this.mappableSources[a]||(this.mappableSources[a]=new Observed);d=this.mappableSources[a]}else{c=this.coordSystem;d=this.availableSources}var e=hex_sha1(miniJSONify(c));if(b){var h=localStorage["dalliance.registry."+e+".last_queried"];if(h)try{setSources(d,JSON.parse(localStorage["dalliance.registry."+e+".sources"]),a);if((Date.now()|0)-(h|0)<432E5)return}catch(j){console.log("Bad registry cache: "+j)}}(new DASRegistry(this.registry)).sources(function(i){for(var l=
[],m=0;m<i.length;++m){var o=i[m];if(!(!o.coords||o.coords.length==0)){var q=o.coords[0];q.taxon!=c.taxon||q.auth!=c.auth||q.version!=c.version||l.push(o)}}localStorage["dalliance.registry."+e+".sources"]=JSON.stringify(l);localStorage["dalliance.registry."+e+".last_queried"]=""+Date.now();setSources(d,l,a)},function(){},c)};
Browser.prototype.move=function(a){var b=this.viewEnd-this.viewStart;this.viewStart-=a/this.scale;this.viewEnd=this.viewStart+b;if(this.currentSeqMax>0&&this.viewEnd>this.currentSeqMax){this.viewEnd=this.currentSeqMax;this.viewStart=this.viewEnd-b}if(this.viewStart<1){this.viewStart=1;this.viewEnd=this.viewStart+b}this.notifyLocation();for(a=0;a<this.tiers.length;++a){this.tiers[a].viewport.style.left=""+((-((this.viewStart-this.tiers[a].norigin)*this.scale)|0)-1E3)+"px";this.tiers[a].overlay.style.left=
""+((-((this.viewStart-this.tiers[a].oorigin)*this.scale)|0)-1E3)+"px"}this.spaceCheck()};Browser.prototype.zoomStep=function(a){var b=1*this.zoomSliderValue;a=b+a;if(a<this.zoomMin)a=this.zoomMin;if(a>this.zoomMax)a=this.zoomMax;if(a!=b){this.zoomSliderValue=a;this.zoom(Math.exp(1*a/this.zoomExpt))}};
Browser.prototype.zoom=function(a){this.zoomFactor=a;a=Math.round((this.viewStart+this.viewEnd)/2)|0;this.viewStart=a-this.zoomBase*this.zoomFactor/2;this.viewEnd=a+this.zoomBase*this.zoomFactor/2;if(this.currentSeqMax>0&&this.viewEnd>this.currentSeqMax+5){a=this.viewEnd-this.viewStart+1;this.viewEnd=this.currentSeqMax;this.viewStart=this.viewEnd-a+1}if(this.viewStart<1){a=this.viewEnd-this.viewStart+1;this.viewStart=1;this.viewEnd=this.viewStart+a-1}this.scale=this.featurePanelWidth/(this.viewEnd-
this.viewStart);this.refresh()};Browser.prototype.spaceCheck=function(){if(!this.knownSpace||this.knownSpace.chr!==this.chr)this.refresh();else{var a=100/this.scale|0;if((this.drawnStart|0)>Math.max(1,(this.viewStart|0)-a|0)||(this.drawnEnd|0)<Math.min((this.viewEnd|0)+a,(this.currentSeqMax|0)>0?this.currentSeqMax|0:1E9))this.refresh()}};
Browser.prototype.resizeViewer=function(a){var b=this.featurePanelWidth;this.featurePanelWidth=this.tierHolder.getBoundingClientRect().width|0|0;if(b!=this.featurePanelWidth){this.zoomMax=this.zoomExpt*Math.log(this.maxViewWidth/this.zoomBase);this.zoomMin=this.zoomExpt*Math.log(this.featurePanelWidth/10/this.zoomBase);this.zoomSliderValue=this.zoomExpt*Math.log((this.viewEnd-this.viewStart+1)/this.zoomBase);this.viewEnd=this.viewStart+(this.viewEnd-this.viewStart)*this.featurePanelWidth/b;b=this.viewEnd-
this.viewStart+1;if(this.currentSeqMax>0&&this.viewEnd>this.currentSeqMax){this.viewEnd=this.currentSeqMax;this.viewStart=this.viewEnd-b+1}if(this.viewStart<1){this.viewStart=1;this.viewEnd=this.viewStart+b-1}this.positionRuler();a||this.spaceCheck();this.notifyLocation()}};Browser.prototype.addTier=function(a){a=new DASSource(a);a.disabled=false;this.makeTier(a);this.markSelectedTiers();this.positionRuler();this.notifyTier()};
function sourceDataURI(a){if(a.uri)return a.uri;else if(a.blob)return"file:"+a.blob.name;else if(a.bwgBlob)return"file:"+a.bwgBlob.name;else if(a.bamBlob)return"file:"+a.bamBlob.name;return a.bwgURI||a.bamURI||a.jbURI||a.twoBitURI||"http://www.biodalliance.org/magic/no_uri"}function sourceStyleURI(a){return a.stylesheet_uri?a.stylesheet_uri:a.tier_type=="sequence"?"http://www.biodalliance.org/magic/sequence":sourceDataURI(a)}
function sourcesAreEqual(a,b){if(sourceDataURI(a)!=sourceDataURI(b)||sourceStyleURI(a)!=sourceStyleURI(b))return false;if(a.mapping!=b.mapping)return false;if(a.tier_type!=b.tier_type)return false;if(a.overlay){if(!b.overlay||b.overlay.length!=a.overlay.length)return false;for(var c=0;c<a.overlay.length;++c)if(!sourcesAreEqual(a.overlay[c],b.overlay[c]))return false}else if(b.overlay)return false;return true}
Browser.prototype.removeTier=function(a,b){var c=-1;if(typeof a.index!=="undefined"&&a.index>=0&&a.index<this.tiers.length)c=a.index;else for(var d=0;d<this.tiers.length;++d)if(sourcesAreEqual(a,this.tiers[d].dasSource)){c=d;break}if(c<0)throw"Couldn't find requested tier";d=this.tiers[c];if(d.sequenceSource&&!b)throw"Can't remove sequence source tier";this.tierHolder.removeChild(d.row);this.tiers.splice(c,1);d=[];for(var e=0;e<this.selectedTiers.length;++e){var h=this.selectedTiers[e];if(h<c)d.push(h);
else h>c&&d.push(h-1)}this.selectedTiers=d;this.markSelectedTiers();this.arrangeTiers();this.notifyTier()};Browser.prototype.getSequenceSource=function(){for(var a=0;a<this.tiers.length;++a)if(this.tiers[a].sequenceSource)return this.tiers[a].sequenceSource};
Browser.prototype.setLocation=function(a,b,c,d){d||(d=function(j){if(j)throw j;});var e=this;if(!a||a==this.chr)return this._setLocation(null,b,c,null,d);else{var h=this.getSequenceSource();if(!h)return d("Need a sequence source");h.getSeqInfo(a,function(j){if(j)return e._setLocation(a,b,c,j,d);else{var i;i=a.indexOf("chr")==0?a.substr(3):"chr"+a;h.getSeqInfo(i,function(l){return l?e._setLocation(i,b,c,l,d):d("Couldn't find sequence '"+a+"'")})}})}};
Browser.prototype._setLocation=function(a,b,c,d,e){if(a){if(a.indexOf("chr")==0)a=a.substring(3);this.chr=a;this.currentSeqMax=d.length}b|=0;c|=0;a=Math.max(10,c-b+1);if(b<1){b=1;c=b+a-1}if(c>this.currentSeqMax){c=this.currentSeqMax;b=Math.max(1,c-a+1)}this.viewStart=b;this.viewEnd=c;c=this.featurePanelWidth/(this.viewEnd-this.viewStart);b=Math.abs(c-this.scale)>1.0E-4;this.scale=c;a=this.zoomSliderValue;this.zoomSliderValue=c=this.zoomExpt*Math.log((this.viewEnd-this.viewStart+1)/this.zoomBase);
if(b){this.refresh();if(this.savedZoom){c-=this.zoomMin;a-=this.zoomMin;b=c-this.savedZoom;if(Math.abs(c-a)>Math.abs(b)){this.isSnapZooming=!this.isSnapZooming;this.savedZoom=a}}else{this.isSnapZooming=false;this.savedZoom=null}}else for(b=0;b<this.tiers.length;++b){this.tiers[b].viewport.style.left=""+((-((this.viewStart-this.tiers[b].norigin)*this.scale)|0)-1E3)+"px";this.tiers[b].overlay.style.left=""+((-((this.viewStart-this.tiers[b].oorigin)*this.scale)|0)-1E3)+"px"}this.notifyLocation();this.spaceCheck();
return e()};Browser.prototype.addFeatureListener=function(a){this.featureListeners.push(a)};Browser.prototype.notifyFeature=function(a,b,c,d){for(var e=0;e<this.featureListeners.length;++e)try{if(this.featureListeners[e](a,b,c,d))return}catch(h){console.log(h.stack)}};Browser.prototype.addFeatureHoverListener=function(a){this.featureHoverListeners.push(a)};
Browser.prototype.notifyFeatureHover=function(a,b,c,d){for(var e=0;e<this.featureHoverListeners.length;++e)try{this.featureHoverListeners[e](a,b,c,d)}catch(h){console.log(h.stack)}};Browser.prototype.addViewListener=function(a){this.viewListeners.push(a)};Browser.prototype.notifyLocation=function(){for(var a=0;a<this.viewListeners.length;++a)try{this.viewListeners[a](this.chr,this.viewStart|0,this.viewEnd|0,this.zoomSliderValue,{current:this.zoomSliderValue,min:this.zoomMin,max:this.zoomMax})}catch(b){console.log(b.stack)}};
Browser.prototype.addTierListener=function(a){this.tierListeners.push(a)};Browser.prototype.notifyTier=function(){for(var a=0;a<this.tierListeners.length;++a)try{this.tierListeners[a]()}catch(b){console.log(b.stack)}};Browser.prototype.addRegionSelectListener=function(a){this.regionSelectListeners.push(a)};Browser.prototype.notifyRegionSelect=function(a,b,c){for(var d=0;d<this.regionSelectListeners.length;++d)try{this.regionSelectListeners[d](a,b,c)}catch(e){console.log(e.stack)}};
Browser.prototype.highlightRegion=function(a,b,c){var d=this;if(a==this.chr)return this._highlightRegion(a,b,c);var e=this.getSequenceSource();if(!e)throw"Need a sequence source";e.getSeqInfo(a,function(h){if(h)return d._highlightRegion(a,b,c);else{var j;j=a.indexOf("chr")==0?a.substr(3):"chr"+a;e.getSeqInfo(j,function(i){if(i)return d._highlightRegion(j,b,c)})}})};
Browser.prototype._highlightRegion=function(a,b,c){for(var d=0;d<this.highlights.length;++d){var e=this.highlights[d];if(e.chr==a&&e.min==b&&e.max==c)return}this.highlights.push(new Region(a,b,c));d=this.viewStart-1E3/this.scale;e=this.viewEnd+1E3/this.scale;if((a==this.chr||a=="chr"+this.chr)&&b<e&&c>d)this.drawOverlays();this.notifyLocation()};Browser.prototype.clearHighlights=function(){this.highlights=[];this.drawOverlays();this.notifyLocation()};
Browser.prototype.drawOverlays=function(){for(var a=0;a<this.tiers.length;++a)this.tiers[a].drawOverlay()};Browser.prototype.featuresInRegion=function(a,b,c){var d=[];if(a!==this.chr)return[];for(a=0;a<this.tiers.length;++a)for(var e=this.tiers[a].currentFeatures||[],h=0;h<e.length;++h){var j=e[h];j.min<=c&&j.max>=b&&d.push(j)}return d};Browser.prototype.getSelectedTier=function(){return this.selectedTiers.length>0?this.selectedTiers[0]:-1};
Browser.prototype.setSelectedTier=function(a){this.selectedTiers=a==null?[]:[a];this.markSelectedTiers();this.notifyTierSelection()};Browser.prototype.markSelectedTiers=function(){for(var a=0;a<this.tiers.length;++a){var b=this.tiers[a].nameButton;this.selectedTiers.indexOf(a)>=0?b.classList.add("active"):b.classList.remove("active")}this.selectedTiers.length>0&&this.browserHolder.focus()};Browser.prototype.addTierSelectionListener=function(a){this.tierSelectionListeners.push(a)};
Browser.prototype.notifyTierSelection=function(){for(var a=0;a<this.tierSelectionListeners.length;++a)try{this.tierSelectionListeners[a](this.selectedTiers)}catch(b){console.log(b.stack)}};Browser.prototype.addTierSelectionWrapListener=function(a){this.tierSelectionWrapListeners.push(a)};Browser.prototype.notifyTierSelectionWrap=function(a){for(var b=0;b<this.tierSelectionWrapListeners.length;++b)try{this.tierSelectionWrapListeners[b](a)}catch(c){console.log(c.stack)}};
Browser.prototype.positionRuler=function(){var a="none",b="",c="";if(this.rulerLocation=="center"){a="block";b=""+(this.featurePanelWidth/2|0)+"px"}else if(this.rulerLocation=="left"){a="block";b="0px"}else if(this.rulerLocation=="right"){a="block";c="0px"}else a="none";this.ruler.style.display=a;this.ruler.style.left=b;this.ruler.style.right=c;this.ruler2.style.display=this.rulerLocation=="center"?"none":"block";this.ruler2.style.left=""+(this.featurePanelWidth/2|0)+"px";for(var d=0;d<this.tiers.length;++d){var e=
this.tiers[d],h=e.quantOverlay,j;if(e.subtiers&&e.subtiers.length>0)j=e.subtiers[0].quant;if(h){h.style.display=j?a:"none";h.style.left=b;h.style.right=c}}};Browser.prototype.featureDoubleClick=function(a,b){if(!(!a||a.length==0)){f=a[a.length-1];if(f.min&&f.max){var c=((f.min|0)-(this.viewStart|0))*this.scale,d=(f.max-f.min+1)*this.scale,e=((f.min|0)+(f.max|0))/2;if(d>10){c=1*(b-c)/d;if(c<0.3)e=f.min|0;else if(c>0.7)e=(f.max|0)+1}c=this.viewEnd-this.viewStart;this.setLocation(null,e-c/2,e+c/2)}}};
Browser.prototype.updateHeight=function(){for(var a=0,b=0;b<this.tiers.length;++b)a+=this.tiers[b].currentHeight||30;this.svgHolder.style.maxHeight=""+Math.max(a,500)+"px"};Browser.prototype.scrollArrowKey=function(a,b){if(this.reverseKeyScrolling)b=-b;if(a.ctrlKey||a.metaKey){var c=false;if(a.shiftKey)c=true;this.leap(b,c)}else this.move(a.shiftKey?100*b:25*b)};
Browser.prototype.leap=function(a,b){var c=this,d=(c.viewStart+c.viewEnd+1)/2|0,e=c.getSelectedTier();if(!(e<0))(e=c.tiers[e])&&(e.featureSource&&sourceAdapterIsCapable(e.featureSource,"quantLeap")&&typeof e.quantLeapThreshold=="number"||e.featureSource&&sourceAdapterIsCapable(e.featureSource,"leap"))?e.findNextFeature(c.chr,d,-a,b,function(h){if(h){var j=h.min,i=h.max;if(b)if(a>0)if(j>d+1)i=j;else{i++;j=i}else if(i<d-1){i++;j=i}else i=j;var l=c.viewEnd-c.viewStart+1;parseFloat(l/2)==parseInt(l/2)&&
l--;j=(j+i-l)/2+1;c.setLocation(h.segment,j,j+l-1)}else alert("no next feature")}):this.move(100*a)};function glyphLookup(a,b,c,d){d=d||[];for(var e=a.length-1;e>=0;--e){var h=a[e];if(!h.notSelectable&&h.min()<=b&&h.max()>=b){if(h.minY)if(c<h.minY()||c>h.maxY())continue;if(h.feature)d.push(h.feature);else h.group&&d.push(h.group);return h.glyphs?glyphLookup(h.glyphs,b,c,d):h.glyph?glyphLookup([h.glyph],b,c,d):d}}return d}var TAGVAL_NOTE_RE=/^([A-Za-z]+)=(.+)/;
Browser.prototype.addFeatureInfoPlugin=function(a){if(!this.featureInfoPlugins)this.featureInfoPlugins=[];this.featureInfoPlugins.push(a)};function FeatureInfo(a,b,c){var d=pick(c.type,b.type),e=pick(c.label,b.label,c.id,b.id);if(e&&e.indexOf("__dazzle")!=0)d=d+": "+e;this.hit=a;this.feature=b;this.group=c;this.title=d;this.sections=[]}FeatureInfo.prototype.setTitle=function(a){this.title=a};
FeatureInfo.prototype.add=function(a,b){if(typeof b==="string")b=makeElement("span",b);this.sections.push({label:a,info:b})};
Browser.prototype.featurePopup=function(a,b,c,d){b=c.length;var e=--b>=0?c[b]:{},h=--b>=0?c[b]:{};c=new FeatureInfo(c,e,h);c.tier=d;b=this.featureInfoPlugins||[];for(fipi=0;fipi<b.length;++fipi)try{b[fipi](e,c)}catch(j){console.log(j.stack||j)}b=d.featureInfoPlugins||[];for(fipi=0;fipi<b.length;++fipi)try{b[fipi](e,c)}catch(i){console.log(i.stack||i)}this.removeAllPopups();d=makeElement("table",null,{className:"table table-striped table-condensed"});d.style.width="100%";d.style.margin="0px";b=0;if(e.method){var l=
makeElement("tr",[makeElement("th","Method"),makeElement("td",e.method)]);d.appendChild(l);++b}l=h.segment?h:e;l=makeElement("tr",[makeElement("th","Location"),makeElement("td",l.segment+":"+l.min+"-"+l.max)]);l.style.backgroundColor=this.tierBackgroundColors[b%this.tierBackgroundColors.length];d.appendChild(l);++b;if(e.score!==undefined&&e.score!==null&&e.score!="-"){l=makeElement("tr",[makeElement("th","Score"),makeElement("td",""+e.score)]);d.appendChild(l);++b}if((l=maybeConcat(h.links,e.links))&&
l.length>0){l=makeElement("tr",[makeElement("th","Links"),makeElement("td",l.map(function(q){return makeElement("div",makeElement("a",q.desc,{href:q.uri,target:"_new"}))}))]);d.appendChild(l);++b}e=maybeConcat(h.notes,e.notes);for(h=0;h<e.length;++h){l="Note";var m=e[h],o=m.match(TAGVAL_NOTE_RE);if(o){l=o[1];m=o[2]}l=makeElement("tr",[makeElement("th",l),makeElement("td",m)]);d.appendChild(l);++b}for(b=0;b<c.sections.length;++b){e=c.sections[b];d.appendChild(makeElement("tr",[makeElement("th",e.label),
makeElement("td",e.info)]))}this.popit(a,c.title||"Feature",d,{width:400})};function Chainset(a,b,c,d){this.uri=a;this.srcTag=b;this.destTag=c;this.coords=d;this.chainsBySrc={};this.chainsByDest={};this.postFetchQueues={}}function parseCigar(a){for(var b=[],c=RegExp("([0-9]*)([MIDS])","g"),d;(d=c.exec(a))!=null;){var e=d[1];if(e.length==0)e=1;b.push({cnt:e|0,op:d[2]})}return b}
Chainset.prototype.fetchChainsTo=function(a){var b=this;(new DASSource(this.uri)).alignments(a,{},function(c){b.chainsByDest[a]||(b.chainsByDest[a]=[]);for(var d=0;d<c.length;++d)for(var e=c[d],h=0;h<e.blocks.length;++h){for(var j=e.blocks[h],i,l,m=0;m<j.segments.length;++m){var o=j.segments[m],q=e.objects[o.object];if(q.dbSource===b.srcTag)i=o;else if(q.dbSource===b.destTag)l=o}if(i&&l){j={srcChr:e.objects[i.object].accession,srcMin:i.min|0,srcMax:i.max|0,srcOri:i.strand,destChr:e.objects[l.object].accession,
destMin:l.min|0,destMax:l.max|0,destOri:l.strand,blocks:[]};m=parseCigar(i.cigar);o=parseCigar(l.cigar);for(var p=q=0,s=0,r=0;s<m.length&&r<o.length;)if(m[s].op=="M"&&o[r].op=="M"){var t=Math.min(m[s].cnt,o[r].cnt);j.blocks.push([q,p,t]);if(m[s].cnt==t)++s;else m[s].cnt-=t;if(o[r].cnt==t)++r;else o[r]-=t;q+=t;p+=t}else if(m[s].op=="I")p+=m[s++].cnt;else if(o[r].op=="I")q+=o[r++].cnt;pusho(b.chainsBySrc,j.srcChr,j);pusho(b.chainsByDest,j.destChr,j)}}if(b.postFetchQueues[a]){c=b.postFetchQueues[a];
for(d=0;d<c.length;++d)c[d]();b.postFetchQueues[a]=null}})};Chainset.prototype.mapPoint=function(a,b){for(var c=this.chainsBySrc[a]||[],d=0;d<c.length;++d){var e=c[d];if(b>=e.srcMin&&b<=e.srcMax){var h;h=e.srcOri=="-"?e.srcMax-b:b-e.srcMin;for(var j=e.blocks,i=0;i<j.length;++i){var l=j[i],m=l[0],o=l[1];l=l[2];if(h>=m&&h<=m+l){c=h-m;return{seq:e.destChr,pos:e.destOri=="-"?e.destMax-o-c:c+o+e.destMin,flipped:e.srcOri!=e.destOri}}}}}return null};
Chainset.prototype.unmapPoint=function(a,b){for(var c=this.chainsByDest[a]||[],d=0;d<c.length;++d){var e=c[d];if(b>=e.destMin&&b<=e.destMax){var h;h=e.srcOri=="-"?e.destMax-b:b-e.destMin;for(var j=e.blocks,i=0;i<j.length;++i){var l=j[i],m=l[0],o=l[1];l=l[2];if(h>=o&&h<=o+l){c=h-o;d=c+m+e.srcMin;d=e.destOri=="-"?e.srcMax-m-c:c+m+e.srcMin;return{seq:e.srcChr,pos:d,flipped:e.srcOri!=e.destOri}}}}}return null};
Chainset.prototype.sourceBlocksForRange=function(a,b,c,d){if(this.chainsByDest[a]){var e=this.unmapPoint(a,b),h=this.unmapPoint(a,c);!e||!h||e.seq!=h.seq?d([]):d([new DASSegment(e.seq,e.pos,h.pos)])}else{e=!this.postFetchQueues[a];var j=this;pusho(this.postFetchQueues,a,function(){j.sourceBlocksForRange(a,b,c,d)});e&&this.fetchChainsTo(a)}};function DColour(a,b,c,d){this.red=a|0;this.green=b|0;this.blue=c|0;if(d)this.name=d}
DColour.prototype.toSvgString=function(){if(!this.name)this.name="rgb("+this.red+","+this.green+","+this.blue+")";return this.name};function hex2(a){y="00"+a.toString(16);return y.substring(y.length-2)}DColour.prototype.toHexString=function(){return"#"+hex2(this.red)+hex2(this.green)+hex2(this.blue)};
var palette={red:new DColour(255,0,0,"red"),green:new DColour(0,255,0,"green"),blue:new DColour(0,0,255,"blue"),yellow:new DColour(255,255,0,"yellow"),white:new DColour(255,255,255,"white"),black:new DColour(0,0,0,"black"),gray:new DColour(180,180,180,"gray"),grey:new DColour(180,180,180,"grey")},COLOR_RE=/^#([0-9A-Fa-f]{2})([0-9A-Fa-f]{2})([0-9A-Fa-f]{2})$/,CSS_COLOR_RE=/rgb\(([0-9]+),([0-9]+),([0-9]+)\)/;
function dasColourForName(a){var b=palette[a];if(!b){if(b=COLOR_RE.exec(a))b=new DColour("0x"+b[1]|0,"0x"+b[2]|0,"0x"+b[3]|0,a);else if(b=CSS_COLOR_RE.exec(a))b=new DColour(b[1]|0,b[2]|0,b[3]|0,a);else{console.log("couldn't handle color: "+a);b=palette.black}palette[a]=b}return b}
function makeColourSteps(a,b,c){for(var d=[],e=0;e<c.length;++e)d.push(dasColourForName(c[e]));c=[];e=0;a:for(;e<a;++e){for(var h=b[0]+(b[b.length-1]-b[0])*(1*e/(a-1)),j=0;j<b.length-1;++j)if(h>=b[j]&&h<=b[j+1]){h=(h-b[j])/(b[j+1]-b[j]);var i=d[j];j=d[j+1];j=(new DColour(i.red*(1-h)+j.red*h|0,i.green*(1-h)+j.green*h|0,i.blue*(1-h)+j.blue*h|0)).toSvgString();c.push(j);continue a}throw"Bad step";}return c}
function makeGradient(a,b,c,d){return d?makeColourSteps(a,[0,0.5,1],[b,c,d]):makeColourSteps(a,[0,1],[b,c])}var dasLibErrorHandler=function(a){alert(a)},dasLibRequestQueue=[];function DASSegment(a,b,c,d){this.name=a;this.start=b;this.end=c;this.description=d}DASSegment.prototype.toString=function(){return this.name+":"+this.start+".."+this.end};DASSegment.prototype.isBounded=function(){return this.start&&this.end};
DASSegment.prototype.toDASQuery=function(){var a="segment="+this.name;if(this.start&&this.end)a+=":"+this.start+","+this.end;return a};function DASSource(a,b){var c;if(typeof a=="string"){this.uri=a;c=b||{}}else c=a||{};for(var d in c)if(typeof c[d]!="function")this[d]=c[d];if(!this.coords)this.coords=[];if(!this.props)this.props={};if((this.dasBaseURI=this.uri)&&this.dasBaseURI.substr(this.uri.length-1)!="/")this.dasBaseURI+="/"}function DASCoords(){}
function coordsMatch(a,b){return a.taxon==b.taxon&&a.auth==b.auth&&a.version==b.version}
DASSource.prototype.entryPoints=function(a){this.doCrossDomainRequest(this.dasBaseURI+"entry_points",function(b){if(!b)return a([]);var c=[];b=b.getElementsByTagName("SEGMENT");for(var d=0;d<b.length;++d){var e=b[d],h=e.getAttribute("id"),j=e.getAttribute("size"),i;if(j){i=1;j=j|0}else{if(i=e.getAttribute("start"))i|=0;if(j=e.getAttribute("stop"))j|=0}var l=null;if(e.firstChild)l=e.firstChild.nodeValue;c.push(new DASSegment(h,i,j,l))}a(c)})};
function DASSequence(a,b,c,d,e){this.name=a;this.start=b;this.end=c;this.alphabet=d;this.seq=e}
DASSource.prototype.sequence=function(a,b){this.doCrossDomainRequest(this.dasBaseURI+"sequence?"+a.toDASQuery(),function(c){if(c){var d=[];c=c.getElementsByTagName("SEQUENCE");for(var e=0;e<c.length;++e){var h=c[e],j=h.getAttribute("id"),i=h.getAttribute("start"),l=h.getAttribute("stop"),m=null;if(h.firstChild){h=h.firstChild.nodeValue;m="";for(var o=0;;){var q=h.indexOf("\n",o);if(q>=0){m+=h.substring(o,q);o=q+1}else{m+=h.substring(o);break}}}d.push(new DASSequence(j,i,l,"DNA",m))}b(d)}else b([])})};
function DASFeature(){}function DASGroup(){}function DASLink(a,b){this.desc=a;this.uri=b}
DASSource.prototype.features=function(a,b,c){b=b||{};var d;if(this.features_uri)d=this.features_uri;else{var e=[];if(a)e.push(a.toDASQuery());else if(b.group){a=b.group;if(typeof a=="string")e.push("group_id="+a);else for(var h=0;h<a.length;++h)e.push("group_id="+a[h])}if(b.adjacent){a=b.adjacent;if(typeof a=="string")a=[a];for(h=0;h<a.length;++h)e.push("adjacent="+a[h])}if(b.type)if(typeof b.type=="string")e.push("type="+b.type);else for(a=0;a<b.type.length;++a)e.push("type="+b.type[a]);b.maxbins&&
e.push("maxbins="+b.maxbins);if(e.length>0)d=this.dasBaseURI+"features?"+e.join(";");else c([],"No filters specified")}this.doCrossDomainRequest(d,function(j,i){if(j){for(var l=[],m={},o=j.getElementsByTagName("SEGMENT"),q=0;q<o.length;++q){var p=o[q],s=p.getAttribute("id");m[s]={min:p.getAttribute("start"),max:p.getAttribute("stop")};p=p.getElementsByTagName("FEATURE");for(var r=0;r<p.length;++r){var t=p[r],v=new DASFeature;v.segment=s;v.id=t.getAttribute("id");v.label=t.getAttribute("label");var u=
elementValue(t,"START"),x=elementValue(t,"END");if((u|0)>(x|0)){v.min=x|0;v.max=u|0}else{v.min=u|0;v.max=x|0}u=t.getElementsByTagName("TYPE");if(u.length>0){u=u[0];if(u.firstChild)v.type=u.firstChild.nodeValue;v.typeId=u.getAttribute("id");v.typeCv=u.getAttribute("cvId")}v.type=elementValue(t,"TYPE");if(!v.type&&v.typeId)v.type=v.typeId;v.method=elementValue(t,"METHOD");(u=elementValue(t,"ORIENTATION"))||(u="0");v.orientation=u;v.score=elementValue(t,"SCORE");v.links=dasLinksOf(t);v.notes=dasNotesOf(t);
u=t.getElementsByTagName("GROUP");for(x=0;x<u.length;++x){var z=u[x],H=new DASGroup;H.type=z.getAttribute("type");H.id=z.getAttribute("id");H.links=dasLinksOf(z);H.notes=dasNotesOf(z);if(v.groups)v.groups.push(H);else v.groups=Array(H)}if(v.notes)for(u=0;u<v.notes.length;++u){x=v.notes[u];if(x.indexOf("Genename=")==0){z=new DASGroup;z.type="gene";z.id=x.substring(9);if(v.groups)v.groups.push(z);else v.groups=Array(z)}}u=t.getElementsByTagName("PART");if(u.length>0){z=[];for(x=0;x<u.length;++x)z.push(u[x].getAttribute("id"));
v.parts=z}u=t.getElementsByTagName("PARENT");if(u.length>0){t=[];for(x=0;x<u.length;++x)t.push(u[x].getAttribute("id"));v.parents=t}l.push(v)}}c(l,undefined,m)}else c([],"Failed request: "+(i.status==0?"server may not support CORS":"status="+i.status))},function(j){c([],j)})};function DASAlignment(a){this.type=a;this.objects={};this.blocks=[]}
DASSource.prototype.alignments=function(a,b,c){var d=this.dasBaseURI+"alignment?query="+a;this.doCrossDomainRequest(d,function(e){if(e){var h=[];e=e.getElementsByTagName("alignment");for(var j=0;j<e.length;++j){for(var i=e[j],l=new DASAlignment(i.getAttribute("alignType")),m=i.getElementsByTagName("alignObject"),o=0;o<m.length;++o){var q=m[o];q={id:q.getAttribute("intObjectId"),accession:q.getAttribute("dbAccessionId"),version:q.getAttribute("objectVersion"),dbSource:q.getAttribute("dbSource"),dbVersion:q.getAttribute("dbVersion")};
l.objects[q.id]=q}i=i.getElementsByTagName("block");for(m=0;m<i.length;++m){q=i[m];o={order:q.getAttribute("blockOrder"),segments:[]};q=q.getElementsByTagName("segment");for(var p=0;p<q.length;++p){var s=q[p];s={object:s.getAttribute("intObjectId"),min:s.getAttribute("start"),max:s.getAttribute("end"),strand:s.getAttribute("strand"),cigar:elementValue(s,"cigar")};o.segments.push(s)}l.blocks.push(o)}h.push(l)}c(h)}else c([],"Failed request "+d)})};function DASStylesheet(){this.styles=[]}
DASStylesheet.prototype.pushStyle=function(a,b,c){a||(a={type:"default"});a=shallowCopy(a);if(b)a.zoom=b;a.style=c;this.styles.push(a)};function DASStyle(){}function parseGradient(a){var b=a.getAttribute("steps");b=b?b|0:50;var c=[],d=[];a=a.getElementsByTagName("STOP");for(var e=0;e<a.length;++e){var h=a[e];c.push(1*h.getAttribute("score"));d.push(h.firstChild.nodeValue)}return makeColourSteps(b,c,d)}
DASSource.prototype.stylesheet=function(a,b){var c,d=this.credentials;if(this.stylesheet_uri){c=this.stylesheet_uri;d=false}else c=this.dasBaseURI+"stylesheet";doCrossDomainRequest(c,function(e){if(e){var h=new DASStylesheet;e=e.getElementsByTagName("TYPE");for(var j=0;j<e.length;++j){var i=e[j],l={};l.type=i.getAttribute("id");l.label=i.getAttribute("label");l.method=i.getAttribute("method");i=i.getElementsByTagName("GLYPH");for(var m=0;m<i.length;++m){var o=i[m],q=o.getAttribute("zoom"),p=childElementOf(o);
o=new DASStyle;o.glyph=p.localName;for(p=p.firstChild;p;){if(p.nodeType==Node.ELEMENT_NODE)o[p.localName]=p.localName=="BGGRAD"?parseGradient(p):p.firstChild.nodeValue;p=p.nextSibling}h.pushStyle(l,q,o)}}a(h)}else b&&b()},d)};function DASRegistry(a,b){b=b||{};this.uri=a;this.opts=b}
DASRegistry.prototype.sources=function(a,b,c){c||(c={});var d=[];c.taxon&&d.push("organism="+c.taxon);c.auth&&d.push("authority="+c.auth);c.version&&d.push("version="+c.version);c=this.uri;if(d.length>0)c=c+"?"+d.join("&");doCrossDomainRequest(c,function(e){if(!e&&b)b();else{var h=[];e=e.getElementsByTagName("SOURCE");for(var j=0;j<e.length;++j){var i=e[j],l=i.getElementsByTagName("VERSION");if(!(l.length<1)){var m=l[0],o=m.getElementsByTagName("COORDINATES");l=[];for(var q=0;q<o.length;++q){var p=
o[q],s=new DASCoords;s.auth=p.getAttribute("authority");s.taxon=p.getAttribute("taxid");s.version=p.getAttribute("version");l.push(s)}o=[];p=m.getElementsByTagName("CAPABILITY");var r;for(q=0;q<p.length;++q){s=p[q];o.push(s.getAttribute("type"));if(s.getAttribute("type")=="das1:features"){r=s.getAttribute("query_uri");r=r.substring(0,r.length-8)}}q={};m=m.getElementsByTagName("PROP");for(p=0;p<m.length;++p)pusho(q,m[p].getAttribute("name"),m[p].getAttribute("value"));if(r){i=new DASSource(r,{source_uri:i.getAttribute("uri"),
name:i.getAttribute("title"),desc:i.getAttribute("description"),coords:l,props:q,capabilities:o});h.push(i)}}}a(h)}})};function elementValue(a,b){var c=a.getElementsByTagName(b);if(c.length>0&&c[0].firstChild){c=c[0];if(c.childNodes.length==1)return c.firstChild.nodeValue;else{for(var d="",e=0;e<c.childNodes.length;++e)d+=c.childNodes[e].nodeValue;return d}}else return null}
function childElementOf(a){if(a.hasChildNodes()){a=a.firstChild;do{if(a.nodeType==Node.ELEMENT_NODE)return a;a=a.nextSibling}while(a!=null)}return null}function dasLinksOf(a){for(var b=[],c=a.getElementsByTagName("LINK"),d=0;d<c.length;++d){var e=c[d];if(e.parentNode==a)b.push(new DASLink(e.firstChild?e.firstChild.nodeValue:"Unknown",e.getAttribute("href")))}return b}
function dasNotesOf(a){var b=[];a=a.getElementsByTagName("NOTE");for(var c=0;c<a.length;++c)a[c].firstChild&&b.push(a[c].firstChild.nodeValue);return b}
function doCrossDomainRequest(a,b,c,d){if(window.XDomainRequest){var e=new XDomainRequest;e.onload=function(){var h=new ActiveXObject("Microsoft.XMLDOM");h.async=false;h.loadXML(e.responseText);b(h)};e.open("get",a)}else{Date.now();e=new XMLHttpRequest;e.onreadystatechange=function(){if(e.readyState==4)if(e.status>=200||e.status==0)b(e.responseXML,e)};e.open("get",a,true);if(c)e.withCredentials=true;d&&e.setRequestHeader("X-DAS-Authorisation",d);e.setRequestHeader("Accept","application/xml,*/*")}e.send("")}
DASSource.prototype.doCrossDomainRequest=function(a,b,c){var d;if(this.xUser)d="Basic "+btoa(this.xUser+":"+this.xPass);try{return doCrossDomainRequest(a,b,this.credentials,d)}catch(e){if(c)c(e);else throw e;}};Browser.prototype.removeAllPopups=function(){removeChildren(this.hPopupHolder);removeChildren(this.popupHolder)};
Browser.prototype.makeTooltip=function(a,b){var c=false,d=this,e=null,h;h=function(){c=false;if(e){clearTimeout(e);e=null}a.removeEventListener("mouseout",h,false)};var j=function(i){var l=i.clientX+window.scrollX,m=i.clientY+window.scrollY;e||(e=setTimeout(function(){var o;o=typeof b==="function"?b():b;var q=makeElement("div",[makeElement("div",null,{className:"tooltip-arrow"}),makeElement("div",o,{className:"tooltip-inner"})],{className:"tooltip bottom in"},{display:"block",top:""+(m+20)+"px",left:""+
Math.max(l-30,20)+"px"});d.hPopupHolder.appendChild(q);var p;p=function(s){try{d.hPopupHolder.removeChild(q)}catch(r){}window.removeEventListener("mousemove",p,false);c&&a.offsetParent!=null&&j(s)};window.addEventListener("mousemove",p,false);e=null},1E3))};a.addEventListener("mouseover",function(i){c=true;a.addEventListener("mouseout",h,false);j(i)},false);a.addEventListener("DOMNodeRemovedFromDocument",function(){c=false;if(e){clearTimeout(e);e=null}},false)};
Browser.prototype.popit=function(a,b,c,d){var e=this;d||(d={});a||(a={});var h=d.width||200,j;if(a.clientX){d=a.clientX;j=a.clientY}else{d=500;j=50}d+=document.documentElement.scrollLeft||document.body.scrollLeft;j+=document.documentElement.scrollTop||document.body.scrollTop;var i=window.innerWidth,l=j,m=Math.min(d-h/2-4,i-h-30),o=makeElement("div");o.className="popover fade "+(a.clientX?"bottom ":"")+"in";o.style.display="block";o.style.position="absolute";o.style.top=""+l+"px";o.style.left=""+m+
"px";o.style.width=h+"px";if(h>276)o.style.maxWidth=h+"px";o.appendChild(makeElement("div",null,{className:"arrow"}));if(b){var q=makeElement("button","",{className:"close"});q.innerHTML="&times;";q.addEventListener("mouseover",function(){q.style.color="red"},false);q.addEventListener("mouseout",function(){q.style.color="black"},false);q.addEventListener("click",function(u){u.preventDefault();u.stopPropagation();e.removeAllPopups()},false);a=makeElement("h4",[makeElement("span",b,null,{maxWidth:"200px"}),
q],{},{paddingLeft:"10px",paddingRight:"10px"});var p,s,r,t;r=function(u){u.stopPropagation();u.preventDefault();m+=u.clientX-p;if(m<8)m=8;if(m>i-h-32)m=i-h-26;l+=u.clientY-s;l=Math.max(10,l);o.style.top=""+l+"px";o.style.left=""+Math.min(m,i-h-10)+"px";p=u.clientX;s=u.clientY};t=function(u){u.stopPropagation();u.preventDefault();window.removeEventListener("mousemove",r,false);window.removeEventListener("mouseup",t,false)};a.addEventListener("mousedown",function(u){u.preventDefault();u.stopPropagation();
p=u.clientX;s=u.clientY;window.addEventListener("mousemove",r,false);window.addEventListener("mouseup",t,false)},false);o.appendChild(a)}o.appendChild(makeElement("div",c,{className:"popover-content"},{padding:"0px"}));this.hPopupHolder.appendChild(o);var v={node:o,displayed:true};o.addEventListener("DOMNodeRemoved",function(u){if(u.target==o)v.displayed=false},false);return v};
function makeTreeTableSection(a,b,c){function d(){if(c){e.className="fa fa-caret-down";b.style.display="table"}else{e.className="fa fa-caret-right";b.style.display="none"}}var e=makeElement("i");d();e.addEventListener("click",function(h){h.preventDefault();h.stopPropagation();c=!c;d()},false);a=makeElement("h6",[e," ",a],{},{display:"block",background:"gray",color:"white",width:"100%",padding:"5px 2px",margin:"0px"});return makeElement("div",[a,b],{})}function dlog(a){console.log(a)}
var MIN_PADDING=3,DEFAULT_SUBTIER_MAX=100;function isDasBooleanTrue(a){a=(""+a).toLowerCase();return a==="yes"||a==="true"}function isDasBooleanNotFalse(a){if(!a)return false;a=(""+a).toLowerCase();return a!=="no"||a!=="false"}function SubTier(){this.glyphs=[];this.height=0;this.quant=null}SubTier.prototype.indexFor=function(a){a=a.min();for(var b=0,c=this.glyphs.length;c>b;){var d=(b+c)/2|0;if(d>=this.glyphs.length)return this.glyphs.length;if(a<this.glyphs[d].min())c=d;else b=d+1}return c};
SubTier.prototype.add=function(a){this.glyphs.splice(this.indexFor(a),0,a);this.height=Math.max(this.height,a.height());if(a.quant&&this.quant==null)this.quant=a.quant};SubTier.prototype.hasSpaceFor=function(a){var b=this.indexFor(a);if(b>0&&this.glyphs[b-1].max()>=a.min())return false;if(b<this.glyphs.length&&this.glyphs[b].min()<=a.max())return false;return true};var GLOBAL_GC;
function drawFeatureTier(a){GLOBAL_GC=a.viewport.getContext("2d");sortFeatures(a);var b=[],c=false,d={},e={};for(var h in a.ungroupedFeatures)for(var j=a.ungroupedFeatures[h],i=0;i<j.length;++i){c=j[i];if(!c.parts){var l=a.styleForFeature(c);if(l)if(l.glyph=="LINEPLOT"){pusho(d,l.id,c);e[l.id]=l}else{var m=glyphForFeature(c,0,a.styleForFeature(c),a);m&&b.push(m)}}}for(var o in d){h=d[o];l=e[o];if(l.glyph=="LINEPLOT"){b.push(makeLineGlyph(h,l,a));c=true}}if(a.dasSource.collapseSuperGroups&&!a.bumped)for(var q in a.superGroups){d=
a.superGroups[q];a.groups[q]=shallowCopy(a.groups[q]);a.groups[q].type=a.groups[d[0]].type;e={};l=1E10;j=-10000000000;i=null;for(m=0;m<d.length;++m)if(h=a.groupedFeatures[d[m]]){for(o=0;o<h.length;++o){c=h[o];pusho(e,c.type,c);l=Math.min(c.min,l);j=Math.max(c.max,j);if(c.segment&&!i)i=c.segment}if(a.groups[q]&&!a.groups[q].links||a.groups[q].links.length==0)a.groups[q].links=a.groups[d[0]].links;delete a.groupedFeatures[d[m]]}a.groups[q].max=j;a.groups[q].min=l;a.groups[q].segment=i;for(var p in e){h=
e[p];l=h[0];j=null;for(o=0;o<h.length;++o){c=h[o];c=new Range(c.min,c.max);j=j?union(j,c):c}j=j.ranges();for(i=0;i<j.length;++i){var s=j[i],r=((s.max()|0)-(s.min()|0)+1)*d.length,t=0;for(o=0;o<h.length;++o){c=h[o];if((c.min|0)<=s.max()&&(c.max|0)>=s.min()){var v=Math.max(c.min|0,s.min());c=Math.min(c.max|0,s.max());t+=c-v+1}}c=new DASFeature;for(k in l)c[k]=l[k];c.min=s.min();c.max=s.max();if(c.label&&d.length>1)c.label+=" ("+d.length+" vars)";c.visualWeight=1*t/r;pusho(a.groupedFeatures,q,c)}}delete a.superGroups[q]}c=
[];for(var u in a.groupedFeatures)c.push(u);c.sort(function(x,z){var H=a.groupedFeatures[x][0].score-a.groupedFeatures[z][0].score;return H>0?-1:H==0?0:1});p={};for(d=0;d<c.length;++d){u=c[d];if(m=glyphsForGroup(a.groupedFeatures[u],0,a.groups[u],a,a.dasSource.collapseSuperGroups&&!a.bumped?"collapsed_gene":"tent")){m.group=a.groups[u];p[u]=m}}for(q in a.superGroups){d=a.superGroups[q];u=[];l=1E10;j=-10000000000;for(c=0;c<d.length;++c){e=p[d[c]];p[d[c]]=null;if(e){u.push(e);l=Math.min(l,e.min());
j=Math.max(j,e.max())}}for(c=0;c<u.length;++c){e=u[c];b.push(new PaddedGlyph(e,l,j))}}for(m in p)(e=p[m])&&b.push(e);q=new SubTier;u=[];d=false;p=a.dasSource.subtierMax||DEFAULT_SUBTIER_MAX;c=0;a:for(;c<b.length;++c){m=b[c];if(m.bump)d=true;if(m.bump&&(a.bumped||a.dasSource.collapseSuperGroups)){for(d=0;d<u.length;++d){e=u[d];if(e.hasSpaceFor(m)){e.add(m);continue a}}if(!(u.length>=p)){e=new SubTier;e.add(m);u.push(e)}}else q.add(m)}if(q.glyphs.length>0)u=[q].concat(u);for(d=0;d<u.length;++d){e=u[d];
e.quant&&e.glyphs.unshift(new GridGlyph(e.height))}for(d=0;d<u.length;++d){e=u[d];e.glyphs.sort(function(x,z){return(x.zindex||0)-(z.zindex||0)})}a.subtiers=u;a.glyphCacheOrigin=a.browser.viewStart}function formatQuantLabel(a){a=""+a;var b=a.indexOf(".");if(b<0)return a;else{var c=2;a.substring(0,1)=="-"&&++c;return b>=c?a.substring(0,b):a.substring(0,b+2)}}
DasTier.prototype.paint=function(){var a=this.browser.retina&&window.devicePixelRatio>1,b=this.subtiers;if(b){var c=this.browser.featurePanelWidth+2E3;if(a)c*=2;var d=this.viewport.width|0;if(d<c-50)this.viewport.width=d=c;c=MIN_PADDING;for(var e=0;e<b.length;++e)c=c+b[e].height+MIN_PADDING;c+=6;e=c;if(a)e*=2;if(e!=this.viewport.height)this.viewport.height=e;this.viewport.style.left="-1000px";this.viewport.style.width=a?""+d/2+"px":""+d+"px";this.viewport.style.height=""+c+"px";this.layoutHeight=
Math.max(c,this.browser.minTierHeight);this.holder.style.height=""+this.layoutHeight+"px";this.updateHeight();this.drawOverlay();this.norigin=this.browser.viewStart;c=this.viewport.getContext("2d");c.fillStyle=this.background;c.clearRect(0,0,d,e);c.restore();c.save();a&&c.scale(2,2);var h=(this.glyphCacheOrigin-this.browser.viewStart)*this.browser.scale+1E3;c.translate(h,MIN_PADDING);for(e=0;e<b.length;++e){for(var j=null,i=b[e].glyphs,l=0;l<i.length;++l){var m=i[l];if(m.min()<d-h&&m.max()>-h){m=
i[l];m.draw(c);if(m.quant)j=m.quant}}c.translate(0,b[e].height+MIN_PADDING)}c.restore();if(j&&this.quantLeapThreshold&&this.featureSource&&sourceAdapterIsCapable(this.featureSource,"quantLeap")){b=3+b[0].height*(1-(this.quantLeapThreshold-j.min)/(j.max-j.min));c.save();a&&c.scale(2,2);c.strokeStyle="red";c.lineWidth=0.3;c.beginPath();c.moveTo(0,b);c.lineTo(5E3,b);c.stroke();c.restore()}this.paintQuant()}};
DasTier.prototype.paintQuant=function(){if(this.quantOverlay){var a=this.browser.retina&&window.devicePixelRatio>1,b;if(this.subtiers&&this.subtiers.length>0)b=this.subtiers[0].quant;if(b){var c=this.subtiers[0].height;this.quantOverlay.height=this.viewport.height;this.quantOverlay.width=a?100:50;this.quantOverlay.style.height=""+(a?this.quantOverlay.height/2:this.quantOverlay.height)+"px";this.quantOverlay.style.width="50px";this.quantOverlay.style.display="block";var d=this.quantOverlay.getContext("2d");
a&&d.scale(2,2);d.fillStyle="white";d.globalAlpha=0.6;a=2;if(c>40)a=1+(c/20|0);var e=(c+MIN_PADDING*2)/(a-1),h=(b.max-b.min)/(a-1);if(this.browser.rulerLocation=="right"){d.fillRect(20,0,30,20);d.fillRect(20,c-20+MIN_PADDING*2,30,20);for(var j=1;j<a-1;++j)d.fillRect(20,j*e-10,30,20)}else{d.fillRect(0,0,30,20);d.fillRect(0,c-20+MIN_PADDING*2,30,20);for(j=1;j<a-1;++j)d.fillRect(0,j*e-10,30,20)}d.globalAlpha=1;d.strokeStyle="black";d.lineWidth=1;d.beginPath();if(this.browser.rulerLocation=="right"){d.moveTo(42,
MIN_PADDING);d.lineTo(50,MIN_PADDING);d.lineTo(50,c+MIN_PADDING);d.lineTo(42,c+MIN_PADDING);for(j=1;j<a-1;++j){var i=j*e;d.moveTo(50,i);d.lineTo(45,i)}}else{d.moveTo(8,MIN_PADDING);d.lineTo(0,MIN_PADDING);d.lineTo(0,c+MIN_PADDING);d.lineTo(8,c+MIN_PADDING);for(j=1;j<a-1;++j){i=j*e;d.moveTo(0,i);d.lineTo(5,i)}}d.stroke();d.fillStyle="black";if(this.browser.rulerLocation=="right"){d.textAlign="right";d.fillText(formatQuantLabel(b.max),41,8);d.fillText(formatQuantLabel(b.min),41,c+MIN_PADDING);for(j=
1;j<a-1;++j){i=j*e;d.fillText(formatQuantLabel(1*b.max-j*h),41,i+3)}}else{d.textAlign="left";d.fillText(formatQuantLabel(b.max),9,8);d.fillText(formatQuantLabel(b.min),9,c+MIN_PADDING);for(j=1;j<a-1;++j){i=j*e;d.fillText(formatQuantLabel(1*b.max-j*h),9,i+3)}}}else this.quantOverlay.style.display="none"}};
function glyphsForGroup(a,b,c,d){var e=d.styleForFeature(c),h,j=[];b=null;for(var i=0;i<a.length;++i){var l=a[i];if(l.orientation&&b==null)b=l.orientation;if(!h&&l.label)h=l.label;var m=d.styleForFeature(l);if(m)if(!l.parts)(l=glyphForFeature(l,0,m,d,null,true))&&j.push(l)}if(j.length==0)return null;a="flat";if(d.dasSource.collapseSuperGroups&&!d.bumped)if(b==="+")a="collapsed+";else{if(b==="-")a="collapsed-"}else if(b==="+")a="hat+";else if(b==="-")a="hat-";d=null;if(h||e&&(e.LABEL||e.LABELS))d=
c.label||h;c=new GroupGlyph(j,a);if(d){if(b==="+")d=">"+d;else if(b==="-")d="<"+d;c=new LabelledGlyph(c,d,false)}c.bump=true;return c}
function glyphForFeature(a,b,c,d,e,h){var j=d.browser.scale,i=d.browser.viewStart,l=c.glyph||"BOX",m=a.min,o=a.max,q=a.orientation,p=a.score,s=a.label||a.id,r=(m-i)*j,t=Math.max((o-i+1)*j,r+1),v=d.forceHeight||c.HEIGHT||e||12,u=v=1*v;i=c.BUMP&&isDasBooleanTrue(c.BUMP);var x;if(l==="CROSS"||l==="EX"||l==="TRIANGLE"||l==="DOT"||l==="SQUARE"||l==="STAR"||l==="PLIMSOLL"){var z=c.FGCOLOR||"black";m=c.BGCOLOR||"none";j=c.STROKECOLOR;if(c.BGITEM&&a.itemRgb)z=a.itemRgb;else if(isDasBooleanTrue(c.COLOR_BY_SCORE2)){o=
c.BGGRAD||c._gradient;if(!o){o=makeGradient(50,c.COLOR1,c.COLOR2,c.COLOR3);c._gradient=o}v=a.score2;if(v!=undefined||!z){v=v||0;u=c.MIN2?1*c.MIN2:0;u=(1*v-u)/((c.MAX2?1*c.MAX2:1)-u)*o.length|0;if(u<0)u=0;if(u>=o.length)u=o.length-1;z=o[u]}}v=d.forceHeight||c.HEIGHT||e||12;u=v=1*v;e=c.SIZE||v;if(c.RSIZE)e=1*c.RSIZE*v;if(c.STROKETHRESHOLD)if(e<1*c.STROKETHRESHOLD)j=null;e=1*e;v=(r+t)/2;o=e/2;if(l==="EX")l=new ExGlyph(v,e,z);else if(l==="TRIANGLE")l=new TriangleGlyph(v,e,c.DIRECTION||"N",c.LINEWIDTH||
e,z,j);else if(l==="DOT")l=new DotGlyph(v,e,z,j);else if(l==="PLIMSOLL")l=new PlimsollGlyph(v,e,0.2*e,z,j);else if(l==="SQUARE")l=new BoxGlyph(v-o,0,e,e,z,j);else if(l==="STAR"){l=5;if(c.POINTS)l=c.POINTS|0;l=new StarGlyph(v,o,l,z,j)}else l=new CrossGlyph(v,e,z);if(m&&m!="none"&&t-r>5){r=new BoxGlyph(r,0,t-r,e,m);l=new GroupGlyph([r,l])}if(isDasBooleanTrue(c.SCATTER)){m=d.quantMin(c);(z=d.quantMax(c))||(z=m<0?0:10);m||(m=0);d=(1*p-m)/(z-m);p=-1*m/(z-m);if(d<0||d>1)return null;else{if(d>=p){v=Math.max(1,
(d-p)*u);b=b+(1-p)*u-v}else b+=(1-p)*u;x={min:m,max:z};r=0;t=typeof a.forceLabel!=="undefined"?a.forceLabel:c.LABEL;if(isDasBooleanNotFalse(t)&&s&&!h){l=new LabelledGlyph(l,s,true,null,t=="above"?"above":"below");if(t=="above")r=l.textHeight+2;h=true}l=new TranslatedGlyph(l,0,b-o-r,u)}}}else if(l==="HISTOGRAM"||l==="GRADIENT"&&p!=="undefined"){m=d.quantMin(c);(z=d.quantMax(c))||(z=m<0?0:10);m||(m=0);if(1*p<1*m)p=m;if(1*p>1*z)p=z;d=(1*p-m)/(z-m);p=-1*m/(z-m);if(l==="HISTOGRAM"){if(d>=p){v=Math.max(1,
(d-p)*u);b=b+(1-p)*u-v}else{v=Math.max(1,(p-d)*u);b+=(1-p)*u}x={min:m,max:z}}z=c.FGCOLOR||null;m=c.BGCOLOR||c.COLOR1||"green";if(c.BGITEM&&a.itemRgb)m=a.itemRgb;p=c.ALPHA?1*c.ALPHA:null;if(c.BGGRAD){o=c.BGGRAD;u=d*o.length|0;if(u<0)u=0;if(u>=o.length)u=o.length-1;m=o[u]}if(c.COLOR2){o=c._gradient;if(!o){o=makeGradient(50,c.COLOR1,c.COLOR2,c.COLOR3);c._gradient=o}u=d*o.length|0;if(u<0)u=0;if(u>=o.length)u=o.length-1;m=o[u]}l=new BoxGlyph(r,b,t-r,v,m,z,p)}else if(l==="HIDDEN"){l=new PaddedGlyph(null,
r,t);h=true}else if(l==="ARROW"){d=c.FGCOLOR||"purple";b=isDasBooleanTrue(c.PARALLEL);m=isDasBooleanTrue(c.SOUTHWEST);o=isDasBooleanTrue(c.NORTHEAST);l=new ArrowGlyph(r,t,v,d,b,m,o)}else if(l==="ANCHORED_ARROW"){z=c.FGCOLOR||"none";m=c.BGCOLOR||"green";l=new AArrowGlyph(r,t,v,m,z,q);l.bump=true}else if(l==="SPAN"){z=c.FGCOLOR||"black";l=new SpanGlyph(r,t,v,z)}else if(l==="LINE"){z=c.FGCOLOR||"black";l=new LineGlyph(r,t,v,c.STYLE||"solid",q,z)}else if(l==="PRIMERS"){z=c.FGCOLOR||"black";m=c.BGCOLOR||
"red";l=new PrimersGlyph(r,t,v,m,z)}else if(l==="TEXT"){d=c.STRING||"text";m=c.FGCOLOR||"black";l=new TextGlyph(r,t,v,m,d)}else if(l==="TOOMANY"){z=c.FGCOLOR||"gray";m=c.BGCOLOR||"orange";l=new TooManyGlyph(r,t,v,m,z)}else if(l==="POINT"){v=d.forceHeight||c.HEIGHT||30;m=d.quantMin(c);z=d.quantMax(c);x=1*v/(z-m);d=(1*p-m)/(z-m);b=(p-1*m)*x|0;x={min:m,max:z};m=c.FGCOLOR||c.COLOR1||"black";if(c.COLOR2){o=c._gradient;if(!o){o=makeGradient(50,c.COLOR1,c.COLOR2,c.COLOR3);c._gradient=o}u=d*o.length|0;if(u<
0)u=0;if(u>=o.length)u=o.length-1;m=o[u]}l=new PointGlyph((r+t)/2,v-b,v,m)}else if(l==="__SEQUENCE"){l=z=a.seq;u=e=a.quals;b=isDasBooleanTrue(c.__INSERTIONS);p=[];if(a.cigar){q=parseCigar(a.cigar);u=l="";for(var H=cursor=0;H<q.length;++H){var C=q[H];if(C.op=="M"){l+=z.substr(cursor,C.cnt);u+=e.substr(cursor,C.cnt);cursor+=C.cnt}else if(C.op=="D")for(var A=0;A<C.cnt;++A){l+="-";u+="Z"}else if(C.op=="I"){var D=z.substr(cursor,C.cnt);A=new TriangleGlyph(r+l.length*j,5,"S",5,"red");if(b)A=new LabelledGlyph(A,
D,false,"center","above","7px sans-serif");A.feature={label:"Insertion: "+D,type:"insertion",method:"insertion"};p.push(A);cursor+=C.cnt}else if(C.op=="S")cursor+=C.cnt;else console.log("unknown cigop"+C.op)}}z=null;if(d.currentSequence){j=d.currentSequence.start|0;q=d.currentSequence.end|0;if(j<=o&&q>=m){e=Math.max(m,j);q=Math.min(o,q);for(z=d.currentSequence.seq.substr(e-j,q-e+1);m<e;){z="N"+z;e--}for(;o>q;){z+="N";q++}}}l=new SequenceGlyph(r,t,v,l,z,c.__SEQCOLOR,u);if(b)l=new TranslatedGlyph(l,
0,7);if(p.length>0){p.splice(0,0,l);l=new GroupGlyph(p)}}else if(l==="__INSERTION"){A=new TriangleGlyph(r,5,"S",5,"red");l=new LabelledGlyph(A,a.insertion||a.altAlleles[0],false,"left","above","7px sans-serif");if(t-r>1){m=c.BGCOLOR||c.COLOR1||"green";r=new BoxGlyph(r,5,t-r,v,m,z);l=new GroupGlyph([r,l])}}else if(l==="__NONE")return null;else{z=c.FGCOLOR||null;m=c.BGCOLOR||c.COLOR1||"green";if(c.BGITEM&&a.itemRgb)m=a.itemRgb;l=new BoxGlyph(r,0,t-r,v,m,z)}if((isDasBooleanTrue(c.LABEL)||a.forceLabel)&&
s&&!h)l=new LabelledGlyph(l,s,false);if(i)l.bump=true;l.feature=a;if(x)l.quant=x;if(c.ZINDEX)l.zindex=c.ZINDEX|0;return l}
DasTier.prototype.styleForFeature=function(a){var b=zoomForScale(this.browser.scale);if(!this.stylesheet)return null;for(var c=null,d=this.stylesheet.styles,e=0;e<d.length;++e){var h=d[e];if(!(h.zoom&&h.zoom!=b)){if(h.orientation)if(h.orientation!=a.orientation)continue;var j=h._labelRE;if(!j||!j.test){j=RegExp("^"+h.label+"$");h._labelRE=j}if(!(h.label&&!j.test(a.label))){j=h._methodRE;if(!j||!j.test){j=RegExp("^"+h.method+"$");h._methodRE=j}if(!(h.method&&!j.test(a.method))){if(h.type)if(h.type==
"default"){if(!c)c=h.style;continue}else{j=h._typeRE;if(!j||!j.test){j=RegExp("^"+h.type+"$");h._typeRE=j}if(!j.test(a.type))continue}return h.style}}}}return c};
function makeLineGlyph(a,b,c){var d=c.browser.viewStart,e=c.browser.scale,h=c.forceHeight||b.HEIGHT||30,j=c.quantMin(b);c=c.quantMax(b);for(var i=1*h/(c-j),l=b.FGCOLOR||b.COLOR1||"black",m=[],o=0;o<a.length;++o){var q=a[o],p=h-((q.score-1*j)*i|0);m.push((((q.min|0)+(q.max|0))/2-d)*e);m.push(p)}a=new LineGraphGlyph(m,l,h);a.quant={min:j,max:c};if(b.ZINDEX)a.zindex=b.ZINDEX|0;return a}
DasTier.prototype.quantMin=function(a){return this.forceMinDynamic?this.currentFeaturesMinScore||0:typeof this.forceMin==="number"?this.forceMin:a.MIN||this.currentFeaturesMinScore||0};DasTier.prototype.quantMax=function(a){return this.forceMaxDynamic?this.currentFeaturesMaxScore||0:typeof this.forceMax==="number"?this.forceMax:a.MAX||this.currentFeaturesMaxScore||0};var MIN_TILE=100,rulerTileColors=["black","white"],baseColors={A:"green",C:"blue",G:"black",T:"red"},steps=[1,2,5];
function tileSizeForScale(a,b){b||(b=MIN_TILE);for(var c=steps.length;a*steps[c%steps.length]*Math.pow(10,c/steps.length|0)<b;)++c;return steps[c%steps.length]*Math.pow(10,c/steps.length|0)}
function drawSeqTier(a,b){var c=a.browser.retina&&window.devicePixelRatio>1,d=a.browser.scale,e=a.browser.viewStart-1E3/d|0,h=a.browser.viewEnd+2E3/d,j=a.browser.currentSeqMax,i=a.browser.featurePanelWidth+2E3;if(c)i*=2;var l=a.viewport.width|0;if(l<i-50)a.viewport.width=l=i;i=50;if(b&&b.seq)i+=25;var m=i;if(c)m*=2;a.viewport.height=m;a.viewport.style.height=""+i+"px";a.viewport.style.width=c?""+l/2+"px":""+l+"px";a.holder.style.height=""+i+"px";a.layoutHeight=i;a.updateHeight();i=a.viewport.getContext("2d");
i.clearRect(0,0,l,a.viewport.height);c&&i.scale(2,2);i.translate(1E3,0);c=h;if(j>0&&j<h)c=j;l=tileSizeForScale(d);m=Math.max(0,(e/l|0)*l);for(j=a.browser.viewStart;m<=c;){i.fillStyle=m/l%2==0?"white":"black";i.strokeStyle="black";i.fillRect((m-j)*d,8,l*d,3);i.strokeRect((m-j)*d,8,l*d,3);i.fillStyle="black";i.fillText(formatLongInt(m),(m-j)*d,22);m+=l}if(b&&b.seq)for(e=e;e<=h;++e)if(e>=b.start&&e<=b.end){c=b.seq.substr(e-b.start,1).toUpperCase();(l=baseColors[c])||(l="gray");i.fillStyle=l;d>=8?i.fillText(c,
(e-j)*d,52):i.fillRect((e-j)*d,42,d,12)}a.norigin=a.browser.viewStart;a.viewport.style.left="-1000px"}
function svgSeqTier(a,b){var c=a.browser.scale,d=a.browser.viewStart-1E3/c|0,e=a.browser.viewEnd+2E3/c,h=a.browser.currentSeqMax,j=e;if(h>0&&h<e)j=h;var i=tileSizeForScale(c),l=Math.max(0,(d/i|0)*i);h=a.browser.viewStart;for(var m=makeElementNS(NS_SVG,"g",[],{fontSize:"8pt"});l<=j;){m.appendChild(makeElementNS(NS_SVG,"rect",null,{x:(l-h)*c,y:8,width:i*c,height:3,fill:l/i%2==0?"white":"black",stroke:"black"}));m.appendChild(makeElementNS(NS_SVG,"text",formatLongInt(l),{x:(l-h)*c,y:28,fill:"black",
stroke:"none"}));l+=i}if(b&&b.seq)for(d=d;d<=e;++d)if(d>=b.start&&d<=b.end){j=b.seq.substr(d-b.start,1).toUpperCase();(i=baseColors[j])||(i="gray");c>=8?m.appendChild(makeElementNS(NS_SVG,"text",j,{x:(d-h)*c,y:52,fill:i})):m.appendChild(makeElementNS(NS_SVG,"rect",null,{x:(d-h)*c,y:42,width:c,height:12,fill:i}))}return m}
function sortFeatures(a){for(var b=a.browser.drawnStart,c=a.browser.drawnEnd,d={},e={},h={},j={},i={},l={},m={},o={},q=[],p,s,r,t=function(){r={};for(var L=0;L<a.currentFeatures.length;++L){var M=a.currentFeatures[L];if(M.id)r[M.id]=M}},v=function(L){var M=[];if(L.parents)for(var S=0;S<L.parents.length;++S){var aa=L.parents[S],Z=r[aa];Z&&Z.typeCv=="SO:0000704"&&pushnew(M,aa)}return M},u=0;u<a.currentFeatures.length;++u){var x=a.currentFeatures[u];if(!x.parts){var z=x.min<=c&&x.max>=b;if(!x.min||!x.max)q.push(x);
else{if(x.score&&x.score!="."&&x.score!="-"){sc=1*x.score;if(!p||sc<p)p=sc;if(!s||sc>s)s=sc}var H=[],C=null;if(x.groups)for(var A=0;A<x.groups.length;++A){var D=x.groups[A],O=D.id;if(D.type=="gene"){C=O;l[O]=D}else if(D.type!="translation"){pusho(e,O,x);l[O]=D;H.push(O);D=j[O];if(!D||x.min<D)j[O]=x.min;D=i[O];if(!D||x.max>D)i[O]=x.max}}if(x.parents){r||t();for(A=0;A<x.parents.length;++A){var B=x.parents[A],G=r[B];if(G){if(!G.parts)G.parts=[x];pushnewo(e,B,G);pusho(e,B,x);l[B]||(l[B]={type:G.type,
id:G.id,label:G.label||G.id});H.push(B);D=j[B];if(!D||x.min<D)j[B]=x.min;D=i[B];if(!D||x.max>D)i[B]=x.max;D=v(G);if(D.length>0){C=D[0];B=r[D[0]];l[D[0]]={type:B.type,id:B.id,label:B.label||B.id};if(!a.dasSource.collapseSuperGroups)a.dasSource.collapseSuperGroups=true}}}}if(H.length==0)z&&pusho(d,x.type,x);else if(C)for(D=0;D<H.length;++D){O=H[D];pushnewo(m,C,O);o[O]=C}}}}for(O in e){q=l[O];if(typeof q.min!=="number")q.min=j[O];if(typeof q.max!=="number")q.max=i[O];if(i[O]>=b&&j[O]<=c)h[O]=e[O]}a.ungroupedFeatures=
d;a.groupedFeatures=h;a.groups=l;a.superGroups=m;a.groupsToSupers=o;if(p){if(p>0)p=0;else if(s<0)s=0;a.currentFeaturesMinScore=p;a.currentFeaturesMaxScore=s}}TAGVAL_NOTE_RE=/^([A-Za-z]+)=(.+)/;Browser.prototype.addFeatureInfoPlugin=function(a){if(!this.featureInfoPlugins)this.featureInfoPlugins=[];this.featureInfoPlugins.push(a)};
function FeatureInfo(a,b,c){var d=pick(c.type,b.type),e=pick(c.label,b.label,c.id,b.id);if(e&&e.indexOf("__dazzle")!=0)d=d+": "+e;this.hit=a;this.feature=b;this.group=c;this.title=d;this.sections=[]}FeatureInfo.prototype.setTitle=function(a){this.title=a};FeatureInfo.prototype.add=function(a,b){if(typeof b==="string")b=makeElement("span",b);this.sections.push({label:a,info:b})};
Browser.prototype.featurePopup=function(a,b,c,d){b=c.length;var e=--b>=0?c[b]:{},h=--b>=0?c[b]:{};c=new FeatureInfo(c,e,h);c.tier=d;b=this.featureInfoPlugins||[];for(fipi=0;fipi<b.length;++fipi)try{b[fipi](e,c)}catch(j){console.log(j.stack||j)}b=d.featureInfoPlugins||[];for(fipi=0;fipi<b.length;++fipi)try{b[fipi](e,c)}catch(i){console.log(i.stack||i)}this.removeAllPopups();d=makeElement("table",null,{className:"table table-striped table-condensed"});d.style.width="100%";d.style.margin="0px";b=0;if(e.method){var l=
makeElement("tr",[makeElement("th","Method"),makeElement("td",e.method)]);d.appendChild(l);++b}l=h.segment?h:e;l=makeElement("tr",[makeElement("th","Location"),makeElement("td",l.segment+":"+l.min+"-"+l.max)]);l.style.backgroundColor=this.tierBackgroundColors[b%this.tierBackgroundColors.length];d.appendChild(l);++b;if(e.score!==undefined&&e.score!==null&&e.score!="-"){l=makeElement("tr",[makeElement("th","Score"),makeElement("td",""+e.score)]);d.appendChild(l);++b}if((l=maybeConcat(h.links,e.links))&&
l.length>0){l=makeElement("tr",[makeElement("th","Links"),makeElement("td",l.map(function(q){return makeElement("div",makeElement("a",q.desc,{href:q.uri,target:"_new"}))}))]);d.appendChild(l);++b}e=maybeConcat(h.notes,e.notes);for(h=0;h<e.length;++h){l="Note";var m=e[h],o=m.match(TAGVAL_NOTE_RE);if(o){l=o[1];m=o[2]}l=makeElement("tr",[makeElement("th",l),makeElement("td",m)]);d.appendChild(l);++b}for(b=0;b<c.sections.length;++b){e=c.sections[b];d.appendChild(makeElement("tr",[makeElement("th",e.label),
makeElement("td",e.info)]))}this.popit(a,c.title||"Feature",d,{width:400})};function Karyoscape(a,b){this.browser=a;this.dsn=b;this.svg=makeElementNS(NS_SVG,"g");this.width=250}Karyoscape.prototype.update=function(a,b,c){this.start=b;this.end=c;if(!this.chr||a!=this.chr){this.chr=a;removeChildren(this.svg);var d=this;this.dsn.features(new DASSegment(a),{type:"karyotype"},function(e,h,j){d.chrLen=j&&j[a]&&j[a].max?j[a].max:null;d.karyos=e||[];d.redraw()})}else this.setThumb()};
var karyo_palette={gneg:"white",gpos25:"rgb(200,200,200)",gpos33:"rgb(180,180,180)",gpos50:"rgb(128,128,128)",gpos66:"rgb(100,100,100)",gpos75:"rgb(64,64,64)",gpos100:"rgb(0,0,0)",gpos:"rgb(0,0,0)",gvar:"rgb(100,100,100)",acen:"rgb(100,100,100)",stalk:"rgb(100,100,100)"};
Karyoscape.prototype.redraw=function(){removeChildren(this.svg);this.karyos=this.karyos.sort(function(q,p){return(q.min|0)-(p.min|0)});if(this.karyos.length>0){if(!this.chrLen)this.chrLen=this.karyos[this.karyos.length-1].max}else{if(!this.chrLen){alert("Warning: insufficient data to set up spatial navigator");this.chrLen=2E8}this.karyos.push({min:1,max:this.chrLen,label:"gneg"})}for(var a=null,b=0;b<this.karyos.length;++b){var c=this.karyos[b],d=1*c.min/this.chrLen*this.width,e=1*c.max/this.chrLen*
this.width,h=karyo_palette[c.label];if(h)if(e>d){d=makeElementNS(NS_SVG,"rect",null,{x:d,y:c.label=="stalk"||c.label=="acen"?5:0,width:e-d,height:c.label=="stalk"||c.label=="acen"?5:15,stroke:"none",fill:h});if(c.label.substring(0,1)=="g"){e=new Range(c.min,c.max);a=a==null?e:union(a,e)}this.browser.makeTooltip(d,c.id);this.svg.appendChild(d)}}if(a){a=a.ranges();b="M 0 10 L 0 0";c="M 0 5 L 0 15";for(var j=h=0;j<a.length;++j){e=a[j];d=1*e.min()/this.chrLen*this.width;e=1*e.max()/this.chrLen*this.width;
if(d-h>0.75){b+=" M "+d+" 0";c+=" M "+d+" 15"}b+=" L "+e+" 0";c+=" L "+e+" 15";h=e}if(this.width-h>0.75){b+=" M "+this.width+" 0";c+=" M "+this.width+" 15"}else{b+=" L "+this.width+" 0";c+=" L "+this.width+" 15"}b+=" L "+this.width+" 10";c+=" L "+this.width+" 5";this.svg.appendChild(makeElementNS(NS_SVG,"path",null,{d:b+" "+c,stroke:"black",strokeWidth:2,fill:"none"}))}this.thumb=makeElementNS(NS_SVG,"rect",null,{x:50,y:-5,width:8,height:25,fill:"blue",fillOpacity:0.5,stroke:"none"});this.svg.appendChild(this.thumb);
this.setThumb();var i=this,l,m=function(q){q.stopPropagation();q.preventDefault();i.thumb.setAttribute("x",Math.max(-4,Math.min(q.clientX+l,i.width-4)))},o=function(q){q.stopPropagation();q.preventDefault();i.onchange&&i.onchange(1*((i.thumb.getAttribute("x")|0)+4)/i.width,true);document.removeEventListener("mousemove",m,true);document.removeEventListener("mouseup",o,true)};this.thumb.addEventListener("mousedown",function(q){q.stopPropagation();q.preventDefault();l=i.thumb.getAttribute("x")-q.clientX;
document.addEventListener("mousemove",m,true);document.addEventListener("mouseup",o,true)},false)};Karyoscape.prototype.setThumb=function(){var a=1*(((this.start|0)+(this.end|0))/2)/this.chrLen*this.width;this.thumb&&this.thumb.setAttribute("x",a-4)};function FetchPool(){this.reqs=[];this.awaitedFeatures={}}FetchPool.prototype.addRequest=function(a){this.reqs.push(a)};FetchPool.prototype.abortAll=function(){for(var a=0;a<this.reqs.length;++a)this.reqs[a].abort()};
function KSCacheBaton(a,b,c,d,e,h){this.chr=a;this.min=b;this.max=c;this.scale=d;this.features=e||[];this.status=h}KSCacheBaton.prototype.toString=function(){return this.chr+":"+this.min+".."+this.max+";scale="+this.scale};function KnownSpace(a,b,c,d,e,h){this.tierMap=a;this.chr=b;this.min=c;this.max=d;this.scale=e;this.seqSource=h||new DummySequenceSource;this.viewCount=0;this.featureCache={};this.latestViews={}}
KnownSpace.prototype.bestCacheOverlapping=function(){var a=this.featureCache[this.tierMap[0]];return a?a:null};KnownSpace.prototype.viewFeatures=function(a,b,c,d){if(d!=d)throw"viewFeatures called with silly scale";if(a!=this.chr)throw"Can't extend Known Space to a new chromosome";if(b<1)b=1;this.min=b;this.max=c;this.scale=d;this.pool&&this.pool.abortAll();this.pool=new FetchPool;this.awaitedSeq=new Awaited;this.seqWasFetched=false;this.viewCount++;this.startFetchesForTiers(this.tierMap)};
function filterFeatures(a,b,c){var d=[];featuresByGroup={};for(var e=0;e<a.length;++e){var h=a[e];if(!h.min||!h.max)d.push(h);else if(h.groups&&h.groups.length>0)pusho(featuresByGroup,h.groups[0].id,h);else h.min<=c&&h.max>=b&&d.push(h)}for(var j in featuresByGroup){a=featuresByGroup[j];var i=1E11,l=-100000000000;for(e=0;e<a.length;++e){h=a[e];i=Math.min(i,h.min);l=Math.max(l,h.max)}if(i<=c||l>=b)for(e=0;e<a.length;++e)d.push(a[e])}return d}
KnownSpace.prototype.invalidate=function(a){if(this.pool){this.featureCache[a]=null;this.startFetchesForTiers([a])}};
KnownSpace.prototype.startFetchesForTiers=function(a){for(var b=this,c=this.awaitedSeq,d=false,e,h=0;h<a.length;++h)try{if(this.startFetchesFor(a[h],c))d=true}catch(j){a[h].updateStatus(j);console.log("Error fetching tier source");console.log(j);e=j}if(d&&!this.seqWasFetched){this.seqWasFetched=true;var i=this.min,l=this.max;if(this.cs)if(this.cs.start<=i&&this.cs.end>=l){a=this.cs.start==i&&this.cs.end==l?this.cs:new DASSequence(this.cs.name,i,l,this.cs.alphabet,this.cs.seq.substring(i-this.cs.start,
l+1-this.cs.start));return c.provide(a)}this.seqSource.fetch(this.chr,i,l,this.pool,function(m,o){if(o){if(!b.cs||i<=b.cs.start&&l>=b.cs.end||i>=b.cs.end||l<=b.cs.start||l-i>b.cs.end-b.cs.start)b.cs=o;c.provide(o)}else{dlog("Noseq: "+miniJSONify(m));c.provide(null)}})}if(e)throw e;};
KnownSpace.prototype.startFetchesFor=function(a,b){var c=this,d=this.viewCount,e=a.getSource()||new DummyFeatureSource,h=a.needsSequence(this.scale),j=c.featureCache[a],i=a.getDesiredTypes(this.scale);if(i===undefined)return false;if(j&&j.chr===this.chr&&j.min<=this.min&&j.max>=this.max){var l=j.features;if(j.min<this.min||j.max>this.max)l=filterFeatures(l,this.min,this.max);c.provision(a,j.chr,Math.max(j.min,this.min),Math.min(j.max,this.max),j.scale,i,l,j.status,h?b:null);l=e.getScales();if(j.scale<=
this.scale||!l)return h}e.instrument&&console.log("Starting  fetch "+d+" ("+this.min+", "+this.max+")");e.fetch(this.chr,this.min,this.max,this.scale,i,this.pool,function(m,o,q){e.instrument&&console.log("Finishing fetch "+d);if(!((c.latestViews[a]||-1)>d)){if(!j||c.min<j.min||c.max>j.max)c.featureCache[a]=new KSCacheBaton(c.chr,c.min,c.max,q,o,m);c.latestViews[a]=d;c.provision(a,c.chr,c.min,c.max,q,i,o,m,h?b:null)}});return h};
KnownSpace.prototype.provision=function(a,b,c,d,e,h,j,i,l){a.updateStatus(i);if(!i){i=false;for(var m=a.getSource();MappedFeatureSource.prototype.isPrototypeOf(m)||CachingFeatureSource.prototype.isPrototypeOf(m)||OverlayFeatureSource.prototype.isPrototypeOf(m);)m=OverlayFeatureSource.prototype.isPrototypeOf(m)?m.sources[0]:m.source;if(BWGFeatureSource.prototype.isPrototypeOf(m)||BAMFeatureSource.prototype.isPrototypeOf(m))i=true;if(!m.opts||!m.opts.forceReduction&&!m.opts.noDownsample)if(e<this.scale/
2&&j.length>200||i&&h&&h.length==1&&h.indexOf("density")>=0)j=downsample(j,this.scale);l?l.await(function(o){a.viewFeatures(b,c,d,e,j,o)}):a.viewFeatures(b,c,d,e,j)}};var __DS_SCALES=[1,2,5];function ds_scale(a){return __DS_SCALES[a%__DS_SCALES.length]*Math.pow(10,a/__DS_SCALES.length|0)}function DSBin(a,b,c){this.scale=a;this.cnt=this.tot=0;this.hasScore=false;this.min=b;this.max=c;this.lap=0;this.covered=null}
DSBin.prototype.score=function(){return this.cnt==0?0:this.hasScore?this.tot/this.cnt:this.lap/coverage(this.covered)};DSBin.prototype.feature=function(a){if(a.score!=undefined){this.tot+=a.score;this.hasScore=true}var b=a.max|0;a=Math.max(this.min,a.min|0);b=Math.min(this.max,b);this.lap+=1*(b-a+1);++this.cnt;b=new Range(a,b);this.covered=this.covered?union(this.covered,b):b};
function downsample(a,b){for(var c=0;ds_scale(c+1)<b;)++c;c=ds_scale(c);for(var d=[],e=-10000000000,h=1E10,j=0;j<a.length;++j){var i=a[j];if(i.groups&&i.groups.length>0)return a;var l=i.min/c|0,m=i.max/c|0;e=Math.max(e,m);h=Math.min(h,l);for(l=l;l<=m;++l){var o=d[l];if(!o){o=new DSBin(c,l*c,(l+1)*c-1);d[l]=o}o.feature(i)}}j=[];for(l=h;l<=e;++l)if(o=d[l]){i=new DASFeature;i.segment=a[0].segment;i.min=l*c+1;i.max=(l+1)*c;i.score=o.score();i.type="density";j.push(i)}return j}var hexcase=0,b64pad="";
function hex_sha1(a){return rstr2hex(rstr_sha1(str2rstr_utf8(a)))}function b64_sha1(a){return rstr2b64(rstr_sha1(str2rstr_utf8(a)))}function any_sha1(a,b){return rstr2any(rstr_sha1(str2rstr_utf8(a)),b)}function hex_hmac_sha1(a,b){return rstr2hex(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(b)))}function b64_hmac_sha1(a,b){return rstr2b64(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(b)))}function any_hmac_sha1(a,b,c){return rstr2any(rstr_hmac_sha1(str2rstr_utf8(a),str2rstr_utf8(b)),c)}
function sha1_vm_test(){return hex_sha1("abc").toLowerCase()=="a9993e364706816aba3e25717850c26c9cd0d89d"}function rstr_sha1(a){return binb2rstr(binb_sha1(rstr2binb(a),a.length*8))}function rstr_hmac_sha1(a,b){var c=rstr2binb(a);if(c.length>16)c=binb_sha1(c,a.length*8);for(var d=Array(16),e=Array(16),h=0;h<16;h++){d[h]=c[h]^909522486;e[h]=c[h]^1549556828}c=binb_sha1(d.concat(rstr2binb(b)),512+b.length*8);return binb2rstr(binb_sha1(e.concat(c),672))}
function rstr2hex(a){for(var b=hexcase?"0123456789ABCDEF":"0123456789abcdef",c="",d,e=0;e<a.length;e++){d=a.charCodeAt(e);c+=b.charAt(d>>>4&15)+b.charAt(d&15)}return c}function rstr2b64(a){for(var b="",c=a.length,d=0;d<c;d+=3)for(var e=a.charCodeAt(d)<<16|(d+1<c?a.charCodeAt(d+1)<<8:0)|(d+2<c?a.charCodeAt(d+2):0),h=0;h<4;h++)b+=d*8+h*6>a.length*8?b64pad:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>>6*(3-h)&63);return b}
function rstr2any(a,b){var c=b.length,d=[],e,h,j,i,l=Array(Math.ceil(a.length/2));for(e=0;e<l.length;e++)l[e]=a.charCodeAt(e*2)<<8|a.charCodeAt(e*2+1);for(;l.length>0;){i=[];for(e=j=0;e<l.length;e++){j=(j<<16)+l[e];h=Math.floor(j/c);j-=h*c;if(i.length>0||h>0)i[i.length]=h}d[d.length]=j;l=i}c="";for(e=d.length-1;e>=0;e--)c+=b.charAt(d[e]);d=Math.ceil(a.length*8/(Math.log(b.length)/Math.log(2)));for(e=c.length;e<d;e++)c=b[0]+c;return c}
function str2rstr_utf8(a){for(var b="",c=-1,d,e;++c<a.length;){d=a.charCodeAt(c);e=c+1<a.length?a.charCodeAt(c+1):0;if(55296<=d&&d<=56319&&56320<=e&&e<=57343){d=65536+((d&1023)<<10)+(e&1023);c++}if(d<=127)b+=String.fromCharCode(d);else if(d<=2047)b+=String.fromCharCode(192|d>>>6&31,128|d&63);else if(d<=65535)b+=String.fromCharCode(224|d>>>12&15,128|d>>>6&63,128|d&63);else if(d<=2097151)b+=String.fromCharCode(240|d>>>18&7,128|d>>>12&63,128|d>>>6&63,128|d&63)}return b}
function str2rstr_utf16le(a){for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a.charCodeAt(c)&255,a.charCodeAt(c)>>>8&255);return b}function str2rstr_utf16be(a){for(var b="",c=0;c<a.length;c++)b+=String.fromCharCode(a.charCodeAt(c)>>>8&255,a.charCodeAt(c)&255);return b}function rstr2binb(a){for(var b=Array(a.length>>2),c=0;c<b.length;c++)b[c]=0;for(c=0;c<a.length*8;c+=8)b[c>>5]|=(a.charCodeAt(c/8)&255)<<24-c%32;return b}
function binb2rstr(a){for(var b="",c=0;c<a.length*32;c+=8)b+=String.fromCharCode(a[c>>5]>>>24-c%32&255);return b}
function binb_sha1(a,b){a[b>>5]|=128<<24-b%32;a[(b+64>>9<<4)+15]=b;for(var c=Array(80),d=1732584193,e=-271733879,h=-1732584194,j=271733878,i=-1009589776,l=0;l<a.length;l+=16){for(var m=d,o=e,q=h,p=j,s=i,r=0;r<80;r++){c[r]=r<16?a[l+r]:bit_rol(c[r-3]^c[r-8]^c[r-14]^c[r-16],1);var t=safe_add(safe_add(bit_rol(d,5),sha1_ft(r,e,h,j)),safe_add(safe_add(i,c[r]),sha1_kt(r)));i=j;j=h;h=bit_rol(e,30);e=d;d=t}d=safe_add(d,m);e=safe_add(e,o);h=safe_add(h,q);j=safe_add(j,p);i=safe_add(i,s)}return Array(d,e,h,j,
i)}function sha1_ft(a,b,c,d){if(a<20)return b&c|~b&d;if(a<40)return b^c^d;if(a<60)return b&c|b&d|c&d;return b^c^d}function sha1_kt(a){return a<20?1518500249:a<40?1859775393:a<60?-1894007588:-899497514}function safe_add(a,b){var c=(a&65535)+(b&65535);return(a>>16)+(b>>16)+(c>>16)<<16|c&65535}function bit_rol(a,b){return a<<b|a>>>32-b}
Browser.prototype.openExportPanel=function(){var a=this;if(this.uiMode==="export"){this.hideToolPanel();this.setUiMode("none")}else{var b=makeElement("div",null,{className:"tier-edit"},{display:"flex",justifyContent:"space-between",paddingTop:"3px",paddingBottom:"3px",borderTop:"1px solid black",borderBottom:"1px solid black"});b.appendChild(makeElement("p","Export current view as SVG"));var c=makeElement("input",null,{type:"checkbox",checked:this.exportHighlights});c.addEventListener("change",function(){a.exportHighlights=
c.checked;a.storeStatus()},false);var d=makeElement("input",null,{type:"checkbox",checked:this.exportRuler});d.addEventListener("change",function(){a.exportRuler=d.checked;a.storeStatus()},false);var e=makeElement("button","Export",{className:"btn btn-primary"});e.addEventListener("click",function(){removeChildren(h);var i=URL.createObjectURL(a.makeSVG({highlights:c.checked,ruler:d.checked?a.rulerLocation:"none"})),l=makeElement("a","[Download]",{href:i,download:"dalliance-view.svg",type:"image/svg+xml"});
i=makeElement("a","[Preview in browser]",{href:i,type:"image/svg+xml",target:"_new"});h.appendChild(makeElement("p",["SVG created: ",l,i]))},false);a.addViewListener(function(){removeChildren(h)});a.addTierListener(function(){removeChildren(h)});var h=makeElement("p",""),j=makeElement("table",[makeElement("tr",[makeElement("th","Include highlights",{},{width:"200px",textAlign:"right"}),makeElement("td",c)]),makeElement("tr",[makeElement("th","Include vertical guideline"),makeElement("td",d)])]);b.appendChild(j);
b.appendChild(e);b.appendChild(h);this.uiMode!=="none"&&this.hideToolPanel();this.browserHolder.insertBefore(b,this.svgHolder);this.activeToolPanel=b;this.setUiMode("export")}};
Browser.prototype.makeSVG=function(a){a=a||{};var b=document.implementation.createDocument(NS_SVG,"svg",null),c=makeElementNS(NS_SVG,"g",null,{fontFamily:"helvetica",fontSize:"8pt"});b.documentElement.appendChild(c);var d=makeElementNS(NS_SVG,"a",makeElementNS(NS_SVG,"text","Graphics from Dalliance "+VERSION,{x:(this.featurePanelWidth+200+20)/2,y:30,strokeWidth:0,fill:"black",fontSize:"12pt",textAnchor:"middle",fill:"blue"}));d.setAttribute("xmlns:xlink",NS_XLINK);d.setAttribute("xlink:href","http://www.biodalliance.org/");
c.appendChild(d);d=makeElementNS(NS_SVG,"rect",null,{x:200,y:50,width:this.featurePanelWidth,height:1E5});d=makeElementNS(NS_SVG,"clipPath",d,{id:"featureClip"});c.appendChild(d);d=70;for(var e=makeElementNS(NS_SVG,"g",null,{}),h=0;h<this.tiers.length;++h){var j=this.tiers[h],i=makeElementNS(NS_SVG,"g",null,{clipPath:"url(#featureClip)",clipRule:"nonzero"}),l=makeElementNS(NS_SVG,"g"),m=d,o=makeElementNS(NS_SVG,"rect",null,{x:0,y:m,width:"10000",height:50,fill:j.background});i.appendChild(o);if(j.dasSource.tier_type===
"sequence"){var q=svgSeqTier(j,j.currentSequence);i.appendChild(makeElementNS(NS_SVG,"g",q,{transform:"translate(200, "+d+")"}));d+=80}else{if(!j.subtiers)continue;q=(j.glyphCacheOrigin-this.viewStart)*this.scale;for(var p=false,s=0;s<j.subtiers.length;++s){for(var r=j.subtiers[s],t=[],v=0;v<r.glyphs.length;++v)t.push(r.glyphs[v].toSVG());i.appendChild(makeElementNS(NS_SVG,"g",t,{transform:"translate("+(200+q)+", "+d+")"}));if(r.quant){p=true;t=r.quant;var u=r.height;v=2;if(u>40)v=1+(u/20|0);u=u/
(v-1);var x=(t.max-t.min)/(v-1),z=new SVGPath;z.moveTo(205,d);z.lineTo(200,d);z.lineTo(200,d+r.height);z.lineTo(205,d+r.height);for(var H=1;H<v-1;++H){var C=H*u;z.moveTo(200,d+C);z.lineTo(203,d+C)}l.appendChild(makeElementNS(NS_SVG,"path",null,{d:z.toPathData(),fill:"none",stroke:"black",strokeWidth:"2px"}));l.appendChild(makeElementNS(NS_SVG,"text",formatQuantLabel(t.max),{x:197,y:d+7,textAnchor:"end"}));l.appendChild(makeElementNS(NS_SVG,"text",formatQuantLabel(t.min),{x:197,y:d+r.height,textAnchor:"end"}));
for(H=1;H<v-1;++H){C=H*u;l.appendChild(makeElementNS(NS_SVG,"text",formatQuantLabel(1*t.max-H*x),{x:197,y:d+C+3,textAnchor:"end"}))}}d+=r.height+3}d+=10}l.appendChild(makeElementNS(NS_SVG,"text",typeof j.config.name==="string"?j.config.name:j.dasSource.name,{x:200-(p?20:12),y:(d+m+5)/2,fontSize:"12pt",textAnchor:"end"}));o.setAttribute("height",d-m);e.appendChild(makeElementNS(NS_SVG,"g",[i,l]))}if(a.highlights){p=this.highlights||[];for(h=0;h<p.length;++h){u=p[h];if((u.chr==this.chr||u.chr=="chr"+
this.chr)&&u.min<this.viewEnd&&u.max>this.viewStart){j=(Math.max(u.min,this.viewStart)-this.viewStart)*this.scale;e.appendChild(makeElementNS(NS_SVG,"rect",null,{x:200+j,y:70,width:(Math.min(u.max,this.viewEnd)-this.viewStart)*this.scale-j,height:d-70,stroke:"none",fill:this.defaultHighlightFill,fillOpacity:this.defaultHighlightAlpha}))}}}p=-1;if(a.ruler=="center")p=200+(this.viewEnd-this.viewStart+1)*this.scale/2;else if(a.ruler=="left")p=200;else if(a.ruler=="right")p=200+(this.viewEnd-this.viewStart+
1)*this.scale;p>=0&&e.appendChild(makeElementNS(NS_SVG,"line",null,{x1:p,y1:70,x2:p,y2:d,stroke:"blue"}));c.appendChild(e);b.documentElement.setAttribute("width",this.featurePanelWidth+20+200);b.documentElement.setAttribute("height",d+50);return new Blob([(new XMLSerializer).serializeToString(b)],{type:"image/svg+xml"})};function Range(a,b){if(typeof a!="number"||typeof b!="number")throw"Bad range "+a+","+b;this._min=a;this._max=b}Range.prototype.min=function(){return this._min};
Range.prototype.max=function(){return this._max};Range.prototype.contains=function(a){return a>=this._min&&a<=this._max};Range.prototype.isContiguous=function(){return true};Range.prototype.ranges=function(){return[this]};Range.prototype.toString=function(){return"["+this._min+"-"+this._max+"]"};function _Compound(a){this._ranges=a}_Compound.prototype.min=function(){return this._ranges[0].min()};_Compound.prototype.max=function(){return this._ranges[this._ranges.length-1].max()};
_Compound.prototype.contains=function(a){for(var b=0;b<this._ranges.length;++b)if(this._ranges[b].contains(a))return true;return false};_Compound.prototype.isContiguous=function(){return this._ranges.length>1};_Compound.prototype.ranges=function(){return this._ranges};_Compound.prototype.toString=function(){for(var a="",b=0;b<this._ranges.length;++b){if(b>0)a+=",";a+=this._ranges[b].toString()}return a};
function union(a,b){for(var c=a.ranges().concat(b.ranges()).sort(rangeOrder),d=[],e=c[0],h=1;h<c.length;++h){var j=c[h];if(j.min()>e.max()+1){d.push(e);e=j}else if(j.max()>e.max())e=new Range(e.min(),j.max())}d.push(e);return d.length==1?d[0]:new _Compound(d)}
function intersection(a,b){for(var c=a.ranges(),d=b.ranges(),e=c.length,h=d.length,j=0,i=0,l=[];j<e&&i<h;){a=c[j];b=d[i];var m=Math.max(a.min(),b.min()),o=Math.min(a.max(),b.max());o>=m&&l.push(new Range(m,o));if(a.max()>b.max())++i;else++j}return l.length==0?null:l.length==1?l[0]:new _Compound(l)}function coverage(a){var b=0;a=a.ranges();for(var c=0;c<a.length;++c){var d=a[c];b+=d.max()-d.min()+1}return b}
function rangeOrder(a,b){return a.min()<b.min()?-1:a.min()>b.min()?1:a.max()<b.max()?-1:b.max()>a.max()?1:0}var THUB_STANZA_REGEXP=/\n\s*\n/,THUB_PARSE_REGEXP=/(\w+) +(.+)\n?/,THUB_SUBGROUP_REGEXP=/subGroup[1-9]/,THUB_PENNANT_PREFIX="http://genome.ucsc.edu/images/";function TrackHub(a){this.genomes={};this.url=a}function TrackHubTrack(){}TrackHubTrack.prototype.get=function(a){if(this[a])return this[a];else if(this._parent)return this._parent.get(a)};function TrackHubDB(a){this.hub=a}
TrackHubDB.prototype.getTracks=function(a){var b=this;if(this._tracks)return a(this._tracks);textXHR(this.absURL,function(c,d){if(d)return a(null,d);c=c.replace("\\\n"," ");var e=[],h={};stanzas=c.split(THUB_STANZA_REGEXP);for(var j=0;j<stanzas.length;++j){var i=stanzas[j].replace(/\#.*/g,"").split(THUB_PARSE_REGEXP),l=new TrackHubTrack;l._db=b;for(var m=0;m<i.length-2;m+=3){var o=i[m+1],q=i[m+2];if(o.match(THUB_SUBGROUP_REGEXP)){if(!l.subgroups)l.subgroups={};o=q.split(/\s/);q=o[0];for(var p={name:o[1],
tags:[],titles:[]},s=2;s<o.length;++s){var r=o[s].split(/=/);p.tags.push(r[0]);p.titles.push(r[1])}l.subgroups[q]=p}else if(o==="subGroups"){o=q.split(/(\w+)=(\w+)/);l.sgm={};for(s=0;s<o.length-2;s+=3)l.sgm[o[s+1]]=o[s+2]}else l[i[m+1]]=i[m+2]}if(l.track&&(l.type||l.container||l.view)){e.push(l);h[l.track]=l}}j=[];i=[];for(o=0;o<e.length;++o){l=e[o];m=true;if(l.parent){ptoks=l.parent.split(/\s+/);if(q=h[ptoks[0]]){l._parent=q;if(!q.children)q.children=[];q.children.push(l);if(q)m=false}}if(l.compositeTrack)i.push(l);
else m&&j.push(l)}for(e=0;e<i.length;++e){h=i[e];if(h.children){l=false;for(m=0;m<h.children.length;++m){o=h.children[m];if(o.view){o.shortLabel=h.shortLabel+": "+o.shortLabel;j.push(o);l=true}}l||j.push(h)}}b._tracks=j;return a(b._tracks,null)},{credentials:this.credentials,salt:true})};
function connectTrackHub(a,b,c){c=c||{};c.salt=true;textXHR(a,function(d,e){if(e)return b(null,e);var h=d.split(THUB_PARSE_REGEXP),j=new TrackHub(a);if(c.credentials)j.credentials=c.credentials;for(var i=0;i<h.length-2;i+=3)j[h[i+1]]=h[i+2];if(j.genomesFile){var l=relativeURL(a,j.genomesFile);textXHR(l,function(m,o){if(o)return b(null,o);stanzas=m.split(THUB_STANZA_REGEXP);for(var q=0;q<stanzas.length;++q){var p=stanzas[q].split(THUB_PARSE_REGEXP),s=new TrackHubDB(j);if(c.credentials)s.credentials=
c.credentials;for(var r=0;r<p.length-2;r+=3)s[p[r+1]]=p[r+2];if(s.twoBitPath)s.twoBitPath=relativeURL(l,s.twoBitPath);if(s.genome&&s.trackDb){s.absURL=relativeURL(l,s.trackDb);j.genomes[s.genome]=s}}b(j)},c)}else b(null,"No genomesFile")},c)}
TrackHubTrack.prototype.toDallianceSource=function(){var a={name:this.shortLabel,desc:this.longLabel};if(this._db.mapping)a.mapping=this._db.mapping;var b=this.get("pennantIcon");if(b){b=b.split(/\s+/);a.pennant=THUB_PENNANT_PREFIX+b[0]}if(b=this.get("searchTrix"))a.trixURI=relativeURL(this._db.absURL,b);if(this.container=="multiWig"){a.merge="concat";a.overlay=[];b=this.children||[];a.style=[];a.noDownsample=true;for(var c=0;c<b.length;++c){var d=b[c],e=d.toDallianceSource();a.overlay.push(e);if(e.style)for(var h=
0;h<e.style.length;++h){var j=e.style[h];j.method=d.shortLabel;if(this.aggregate=="transparentOverlay")j.style.ALPHA=0.5;a.style.push(j)}}return a}else{typeToks=this.type.split(/\s+/);if(typeToks[0]=="bigBed"){b=typeToks[1]|0;c=typeToks[2]=="+";a.bwgURI=relativeURL(this._db.absURL,this.bigDataUrl);a.style=this.bigbedStyles();if(this._db.credentials)a.credentials=true;if(b>=12&&c)a.collapseSuperGroups=true;return a}else if(typeToks[0]=="bigWig"){a.bwgURI=relativeURL(this._db.absURL,this.bigDataUrl);
a.style=this.bigwigStyles();a.noDownsample=true;if(this.yLineOnOff&&this.yLineOnOff=="on")a.quantLeapThreshold=this.yLineMark!==undefined?1*this.yLineMark:0;if(this._db.credentials)a.credentials=true;return a}else if(typeToks[0]=="bam"){a.bamURI=relativeURL(this._db.absURL,this.bigDataUrl);if(this._db.credentials)a.credentials=true;return a}else console.log("Unsupported "+this.type)}};
TrackHubTrack.prototype.bigwigStyles=function(){var a,b;if(typeToks.length>=3){a=1*typeToks[1];b=1*typeToks[2]}var c;if(this.maxHeightPixels){var d=this.maxHeightPixels.split(/:/);if(d.length==3)c=d[1]|0;else console.log("maxHeightPixels should be of the form max:default:min")}d="bars";if(this.graphTypeDefault)d=this.graphTypeDefault;var e="black",h=null;if(this.color)e="rgb("+this.color+")";if(this.altColor)h="rgb("+this.altColor+")";var j=new DASStylesheet,i=new DASStyle;i.glyph=d=="points"?"POINT":
"HISTOGRAM";if(h){i.COLOR1=e;i.COLOR2=h}else i.BGCOLOR=e;i.HEIGHT=c||30;if(a||b){i.MIN=a;i.MAX=b}j.pushStyle({type:"default"},null,i);return j.styles};
TrackHubTrack.prototype.bigbedStyles=function(){var a=(""+this.get("itemRgb")).toLowerCase()=="on",b=this.get("visibility")||"full",c=this.get("color");c=c?"rgb("+c+")":"blue";var d=new DASStylesheet,e=new DASStyle;e.glyph="BOX";e.FGCOLOR="black";e.BGCOLOR=c;e.HEIGHT=b=="full"||b=="pack"?12:8;e.BUMP=b=="full"||b=="pack";e.LABEL=b=="full"||b=="pack";e.ZINDEX=20;if(a)e.BGITEM=true;if(b=this.get("colorByStrand")){b=b.split(/\s+/);c=shallowCopy(e);c.BGCOLOR="rgb("+b[0]+")";d.pushStyle({type:"bigwig",
orientation:"+"},null,c);e=shallowCopy(e);e.BGCOLOR="rgb("+b[1]+")";d.pushStyle({type:"bigwig",orientation:"-"},null,e)}else d.pushStyle({type:"bigwig"},null,e);e=new DASStyle;e.glyph="BOX";e.FGCOLOR="black";if(a)e.BGITEM=true;e.BGCOLOR="red";e.HEIGHT=10;e.BUMP=true;e.ZINDEX=20;d.pushStyle({type:"bb-translation"},null,e);a=new DASStyle;a.glyph="BOX";a.FGCOLOR="black";a.BGCOLOR="white";a.HEIGHT=10;a.ZINDEX=10;a.BUMP=true;a.LABEL=true;d.pushStyle({type:"bb-transcript"},null,a);return d.styles};
function THUB_COMPARE(a,b){return a.priority&&b.priority?1*a.priority-1*b.priority:a.priority?1:b.priority?-1:a.shortLabel.localeCompare(b.shortLabel)}var __tier_idSeed=0;
function DasTier(a,b,c,d,e,h,j,i,l){this.config=l||{};this.id="tier"+ ++__tier_idSeed;this.browser=a;this.dasSource=new DASSource(b);this.viewport=c;this.holder=d;this.overlay=e;this.placard=h;this.placardContent=j;this.req=null;this.layoutHeight=25;this.bumped=true;this.notifier=i;this.styleIdSeed=0;if(b.quantLeapThreshold)this.quantLeapThreshold=b.quantLeapThreshold;if(this.dasSource.collapseSuperGroups)this.bumped=false;this.y=0;this.layoutWasDone=false;b.featureInfoPlugin&&this.addFeatureInfoPlugin(b.featureInfoPlugin);
this.initSources();var m=this;this.featureSource&&this.featureSource.getDefaultFIPs&&this.featureSource.getDefaultFIPs(function(o){o&&m.addFeatureInfoPlugin(o)});this.featureSource&&this.featureSource.addReadinessListener&&this.featureSource.addReadinessListener(function(o){m.notify(o,-1)});this.listeners=[]}DasTier.prototype.toString=function(){return this.id};DasTier.prototype.addFeatureInfoPlugin=function(a){if(!this.featureInfoPlugins)this.featureInfoPlugins=[];this.featureInfoPlugins.push(a)};
DasTier.prototype.init=function(){var a=this;if(a.dasSource.style){this.setStylesheet({styles:a.dasSource.style});this.browser.refreshTier(this)}else{var b;b=a.dasSource.stylesheet_uri?new DASFeatureSource(a.dasSource):a.getSource();a.status="Fetching stylesheet";b.getStyleSheet(function(c,d){if(d){a.error="No stylesheet";c=new DASStylesheet;var e=new DASStyle;e.glyph="BOX";e.BGCOLOR="blue";e.FGCOLOR="black";c.pushStyle({type:"default"},null,e);a.setStylesheet(c)}else{a.setStylesheet(c);if(c.geneHint){a.dasSource.collapseSuperGroups=
true;a.bumped=false;a.updateLabel()}}a.browser.refreshTier(a)})}};DasTier.prototype.setStylesheet=function(a){this.baseStylesheet=shallowCopy(a);for(a=0;a<this.baseStylesheet.styles.length;++a){var b=this.baseStylesheet.styles[a]=shallowCopy(this.baseStylesheet.styles[a]);b._methodRE=b._labelRE=b._typeRE=null;b.style=shallowCopy(b.style);b.style.id="style"+ ++this.styleIdSeed}this._updateFromConfig()};DasTier.prototype.getSource=function(){return this.featureSource};
DasTier.prototype.getDesiredTypes=function(){var a=[],b=false,c=zoomForScale(this.browser.scale);if(this.stylesheet){for(var d=this.stylesheet.styles,e=0;e<d.length;++e){var h=d[e];if(!h.zoom||h.zoom==c)if(!h.type||h.type=="default"){b=true;break}else pushnew(a,h.type)}return b?null:a}};DasTier.prototype.needsSequence=function(a){if(this.dasSource.tier_type==="sequence"&&a<5)return true;else if((this.dasSource.bamURI||this.dasSource.bamBlob)&&a<20)return true;return false};
DasTier.prototype.viewFeatures=function(a,b,c,d,e,h){this.currentFeatures=e;this.currentSequence=h;this.knownChr=a;this.knownStart=b;this.knownEnd=c;this.error=this.status=null;this.draw()};
DasTier.prototype.updateStatus=function(a){if(a){this.currentFeatures=[];this.currentSequence=null;this.error=a;this.placardContent.textContent=a;this.placard.style.display="block";this.holder.style.display="none";this.draw();this.updateHeight()}else if(this.error){this.placard.style.display="none";this.holder.style.display="block";this.error=null;this.updateHeight()}};
DasTier.prototype.draw=function(){var a=this.currentSequence;this.dasSource.tier_type==="sequence"?drawSeqTier(this,a):drawFeatureTier(this);this.paint();this.originHaxx=0;this.browser.arrangeTiers()};function zoomForScale(a){return a>0.2?"high":a>0.01?"medium":"low"}
DasTier.prototype.findNextFeature=function(a,b,c,d,e){if(this.quantLeapThreshold){b=b+(this.browser.viewEnd-this.browser.viewStart+1)*c/2|0;this.featureSource.quantFindNextFeature(a,b,c,this.quantLeapThreshold,e)}else{if(this.knownStart&&b>=this.knownStart&&b<=this.knownEnd)if(this.currentFeatures){for(var h=null,j=0;j<this.currentFeatures.length;++j){var i=this.currentFeatures[j];if(i.min&&i.max)if(!(i.parents&&i.parents.length>0))if(c<0)if(d==1&&i.max>=b&&i.min<b){if(!h||i.min>h.min||i.min==h.min&&
i.max<h.max)h=i}else{if(i.max<b)if(!h||i.max>h.max||i.max==h.max&&i.min<h.min||i.min==h.mmin&&h.max>=b)h=i}else if(d==1&&i.min<=b&&i.max>b){if(!h||i.max<h.max||i.max==h.max&&i.min>h.min)h=i}else if(i.min>b)if(!h||i.min<h.min||i.min==h.min&&i.max>h.max||i.max==h.max&&h.min<=b)h=i}if(h)return e(h);b=c<0?this.knownStart:this.knownEnd}this.featureSource.findNextFeature(a,b,c,e)}};
DasTier.prototype.updateLabel=function(){this.bumpButton.className=this.bumped?"fa fa-minus-circle":"fa fa-plus-circle";this.bumpButton.style.display=this.dasSource.collapseSuperGroups?"inline-block":"none"};DasTier.prototype.updateHeight=function(){this.currentHeight=Math.max(this.layoutHeight,Math.max(this.holder.clientHeight,this.label.clientHeight+4));if(this.placard.style.display!=="none")this.currentHeight=Math.max(this.currentHeight,52);this.row.style.height=""+this.currentHeight+"px";this.browser.updateHeight()};
DasTier.prototype.drawOverlay=function(){var a=this.browser,b=this.overlay.getContext("2d");this.overlay.height=this.viewport.height;for(var c=a.viewStart-1E3/a.scale,d=a.viewStart-1E3/a.scale,e=a.viewEnd+1E3/a.scale,h=0;h<a.highlights.length;++h){var j=a.highlights[h];if((j.chr===a.chr||j.chr==="chr"+a.chr)&&j.min<e&&j.max>d){b.globalAlpha=a.defaultHighlightAlpha;b.fillStyle=a.defaultHighlightFill;b.fillRect((j.min-c)*a.scale,0,(j.max-j.min)*a.scale,this.overlay.height)}}this.oorigin=a.viewStart;
this.overlay.style.left="-1000px"};DasTier.prototype.notify=function(a,b){b=b||2E3;if(this.notifierFadeTimeout){clearTimeout(this.notifierFadeTimeout);this.notifierFadeTimeout=null}if(a){this.notifier.textContent=a;this.notifier.style.opacity=0.8;if(b>0){var c=this;this.notifierFadeTimeout=setTimeout(function(){c.notifier.style.opacity=0;c.notifierFadeTimeout=null},b)}}else this.notifier.style.opacity=0};DasTier.prototype.setConfig=function(a){this.config=a||{};this._updateFromConfig();this.notifyTierListeners()};
DasTier.prototype.mergeConfig=function(a){for(var b in a)this.config[b]=a[b];this._updateFromConfig();this.notifyTierListeners()};
DasTier.prototype._updateFromConfig=function(){var a=false;this.nameElement.textContent=typeof this.config.name==="string"?this.config.name:this.dasSource.name;var b=this.config.height||this.dasSource.forceHeight;if(b!=this.forceHeight){this.forceHeight=b;a=true}if(this.forceMinDynamic!=this.config.forceMinDynamic){this.forceMinDynamic=this.config.forceMinDynamic;a=true}b=this.config.forceMin!=undefined?this.config.forceMin:this.dasSource.forceMin;if(this.forceMin!=b){this.forceMin=b;a=true}if(this.forceMaxDynamic!=
this.config.forceMaxDynamic){this.forceMaxDynamic=this.config.forceMaxDynamic;a=true}b=this.config.forceMax!=undefined?this.config.forceMax:this.dasSource.forceMax;if(this.forceMax!=b){this.forceMax=b;a=true}b=null;if(this.config.quantLeapThreshold!==undefined)b=this.config.quantLeapThreshold;else if(this.dasSource.quantLeapThreshold!==undefined)b=this.dasSource.quantLeapThreshold;if(b!=this.quantLeapThreshold){this.quantLeapThreshold=b;a=true}b=this.config.stylesheet||this.baseStylesheet;if(this.stylesheet!==
b){this.stylesheet=b;a=true}a&&this.scheduleRedraw()};DasTier.prototype.scheduleRedraw=function(){if(this.currentFeatures){var a=this;if(!this.redrawTimeout)this.redrawTimeout=setTimeout(function(){a.draw();a.redrawTimeout=null},10)}};DasTier.prototype.addTierListener=function(a){this.listeners.push(a)};DasTier.prototype.notifyTierListeners=function(a){for(var b=0;b<this.listeners.length;++b)try{this.listeners[b](a)}catch(c){console.log(c)}this.browser.notifyTier()};
Browser.prototype.currentlyActive=function(a){for(var b=0;b<this.tiers.length;++b)if(sourcesAreEqual(this.tiers[b].dasSource,a))return this.tiers[b];return false};Browser.prototype.makeButton=function(a,b){var c=makeElement("a",a,{href:"#"});b&&this.makeTooltip(c,b);return makeElement("li",c)};function activateButton(a,b){for(var c=0;c<a.length;++c){var d=a[c];d===b?d.classList.add("active"):d.classList.remove("active")}}
Browser.prototype.showTrackAdder=function(){function a(w){ea.style.display="none";ja.style.display="none";ka.style.display="none";J=false;removeChildren(I);for(var K=makeElement("div",null,{},{width:"100%"}),P=[],N=0;N<w.length;++N)P.push(w[N]);P.sort(function(ga,ma){return ga.shortLabel.toLowerCase().trim().localeCompare(ma.shortLabel.toLowerCase().trim())});w=[];var Q=[];for(N=0;N<P.length;++N){var F=P[N];F.children&&F.children.length>0&&F.container!="multiWig"?w.push(F):Q.push(F)}Q.length>0&&w.push({shortLabel:"Others",
priority:-100000000,children:Q});w.sort(THUB_COMPARE);var U=[];for(P=0;P<w.length;++P){F=Q=w[P];if(!F.dimensions&&F._parent&&F._parent.dimensions)F=F._parent;N={};if(F.dimensions)for(var X=F.dimensions.split(/(\w+)=(\w+)/),V=0;V<X.length-2;V+=3)N[X[V+1]]=X[V+2];if(N.dimX&&N.dimY){var Y=N.dimX,ba=N.dimY;N=F.subgroups[Y];X=F.subgroups[ba];V={};for(var $=0;$<Q.children.length;++$){var ca=Q.children[$];F=ca.sgm[Y];var ha=ca.sgm[ba];V[F]||(V[F]={});V[F][ha]=ca}ba=makeElement("table",null,{className:"table table-striped table-condensed"},
{tableLayout:"fixed"});F=makeElement("tr");F.appendChild(makeElement("th",null,{},{width:"150px",height:"100px"}));for(ha=0;ha<N.titles.length;++ha){Y=makeElement("th",makeElement("div",N.titles[ha],{},{transform:"rotate(-60deg)",transformOrigin:"0% 100%",webkitTransform:"rotate(-60deg) translate(20px,10px)",webkitTransformOrigin:"0% 100%",textAlign:"left"}),{},{width:"35px",height:"100px",verticalAlign:"bottom"});F.appendChild(Y)}ba.appendChild(F);for(var ra=makeElement("tbody",null,{className:"table table-striped table-condensed"}),
oa=0;oa<X.titles.length;++oa){ha=X.tags[oa];var pa=makeElement("tr");pa.appendChild(makeElement("th",X.titles[oa]),{});for(var qa=0;qa<N.titles.length;++qa){F=N.tags[qa];var sa=makeElement("td");if(V[F]&&V[F][ha]){F=V[F][ha];$=F.toDallianceSource();if(!$)continue;Y=makeElement("tr");ca=makeElement("td");ca.style.textAlign="center";var ia=makeElement("input");ia.type="checkbox";ia.dalliance_source=$;if(fa)ia.dalliance_mapping=fa;U.push(ia);sa.appendChild(ia);ia.addEventListener("change",function(ga){ga.target.checked?
p.addTier(ga.target.dalliance_source):p.removeTier(ga.target.dalliance_source)})}pa.appendChild(sa)}ra.appendChild(pa)}ba.appendChild(ra);K.appendChild(makeTreeTableSection(Q.shortLabel,ba,P==0))}else{X=makeElement("tbody",null,{className:"table table-striped table-condensed"});V=makeElement("table",X,{className:"table table-striped table-condensed"},{width:"100%",tableLayout:"fixed"});ha=0;Q.children.sort(THUB_COMPARE);for(N=0;N<Q.children.length;++N){F=Q.children[N];if($=F.toDallianceSource()){Y=
makeElement("tr");ca=makeElement("td",null,{},{width:"30px"});ca.style.textAlign="center";ia=makeElement("input");ia.type="checkbox";ia.dalliance_source=$;if(fa)ia.dalliance_mapping=fa;U.push(ia);ca.appendChild(ia);ia.addEventListener("change",function(ga){ga.target.checked?p.addTier(ga.target.dalliance_source):p.removeTier(ga.target.dalliance_source)});Y.appendChild(ca);ba=makeElement("td");ba.appendChild(document.createTextNode(F.shortLabel));F.longLabel&&F.longLabel.length>0&&p.makeTooltip(ba,
F.longLabel);Y.appendChild(ba);X.appendChild(Y);++ha}}w.length>1||Q.shortLabel!=="Others"?K.appendChild(makeTreeTableSection(Q.shortLabel,V,P==0)):K.appendChild(V)}}var ua=function(){for(var ga=0;ga<U.length;++ga){var ma=U[ga],ta=p.currentlyActive(ma.dalliance_source);if(ta){ma.checked=true;ma.disabled=ta.sequenceSource!=null}else ma.checked=false}};ua();p.addTierListener(function(){ua()});I.appendChild(K)}function b(){activateButton(r,G);J="bin";ea.style.display="none";ja.style.display="inline";
ka.style.display="none";removeChildren(I);var w=makeElement("div",null,{},{paddingLeft:"10px",paddingRight:"10px"});w.appendChild(makeElement("h3","Add custom URL-based data"));w.appendChild(makeElement("p",["You can add indexed binary data hosted on an web server that supports CORS (",makeElement("a","full details",{href:"http://www.biodalliance.org/bin.html"}),").  Currently supported formats are bigwig, bigbed, and indexed BAM."]));w.appendChild(makeElement("br"));w.appendChild(document.createTextNode("URL: "));
S=makeElement("input","",{size:80,value:"http://www.biodalliance.org/datasets/ensGene.bb"},{width:"100%"});w.appendChild(S);w.appendChild(makeElement("br"));w.appendChild(makeElement("b","- or -"));w.appendChild(makeElement("br"));w.appendChild(document.createTextNode("File: "));da=makeElement("input",null,{type:"file"});w.appendChild(da);w.appendChild(makeElement("p",'Clicking the "Add" button below will initiate a series of test queries.'));I.appendChild(w);S.focus()}function c(){activateButton(r,
L);ea.style.display="none";ja.style.display="inline";ka.style.display="none";J="hub-connect";ea.style.visibility="hidden";removeChildren(I);var w=makeElement("div",null,{},{paddingLeft:"10px",paddingRight:"10px"});w.appendChild(makeElement("h3","Connect to a track hub."));w.appendChild(makeElement("p",['Enter the top-level URL (usually points to a file called "hub.txt" of a UCSC-style track hub']));S=makeElement("input","",{size:120,value:"http://www.biodalliance.org/datasets/testhub/hub.txt"},{width:"100%"});
w.appendChild(S);I.appendChild(w);S.focus()}function d(){activateButton(r,B);ea.style.display="none";ja.style.display="inline";ka.style.display="none";J="das";removeChildren(I);var w=makeElement("div",null,{},{paddingLeft:"10px",paddingRight:"10px"});w.appendChild(makeElement("h3","Add custom DAS data"));w.appendChild(makeElement("p","This interface is intended for adding custom or lab-specific data.  Public data can be added more easily via the registry interface."));w.appendChild(document.createTextNode("URL: "));
w.appendChild(makeElement("br"));S=makeElement("input","",{size:80,value:"http://www.derkholm.net:8080/das/medipseq_reads/"},{width:"100%"});w.appendChild(S);w.appendChild(makeElement("p",'Clicking the "Add" button below will initiate a series of test queries.  If the source is password-protected, you may be prompted to enter credentials.'));I.appendChild(w);S.focus()}function e(){if(J)if(J==="das"){var w=S.value.trim();/^.+:\/\//.exec(w)||(w="http://"+w);var K=new DASSource({name:"temporary",uri:w});
va(K)}else if(J==="bin"){K={name:"temporary"};if((w=da.files)&&w.length>0&&w[0]){K.bwgBlob=w[0];K.noPersist=true}else{w=S.value.trim();/^.+:\/\//.exec(w)||(w="http://"+w);K.bwgURI=w}K=new DASSource(K);wa(K)}else if(J==="reset")d();else if(J==="reset-bin")b();else if(J==="reset-hub")c();else if(J==="prompt-bai")if((w=da.files)&&w.length>0&&w[0]){R.baiBlob=w[0];m(R)}else i(R);else if(J==="prompt-tbi")if((w=da.files)&&w.length>0&&w[0]){R.indexBlob=w[0];o(R)}else l(R);else if(J==="finalize"||J==="finalize-bin"){R.name=
aa.value;K=Z.value;R.mapping=K!="__default__"?K:undefined;if(W)R.maxbins=W.checked;if(T.value.length>1&&E.value.length>1){dlog("password");R.xUser=T.value;R.xPass=E.value}p.addTier(R);J=="finalize-bin"?b():d()}else{if(J==="hub-connect"){w=S.value.trim();/^.+:\/\//.exec(w)||(w="http://"+w);h(w)}}else p.removeAllPopups()}function h(w,K,P){K=K||{};connectTrackHub(w,function(N,Q){if(Q){if(!P)return h(w,{credentials:true},true);removeChildren(I);I.appendChild(makeElement("h2","Error connecting to track hub"));
I.appendChild(makeElement("p",Q));J="reset-hub"}else{var F=null,U=null;for(var X in N.genomes){var V=null,Y=false;if(X==p.coordSystem.ucscName)Y=true;else for(var ba in p.chains)if(X==p.chains[ba].coords.ucscName){V=ba;Y=true}if(Y){hc={url:w,genome:X};if(K.credentials)hc.credentials=true;if(V){hc.mapping=V;N.genomes[X].mapping=V}p.hubs.push(hc);p.hubObjects.push(N.genomes[X]);Y=A(N.genomes[X]);M.appendChild(Y);if(!V||!F){F=N.genomes[X];U=Y}}}if(F){p.notifyTier();activateButton(r,U);F.getTracks(function($){a($)})}else{removeChildren(I);
I.appendChild(makeElement("h2","No data for this genome"));I.appendChild(makeElement("p","This URL appears to be a valid track-hub, but it doesn't contain any data for the coordinate system of this browser"));I.appendChild(makeElement("p","coordSystem.ucscName = "+p.coordSystem.ucscName));J="reset-hub"}}},K)}function j(w,K){var P=w.uri;if(K){var N=/(.+)\/[^\/]+\/?/.exec(P);if(N)P=N[1]+"/sources"}(new DASRegistry(P,{credentials:w.credentials})).sources(function(Q){if(!Q||Q.length==0)return K?na(w):
j(w,true);var F=null;if(Q.length==1)F=Q[0];else for(var U=0;U<Q.length;++U)if(Q[U].uri===w.uri){F=Q[U];break}U=Q=false;if(F){w.name=F.name;w.desc=F.desc;w.maxbins=F.maxbins?true:false;if(F.capabilities)w.capabilities=F.capabilities;U=true;if(F.coords&&F.coords.length==1){F=F.coords[0];if(coordsMatch(F,p.coordSystem))Q=true;else if(p.chains)for(var X in p.chains)if(coordsMatch(F,p.chains[X].coords)){w.mapping=X;Q=true}}}return na(w,Q,U)},function(){return K?na(w):j(w,true)})}function i(w){ea.style.display=
"none";ja.style.display="inline";ka.style.display="inline";removeChildren(I);J="prompt-bai";I.appendChild(makeElement("h2","Select an index file"));I.appendChild(makeElement("p","Dalliance requires a BAM index (.bai) file when displaying BAM data.  These normally accompany BAM files.  For security reasons, web applications like Dalliance can only access local files which you have explicity selected.  Please use the file chooser below to select the appropriate BAI file"));I.appendChild(document.createTextNode("Index file: "));
da=makeElement("input",null,{type:"file"});I.appendChild(da);R=w}function l(w){ea.style.display="none";ja.style.display="inline";ka.style.display="inline";removeChildren(I);J="prompt-tbi";I.appendChild(makeElement("h2","Select an index file"));I.appendChild(makeElement("p","Dalliance requires a Tabix index (.tbi) file when displaying VCF data.  For security reasons, web applications like Dalliance can only access local files which you have explicity selected.  Please use the file chooser below to select the appropriate BAI file"));
I.appendChild(document.createTextNode("Index file: "));da=makeElement("input",null,{type:"file"});I.appendChild(da);R=w}function m(w){(w.baiBlob?new BlobFetchable(w.baiBlob):new URLFetchable(w.bwgURI+".bai")).slice(0,256).fetch(function(K){var P=false;if(K){K=new Uint8Array(K);P=readInt(K,0)==BAI_MAGIC}if(P){if(K=/\/?([^\/]+?)(.bam)?$/.exec(w.bwgURI||w.bwgBlob.name))w.name=K[1];w.bamURI=w.bwgURI;w.bamBlob=w.bwgBlob;w.bwgURI=undefined;w.bwgBlob=undefined;return na(w,false,false,true)}else return q("You have selected a valid BAM file, but a corresponding index (.bai) file was not found.  Please index your BAM (samtools index) and place the BAI file in the same directory")})}
function o(w){(w.indexBlob?new BlobFetchable(w.indexBlob):new URLFetchable(w.bwgURI+".tbi")).slice(0,65536).fetch(function(K){var P=false;if(K){var N=new Uint8Array(K);if(N[0]==31||N[1]==139){K=unbgzf(K);N=new Uint8Array(K);P=readInt(N,0)==TABIX_MAGIC}}if(P){if(K=/\/?([^\/]+?)(.vcf)?(.gz)?$/.exec(w.bwgURI||w.bwgBlob.name))w.name=K[1];w.uri=w.bwgURI;w.blob=w.bwgBlob;w.bwgURI=undefined;w.bwgBlob=undefined;w.tier_type="tabix";w.payload="vcf";return na(w,false,false,true)}else return q('You have selected a valid VCF file, but a corresponding index (.tbi) file was not found.  Please index your VCF ("tabix -p vcf -f myfile.vcf.gz") and place the .tbi file in the same directory')})}
function q(w){ea.style.display="none";ja.style.display="inline";ka.style.display="inline";removeChildren(I);w=w||"Custom data format not recognized";I.appendChild(makeElement("h2","Error adding custom data"));I.appendChild(makeElement("p",w));I.appendChild(makeElement("p","Currently supported formats are bigBed, bigWig, and BAM."));J="reset-bin"}if(this.uiMode==="add"){this.hideToolPanel();this.setUiMode("none")}else{var p=this,s=makeElement("div",null,{className:"dalliance"},{width:"100%",display:"inline-block",
boxSizing:"border-box",MozBoxSizing:"border-box",verticalAlign:"top"}),r=[],t,v;if(!this.noRegistryTabs){var u=this.makeButton("Registry","Browse compatible datasources from the DAS registry");r.push(u);for(var x in this.mappableSources)(function(w){var K=p.makeButton(p.chains[w].srcTag,"Browse datasources mapped from "+p.chains[w].srcTag);r.push(K);K.addEventListener("click",function(P){P.preventDefault();P.stopPropagation();activateButton(r,K);t(p.mappableSources[w],w)},false)})(x)}x={};for(var z=
0;z<this.defaultSources.length;++z){var H=this.defaultSources[z],C=H.group||"Defaults";if(x[C])x[C].push(H);else x[C]=[H]}var A=function(w){var K=w.hub,P=makeElement("i",null,{className:"fa fa-times"}),N=K.shortLabel||"Unknown";if(w.mapping)N=N+" ("+w.genome+")";N=makeElement("span",[N," ",P]);var Q=p.makeButton(N,K.longLabel);r.push(Q);Q.addEventListener("click",function(F){F.preventDefault();F.stopPropagation();activateButton(r,Q);removeChildren(I);I.appendChild(makeElement("div",makeElement("img",
null,{src:p.uiPrefix+"img/loader.gif"},{marginLeft:"auto",marginRight:"auto",marginTop:"100px"}),null,{textAlign:"center"}));ea.style.display="none";ja.style.display="none";ka.style.display="none";w.getTracks(function(U,X){X&&console.log(X);a(U)})},false);P.addEventListener("click",function(F){F.preventDefault();F.stopPropagation();for(F=0;F<p.hubObjects.length;++F)if(p.hubObjects[F].absURL==w.absURL){p.hubObjects.splice(F,1);break}for(F=0;F<p.hubs.length;++F){var U=p.hubs[F];if(typeof U==="string")U=
{url:U};if(U.url==w.hub.url&&!U.genome||U.genome==w.genome){p.hubs.splice(F,1);break}}p.notifyTier();M.removeChild(Q);activateButton(r,L);c()},false);return Q},D=null,O=null;for(C in x)(function(w,K){var P=p.makeButton(w,"Browse the default set of data for this browser");P.addEventListener("click",function(N){N.preventDefault();N.stopPropagation();activateButton(r,P);t(new Observed(K))},false);r.push(P);if(!D){D=P;O=K}})(C,x[C]);var B=this.makeButton("DAS","Add arbitrary DAS data");r.push(B);var G=
this.makeButton("Binary","Add data in bigwig or bigbed format");r.push(G);for(C=0;C<this.hubObjects.length;++C)A(this.hubObjects[C]);var L=this.makeButton("+","Connect to a new track-hub");r.push(L);var M=makeElement("ul",r,{className:"nav nav-tabs"},{marginBottom:"0px"});s.appendChild(M);var S,aa,Z,W,da,T,E,J=false,R=null;C=makeElement("form",null,{},{display:"inline-block",width:"100%"});C.addEventListener("submit",function(w){w.stopPropagation();w.preventDefault();e();return false},true);var I=
makeElement("div");I.style.position="relative";I.style.overflow="scroll";C.appendChild(I);var fa,la;t=function(w,K){ea.style.display="none";ja.style.display="none";ka.style.display="none";la&&la.removeListener(v);fa=K;la=w;la.addListenerAndFire(v)};v=function(w){J=false;var K=[];removeChildren(I);if(w){for(var P=makeElement("tbody",null,{className:"table table-striped table-condensed"},{width:"100%"}),N=makeElement("table",P,{className:"table table-striped table-condensed"},{width:"100%",tableLayout:"fixed"}),
Q=0,F=[],U=0;U<w.length;++U)F.push(w[U]);F.sort(function($,ca){return $.name.toLowerCase().trim().localeCompare(ca.name.toLowerCase().trim())});for(U=0;U<F.length;++U){w=F[U];var X=makeElement("tr"),V=makeElement("td",null,{},{width:"30px"});V.style.textAlign="center";if(!w.props||w.props.cors){var Y=makeElement("input");Y.type="checkbox";Y.dalliance_source=w;if(fa)Y.dalliance_mapping=fa;V.appendChild(Y);K.push(Y);Y.addEventListener("change",function($){$.target.checked?p.addTier($.target.dalliance_source):
p.removeTier($.target.dalliance_source)})}else{V.appendChild(document.createTextNode("!"));p.makeTooltip(V,makeElement("span",["This data source isn't accessible because it doesn't support ",makeElement("a","CORS",{href:"http://www.w3.org/TR/cors/"}),"."]))}X.appendChild(V);V=makeElement("td");V.appendChild(document.createTextNode(w.name));w.desc&&w.desc.length>0&&p.makeTooltip(V,w.desc);X.appendChild(V);P.appendChild(X);++Q}var ba=function(){for(var $=0;$<K.length;++$){var ca=K[$],ha=p.currentlyActive(ca.dalliance_source);
if(ha){ca.checked=true;ca.disabled=ha.sequenceSource!=null}else ca.checked=false}};ba();p.addTierListener(function(){ba()});I.appendChild(N)}else I.appendChild(makeElement("p","Dalliance was unable to retrieve data source information from the DAS registry, please try again later"))};u&&u.addEventListener("click",function(w){w.preventDefault();w.stopPropagation();activateButton(r,u);t(p.availableSources)},false);G.addEventListener("click",function(w){w.preventDefault();w.stopPropagation();b()},false);
L.addEventListener("click",function(w){w.preventDefault();w.stopPropagation();c()},false);B.addEventListener("click",function(w){w.preventDefault();w.stopPropagation();d()},false);var ja=makeElement("button","Add",{className:"btn btn-primary"});ja.addEventListener("click",function(w){w.stopPropagation();w.preventDefault();e()},false);var va=function(w,K){var P=p.knownSpace;if(P){var N=Math.max(P.min,(P.min+P.max-100)/2)|0;P=new DASSegment(P.chr,N,Math.min(N+99,P.max));w.features(P,{},function(Q,F){if(F)if(K){removeChildren(I);
I.appendChild(makeElement("h2","Custom data not found"));I.appendChild(makeElement("p","DAS uri: "+w.uri+" is not answering features requests"));J="reset"}else{dlog("retrying with credentials");w.credentials=true;va(w,true)}else{var U=/\/([^\/]+)\/?$/.exec(w.uri);if(U)w.name=U[1];j(w)}})}else alert("Can't confirm track-addition to an uninit browser.")},wa=function(w,K){(w.bwgURI?new URLFetchable(w.bwgURI,null,null,{credentials:w.credentials}):new BlobFetchable(w.bwgBlob)).slice(0,65536).salted().fetch(function(P,
N){if(P){var Q=new Uint8Array(P),F=readInt(Q,0);if(F==BIG_WIG_MAGIC||F==BIG_BED_MAGIC){if(Q=/\/?([^\/]+?)(.bw|.bb|.bigWig|.bigBed)?$/.exec(w.bwgURI||w.bwgBlob.name))w.name=Q[1];return na(w,false,false,true)}else{if(Q[0]!=31||Q[1]!=139)return q();Q=unbgzf(P);Q=new Uint8Array(Q);F=readInt(Q,0);if(F==BAM_MAGIC)return w.bwgBlob?i(w):m(w);else if(F==1768301347)return w.bwgBlob?l(w):o(w);else{console.log("magic = "+F.toString(16));return q()}}}else{if(!K){w.credentials=true;wa(w,true)}removeChildren(I);
I.appendChild(makeElement("h2","Custom data not found"));w.bwgURI?I.appendChild(makeElement("p","Data URI: "+w.bwgURI+" is not accessible.")):I.appendChild(makeElement("p","File access failed, are you using an up-to-date browser?"));N&&I.appendChild(makeElement("p",""+N));I.appendChild(makeElement("p","If in doubt, please check that the server where the file is hosted supports CORS."));J="reset-bin"}})},na=function(w,K,P,N){ea.style.display="none";ja.style.display="inline";ka.style.display="inline";
removeChildren(I);I.appendChild(makeElement("h2","Add custom data: step 2"));I.appendChild(document.createTextNode("Label: "));aa=makeElement("input","",{value:w.name});I.appendChild(aa);T=makeElement("input","");E=makeElement("input","");I.appendChild(makeElement("br"));I.appendChild(makeElement("br"));I.appendChild(makeElement("h4","Coordinate system: "));Z=makeElement("select",null);Z.appendChild(makeElement("option",p.coordSystem.auth+p.coordSystem.version,{value:"__default__"}));if(p.chains)for(var Q in p.chains){var F=
p.chains[Q].coords;Z.appendChild(makeElement("option",F.auth+F.version,{value:Q}))}Z.value=w.mapping||"__default__";I.appendChild(Z);if(K)I.appendChild(makeElement("p","(Based on server response, probably doesn't need changing.)"));else{I.appendChild(makeElement("p",[makeElement("b","Warning: "),"unable to determine the correct value from server responses.  Please check carefully."]));I.appendChild(makeElement("p","If you don't see the mapping you're looking for, please contact thomas@biodalliance.org"))}if(!N){I.appendChild(document.createTextNode("Quantitative: "));
W=makeElement("input",null,{type:"checkbox",checked:true});if(typeof w.maxbins!=="undefined")W.checked=w.maxbins;I.appendChild(W);P?I.appendChild(makeElement("p","(Based on server response, probably doesn't need changing.)")):I.appendChild(makeElement("p",[makeElement("b","Warning: "),"unable to determine correct value.  If in doubt, leave checked."]))}w.bwgBlob&&I.appendChild(makeElement("p",[makeElement("b","Warning: "),"data added from local file.  Due to the browser security model, the track will disappear if you reload Dalliance."]));
aa.focus();J=J==="bin"||J==="prompt-bai"||J==="prompt-tbi"?"finalize-bin":"finalize";R=w},ka=makeElement("button","Cancel",{className:"btn"});ka.addEventListener("click",function(w){w.stopPropagation();w.preventDefault();J==="finalize-bin"?b():d()},false);var ea=makeElement("button","Refresh",{className:"btn"});ea.addEventListener("click",function(w){w.stopPropagation();w.preventDefault();p.queryRegistry(fa)},false);this.makeTooltip(ea,"Click to re-fetch data from the DAS registry");x=makeElement("div",
[ja," ",ka," ",ea]);x.style.margin="10px";C.appendChild(x);s.appendChild(C);t(p.availableSources);this.showToolPanel(s);this.setUiMode("add");if(D){activateButton(r,D);t(new Observed(O))}}};var TWOBIT_MAGIC=440477507,TWOBIT_MAGIC_BE=1126646042;function TwoBitFile(){}
function makeTwoBit(a,b){var c=new TwoBitFile;c.data=a;c.data.slice(0,12500).fetch(function(d){if(!d)return b(null,"Couldn't access data");var e=new Uint8Array(d);d=readInt(e,0);if(d==TWOBIT_MAGIC)c.readInt=readInt;else if(d==TWOBIT_MAGIC_BE)c.readInt=readIntBE;else return b(null,"Not a .2bit file, magic=0x"+d.toString(16));d=c.readInt(e,4);if(d!=0)return b(null,"Unsupported version "+d);c.seqCount=c.readInt(e,8);c.seqDict={};var h=16,j=0,i=0,l=function(){for(;j<c.seqCount;){var m=e[h];if(h+m+6>=
e.length)return c.data.slice(i+h,12500).fetch(function(p){i+=h;h=0;e=new Uint8Array(p);l()});else{++h;for(var o="",q=1;q<=m;++q)o+=String.fromCharCode(e[h++]);m=c.readInt(e,h);h+=4;c.seqDict[o]=new TwoBitSeq(c,m);++j}}return b(c)};l()})}TwoBitFile.prototype.getSeq=function(a){var b=this.seqDict[a];b||(b=this.seqDict["chr"+a]);return b};TwoBitFile.prototype.fetch=function(a,b,c,d){var e=this.getSeq(a);if(e)e.fetch(b,c,d);else return d(null,"Couldn't find "+a)};
function TwoBitSeq(a,b){this.tbf=a;this.offset=b}
TwoBitSeq.prototype.init=function(a){if(this.seqOffset)return a();var b=this;b.tbf.data.slice(b.offset,8).fetch(function(c){if(!c)return a("Fetch failed");c=new Uint8Array(c);b._length=b.tbf.readInt(c,0);b.nBlockCnt=b.tbf.readInt(c,4);b.tbf.data.slice(b.offset+8,b.nBlockCnt*8+4).fetch(function(d){if(!d)return a("Fetch failed");d=new Uint8Array(d);for(var e=null,h=0;h<b.nBlockCnt;++h){var j=b.tbf.readInt(d,h*4),i=b.tbf.readInt(d,(h+b.nBlockCnt)*4);j=new Range(j,j+i-1);e=e?union(e,j):j}b.nBlocks=e;
b.mBlockCnt=b.tbf.readInt(d,b.nBlockCnt*8);b.seqLength=(b._length+3)/4|0;b.seqOffset=b.offset+16+(b.nBlockCnt+b.mBlockCnt)*8;return a()})})};var TWOBIT_TABLE=["T","C","A","G"];
TwoBitSeq.prototype.fetch=function(a,b,c){--a;--b;var d=this;this.init(function(e){if(e)return c(null,e);var h=a>>2;e=b+3>>2;if(h<0||e>d.seqLength)return c("Coordinates out of bounds: "+a+":"+b);d.tbf.data.slice(d.seqOffset+h,e-h).fetch(function(j){function i(s){for(;q<=s;){var r=q&3,t=l[(q>>2)-h];o+=TWOBIT_TABLE[r==0?t>>6&3:r==1?t>>4&3:r==2?t>>2&3:t&3];++q}}if(j==null)return c("SeqFetch failed");var l=new Uint8Array(j);j=[];if(d.nBlocks){var m=intersection(new Range(a,b),d.nBlocks);if(m)j=m.ranges()}var o=
"",q=a;for(m=0;m<j.length;++m){var p=j[m];if(q>p.min())throw"N mismatch...";for(q<p.min()&&i(p.min()-1);q<=p.max();){o+="N";++q}}q<=b&&i(b);return c(o)})})};TwoBitSeq.prototype.length=function(a){var b=this;this.init(function(c){return c?a(null,c):a(b._length)})};var NUM_REGEXP=/[0-9]+/;function stringToNumbersArray(a){for(var b=[],c;c=NUM_REGEXP.exec(a);){b.push(c[0]);a=a.substring(c.index+c[0].length)}return b}var STRICT_NUM_REGEXP=/^[0-9]+$/;
function stringToInt(a){a=a.replace(RegExp(",","g"),"");if(!STRICT_NUM_REGEXP.test(a))return null;return a|0}function pushnew(a,b){for(var c=0;c<a.length;++c)if(a[c]==b)return;a.push(b)}function pusho(a,b,c){if(a[b])a[b].push(c);else a[b]=[c]}function pushnewo(a,b,c){var d=a[b];if(d){for(a=0;a<d.length;++a)if(d[a]==c)return;d.push(c)}else a[b]=[c]}function pick(a,b,c,d){if(a)return a;else if(b)return b;else if(c)return c;else if(d)return d}
function pushnew(a,b){for(var c=0;c<a.length;++c)if(a[c]==b)return;a.push(b)}function maybeConcat(a,b){var c=[];if(a)for(var d=0;d<a.length;++d)pushnew(c,a[d]);if(b)for(d=0;d<b.length;++d)pushnew(c,b[d]);return c}function arrayIndexOf(a,b){if(!a)return-1;for(var c=0;c<a.length;++c)if(a[c]===b)return c;return-1}function arrayRemove(a,b){var c=arrayIndexOf(a,b);if(c>=0){a.splice(c,1);return true}return false}
function makeElement(a,b,c,d){a=document.createElement(a);if(b){b instanceof Array||(b=[b]);for(var e=0;e<b.length;++e){var h=b[e];if(typeof h=="string")h=document.createTextNode(h);a.appendChild(h)}}if(c)for(var j in c)try{a[j]=c[j]}catch(i){console.log("error setting "+j);throw i;}if(d)for(j in d)a.style[j]=d[j];return a}
function makeElementNS(a,b,c,d){a=document.createElementNS(a,b);if(c){c instanceof Array||(c=[c]);for(b=0;b<c.length;++b){var e=c[b];if(typeof e=="string")e=document.createTextNode(e);a.appendChild(e)}}setAttrs(a,d);return a}var attr_name_cache={};function setAttr(a,b,c){var d=attr_name_cache[b];if(!d){d="";for(var e=0;e<b.length;++e){var h=b.substring(e,e+1),j=h.toLowerCase();d=j!=h?d+"-"+j:d+h}d=attr_name_cache[b]=d}a.setAttribute(d,c)}
function setAttrs(a,b){if(b)for(var c in b)setAttr(a,c,b[c])}function removeChildren(a){if(a&&a.childNodes)for(;a.childNodes.length>0;)a.removeChild(a.firstChild)}
function miniJSONify(a,b){if(typeof a==="undefined")return"undefined";else if(a==null)return"null";else if(typeof a=="string")return"'"+a+"'";else if(typeof a=="number")return""+a;else if(typeof a=="boolean")return""+a;else if(typeof a=="object")if(a instanceof Array){for(var c=null,d=0;d<a.length;++d)c=(c==null?"":c+", ")+miniJSONify(a[d],b);return"["+(c?c:"")+"]"}else{b=b||{};c=null;for(d in a)if(!b[d])if(d!=undefined&&typeof a[d]!="function")c=(c==null?"":c+", ")+d+": "+miniJSONify(a[d],b);return"{"+
(c?c:"")+"}"}else return typeof a}function shallowCopy(a){n={};for(k in a)n[k]=a[k];return n}function Observed(a){this.value=a;this.listeners=[]}Observed.prototype.addListener=function(a){this.listeners.push(a)};Observed.prototype.addListenerAndFire=function(a){this.listeners.push(a);a(this.value)};Observed.prototype.removeListener=function(a){arrayRemove(this.listeners,a)};Observed.prototype.get=function(){return this.value};Observed.prototype.set=function(a){this.value=a;for(var b=0;b<this.listeners.length;++b)this.listeners[b](a)};
function Awaited(){this.queue=[]}Awaited.prototype.provide=function(a){if(this.res!==undefined)throw"Resource has already been provided.";this.res=a;for(var b=0;b<this.queue.length;++b)this.queue[b](a);this.queue=null};Awaited.prototype.await=function(a){if(this.res!==undefined){a(this.res);return this.res}else this.queue.push(a)};__dalliance_saltSeed=0;function saltURL(a){return a+"?salt="+b64_sha1(""+Date.now()+","+ ++__dalliance_saltSeed)}
function textXHR(a,b,c){if(c.salt)a=saltURL(a);var d=new XMLHttpRequest;d.onreadystatechange=function(){if(d.readyState==4)d.status>=300?b(null,"Error code "+d.status):b(d.responseText)};d.open("GET",a,true);d.responseType="text";if(c&&c.credentials)d.withCredentials=true;d.send("")}function relativeURL(a,b){if(b.indexOf("http:")==0||b.indexOf("https:")==0)return b;var c=a.lastIndexOf("/");return c>=0?a.substr(0,c+1)+b:b}
if(!("trim"in String.prototype))String.prototype.trim=function(){return this.replace(/^\s+/,"").replace(/\s+$/,"")};var VERSION={CONFIG:5,MAJOR:0,MINOR:11,MICRO:11,PATCH:"",BRANCH:""};VERSION.toString=function(){var a=""+this.MAJOR+"."+this.MINOR+"."+this.MICRO;if(this.PATCH)a+=this.PATCH;if(this.BRANCH&&this.BRANCH!="")a=a+"-"+this.BRANCH;return a};function formatLongInt(a){return(a|0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}
Browser.prototype.initUI=function(a,b){document.head.appendChild(makeElement("link","",{rel:"stylesheet",href:this.uiPrefix+"css/bootstrap-scoped.css"}));document.head.appendChild(makeElement("link","",{rel:"stylesheet",href:this.uiPrefix+"css/dalliance-scoped.css"}));document.head.appendChild(makeElement("link","",{rel:"stylesheet",href:this.uiPrefix+"css/font-awesome.min.css"}));var c=this;c.disableDefaultFeaturePopup||this.addFeatureListener(function(A,D,O,B){c.featurePopup(A,D,O,B)});a.classList.add("dalliance");
var d=c.toolbar=makeElement("div",null,{className:"btn-toolbar toolbar"}),e=c.coordSystem.speciesName+" "+c.coordSystem.auth+c.coordSystem.version;if(this.setDocumentTitle)document.title=e+" :: dalliance";var h=makeElement("input","",{className:"loc-field"});c.makeTooltip(h,"Enter a genomic location or gene name");var j=makeElement("p","",{className:"loc-status"}),i=makeElement("a",[makeElement("i",null,{className:"fa fa-search-plus"})],{className:"btn"}),l=makeElement("input","",{type:"range",min:100,
max:250},{className:"zoom-slider"},{width:"150px"}),m=makeElement("a",[makeElement("i",null,{className:"fa fa-search-minus"})],{className:"btn"}),o=makeElement("a",[makeElement("i",null,{className:"fa fa-eraser"})],{className:"btn"}),q=makeElement("a",[makeElement("i",null,{className:"fa fa-plus"})],{className:"btn"}),p=makeElement("a",[makeElement("i",null,{className:"fa fa-bookmark"})],{className:"btn"}),s=makeElement("a",[makeElement("i",null,{className:"fa fa-print"})],{className:"btn"});makeElement("a",
[makeElement("i",null,{className:"fa fa-refresh"})],{className:"btn"});var r=makeElement("a",[makeElement("i",null,{className:"fa fa-cogs"})],{className:"btn"}),t=makeElement("a",[makeElement("i",null,{className:"fa fa-question"})],{className:"btn"}),v=makeElement("a",[makeElement("i",null,{className:"fa fa-road"})],{className:"btn"});c.makeTooltip(v,"Configure currently selected track(s) (E)");var u=makeElement("a",[makeElement("i",null,{className:"fa fa-chevron-left"})],{className:"btn"}),x=makeElement("a",
[makeElement("i",null,{className:"fa fa-chevron-right"})],{className:"btn pull-right"}),z=makeElement("div",[q,v,s,r,t],{className:"btn-group pull-right"});this.setUiMode=function(A){this.uiMode=A;var D={help:t,add:q,opts:r,"export":s,tier:v};for(var O in D)O==A?D[O].classList.add("active"):D[O].classList.remove("active")};d.appendChild(x);d.appendChild(z);d.appendChild(u);this.noTitle||d.appendChild(makeElement("div",makeElement("h4",e,{},{margin:"0px"}),{className:"btn-group title"}));d.appendChild(makeElement("div",
[h,j],{className:"btn-group loc-group"}));d.appendChild(o);d.appendChild(makeElement("div",[i,makeElement("span",l,{className:"btn"}),m],{className:"btn-group"}));a.appendChild(d);a.appendChild(b);this.addViewListener(function(A,D,O,B,G){h.value=A+":"+formatLongInt(D)+".."+formatLongInt(O);l.min=G.min|0;l.max=G.max|0;l.value=G.current|0;c.storeStatus&&c.storeViewStatus();o.style.display=c.highlights.length>0?"inline-block":"none"});this.addTierListener(function(){c.storeStatus&&c.storeTierStatus()});
h.addEventListener("keydown",function(A){if(A.keyCode==40){A.preventDefault();A.stopPropagation();c.setSelectedTier(0)}if(A.keyCode==10||A.keyCode==13){A.preventDefault();c.search(h.value,function(D){j.textContent=D?""+D:""})}},false);var H;q.addEventListener("click",function(A){if(H&&H.displayed)c.removeAllPopups();else H=c.showTrackAdder(A)},false);c.makeTooltip(q,"Add a new track from the registry or an indexed file. (A)");i.addEventListener("click",function(A){A.stopPropagation();A.preventDefault();
c.zoomStep(-10)},false);c.makeTooltip(i,"Zoom in (+)");m.addEventListener("click",function(A){A.stopPropagation();A.preventDefault();c.zoomStep(10)},false);c.makeTooltip(m,"Zoom out (-)");l.addEventListener("change",function(){c.zoomSliderValue=1*l.value;c.zoom(Math.exp(1*l.value/c.zoomExpt))},false);p.addEventListener("click",function(A){A.stopPropagation();A.preventDefault()},false);c.makeTooltip(p,"Favourite regions");s.addEventListener("click",function(A){A.stopPropagation();A.preventDefault();
c.openExportPanel()},false);c.makeTooltip(s,"Export publication-quality SVG. (P)");r.addEventListener("click",function(A){A.stopPropagation();A.preventDefault();c.toggleOptsPopup(A)},false);c.makeTooltip(r,"Configure options.");t.addEventListener("click",function(A){A.stopPropagation();A.preventDefault();c.toggleHelpPopup(A)});c.makeTooltip(t,"Help; Keyboard shortcuts. (H)");v.addEventListener("click",function(A){A.stopPropagation();A.preventDefault();c.selectedTiers.length==1&&c.openTierPanel(c.tiers[c.selectedTiers[0]])},
false);u.addEventListener("click",function(){c.leap(c.reverseKeyScrolling?-1:1,false)},false);c.makeTooltip(u,function(){var A=c.getSelectedTier(),D;if(A>=0)D=c.tiers[A];return D&&D.featureSource&&sourceAdapterIsCapable(D.featureSource,"quantLeap")&&typeof D.quantLeapThreshold=="number"?'Jump to the next region with a score above the threshold in the selected track "'+(D.config.name||D.dasSource.name)+'"" (ctrl+LEFT)':D&&D.featureSource&&sourceAdapterIsCapable(D.featureSource,"leap")?'Jump to the next feature in the selected track "'+
(D.config.name||D.dasSource.name)+'" (ctrl+LEFT)':"Jump left (shift+LEFT)"});x.addEventListener("click",function(){c.leap(c.reverseKeyScrolling?1:-1,false)},false);c.makeTooltip(x,function(){var A=c.getSelectedTier(),D;if(A>=0)D=c.tiers[A];return D&&D.featureSource&&sourceAdapterIsCapable(D.featureSource,"quantLeap")&&typeof D.quantLeapThreshold=="number"?'Jump to the next region with a score above the threshold in the selected track "'+(D.config.name||D.dasSource.name)+'"" (ctrl+RIGHT)':D&&D.featureSource&&
sourceAdapterIsCapable(D.featureSource,"leap")?'Jump to the next feature in the selected track "'+(D.config.name||D.dasSource.name)+'" (ctrl+RIGHT)':"Jump right (shift+RIGHT)"});o.addEventListener("click",function(){c.clearHighlights()},false);c.makeTooltip(o,"Clear highlights (C)");c.addTierSelectionWrapListener(function(A){if(A<0){c.setSelectedTier(null);h.focus()}});c.addTierSelectionListener(function(A){if(c.uiMode==="tier")if(A.length==0){c.hideToolPanel();c.manipulatingTier=null;c.uiMode="none"}else{A=
c.tiers[A[0]];A!=c.manipulatingTier&&c.openTierPanel(A)}});var C=function(A){if(A.keyCode==65||A.keyCode==97){A.preventDefault();A.stopPropagation();c.showTrackAdder()}else if(A.keyCode==72||A.keyCode==104){A.stopPropagation();A.preventDefault();c.toggleHelpPopup(A)}else if(A.keyCode==69||A.keyCode==101){A.stopPropagation();A.preventDefault();c.selectedTiers.length==1&&c.openTierPanel(c.tiers[c.selectedTiers[0]])}else if(A.keyCode==80||A.keyCode==112){A.stopPropagation();A.preventDefault();c.openExportPanel()}else if(A.keyCode==
67||A.keyCode==99){A.stopPropagation();A.preventDefault();c.clearHighlights()}};a.addEventListener("focus",function(){a.addEventListener("keydown",C,false)},false);a.addEventListener("blur",function(){a.removeEventListener("keydown",C,false)},false);a.addEventListener("keydown",function(A){if(A.keyCode===27){A.preventDefault();A.stopPropagation();c.uiMode="none";c.hideToolPanel();c.selectedTiers&&c.selectedTiers.length>0&&c.browserHolder.focus()}},false)};
Browser.prototype.showToolPanel=function(a,b){this.activeToolPanel&&this.activeToolPanel.parentElement.removeChild(this.activeToolPanel);var c;c=b?a:makeElement("div",a,{},{overflowY:"auto",width:"100%"});this.activeToolPanel=makeElement("div",[makeElement("div",null,{className:"tool-divider"}),c],{className:"tool-holder"});this.svgHolder.appendChild(this.activeToolPanel);this.resizeViewer()};
Browser.prototype.hideToolPanel=function(){this.activeToolPanel&&this.activeToolPanel.parentElement.removeChild(this.activeToolPanel);this.svgHolder.style.width="100%";this.activeToolPanel=null;this.resizeViewer()};
Browser.prototype.toggleHelpPopup=function(){if(this.uiMode==="help"){this.hideToolPanel();this.setUiMode("none")}else{this.showToolPanel(makeElement("iframe",null,{scrolling:"yes",seamless:"seamless",src:this.uiPrefix+"help/index.html",seamless:"seamless",className:"help-panel"}),true);this.setUiMode("help")}};
Browser.prototype.toggleOptsPopup=function(){var a=this;if(this.uiMode==="opts"){this.hideToolPanel();this.setUiMode("none")}else{var b=makeElement("div",null,{className:"form-horizontal"},{boxSizing:"border-box",MozBoxSizing:"border-box",display:"inline-block",verticalAlign:"top"}),c=makeElement("table");c.cellPadding=5;var d=makeElement("input","",{type:"checkbox",checked:a.reverseScrolling});d.addEventListener("change",function(){a.reverseScrolling=d.checked;a.storeStatus()},false);c.appendChild(makeElement("tr",
[makeElement("td","Reverse trackpad scrolling",{align:"right"}),makeElement("td",d)]));var e=makeElement("input","",{type:"checkbox",checked:a.reverseKeyScrolling});e.addEventListener("change",function(){a.reverseKeyScrolling=e.checked;a.storeStatus()},false);c.appendChild(makeElement("tr",[makeElement("td","Reverse scrolling buttons and keys",{align:"right"}),makeElement("td",e)]));var h=makeElement("select");h.appendChild(makeElement("option","Left",{value:"left"}));h.appendChild(makeElement("option",
"Center",{value:"center"}));h.appendChild(makeElement("option","Right",{value:"right"}));h.appendChild(makeElement("option","None",{value:"none"}));h.value=a.rulerLocation;h.addEventListener("change",function(){a.rulerLocation=h.value;a.positionRuler();for(var j=0;j<a.tiers.length;++j)a.tiers[j].paintQuant();a.storeStatus()},false);c.appendChild(makeElement("tr",[makeElement("td","Vertical guideline",{align:"right"}),makeElement("td",h)]));b.appendChild(c);c=makeElement("button","Reset browser",{className:"btn"},
{marginLeft:"auto",marginRight:"auto",display:"block"});c.addEventListener("click",function(){a.reset()},false);b.appendChild(c);this.showToolPanel(b);this.setUiMode("opts")}};function SVGPath(){this.ops=[]}SVGPath.prototype.moveTo=function(a,b){this.ops.push("M "+a+" "+b)};SVGPath.prototype.lineTo=function(a,b){this.ops.push("L "+a+" "+b)};SVGPath.prototype.closePath=function(){this.ops.push("Z")};SVGPath.prototype.toPathData=function(){return this.ops.join(" ")};
function PathGlyphBase(a,b){this._stroke=a;this._fill=b}PathGlyphBase.prototype.draw=function(a){a.beginPath();this.drawPath(a);if(this._fill){a.fillStyle=this._fill;a.fill()}if(this._stroke){a.strokeStyle=this._stroke;a.stroke()}};PathGlyphBase.prototype.toSVG=function(){var a=new SVGPath;this.drawPath(a);return makeElementNS(NS_SVG,"path",null,{d:a.toPathData(),fill:this._fill||"none",stroke:this._stroke||"none"})};
PathGlyphBase.prototype.drawPath=function(){throw"drawPath method on PathGlyphBase must be overridden";};function BoxGlyph(a,b,c,d,e,h,j,i){this.x=a;this.y=b;this._width=c;this._height=d;this.fill=e;this.stroke=h;this._alpha=j;this._radius=i||0}
BoxGlyph.prototype.draw=function(a){var b=this._radius;a.beginPath();if(b>0){a.moveTo(this.x+b,this.y);a.lineTo(this.x+this._width-b,this.y);a.arcTo(this.x+this._width,this.y,this.x+this._width,this.y+b,b);a.lineTo(this.x+this._width,this.y+this._height-b);a.arcTo(this.x+this._width,this.y+this._height,this.x+this._width-b,this.y+this._height,b);a.lineTo(this.x+b,this.y+this._height);a.arcTo(this.x,this.y+this._height,this.x,this.y+this._height-b,b);a.lineTo(this.x,this.y+b);a.arcTo(this.x,this.y,
this.x+b,this.y,b)}else{a.lineJoin="miter";a.lineCap="square";a.moveTo(this.x,this.y);a.lineTo(this.x+this._width,this.y);a.lineTo(this.x+this._width,this.y+this._height);a.lineTo(this.x,this.y+this._height);a.lineTo(this.x,this.y)}a.closePath();if(this._alpha!=null){a.save();a.globalAlpha=this._alpha}if(this.fill){a.fillStyle=this.fill;a.fill()}if(this.stroke){a.strokeStyle=this.stroke;a.lineWidth=0.5;a.stroke()}this._alpha!=null&&a.restore()};
BoxGlyph.prototype.toSVG=function(){var a=makeElementNS(NS_SVG,"rect",null,{x:this.x,y:this.y,width:this._width,height:this._height,stroke:this.stroke||"none",strokeWidth:0.5,fill:this.fill||"none"});this._alpha!=null&&a.setAttribute("opacity",this._alpha);return a};BoxGlyph.prototype.min=function(){return this.x};BoxGlyph.prototype.max=function(){return this.x+this._width};BoxGlyph.prototype.height=function(){return this.y+this._height};
function GroupGlyph(a,b){this.glyphs=a;this.connector=b;this.h=a[0].height();var c=new Range(a[0].min(),a[0].max());for(g=1;g<a.length;++g){var d=a[g];c=union(c,new Range(d.min(),d.max()));this.h=Math.max(this.h,d.height())}this.coverage=c}
GroupGlyph.prototype.drawConnectors=function(a){for(var b=this.coverage.ranges(),c=1;c<b.length;++c){var d=b[c],e=b[c-1];if(e&&d.min()>e.max()){e=e.max();d=d.min();var h=(e+d)/2;if(this.connector==="hat+"){a.moveTo(e,this.h/2);a.lineTo(h,0);a.lineTo(d,this.h/2)}else if(this.connector==="hat-"){a.moveTo(e,this.h/2);a.lineTo(h,this.h);a.lineTo(d,this.h/2)}else if(this.connector==="collapsed+"){a.moveTo(e,this.h/2);a.lineTo(d,this.h/2);if(d-e>4){a.moveTo(h-2,this.h/2-3);a.lineTo(h+2,this.h/2);a.lineTo(h-
2,this.h/2+3)}}else if(this.connector==="collapsed-"){a.moveTo(e,this.h/2);a.lineTo(d,this.h/2);if(d-e>4){a.moveTo(h+2,this.h/2-3);a.lineTo(h-2,this.h/2);a.lineTo(h+2,this.h/2+3)}}else{a.moveTo(e,this.h/2);a.lineTo(d,this.h/2)}}}};GroupGlyph.prototype.draw=function(a){for(var b=0;b<this.glyphs.length;++b)this.glyphs[b].draw(a);a.strokeStyle="black";a.beginPath();this.drawConnectors(a);a.stroke()};
GroupGlyph.prototype.toSVG=function(){for(var a=makeElementNS(NS_SVG,"g"),b=0;b<this.glyphs.length;++b)a.appendChild(this.glyphs[b].toSVG());b=new SVGPath;this.drawConnectors(b);b=makeElementNS(NS_SVG,"path",null,{d:b.toPathData(),fill:"none",stroke:"black",strokeWidth:0.5});a.appendChild(b);return a};GroupGlyph.prototype.min=function(){return this.coverage.min()};GroupGlyph.prototype.max=function(){return this.coverage.max()};GroupGlyph.prototype.height=function(){return this.h};
function LineGraphGlyph(a,b,c){this.points=a;this.color=b;this._height=c||50}LineGraphGlyph.prototype.min=function(){return this.points[0]};LineGraphGlyph.prototype.max=function(){return this.points[this.points.length-2]};LineGraphGlyph.prototype.height=function(){return this._height};
LineGraphGlyph.prototype.draw=function(a){a.save();a.strokeStyle=this.color;a.lineWidth=2;a.beginPath();for(var b=0;b<this.points.length;b+=2){var c=this.points[b],d=this.points[b+1];b==0?a.moveTo(c,d):a.lineTo(c,d)}a.stroke();a.restore()};LineGraphGlyph.prototype.toSVG=function(){for(var a=new SVGPath,b=0;b<this.points.length;b+=2){var c=this.points[b],d=this.points[b+1];b==0?a.moveTo(c,d):a.lineTo(c,d)}return makeElementNS(NS_SVG,"path",null,{d:a.toPathData(),fill:"none",stroke:this.color,strokeWidth:"2px"})};
function LabelledGlyph(a,b,c,d,e,h){this.glyph=a;this.text=b;this.anchor=d||"left";this.align=e||"below";if(h)this.font=h;if(this.font){GLOBAL_GC.save();GLOBAL_GC.font=this.font}b=GLOBAL_GC.measureText(b);this.font&&GLOBAL_GC.restore();this.textLen=b.width;this.textHeight=5;this.bump=a.bump;this.measured=!c}
LabelledGlyph.prototype.toSVG=function(){var a=this.glyph.toSVG(),b={};if(this.align=="above"){a=makeElementNS(NS_SVG,"g",a,{transform:"translate(0, "+(this.textHeight|2)+")"});b.y=this.textHeight}else b.y=this.glyph.height()+15;if(this.font)b.fontSize=7;b.x="center"==this.anchor?(this.glyph.min()+this.glyph.max()-this.textLen)/2:this.glyph.min();return makeElementNS(NS_SVG,"g",[a,makeElementNS(NS_SVG,"text",this.text,b)])};LabelledGlyph.prototype.min=function(){return this.glyph.min()};
LabelledGlyph.prototype.max=function(){return this.measured?Math.max(this.glyph.max(),1*this.glyph.min()+this.textLen+10):this.glyph.max()};LabelledGlyph.prototype.height=function(){var a=this.glyph.height();if(this.measured)a+=this.align=="above"?this.textHeight+2:20;return a};
LabelledGlyph.prototype.draw=function(a){if(this.align=="above"){a.save();a.translate(0,this.textHeight+2)}this.glyph.draw(a);this.align=="above"&&a.restore();a.fillStyle="black";if(this.font){a.save();a.font=this.font}var b;b="center"==this.anchor?(this.glyph.min()+this.glyph.max()-this.textLen)/2:this.glyph.min();a.fillText(this.text,b,this.align=="above"?this.textHeight:this.glyph.height()+15);this.font&&a.restore()};function CrossGlyph(a,b,c){this._x=a;this._height=b;this._stroke=c}
CrossGlyph.prototype.draw=function(a){var b=this._height/2;a.beginPath();a.moveTo(this._x,0);a.lineTo(this._x,this._height);a.moveTo(this._x-b,b);a.lineTo(this._x+b,b);a.strokeStyle=this._stroke;a.lineWidth=1;a.stroke()};CrossGlyph.prototype.toSVG=function(){var a=this._height/2,b=new SVGPath;b.moveTo(this._x,0);b.lineTo(this._x,this._height);b.moveTo(this._x-a,a);b.lineTo(this._x+a,a);return makeElementNS(NS_SVG,"path",null,{d:b.toPathData(),fill:"none",stroke:this._stroke,strokeWidth:"1px"})};
CrossGlyph.prototype.min=function(){return this._x-this._height/2};CrossGlyph.prototype.max=function(){return this._x+this._height/2};CrossGlyph.prototype.height=function(){return this._height};function ExGlyph(a,b,c){this._x=a;this._height=b;this._stroke=c}ExGlyph.prototype.draw=function(a){var b=this._height/2;a.beginPath();a.moveTo(this._x-b,0);a.lineTo(this._x+b,this._height);a.moveTo(this._x-b,this._height);a.lineTo(this._x+b,0);a.strokeStyle=this._stroke;a.lineWidth=1;a.stroke()};
ExGlyph.prototype.toSVG=function(){var a=this._height/2,b=new SVGPath;b.moveTo(this._x-a,0);b.lineTo(this._x+a,this._height);b.moveTo(this._x-a,this._height);b.lineTo(this._x+a,0);return makeElementNS(NS_SVG,"path",null,{d:b.toPathData(),fill:"none",stroke:this._stroke,strokeWidth:"1px"})};ExGlyph.prototype.min=function(){return this._x-this._height/2};ExGlyph.prototype.max=function(){return this._x+this._height/2};ExGlyph.prototype.height=function(){return this._height};
function TriangleGlyph(a,b,c,d,e,h){PathGlyphBase.call(this,h,e);this._x=a;this._height=b;this._dir=c;this._width=d}TriangleGlyph.prototype=Object.create(PathGlyphBase.prototype);
TriangleGlyph.prototype.drawPath=function(a){var b=this._height/2,c=this._width/2;if(this._dir==="S"){a.moveTo(this._x,this._height);a.lineTo(this._x-c,0);a.lineTo(this._x+c,0)}else if(this._dir==="W"){a.moveTo(this._x+c,b);a.lineTo(this._x-c,0);a.lineTo(this._x-c,this._height)}else if(this._dir==="E"){a.moveTo(this._x-c,b);a.lineTo(this._x+c,0);a.lineTo(this._x+c,this._height)}else{a.moveTo(this._x,0);a.lineTo(this._x+c,this._height);a.lineTo(this._x-c,this._height)}a.closePath()};
TriangleGlyph.prototype.min=function(){return this._x-this._height/2};TriangleGlyph.prototype.max=function(){return this._x+this._height/2};TriangleGlyph.prototype.height=function(){return this._height};function DotGlyph(a,b,c,d){this._x=a;this._height=b;this._fill=c;this._stroke=d}DotGlyph.prototype.draw=function(a){var b=this._height/2;a.fillStyle=this._stroke;a.beginPath();a.arc(this._x,b,b,0,6.29);if(this._fill){a.fillStyle=this._fill;a.fill()}if(this._stroke){a.strokeStyle=this._stroke;a.stroke()}};
DotGlyph.prototype.toSVG=function(){var a=this._height/2;return makeElementNS(NS_SVG,"circle",null,{cx:this._x,cy:a,r:a,fill:this._fill||"none",stroke:this._stroke||"none",strokeWidth:"1px"})};DotGlyph.prototype.min=function(){return this._x-this._height/2};DotGlyph.prototype.max=function(){return this._x+this._height/2};DotGlyph.prototype.height=function(){return this._height};function PaddedGlyph(a,b,c){this.glyph=a;this._min=b;this._max=c;if(a)this.bump=a.bump}
PaddedGlyph.prototype.draw=function(a){this.glyph&&this.glyph.draw(a)};PaddedGlyph.prototype.toSVG=function(){return this.glyph?this.glyph.toSVG():makeElementNS(NS_SVG,"g")};PaddedGlyph.prototype.min=function(){return this._min};PaddedGlyph.prototype.max=function(){return this._max};PaddedGlyph.prototype.height=function(){return this.glyph?this.glyph.height():1};function AArrowGlyph(a,b,c,d,e,h){PathGlyphBase.call(this,e,d);this._min=a;this._max=b;this._height=c;this._ori=h}
AArrowGlyph.prototype=Object.create(PathGlyphBase.prototype);AArrowGlyph.prototype.min=function(){return this._min};AArrowGlyph.prototype.max=function(){return this._max};AArrowGlyph.prototype.height=function(){return this._height};
AArrowGlyph.prototype.drawPath=function(a){var b=this._max,c=this._min,d=this._height,e=0,h=0,j=this._height+2,i=0.333333*this._height;if(this._ori)if(this._ori==="+")h=0.5*this._height;else if(this._ori==="-")e=0.5*this._height;if(b-c<j){c=(b+c-j)/2;b=c+j}a.moveTo(c+e,0+i);a.lineTo(b-h,0+i);a.lineTo(b-h,0);a.lineTo(b,0+this._height/2);a.lineTo(b-h,0+d);a.lineTo(b-h,0+i+i);a.lineTo(c+e,0+i+i);a.lineTo(c+e,0+d);a.lineTo(c,0+d/2);a.lineTo(c+e,0);a.lineTo(c+e,0+i)};
function SpanGlyph(a,b,c,d){PathGlyphBase.call(this,d,null);this._min=a;this._max=b;this._height=c}SpanGlyph.prototype=Object.create(PathGlyphBase.prototype);SpanGlyph.prototype.min=function(){return this._min};SpanGlyph.prototype.max=function(){return this._max};SpanGlyph.prototype.height=function(){return this._height};SpanGlyph.prototype.drawPath=function(a){var b=this._min,c=this._max,d=this._height,e=d/2;a.moveTo(b,e);a.lineTo(c,e);a.moveTo(b,0);a.lineTo(b,d);a.moveTo(c,0);a.lineTo(c,d)};
function LineGlyph(a,b,c,d,e,h){this._min=a;this._max=b;this._height=c;this._style=d;this._strand=e;this._stroke=h}LineGlyph.prototype.min=function(){return this._min};LineGlyph.prototype.max=function(){return this._max};LineGlyph.prototype.height=function(){return this._height};LineGlyph.prototype.drawPath=function(a){var b=this._min,c=this._max,d=this._height,e=d/2;if(this._style==="hat"){a.moveTo(b,e);a.lineTo((b+c)/2,this._strand==="-"?d:0)}else a.moveTo(b,e);a.lineTo(c,e)};
LineGlyph.prototype.draw=function(a){a.beginPath();this.drawPath(a);a.strokeStyle=this._stroke;if(this._style==="dashed"&&a.setLineDash){a.save();a.setLineDash([3]);a.stroke();a.restore()}else a.stroke()};LineGlyph.prototype.toSVG=function(){var a=new SVGPath;this.drawPath(a);a={d:a.toPathData(),stroke:this._stroke||"none"};if(this._style==="dashed")a.strokeDasharray="3";return makeElementNS(NS_SVG,"path",null,a)};
function PrimersGlyph(a,b,c,d,e){this._min=a;this._max=b;this._height=c;this._fill=d;this._stroke=e}PrimersGlyph.prototype.min=function(){return this._min};PrimersGlyph.prototype.max=function(){return this._max};PrimersGlyph.prototype.height=function(){return this._height};PrimersGlyph.prototype.drawStemPath=function(a){var b=this._max,c=this._height/2;a.moveTo(this._min,c);a.lineTo(b,c)};
PrimersGlyph.prototype.drawTrigsPath=function(a){var b=this._min,c=this._max,d=this._height,e=d/2;a.moveTo(b,0);a.lineTo(b+d,e);a.lineTo(b,d);a.lineTo(b,0);a.moveTo(c,0);a.lineTo(c-d,e);a.lineTo(c,d);a.lineTo(c,0)};PrimersGlyph.prototype.draw=function(a){a.beginPath();this.drawStemPath(a);a.strokeStyle=this._stroke;a.stroke();a.beginPath();this.drawTrigsPath(a);a.fillStyle=this._fill;a.fill()};
PrimersGlyph.prototype.toSVG=function(){var a=new SVGPath;this.drawStemPath(a);var b=new SVGPath;this.drawTrigsPath(b);return makeElementNS(NS_SVG,"g",[makeElementNS(NS_SVG,"path",null,{d:a.toPathData(),stroke:this._stroke||"none"}),makeElementNS(NS_SVG,"path",null,{d:b.toPathData(),fill:this._fill||"none"})])};function ArrowGlyph(a,b,c,d,e,h,j){PathGlyphBase.call(this,null,d);this._min=a;this._max=b;this._height=c;this._color=d;this._parallel=e;this._sw=h;this._ne=j}ArrowGlyph.prototype=Object.create(PathGlyphBase.prototype);
ArrowGlyph.prototype.min=function(){return this._min};ArrowGlyph.prototype.max=function(){return this._max};ArrowGlyph.prototype.height=function(){return this._height};
ArrowGlyph.prototype.drawPath=function(a){var b=this._min,c=this._max,d=this._height;if(this._parallel){var e=d/2,h=0.4*d;if(this._sw){a.moveTo(b+e,d-h);a.lineTo(b+e,d);a.lineTo(b,e);a.lineTo(b+e,0);a.lineTo(b+e,h)}else{a.moveTo(b,d-h);a.lineTo(b,h)}if(this._ne){a.lineTo(c-e,h);a.lineTo(c-e,0);a.lineTo(c,e);a.lineTo(c-e,d);a.lineTo(c-e,d-h)}else{a.lineTo(c,h);a.lineTo(c,d-h)}}else{e=(b+c)/2;h=0.4*(c-b);var j=d/3;if(this._ne){a.moveTo(b+h,j);a.lineTo(b,j);a.lineTo(e,0);a.lineTo(c,j);a.lineTo(c-h,j)}else{a.moveTo(b+
h,0);a.lineTo(c-h,0)}if(this._sw){a.lineTo(c-h,d-j);a.lineTo(c,d-j);a.lineTo(e,d);a.lineTo(b,d-j);a.lineTo(b+h,d-j)}else{a.lineTo(c-h,d);a.lineTo(b+h,d)}}a.closePath()};function TooManyGlyph(a,b,c,d,e){this._min=a;this._max=b;this._height=c;this._fill=d;this._stroke=e}TooManyGlyph.prototype.min=function(){return this._min};TooManyGlyph.prototype.max=function(){return this._max};TooManyGlyph.prototype.height=function(){return this._height};
TooManyGlyph.prototype.toSVG=function(){return makeElementNS(NS_SVG,"rect",null,{x:this._min,y:0,width:this._max-this._min,height:this._height,stroke:this._stroke||"none",fill:this._fill||"none"})};
TooManyGlyph.prototype.draw=function(a){if(this._fill){a.fillStyle=this._fill;a.fillRect(this._min,0,this._max-this._min,this._height)}if(this._stroke){a.strokeStyle=this._stroke;a.strokeRect(this._min,0,this._max-this._min,this._height);a.beginPath();for(var b=2;b<this._height;b+=3){a.moveTo(this._min,b);a.lineTo(this._max,b)}a.stroke()}};function TextGlyph(a,b,c,d,e){this._min=a;this._max=b;this._height=c;this._fill=d;this._string=e;this._textLen=GLOBAL_GC.measureText(e).width}
TextGlyph.prototype.min=function(){return this._min};TextGlyph.prototype.max=function(){return Math.max(this._max,this._min+this._textLen)};TextGlyph.prototype.height=function(){return this._height};TextGlyph.prototype.draw=function(a){a.fillStyle=this._fill;a.fillText(this._string,this._min,this._height-4)};TextGlyph.prototype.toSVG=function(){return makeElementNS(NS_SVG,"text",this._string,{x:this._min,y:this._height-4})};
function SequenceGlyph(a,b,c,d,e,h,j){this._min=a;this._max=b;this._height=c;this._seq=d;this._ref=e;this._scheme=h;this._quals=j}SequenceGlyph.prototype.min=function(){return this._min};SequenceGlyph.prototype.max=function(){return this._max};SequenceGlyph.prototype.height=function(){return this._height};SequenceGlyph.prototype.alphaForQual=function(a){return 0.1+0.9*Math.max(0,Math.min(1*a/30,1))};
SequenceGlyph.prototype.draw=function(a){for(var b=this._seq,c=(this._max-this._min+1)/this._seq.length,d=0;d<b.length;++d){var e=b.substr(d,1).toUpperCase(),h=baseColors[e];h||(h="gray");if(this._scheme==="mismatch"&&this._ref){h=this._ref.substr(d,1).toUpperCase();h=h==="N"?"gray":h===e?"black":"red"}a.fillStyle=h;if(this._quals){h=this._quals.charCodeAt(d)-33;a.save();a.globalAlpha=this.alphaForQual(h)}c>=8?a.fillText(e,this._min+d*c,8):a.fillRect(this._min+d*c,0,c,this._height);this._quals&&a.restore()}};
SequenceGlyph.prototype.toSVG=function(){for(var a=this._seq,b=(this._max-this._min+1)/this._seq.length,c=makeElementNS(NS_SVG,"g"),d=0;d<a.length;++d){var e=a.substr(d,1).toUpperCase(),h=baseColors[e];h||(h="gray");if(this._scheme==="mismatch"&&this._ref){h=this._ref.substr(d,1).toUpperCase();h=h==="N"?"gray":h===e?"black":"red"}var j=1;if(this._quals)j=this.alphaForQual(this._quals.charCodeAt(d)-33);b>=8?c.appendChild(makeElementNS(NS_SVG,"text",e,{x:this._min+d*b,y:8,fill:h,fillOpacity:j})):c.appendChild(makeElementNS(NS_SVG,
"rect",null,{x:this._min+d*b,y:0,width:b,height:this._height,fill:h,fillOpacity:j}))}return c};function TranslatedGlyph(a,b,c,d){this.glyph=a;this._height=d;this._x=b;this._y=c}TranslatedGlyph.prototype.height=function(){return this._height?this._height:this.glyph.height()+this._y};TranslatedGlyph.prototype.min=function(){return this.glyph.min()+this._x};TranslatedGlyph.prototype.max=function(){return this.glyph.max()+this._x};TranslatedGlyph.prototype.minY=function(){return this._y};
TranslatedGlyph.prototype.maxY=function(){return this._y+this.glyph.height()};TranslatedGlyph.prototype.draw=function(a){a.save();a.translate(this._x,this._y);this.glyph.draw(a);a.restore()};TranslatedGlyph.prototype.toSVG=function(){var a=this.glyph.toSVG();a.setAttribute("transform","translate("+this._x+","+this._y+")");return a};function PointGlyph(a,b,c,d){this._x=a;this._y=b;this._height=c;this._fill=d}PointGlyph.prototype.min=function(){return this._x-2};
PointGlyph.prototype.max=function(){return this._x+2};PointGlyph.prototype.height=function(){return this._height};PointGlyph.prototype.draw=function(a){a.save();a.globalAlpha=0.3;a.fillStyle=this._fill;a.beginPath();a.arc(this._x,this._y,1.5,0,6.29);a.fill();a.restore()};PointGlyph.prototype.toSVG=function(){return makeElementNS(NS_SVG,"circle",null,{cx:this._x,cy:this._y,r:2,fill:this._fill,stroke:"none"})};function GridGlyph(a){this._height=a||50}GridGlyph.prototype.notSelectable=true;
GridGlyph.prototype.min=function(){return-100000};GridGlyph.prototype.max=function(){return 1E5};GridGlyph.prototype.height=function(){return this._height};GridGlyph.prototype.draw=function(a){a.save();a.strokeStyle="black";a.lineWidth=0.1;a.beginPath();for(var b=0;b<=this._height;b+=10){a.moveTo(-5000,b);a.lineTo(5E3,b)}a.stroke();a.restore()};
GridGlyph.prototype.toSVG=function(){for(var a=new SVGPath,b=0;b<=this._height;b+=10){a.moveTo(-5000,b);a.lineTo(5E3,b)}return makeElementNS(NS_SVG,"path",null,{d:a.toPathData(),fill:"none",stroke:"black",strokeWidth:"0.1px"})};function StarGlyph(a,b,c,d,e){PathGlyphBase.call(this,e,d);this._x=a;this._r=b;this._points=c}StarGlyph.prototype=Object.create(PathGlyphBase.prototype);StarGlyph.prototype.min=function(){return this._x-this._r};StarGlyph.prototype.max=function(){return this._x+this._r};
StarGlyph.prototype.height=function(){return 2*this._r};StarGlyph.prototype.drawPath=function(a){for(var b=this._x,c=this._r,d=this._r,e=0;e<this._points;++e){var h=e*6.28/this._points,j=b+d*Math.sin(h);h=c-d*Math.cos(h);e==0?a.moveTo(j,h):a.lineTo(j,h);h=(e+0.5)*6.28/this._points;j=b+0.4*d*Math.sin(h);h=c-0.4*d*Math.cos(h);a.lineTo(j,h)}a.closePath()};function PlimsollGlyph(a,b,c,d,e){this._x=a;this._height=b;this._overhang=c;this._fill=d;this._stroke=e;this._hh=b/2}
PlimsollGlyph.prototype.draw=function(a){var b=this._height/2;a.fillStyle=this._stroke;a.beginPath();a.arc(this._x,b,b-this._overhang,0,6.29);a.moveTo(this._x,0);a.lineTo(this._x,this._height);if(this._fill){a.fillStyle=this._fill;a.fill()}if(this._stroke){a.strokeStyle=this._stroke;a.stroke()}};
PlimsollGlyph.prototype.toSVG=function(){var a=this._hh;return makeElementNS(NS_SVG,"g",[makeElementNS(NS_SVG,"circle",null,{cx:this._x,cy:a,r:a-this._overhang}),makeElementNS(NS_SVG,"line",null,{x1:this._x,y1:0,x2:this._x,y2:this._height})],{fill:this._fill||"none",stroke:this._stroke||"none",strokeWidth:"1px"})};PlimsollGlyph.prototype.min=function(){return this._x-this._hh};PlimsollGlyph.prototype.max=function(){return this._x+this._hh};PlimsollGlyph.prototype.height=function(){return this._height};
Browser.prototype.nukeStatus=function(){delete localStorage["dalliance."+this.cookieKey+".view-chr"];delete localStorage["dalliance."+this.cookieKey+".view-start"];delete localStorage["dalliance."+this.cookieKey+".view-end"];delete localStorage["dalliance."+this.cookieKey+".current-seq-length"];delete localStorage["dalliance."+this.cookieKey+".showing-alt-zoom"];delete localStorage["dalliance."+this.cookieKey+".saved-zoom"];delete localStorage["dalliance."+this.cookieKey+".sources"];delete localStorage["dalliance."+
this.cookieKey+".hubs"];delete localStorage["dalliance."+this.cookieKey+".version"];delete localStorage["dalliance."+this.cookieKey+".reverse-scrolling"];delete localStorage["dalliance."+this.cookieKey+".reverse-key-scrolling"];delete localStorage["dalliance."+this.cookieKey+".ruler-location"]};Browser.prototype.storeStatus=function(){this.storeViewStatus();this.storeTierStatus()};
Browser.prototype.storeViewStatus=function(){if(!(!this.cookieKey||this.noPersist||this.noPersistView)){localStorage["dalliance."+this.cookieKey+".view-chr"]=this.chr;localStorage["dalliance."+this.cookieKey+".view-start"]=this.viewStart|0;localStorage["dalliance."+this.cookieKey+".view-end"]=this.viewEnd|0;localStorage["dalliance."+this.cookieKey+".showing-alt-zoom"]=""+this.isSnapZooming;localStorage["dalliance."+this.cookieKey+".saved-zoom"]=this.savedZoom;if(this.currentSeqMax)localStorage["dalliance."+
this.cookieKey+".current-seq-length"]=this.currentSeqMax}};
Browser.prototype.storeTierStatus=function(){if(!(!this.cookieKey||this.noPersist)){for(var a=[],b=0;b<this.tiers.length;++b){var c=this.tiers[b];c.dasSource.noPersist||a.push({source:c.dasSource,config:c.config||{}})}localStorage["dalliance."+this.cookieKey+".sources"]=JSON.stringify(a);a={};b=[];for(c=0;c<this.hubObjects.length;++c){var d=this.hubObjects[c],e={url:d.hub.url,genome:d.genome};if(d.credentials)e.credentials=d.credentials;if(d.mapping)e.mapping=d.mapping;a[e.url]=true;b.push(e)}for(c=
0;c<this.hubs.length;++c){e=this.hubs[c];if(typeof e==="string")e={url:e};a[e.url]||b.push(e)}localStorage["dalliance."+this.cookieKey+".hubs"]=JSON.stringify(b);localStorage["dalliance."+this.cookieKey+".reverse-scrolling"]=this.reverseScrolling;localStorage["dalliance."+this.cookieKey+".reverse-key-scrolling"]=this.reverseKeyScrolling;localStorage["dalliance."+this.cookieKey+".ruler-location"]=this.rulerLocation;localStorage["dalliance."+this.cookieKey+".export-ruler"]=this.exportRuler;localStorage["dalliance."+
this.cookieKey+".export-highlights"]=this.exportHighlights;localStorage["dalliance."+this.cookieKey+".version"]=VERSION.CONFIG}};
Browser.prototype.restoreStatus=function(){if(!this.noPersist){var a=localStorage["dalliance."+this.cookieKey+".version"];a=a?a|0:-100;if(VERSION.CONFIG==a){a=localStorage["dalliance."+this.cookieKey+".configHash"]||"";var b=hex_sha1(miniJSONify({sources:this.sources,hubs:this.hubs}));if(b!=a)localStorage["dalliance."+this.cookieKey+".configHash"]=b;else{a={};for(b=0;b<this.sources.length;++b){var c=this.sources[b],d=sourceDataURI(c),e=a[d];e||(a[d]=e=[]);e.push(c)}if(!this.noPersistView){b=localStorage["dalliance."+
this.cookieKey+".view-chr"];c=localStorage["dalliance."+this.cookieKey+".view-start"]|0;e=localStorage["dalliance."+this.cookieKey+".view-end"]|0;if(b&&c&&e){this.chr=b;this.viewStart=c;this.viewEnd=e;if(b=localStorage["dalliance."+this.cookieKey+".current-seq-length"])this.currentSeqMax=b|0;this.isSnapZooming=localStorage["dalliance."+this.cookieKey+".showing-alt-zoom"]=="true";b=parseFloat(localStorage["dalliance."+this.cookieKey+".saved-zoom"]);if(typeof b==="number"&&!isNaN(b))this.savedZoom=
b}}this.reverseScrolling=(b=localStorage["dalliance."+this.cookieKey+".reverse-scrolling"])&&b=="true";this.reverseKeyScrolling=(b=localStorage["dalliance."+this.cookieKey+".reverse-key-scrolling"])&&b=="true";if(b=localStorage["dalliance."+this.cookieKey+".ruler-location"])this.rulerLocation=b;if(b=localStorage["dalliance."+this.cookieKey+".export-ruler"])this.exportRuler=b==="true";if(b=localStorage["dalliance."+this.cookieKey+".export-highlights"])this.exportHighlights=b==="true";if(b=localStorage["dalliance."+
this.cookieKey+".sources"]){var h=JSON.parse(b);this.sources=[];this.restoredConfigs=[];for(b=0;b<h.length;++b){c=this.sources[b]=h[b].source;this.restoredConfigs[b]=h[b].config;d=sourceDataURI(c);e=a[d]||[];for(d=0;d<e.length;++d){var j=e[d];if(sourcesAreEqual(c,j))if(j.featureInfoPlugin)c.featureInfoPlugin=j.featureInfoPlugin}}}if(a=localStorage["dalliance."+this.cookieKey+".hubs"])this.hubs=JSON.parse(a);return true}}}};
Browser.prototype.reset=function(){for(var a=this.tiers.length-1;a>=0;--a)this.removeTier({index:a},true);for(a=0;a<this.defaultSources.length;++a)this.defaultSources[a].disabled||this.addTier(this.defaultSources[a]);this.highlights.splice(0,this.highlights.length);this.setLocation(this.defaultChr,this.defaultStart,this.defaultEnd)};var __dalliance_sourceAdapterFactories={};function dalliance_registerSourceAdapterFactory(a,b){__dalliance_sourceAdapterFactories[a]=b}
DasTier.prototype.initSources=function(){var a=this,b=new DummyFeatureSource,c;if(this.dasSource.tier_type=="sequence")c=this.dasSource.twoBitURI?new TwoBitSequenceSource(this.dasSource):new DASSequenceSource(this.dasSource);else b=this.browser.createFeatureSource(this.dasSource);this.featureSource=b;this.sequenceSource=c;this.featureSource&&this.featureSource.addChangeListener&&this.featureSource.addChangeListener(function(){a.browser.refreshTier(a)})};
Browser.prototype.createFeatureSource=function(a){var b=this.sourceCache.get(a);if(b)return b;if(a.tier_type&&__dalliance_sourceAdapterFactories[a.tier_type])b=__dalliance_sourceAdapterFactories[a.tier_type](a).features;else if(a.bwgURI||a.bwgBlob)b=new BWGFeatureSource(a);else if(a.bamURI||a.bamBlob)b=new BAMFeatureSource(a);else if(a.bamblrURI)b=new BamblrFeatureSource(a);else if(a.jbURI)b=new JBrowseFeatureSource(a);else if(a.uri||a.features_uri)b=new DASFeatureSource(a);if(a.overlay){var c=[];
b&&c.push(new CachingFeatureSource(b));for(b=0;b<a.overlay.length;++b)c.push(this.createFeatureSource(a.overlay[b]));b=new OverlayFeatureSource(c,a)}if(a.mapping)b=new MappedFeatureSource(b,this.chains[a.mapping]);if(a.name&&!b.name)b.name=a.name;if(b!=null){b=new CachingFeatureSource(b);this.sourceCache.put(a,b)}return b};function SourceCache(){this.sourcesByURI={}}
SourceCache.prototype.get=function(a){var b=this.sourcesByURI[sourceDataURI(a)];if(b)for(var c=0;c<b.configs.length;++c)if(sourcesAreEqual(b.configs[c],a))return b.sources[c]};SourceCache.prototype.put=function(a,b){var c=sourceDataURI(a),d=this.sourcesByURI[c];if(!d){d={configs:[],sources:[]};this.sourcesByURI[c]=d}d.configs.push(a);d.sources.push(b)};var __cfs_id_seed=0;
function CachingFeatureSource(a){var b=this;this.source=a;this.cfsid="cfs"+ ++__cfs_id_seed;if(a.name)this.name=a.name;a.addChangeListener&&a.addChangeListener(function(){b.cfsid="cfs"+ ++__cfs_id_seed})}CachingFeatureSource.prototype.addReadinessListener=function(a){if(this.source.addReadinessListener)return this.source.addReadinessListener(a);else a(null)};CachingFeatureSource.prototype.search=function(a,b){if(this.source.search)return this.source.search(a,b)};
CachingFeatureSource.prototype.getDefaultFIPs=function(a){if(this.source.getDefaultFIPs)return this.source.getDefaultFIPs(a)};CachingFeatureSource.prototype.getStyleSheet=function(a){this.source.getStyleSheet(a)};CachingFeatureSource.prototype.getScales=function(){return this.source.getScales()};CachingFeatureSource.prototype.addActivityListener=function(a){this.source.addActivityListener&&this.source.addActivityListener(a)};
CachingFeatureSource.prototype.addChangeListener=function(a){this.source.addChangeListener&&this.source.addChangeListener(a)};CachingFeatureSource.prototype.findNextFeature=function(a,b,c,d){this.source.findNextFeature(a,b,c,d)};CachingFeatureSource.prototype.quantFindNextFeature=function(a,b,c,d,e){this.source.quantFindNextFeature(a,b,c,d,e)};CachingFeatureSource.prototype.capabilities=function(){return this.source.capabilities?this.source.capabilities():{}};
CachingFeatureSource.prototype.fetch=function(a,b,c,d,e,h,j){if(h==null)throw"pool is null...";var i=h.awaitedFeatures[this.cfsid];if(!i){i=new Awaited;h.awaitedFeatures[this.cfsid]=i;this.source.fetch(a,b,c,d,e,h,function(l,m,o){i.res||i.provide({status:l,features:m,scale:o})})}i.await(function(l){j(l.status,l.features,l.scale)})};function FeatureSourceBase(){this.busy=0;this.activityListeners=[];this.readinessListeners=[];this.readiness=null}
FeatureSourceBase.prototype.addReadinessListener=function(a){this.readinessListeners.push(a);a(this.readiness)};FeatureSourceBase.prototype.notifyReadiness=function(){for(var a=0;a<this.readinessListeners.length;++a)try{this.readinessListeners[a](this.readiness)}catch(b){console.log(b)}};FeatureSourceBase.prototype.addActivityListener=function(a){this.activityListeners.push(a)};FeatureSourceBase.prototype.notifyActivity=function(){for(var a=0;a<this.activityListeners.length;++a)try{this.activityListeners[a](this.busy)}catch(b){console.log(b)}};
FeatureSourceBase.prototype.getScales=function(){return null};FeatureSourceBase.prototype.fetch=function(a,b,c,d,e,h,j){return j(null,[],1E9)};FeatureSourceBase.prototype.getStyleSheet=function(a){var b=new DASStylesheet,c=new DASStyle;c.glyph="BOX";c.BGCOLOR="blue";c.FGCOLOR="black";b.pushStyle({type:"default"},null,c);return a(b)};function DASFeatureSource(a){this.dasSource=a;this.busy=0;this.activityListeners=[]}DASFeatureSource.prototype.addActivityListener=function(a){this.activityListeners.push(a)};
DASFeatureSource.prototype.notifyActivity=function(){for(var a=0;a<this.activityListeners.length;++a)try{this.activityListeners[a](this.busy)}catch(b){console.log(b)}};DASFeatureSource.prototype.getStyleSheet=function(a){this.dasSource.stylesheet(function(b){a(b)},function(){a(null,"Couldn't fetch DAS stylesheet")})};
DASFeatureSource.prototype.fetch=function(a,b,c,d,e,h,j){if(e&&e.length==0)j(null,[],d);else if(this.dasSource.uri||this.dasSource.features_uri){if(this.dasSource.dasStaticFeatures&&this.cachedStaticFeatures)return j(null,this.cachedStaticFeatures,this.cachedStaticScale);var i=this.dasSource.maxbins!==false;e={type:e};if(i)e.maxbins=1+((c-b)/d|0);var l=this;l.busy++;l.notifyActivity();this.dasSource.features(new DASSegment(a,b,c),e,function(m,o){l.busy--;l.notifyActivity();var q=d;i||(q=0.1);if(!o&&
l.dasSource.dasStaticFeatures){l.cachedStaticFeatures=m;l.cachedStaticScale=q}j(o,m,q)})}};
DASFeatureSource.prototype.findNextFeature=this.sourceFindNextFeature=function(a,b,c,d){if(this.dasSource.capabilities&&arrayIndexOf(this.dasSource.capabilities,"das1:adjacent-feature")>=0){var e=this;if(this.dasAdjLock)return dlog("Already looking for a next feature, be patient!");this.dasAdjLock=true;a={adjacent:a+":"+(b|0)+":"+(c>0?"F":"B")};if(b=thisTier.getDesiredTypes(thisTier.browser.scale))a.types=b;thisTier.dasSource.features(null,a,function(h){e.dasAdjLock=false;if(h.length>0&&h[0]!=null){dlog("DAS adjacent seems to be working...");
d(h[0])}})}};function DASSequenceSource(a){this.dasSource=a;this.awaitedEntryPoints=new Awaited;var b=this;this.dasSource.entryPoints(function(c){b.awaitedEntryPoints.provide(c)})}DASSequenceSource.prototype.fetch=function(a,b,c,d,e){this.dasSource.sequence(new DASSegment(a,b,c),function(h){return h.length==1?e(null,h[0]):e("Didn't get sequence")})};
DASSequenceSource.prototype.getSeqInfo=function(a,b){this.awaitedEntryPoints.await(function(c){for(var d=0;d<c.length;++d)if(c[d].name==a)return b({length:c[d].end});return b()})};function TwoBitSequenceSource(a){var b=this;this.source=a;this.twoBit=new Awaited;makeTwoBit(new URLFetchable(a.twoBitURI),function(c,d){d?dlog(d):b.twoBit.provide(c)})}
TwoBitSequenceSource.prototype.fetch=function(a,b,c,d,e){this.twoBit.await(function(h){h.fetch(a,b,c,function(j,i){if(i)return e(i,null);else{var l=new DASSequence(a,b,c,"DNA",j);return e(null,l)}})})};TwoBitSequenceSource.prototype.getSeqInfo=function(a,b){this.twoBit.await(function(c){c.getSeq(a)?c.getSeq(a).length(function(d){b({length:d})}):b()})};DASFeatureSource.prototype.getScales=function(){return[]};var bwg_preflights={};
function BWGFeatureSource(a){FeatureSourceBase.call(this);var b=this;this.readiness="Connecting";this.bwgSource=this.opts=a;b.bwgHolder=new Awaited;if(this.opts.preflight){var c=bwg_preflights[this.opts.preflight];if(!c){c=new Awaited;bwg_preflights[this.opts.preflight]=c;var d=new XMLHttpRequest;d.onreadystatechange=function(){if(d.readyState==4)d.status==200?c.provide("success"):c.provide("failure")};d.open("get",this.opts.preflight+"?"+hex_sha1("salt"+Date.now()),true);if(this.opts.credentials)d.withCredentials=
true;d.send("")}c.await(function(e){e==="success"&&b.init()})}else b.init()}BWGFeatureSource.prototype=Object.create(FeatureSourceBase.prototype);
BWGFeatureSource.prototype.init=function(){var a=this,b,c;if(this.bwgSource.bwgURI){b=makeBwgFromURL;c=this.bwgSource.bwgURI}else{b=makeBwgFromFile;c=this.bwgSource.bwgBlob}b(c,function(d,e){if(e){a.error=e;a.readiness=null;a.notifyReadiness();a.bwgHolder.provide(null)}else{a.bwgHolder.provide(d);a.readiness=null;a.notifyReadiness();d.type=="bigbed"&&d.getExtraIndices(function(h){a.extraIndices=h})}},this.opts.credentials)};
BWGFeatureSource.prototype.capabilities=function(){var a={leap:true};if(this.bwgHolder.res&&this.bwgHolder.res.type=="bigwig")a.quantLeap=true;if(this.extraIndices&&this.extraIndices.length>0){a.search=[];for(var b=0;b<this.extraIndices.length;++b)a.search.push(this.extraIndices[b].field)}return a};
BWGFeatureSource.prototype.fetch=function(a,b,c,d,e,h,j){var i=this;this.bwgHolder.await(function(l){if(l==null)return j(i.error||"Can't access binary file",null,null);var m;m=!e||e.length==0||arrayIndexOf(e,"density")>=0;if(i.opts.clientBin)m=false;if(l.type=="bigwig"||m||typeof i.opts.forceReduction!=="undefined"){m=-1;for(var o=0;o<l.zoomLevels.length;++o)if(l.zoomLevels[o].reduction<=d)m=o;else break;if(typeof i.opts.forceReduction!=="undefined")m=i.opts.forceReduction;m=m<0?l.getUnzoomedView():
l.getZoomedView(m)}else m=l.getUnzoomedView();i.busy++;i.notifyActivity();m.readWigData(a,b,c,function(q){i.busy--;i.notifyActivity();var p=1E9;if(l.type==="bigwig"){var s=(c-b)/q.length/2;if(s<p)p=s}if(i.opts.link)for(s=0;s<q.length;++s){var r=q[s];if(r.label)r.links=[new DASLink("Link",i.opts.link.replace(/\$\$/,r.label))]}j(null,q,p)})})};
BWGFeatureSource.prototype.quantFindNextFeature=function(a,b,c,d,e){var h=this;h.busy++;h.notifyActivity();this.bwgHolder.res.thresholdSearch(a,b,c,d,function(j,i){h.busy--;h.notifyActivity();return e(j,i)})};BWGFeatureSource.prototype.findNextFeature=function(a,b,c,d){var e=this;e.busy++;e.notifyActivity();this.bwgHolder.res.getUnzoomedView().getFirstAdjacent(a,b,c,function(h){e.busy--;e.notifyActivity();h.length>0&&h[0]!=null&&d(h[0])})};
BWGFeatureSource.prototype.getScales=function(){var a=this.bwgHolder.res;if(a){for(var b=[1],c=0;c<a.zoomLevels.length;++c)b.push(a.zoomLevels[c].reduction);return b}else return null};BWGFeatureSource.prototype.search=function(a,b){if(!this.extraIndices||this.extraIndices.length==0)return b(null,"No indices available");return this.extraIndices[0].lookup(a,b)};
BWGFeatureSource.prototype.getDefaultFIPs=function(a){if(this.opts.noExtraFeatureInfo)return true;this.bwgHolder.await(function(b){b&&b.schema&&b.definedFieldCount<b.schema.fields.length&&a(function(c,d){for(var e=b.definedFieldCount;e<b.schema.fields.length;++e){var h=b.schema.fields[e];d.add(h.comment,c[h.name])}})})};
BWGFeatureSource.prototype.getStyleSheet=function(a){this.bwgHolder.await(function(b){if(!b)return a(null,"bbi error");var c=new DASStylesheet;if(b.type=="bigbed"){var d=new DASStyle;d.glyph="BOX";d.FGCOLOR="black";d.BGCOLOR="blue";d.HEIGHT=8;d.BUMP=true;d.LABEL=true;d.ZINDEX=20;c.pushStyle({type:"bigwig"},null,d);d.glyph="BOX";d.FGCOLOR="black";d.BGCOLOR="red";d.HEIGHT=10;d.BUMP=true;d.ZINDEX=20;c.pushStyle({type:"bb-translation"},null,d);d=new DASStyle;d.glyph="BOX";d.FGCOLOR="black";d.BGCOLOR=
"white";d.HEIGHT=10;d.ZINDEX=10;d.BUMP=true;d.LABEL=true;c.pushStyle({type:"bb-transcript"},null,d);d=new DASStyle;d.glyph="HISTOGRAM";d.COLOR1="white";d.COLOR2="black";d.HEIGHT=30;c.pushStyle({type:"density"},null,d)}else{d=new DASStyle;d.glyph="HISTOGRAM";d.COLOR1="white";d.COLOR2="black";d.HEIGHT=30;c.pushStyle({type:"default"},null,d)}if(b.definedFieldCount==12&&b.fieldCount>=14)c.geneHint=true;return a(c)})};function BamblrFeatureSource(a){this.bamblr=a.bamblrURI}
BamblrFeatureSource.prototype.getScales=function(){return[]};BamblrFeatureSource.prototype.getStyleSheet=function(a){var b=new DASStylesheet,c=new DASStyle;c.glyph="HISTOGRAM";c.COLOR1="black";c.COLOR2="red";c.HEIGHT=30;b.pushStyle({type:"default"},null,c);return a(b)};
BamblrFeatureSource.prototype.fetch=function(a,b,c,d,e,h,j){var i=d|0;if(i<1)i=1;(new URLFetchable(this.bamblr+"?seq="+a+"&min="+b+"&max="+c+"&rez="+i)).fetch(function(l){if(l==null)dlog("failing bamblr");else{l=new Int32Array(l);for(var m=[],o=0;o<l.length;++o){var q=new DASFeature;q.min=b+o*i;q.max=q.min+i-1;q.segment=a;q.type="bamblr";q.score=l[o];m.push(q)}j(null,m,i)}})};
function BAMFeatureSource(a){FeatureSourceBase.call(this);var b=this;this.bamSource=a;this.opts={credentials:a.credentials,preflight:a.preflight};this.bamHolder=new Awaited;if(this.opts.preflight){var c=bwg_preflights[this.opts.preflight];if(!c){c=new Awaited;bwg_preflights[this.opts.preflight]=c;var d=new XMLHttpRequest;d.onreadystatechange=function(){if(d.readyState==4)d.status==200?c.provide("success"):c.provide("failure")};d.open("get",this.opts.preflight+"?"+hex_sha1("salt"+Date.now()),true);
if(this.opts.credentials)d.withCredentials="true";d.send("")}c.await(function(e){e==="success"&&b.init()})}else b.init()}BAMFeatureSource.prototype=Object.create(FeatureSourceBase.prototype);
BAMFeatureSource.prototype.init=function(){var a=this,b,c;if(this.bamSource.bamBlob){b=new BlobFetchable(this.bamSource.bamBlob);c=new BlobFetchable(this.bamSource.baiBlob)}else{b=new URLFetchable(this.bamSource.bamURI,{credentials:this.opts.credentials});c=new URLFetchable(this.bamSource.baiURI||this.bamSource.bamURI+".bai",{credentials:this.opts.credentials})}makeBam(b,c,function(d){a.readiness=null;a.notifyReadiness();a.bamHolder.provide(d)})};
BAMFeatureSource.prototype.fetch=function(a,b,c,d,e,h,j){var i=this;i.busy++;i.notifyActivity();this.bamHolder.await(function(l){l.fetch(a,b,c,function(m,o){i.busy--;i.notifyActivity();if(o)j(o,null,null);else{for(var q=[],p=0;p<m.length;++p){var s=m[p];if(!(s.flag&4)){var r=s.seq.length;if(s.cigar){r=0;for(var t=parseCigar(s.cigar),v=0;v<t.length;++v){var u=t[v];if(u.op=="M"||u.op=="D")r+=u.cnt}}t=new DASFeature;t.min=s.pos+1;t.max=s.pos+r;t.segment=s.segment;t.type="bam";t.id=s.readName;t.notes=
["Sequence="+s.seq,"CIGAR="+s.cigar,"MQ="+s.mq];t.cigar=s.cigar;t.seq=s.seq;t.quals=s.quals;q.push(t)}}j(null,q,1E9)}})})};BAMFeatureSource.prototype.getScales=function(){return 1E9};
BAMFeatureSource.prototype.getStyleSheet=function(a){this.bamHolder.await(function(){var b=new DASStylesheet,c=new DASStyle;c.glyph="HISTOGRAM";c.COLOR1="black";c.COLOR2="red";c.HEIGHT=30;b.pushStyle({type:"density"},"low",c);b.pushStyle({type:"density"},"medium",c);c=new DASStyle;c.glyph="__SEQUENCE";c.FGCOLOR="black";c.BGCOLOR="blue";c.HEIGHT=8;c.BUMP=true;c.LABEL=false;c.ZINDEX=20;b.pushStyle({type:"bam"},"high",c);return a(b)})};
function MappedFeatureSource(a,b){this.source=a;this.mapping=b;this.activityListeners=[];this.busy=0}MappedFeatureSource.prototype.addActivityListener=function(a){this.activityListeners.push(a)};MappedFeatureSource.prototype.notifyActivity=function(){for(var a=0;a<this.activityListeners.length;++a)try{this.activityListeners[a](this.busy)}catch(b){console.log(b)}};MappedFeatureSource.prototype.getStyleSheet=function(a){return this.source.getStyleSheet(a)};MappedFeatureSource.prototype.getScales=function(){return this.source.getScales()};
MappedFeatureSource.prototype.fetch=function(a,b,c,d,e,h,j){var i=this;i.busy++;i.notifyActivity();this.mapping.sourceBlocksForRange(a,b,c,function(l){if(l.length==0){i.busy--;i.notifyActivity();j("No mapping available for this regions",[],d)}else{l=l[0];i.source.fetch(l.name,l.start,l.end,d,e,h,function(m,o,q){i.busy--;i.notifyActivity();var p=[];if(o)for(var s=0;s<o.length;++s){var r=o[s],t=r.segment;if(t.indexOf("chr")==0)t=t.substr(3);var v=i.mapping.mapPoint(t,r.min);t=i.mapping.mapPoint(t,r.max);
if(!v||!t||v.seq!=t.seq||v.seq!=a)r.parts&&r.parts.length>0&&p.push(r);else{r.segment=v.seq;r.min=v.pos;r.max=t.pos;if(r.min>r.max){t=r.max;r.max=r.min;r.min=t}if(v.flipped)if(r.orientation=="-")r.orientation="+";else if(r.orientation=="+")r.orientation="-";p.push(r)}}j(m,p,q)})}})};function DummyFeatureSource(){}DummyFeatureSource.prototype.getScales=function(){return null};DummyFeatureSource.prototype.fetch=function(a,b,c,d,e,h,j){return j(null,[],1E9)};
DummyFeatureSource.prototype.getStyleSheet=function(a){var b=new DASStylesheet,c=new DASStyle;c.glyph="BOX";c.BGCOLOR="blue";c.FGCOLOR="black";b.pushStyle({type:"default"},null,c);return a(b)};function DummySequenceSource(){}DummySequenceSource.prototype.fetch=function(a,b,c,d,e){return e(null,null)};function JBrowseFeatureSource(a){this.store=new JBrowseStore(a.jbURI,a.jbQuery)}JBrowseFeatureSource.prototype.getScales=function(){return null};
JBrowseFeatureSource.prototype.getStyleSheet=function(a){var b=new DASStylesheet,c=new DASStyle;c.glyph="BOX";c.FGCOLOR="black";c.BGCOLOR="green";c.HEIGHT=8;c.BUMP=true;c.LABEL=true;c.ZINDEX=20;b.pushStyle({type:"default"},null,c);return a(b)};JBrowseFeatureSource.prototype.fetch=function(a,b,c,d,e,h,j){e&&e.length==0?j(null,[],d):this.store.features(new DASSegment(a,b,c),{},function(i,l){j(l,i,1E5)})};function sourceAdapterIsCapable(a,b){return a.capabilities?a.capabilities()[b]:false}
function JBrowseStore(a,b){this.base=a;this.query=b}var topLevelResp;
JBrowseStore.prototype.features=function(a,b,c){b=b||{};url=this.base+"/features/"+a.name;b=[];this.query&&b.push(this.query);if(a.isBounded){b.push("start="+a.start);b.push("end="+a.end)}if(b.length>0)url=url+"?"+b.join("&");var d=new XMLHttpRequest;d.onreadystatechange=function(){if(d.readyState==4)if(d.status>=300)c(null,"Error code "+d.status);else{var e=JSON.parse(d.response).features,h=[];for(fi=0;fi<e.length;++fi){var j=e[fi],i=new DASFeature;i.segment=a;i.min=(j.start|0)+1;i.max=j.end|0;if(j.name)i.label=
j.name;i.type=j.type||"unknown";h.push(i)}c(h)}};d.open("GET",url,true);d.responseType="text";d.send("")};function EnsemblFeatureSource(a){this.source=a;this.base=a.uri||"http://beta.rest.ensembl.org";this.species=a.species||"human";this.activityListeners=[];this.busy=0;this.type=typeof a.type==="string"?[a.type]:a.type||["regulatory"]}EnsemblFeatureSource.prototype.addActivityListener=function(a){this.activityListeners.push(a)};
EnsemblFeatureSource.prototype.notifyActivity=function(){for(var a=0;a<this.activityListeners.length;++a)try{this.activityListeners[a](this.busy)}catch(b){console.log(b)}};
EnsemblFeatureSource.prototype.getStyleSheet=function(a){var b=new DASStylesheet,c=new DASStyle;c.glyph="__NONE";this.type.indexOf("exon")>=0&&b.pushStyle({type:"transcript"},null,c);if(this.type.indexOf("exon")>=0||this.type.indexOf("transcript")>=0)b.pushStyle({type:"gene"},null,c);c=new DASStyle;c.glyph="BOX";c.FGCOLOR="black";c.BGCOLOR="red";c.HEIGHT=8;c.BUMP=true;c.LABEL=true;c.ZINDEX=10;b.pushStyle({type:"cds"},null,c);c=new DASStyle;c.glyph="SQUARE";c.BUMP="yes";c.LABEL="no";c.FGCOLOR="blue";
b.pushStyle({type:"variation",method:".+_UTR_variant"},null,c);c=new DASStyle;c.glyph="TRIANGLE";c.DIRECTION="S";c.BUMP="yes";c.LABEL="no";c.FGCOLOR="blue";b.pushStyle({type:"variation",method:"missense_variant"},null,c);c=new DASStyle;c.glyph="TRIANGLE";c.DIRECTION="N";c.BUMP="yes";c.LABEL="no";c.FGCOLOR="blue";b.pushStyle({type:"variation",method:"splice_.+_variant"},null,c);c=new DASStyle;c.glyph="STAR";c.POINTS=6;c.BUMP="yes";c.LABEL="no";c.FGCOLOR="blue";b.pushStyle({type:"variation",method:"regulatory_region_variant"},
null,c);c=new DASStyle;c.glyph="PLIMSOLL";c.BUMP="yes";c.LABEL="no";c.FGCOLOR="rgb(50,80,255)";c.STROKECOLOR="black";b.pushStyle({type:"variation"},null,c);c=new DASStyle;c.glyph="SQUARE";c.BUMP="yes";c.LABEL="no";c.BGCOLOR="#888888";c.FGCOLOR="red";b.pushStyle({type:"indel",method:".+_UTR_variant"},null,c);c=new DASStyle;c.glyph="TRIANGLE";c.DIRECTION="S";c.BUMP="yes";c.LABEL="no";c.BGCOLOR="#888888";c.FGCOLOR="red";b.pushStyle({type:"indel",method:"missense_variant"},null,c);c=new DASStyle;c.glyph=
"TRIANGLE";c.DIRECTION="N";c.BUMP="yes";c.LABEL="no";c.BGCOLOR="#888888";c.FGCOLOR="red";b.pushStyle({type:"indel",method:"splice_.+_variant"},null,c);c=new DASStyle;c.glyph="STAR";c.POINTS=6;c.BUMP="yes";c.LABEL="no";c.BGCOLOR="#888888";c.FGCOLOR="red";b.pushStyle({type:"indel",method:"regulatory_region_variant"},null,c);c=new DASStyle;c.glyph="PLIMSOLL";c.BUMP="yes";c.LABEL="no";c.BGCOLOR="#888888";c.FGCOLOR="red";c.STROKECOLOR="black";b.pushStyle({type:"indel"},null,c);c=new DASStyle;c.glyph="BOX";
c.FGCOLOR="black";c.BGCOLOR="orange";c.HEIGHT=8;c.BUMP=true;c.LABEL=true;c.ZINDEX=20;b.pushStyle({type:"default"},null,c);return a(b)};EnsemblFeatureSource.prototype.getScales=function(){return[]};
EnsemblFeatureSource.prototype.fetch=function(a,b,c,d,e,h,j){var i=this;url=this.base+"/feature/region/"+this.species+"/"+a+":"+b+"-"+c;b=[];for(c=0;c<this.type.length;++c)b.push("feature="+this.type[c]);b.push("content-type=application/json");url=url+"?"+b.join(";");var l=new XMLHttpRequest;l.onreadystatechange=function(){if(l.readyState==4){i.busy--;i.notifyActivity();if(l.status>=300){var m="Error code "+l.status;try{var o=JSON.parse(l.response);if(o.error)m=o.error}catch(q){}j(m,null)}else{m=
JSON.parse(l.response);o=[];for(fi=0;fi<m.length;++fi){var p=m[fi],s=[],r=new DASFeature;r.segment=a;r.min=p.start|0;r.max=p.end|0;r.type=p.feature_type||"unknown";r.id=p.ID;if(p.Parent){var t=new DASGroup;t.id=p.Parent;r.groups=[t]}if(p.strand)if(p.strand<0)r.orientation="-";else if(p.strand>0)r.orientation="+";if(p.consequence_type)r.method=p.consequence_type;if(p.alt_alleles){s.push("Alleles="+p.alt_alleles.join("/"));if(p.alt_alleles.length>1)if(p.alt_alleles[1].length!=p.alt_alleles[0].length||
p.alt_alleles[1]=="-")r.type="indel"}if(s.length>0)r.notes=s;o.push(r)}j(null,o)}}};i.busy++;i.notifyActivity();l.open("GET",url,true);l.responseType="text";l.send("")};dalliance_registerSourceAdapterFactory("ensembl",function(a){return{features:new EnsemblFeatureSource(a)}});
function OverlayFeatureSource(a,b){this.sources=a;this.opts=b||{};this.activityListeners=[];this.readinessListeners=[];this.changeListeners=[];this.business=[];this.readiness=[];for(var c=0;c<this.sources.length;++c)this.initN(c);this.merge=b.merge=="concat"?OverlayFeatureSource_merge_concat:OverlayFeatureSource_merge_byKey}
OverlayFeatureSource.prototype.initN=function(a){var b=this.sources[a],c=this;this.business[a]=0;b.addActivityListener&&b.addActivityListener(function(d){c.business[a]=d;c.notifyActivity()});b.addChangeListener&&b.addChangeListener(function(){c.notifyChange()});b.addReadinessListener&&b.addReadinessListener(function(d){c.readiness[a]=d;c.notifyReadiness()})};OverlayFeatureSource.prototype.addReadinessListener=function(a){this.readinessListeners.push(a);this.notifyReadinessListener(a)};
OverlayFeatureSource.prototype.notifyReadiness=function(){for(var a=0;a<this.readinessListeners.length;++a)this.notifyReadinessListener(this.readinessListeners[a])};OverlayFeatureSource.prototype.notifyReadinessListener=function(a){for(var b=null,c=0;c<this.readiness.length;++c)if(this.readiness[c]!=null){b=this.readiness[c];break}try{a(b)}catch(d){console.log(d)}};OverlayFeatureSource.prototype.addActivityListener=function(a){this.activityListeners.push(a)};
OverlayFeatureSource.prototype.notifyActivity=function(){for(var a=0,b=0;b<this.business.length;++b)a+=this.business[b];for(b=0;b<this.activityListeners.length;++b)try{this.activityListeners[b](a)}catch(c){console.log(c)}};OverlayFeatureSource.prototype.addChangeListener=function(a){this.changeListeners.push(a)};OverlayFeatureSource.prototype.notifyChange=function(){for(var a=0;a<this.changeListeners.length;++a)try{this.changeListeners[a](this.busy)}catch(b){console.log(b)}};
OverlayFeatureSource.prototype.getScales=function(){return this.sources[0].getScales()};OverlayFeatureSource.prototype.getStyleSheet=function(a){return this.sources[0].getStyleSheet(a)};OverlayFeatureSource.prototype.capabilities=function(){var a={},b=this.sources[0];if(b.capabilities)a=shallowCopy(b.capabilities());for(b=1;b<this.sources.length;++b){var c=this.sources[b];if(c.capabilities){c=c.capabilities();if(c.search)a.search=c.search}}return a};
OverlayFeatureSource.prototype.search=function(a,b){for(var c=0;c<this.sources.length;++c)if(sourceAdapterIsCapable(this.sources[c],"search"))return this.sources[c].search(a,b)};OverlayFeatureSource.prototype.fetch=function(a,b,c,d,e,h,j){j=new OverlayBaton(this,j,this.sources.length);for(var i=0;i<this.sources.length;++i)this.fetchN(j,i,a,b,c,d,e,h)};OverlayFeatureSource.prototype.fetchN=function(a,b,c,d,e,h,j,i){this.sources[b].fetch(c,d,e,h,j,i,function(l,m,o){return a.completed(b,l,m,o)})};
OverlayFeatureSource.prototype.quantFindNextFeature=function(a,b,c,d,e){return this.sources[0].quantFindNextFeature(a,b,c,d,e)};OverlayFeatureSource.prototype.findNextFeature=function(a,b,c,d){return this.sources[0].findNextFeature(a,b,c,d)};function OverlayBaton(a,b,c){this.source=a;this.callback=b;this.count=c;this.statusCount=this.returnCount=0;this.returns=[];this.features=[];this.statuses=[];this.scale=null}
OverlayBaton.prototype.completed=function(a,b,c,d){if(this.scale==null||a==0)this.scale=d;if(this.returns[a])throw"Multiple returns for source "+a;this.returns[a]=true;this.returnCount++;this.features[a]=c;if(b){this.statuses[a]=b;this.statusCount++}if(this.returnCount==this.count)if(this.statusCount>0){a="";for(b=0;b<this.count;++b)if(c=this.statuses[b]){if(a.length>0)a+=", ";a+=c}return this.callback(a,null,this.scale)}else this.callback(null,this.source.merge(this.features),this.scale)};
OverlayFeatureSource.prototype.getDefaultFIPs=function(a){for(var b=0;b<this.sources.length;++b){var c=this.sources[b];c.getDefaultFIPs&&c.getDefaultFIPs(a)}};OverlayFeatureSource.prototype.keyForFeature=function(a){return""+a.min+".."+a.max};
function OverlayFeatureSource_merge_byKey(a){for(var b=[],c=1;c<a.length;++c){for(var d={},e=a[c],h=0;h<e.length;++h)d[this.keyForFeature(e[h])]=e[h];b.push(d)}c=[];a=a[0];for(h=0;h<a.length;++h){for(var j=a[h],i=0;i<b.length;++i){d=b[i];if(e=d[this.keyForFeature(j)])for(var l in e)if(l==="score")j.score2=e.score;else l==="min"||l==="max"||l==="segment"||l==="_cachedStyle"||(j[l]=e[l])}c.push(j)}return c}
function OverlayFeatureSource_merge_concat(a){for(var b=[],c=0;c<a.length;++c)for(var d=a[c],e=this.sources[c].name,h=0;h<d.length;++h){var j=d[h];j.method=e;b.push(j)}return b}
Browser.prototype.mergeSelectedTiers=function(){for(var a=[],b=[],c=0;c<this.selectedTiers.length;++c){var d=this.tiers[this.selectedTiers[c]];a.push(shallowCopy(d.dasSource));for(var e=d.stylesheet.styles,h=0;h<e.length;++h){var j=e[h],i=shallowCopy(j);i.method=d.dasSource.name.replace(/[()+*?]/g,"\\$&");i._methodRE=null;i.style=shallowCopy(j.style);if(i.style.ZINDEX===undefined)i.style.ZINDEX=c;if(d.forceMin)i.style.MIN=d.forceMin;if(d.forceMax)i.style.MAX=d.forceMax;b.push(i)}}this.addTier({name:"Merged",
merge:"concat",overlay:a,noDownsample:true,style:b});this.setSelectedTier(this.tiers.length-1)};var REGION_PATTERN=/([\d+,\w,\.,\_,\-]+):([0-9,]+)([KkMmGg])?([\-,\,.]+([0-9,]+)([KkMmGg])?)?/;function parseLocCardinal(a,b){var c=a.replace(/,/g,"");return b==="k"||b==="K"?c*1E3:b=="m"||b==="M"?c*1E6:c}
Browser.prototype.search=function(a,b){var c=this,d=REGION_PATTERN.exec(a);if(d){var e=d[1],h;if(d[5]){h=parseLocCardinal(d[2],d[3]);d=parseLocCardinal(d[5],d[6])}else{var j=this.viewEnd-this.viewStart+1;h=parseLocCardinal(d[2],d[3])-j/2|0;d=h+j-1}this.setLocation(e,h,d,b)}else{if(!a||a.length==0)return false;var i=0,l=false,m=function(q,p){--i;if(p)return b(p);q||(q=[]);for(var s=5E8,r=-100000000,t=null,v=0;v<q.length;++v){var u=q[v];if(t==null)t=u.segment;s=Math.min(s,u.min);r=Math.max(r,u.max)}if(t){l=
true;c.highlightRegion(t,s,r);v=Math.max(2500,0.3*(r-s+1)|0);c.setLocation(t,s-v,r+v,b)}else if(i==0&&!l)return b("no match for '"+a+"'")},o=function(q,p){p.lookup(a,function(s){if(s==null||s.length<2)return q.featureSource.search(a,m);else{s=s[1].split(",")[0];return q.featureSource.search(s,m)}})};if(this.searchEndpoint){i=1;return this.doDasSearch(c.searchEndpoint,a,m)}for(e=0;e<this.tiers.length;++e)(function(q){if(sourceAdapterIsCapable(q.featureSource,"search"))if(q.dasSource.trixURI){++i;q.trix?
o(q,q.trix):connectTrix(new URLFetchable(q.dasSource.trixURI),new URLFetchable(q.dasSource.trixURI+"x"),function(p){q.trix=p;o(q,p)})}else{++i;q.featureSource.search(a,m)}else if(q.dasSource.provides_search){++i;c.doDasSearch(q.dasSource,a,m)}})(this.tiers[e])}};Browser.prototype.doDasSearch=function(a,b,c){a.features(null,{group:b,type:"transcript"},function(d){d||(d=[]);for(var e=[],h=0;h<d.length;++h){var j=d[h];j.label.toLowerCase()==b.toLowerCase()&&e.push(j)}return c(e)},false)};
var __dalliance_smallGlyphs={DOT:true,EX:true,STAR:true,SQUARE:true,CROSS:true,TRIANGLE:true,PLIMSOLL:true};
Browser.prototype.openTierPanel=function(a){if(this.uiMode==="tier"&&this.manipulatingTier===a){this.hideToolPanel();this.setUiMode("none")}else{var b=function(E){if(!E.BGGRAD){if(r==1){if(E.glyph=="LINEPLOT"||__dalliance_smallGlyphs[E.glyph])E.FGCOLOR=i.value;else E.BGCOLOR=i.value;E.COLOR1=E.COLOR2=E.COLOR3=null}else{E.COLOR1=i.value;E.COLOR2=l.value;E.COLOR3=r>2?m.value:null}E._gradient=null}},c=function(){for(var E=copyStylesheet(a.stylesheet),J=0;J<E.styles.length;++J)b(E.styles[J].style);a.mergeConfig({stylesheet:E})};
this.manipulatingTier=a;var d=makeElement("div",null,{className:"tier-edit"});if(a.dasSource.mapping){var e=this.chains[a.dasSource.mapping].coords;d.appendChild(makeElement("div","Mapped from "+e.auth+e.version,null,{background:"gray",paddingBottom:"5px",marginBottom:"5px",textAlign:"center"}))}var h=makeElement("input",null,{type:"text"}),j=makeElement("select");j.appendChild(makeElement("option","Histogram",{value:"HISTOGRAM"}));j.appendChild(makeElement("option","Line Plot",{value:"LINEPLOT"}));
j.appendChild(makeElement("option","Ribbon",{value:"GRADIENT"}));j.appendChild(makeElement("option","Scatter",{value:"SCATTER"}));var i=makeElement("input",null,{type:"text",value:"#dd00dd"}),l=makeElement("input",null,{type:"text",value:"#dd00dd"}),m=makeElement("input",null,{type:"text",value:"#dd00dd"});try{i.type=l.type=m.type="color"}catch(o){}var q=[i,l,m],p=makeElement("i",null,{className:"fa fa-plus-circle"}),s=makeElement("i",null,{className:"fa fa-minus-circle"}),r=1,t=makeElement("td",
q),v=function(E){r=E;for(var J=0;J<E;++J)q[J].style.display="block";for(J=E;J<q.length;++J)q[J].style.display="none"};p.addEventListener("click",function(){if(r<3){v(r+1);c(null)}},false);s.addEventListener("click",function(){if(r>1){v(r-1);c(null)}},false);var u=makeElement("input",null,{type:"text",value:"0.0"}),x=makeElement("input",null,{type:"text",value:"10.0"}),z=makeElement("input",null,{type:"checkbox"}),H=makeElement("input",null,{type:"checkbox"}),C=makeElement("input",null,{type:"checkbox",
checked:a.quantLeapThreshold!==undefined}),A=makeElement("input",null,{type:"text",value:a.quantLeapThreshold,disabled:!C.checked}),D=makeElement("input",null,{type:"text",value:"50"}),O=null;if(a.stylesheet.styles.length>0)O=a.stylesheet.styles[0].style;e=function(){h.value=typeof a.config.name==="string"?a.config.name:a.dasSource.name;if(a.forceHeight)D.value=""+a.forceHeight;else if(O&&O.HEIGHT)D.value=""+O.HEIGHT;if(typeof a.quantLeapThreshold=="number"){C.checked=true;A.disabled=false;if(parseFloat(A.value)!=
a.quantLeapThreshold)A.value=a.quantLeapThreshold}else{C.checked=false;A.disabled=true}if(a.stylesheet.styles.length>0){var E=O=a.stylesheet.styles[0].style,J=false,R=false;for(R=0;R<a.stylesheet.styles.length;++R){var I=a.stylesheet.styles[R].style;if(I.glyph=="LINEPLOT"||I.glyph=="HISTOGRAM"||I.glyph=="GRADIENT"||isDasBooleanTrue(I.SCATTER)){J||(E=O=I);J=true}}R=J&&a.stylesheet.styles.length==1;if(J){Z.style.display="table-row";W.style.display="table-row"}else{Z.style.display="none";W.style.display=
"none"}if(R){S.style.display="table-row";aa.style.display="table-row"}else{S.style.display="none";aa.style.display="none"}R=1;if(E.COLOR1){i.value=dasColourForName(E.COLOR1).toHexString();if(E.COLOR2){l.value=dasColourForName(E.COLOR2).toHexString();if(E.COLOR3){m.value=dasColourForName(E.COLOR3).toHexString();R=3}else R=2}}else if(E.glyph=="LINEPLOT"||E.glyph=="DOT"&&E.FGCOLOR)i.value=dasColourForName(E.FGCOLOR).toHexString();else if(E.BGCOLOR)i.value=dasColourForName(E.BGCOLOR).toHexString();v(R);
j.value=isDasBooleanTrue(E.SCATTER)?"SCATTER":E.glyph;var fa,la;if(E.MIN!==undefined){R=parseFloat(E.MIN);isNaN(R)||(fa=R)}if(!a.forceMinDynamic&&(E.MIN!==undefined||a.forceMin!==undefined)){z.checked=true;u.disabled=false}else{z.checked=false;u.disabled=true}if(E.MAX!==undefined){R=parseFloat(E.MAX);isNaN(R)||(la=R)}if(!a.forceMaxDynamic&&(E.MAX!==undefined||a.forceMax!==undefined)){H.checked=true;x.disabled=false}else{H.checked=false;x.disabled=true}if(a.forceMin!=undefined)fa=a.forceMin;if(a.forceMax!=
undefined)la=a.forceMax;if(typeof fa=="number"&&fa!=parseFloat(u.value))u.value=fa;if(typeof la=="number"&&la!=parseFloat(x.value))x.value=la;if(E=getSeqStyle(a.stylesheet)){G.style.display="table-row";B.checked=E.__SEQCOLOR==="mismatch";M.style.display="table-row";L.checked=isDasBooleanTrue(E.__INSERTIONS)}else{G.style.display="none";M.style.display="none"}}da.style.display=J&&sourceAdapterIsCapable(a.featureSource,"quantLeap")?"table-row":"none"};var B=makeElement("input",null,{type:"checkbox"}),
G=makeElement("tr",[makeElement("th","Color mismatches"),makeElement("td",B)]);B.addEventListener("change",function(){var E=copyStylesheet(a.stylesheet);getSeqStyle(E).__SEQCOLOR=B.checked?"mismatch":"base";a.mergeConfig({stylesheet:E})});var L=makeElement("input",null,{type:"checkbox"}),M=makeElement("tr",[makeElement("th","Show insertions"),makeElement("td",L)]);L.addEventListener("change",function(){var E=copyStylesheet(a.stylesheet);getSeqStyle(E).__INSERTIONS=L.checked?"yes":"no";a.mergeConfig({stylesheet:E})});
var S=makeElement("tr",[makeElement("th","Style"),makeElement("td",j)]),aa=makeElement("tr",[makeElement("th",["Colour(s)",p,s]),t]),Z=makeElement("tr",[makeElement("th","Min value"),makeElement("td",[z," ",u])]),W=makeElement("tr",[makeElement("th","Max value"),makeElement("td",[H," ",x])]),da=makeElement("tr",[makeElement("th","Threshold leap:"),makeElement("td",[C," ",A])]);p=makeElement("table",[makeElement("tr",[makeElement("th","Name",{},{width:"150px",textAlign:"right"}),h]),makeElement("tr",
[makeElement("th","Height"),makeElement("td",D)]),S,aa,Z,W,da,G,M]);e();d.appendChild(p);p=makeElement("button","Reset track",{className:"btn"},{marginLeft:"auto",marginRight:"auto",display:"block"});p.addEventListener("click",function(){a.setConfig({})},false);d.appendChild(p);h.addEventListener("input",function(){a.mergeConfig({name:h.value})},false);for(p=0;p<q.length;++p)q[p].addEventListener("change",c,false);j.addEventListener("change",function(){for(var E=copyStylesheet(a.stylesheet),J=0;J<
E.styles.length;++J){var R=E.styles[J].style;if(j.value==="SCATTER"){R.SCATTER=true;R.glyph="DOT";R.SIZE="3"}else{R.glyph=j.value;R.SCATTER=undefined}b(R)}a.mergeConfig({stylesheet:E})},false);z.addEventListener("change",function(){var E={forceMinDynamic:!z.checked};u.disabled=!z.checked;var J=parseFloat(u.value);if(z.checked&&typeof J=="number"&&!isNaN(J))E.forceMin=parseFloat(J);a.mergeConfig(E)});u.addEventListener("input",function(){var E=parseFloat(u.value);typeof E=="number"&&!isNaN(E)&&a.mergeConfig({forceMin:E})},
false);H.addEventListener("change",function(){var E={forceMaxDynamic:!H.checked};x.disabled=!H.checked;var J=parseFloat(x.value);if(H.checked&&typeof J=="number"&&!isNaN(J))E.forceMax=parseFloat(J);a.mergeConfig(E)});x.addEventListener("input",function(){var E=parseFloat(x.value);typeof E=="number"&&!isNaN(E)&&a.mergeConfig({forceMax:E})},false);D.addEventListener("input",function(){var E=parseFloat(D.value);typeof E=="number"&&!isNaN(E)&&a.mergeConfig({height:Math.min(500,E|0)})},false);var T=function(){A.disabled=
!C.checked;if(C.checked){var E=parseFloat(A.value);typeof E=="number"&&!isNaN(E)&&a.mergeConfig({quantLeapThreshold:parseFloat(A.value)})}else a.mergeConfig({quantLeapThreshold:null})};C.addEventListener("change",function(){T()},false);A.addEventListener("input",function(){T()},false);this.showToolPanel(d);this.setUiMode("tier");a.addTierListener(e)}};function getSeqStyle(a){for(var b=0;b<a.styles.length;++b){var c=a.styles[b].style;if(c.glyph==="__SEQUENCE")return c}}
function copyStylesheet(a){var b=shallowCopy(a);b.styles=[];for(var c=0;c<a.styles.length;++c){var d=b.styles[c]=shallowCopy(a.styles[c]);d._methodRE=d._labelRE=d._typeRE=null;d.style=shallowCopy(d.style)}return b}function connectTrix(a,b,c){b.fetchAsText(function(d){if(!d)return c(null,"Couldn't fetch index-index");d=d.split(/(.+)([0-9A-F]{10})\n/);for(var e=[],h=[],j=1;j<d.length;j+=3){e.push(d[j]);h.push(parseInt(d[j+1],16))}return c(new TrixIndex(e,h,a))})}
function TrixIndex(a,b,c){this.keys=a;this.offsets=b;this.ix=c}TrixIndex.prototype.lookup=function(a,b){for(var c,d=(a+"     ").substring(0,5).toLowerCase(),e=0;e<this.keys.length;++e)if(d.localeCompare(this.keys[e])<0){c=this.ix.slice(this.offsets[e-1],this.offsets[e]-this.offsets[e-1]);break}c||(c=this.ix.slice(this.offsets[this.offsets.length-1]));c.fetchAsText(function(h){h=h.split("\n");for(var j=0;j<h.length;++j)if(h[j].indexOf(a.toLowerCase()+" ")==0)return b(h[j].split(" "));return b(null)})};
var TABIX_MAGIC=21578324;function TabixFile(){}
function connectTabix(a,b,c){var d=new TabixFile;d.data=a;d.tbi=b;d.tbi.fetch(function(e){if(!e)return dlog("Couldn't access Tabix");e=unbgzf(e,e.byteLength);var h=new Uint8Array(e);if(readInt(h,0)!=TABIX_MAGIC)return c(null,"Not a tabix index");var j=readInt(h,4);d.format=readInt(h,8);d.colSeq=readInt(h,12);d.colStart=readInt(h,16);d.colEnd=readInt(h,20);d.meta=readInt(h,24);d.skip=readInt(h,28);readInt(h,32);d.indices=[];var i=36;d.chrToIndex={};d.indexToChr=[];for(var l=0;l<j;++l){for(var m="";;){var o=
h[i++];if(o==0)break;m+=String.fromCharCode(o)}d.chrToIndex[m]=l;if(m.indexOf("chr")==0)d.chrToIndex[m.substring(3)]=l;else d.chrToIndex["chr"+m]=l;d.indexToChr.push(m)}m=1E9;for(o=0;o<j;++o){var q=i,p=readInt(h,i);i+=4;for(l=0;l<p;++l){readInt(h,i);var s=readInt(h,i+4);i+=8+s*16}s=readInt(h,i);i+=4;var r=i;for(l=0;l<s;++l){var t=readVob(h,r);r+=8;if(t){l=t.block;if(t.offset>0)l+=65536;if(l<m)m=l;break}}i+=s*8;ub=h;if(p>0)d.indices[o]=new Uint8Array(e,q,i-q)}c(d)})}
TabixFile.prototype.blocksForRange=function(a,b,c){var d=this.indices[a];if(!d)return[];a=reg2bins(b,c);for(var e=[],h=0;h<a.length;++h)e[a[h]]=true;a=[];var j=[];h=readInt(d,0);for(var i=4,l=0;l<h;++l){var m=readInt(d,i),o=readInt(d,i+4);i+=8;if(e[m])for(var q=0;q<o;++q){var p=readVob(d,i),s=readVob(d,i+8);(m<4681?j:a).push(new Chunk(p,s));i+=16}else i+=o*16}h=readInt(d,i);e=null;b=Math.min(b>>14,h-1);c=Math.min(c>>14,h-1);for(h=b;h<=c;++h)if(b=readVob(d,i+4+h*8))if(!e||b.block<e.block||b.offset<
e.offset)e=b;d=[];if(e!=null)for(h=0;h<j.length;++h){c=j[h];c.maxv.block>=e.block&&c.maxv.offset>=e.offset&&d.push(c)}j=d;d=[];for(h=0;h<j.length;++h)d.push(j[h]);for(h=0;h<a.length;++h)d.push(a[h]);d.sort(function(r,t){var v=r.minv.block-t.minv.block;return v!=0?v:r.minv.offset-t.minv.offset});a=[];if(d.length>0){j=d[0];for(h=1;h<d.length;++h){c=d[h];if(c.minv.block==j.maxv.block)j=new Chunk(j.minv,c.maxv);else{a.push(j);j=c}}a.push(j)}return a};
TabixFile.prototype.fetch=function(a,b,c,d){function e(){if(m>=i.length)return d(l);else if(o){var q=new Uint8Array(o);h.readRecords(q,i[m].minv.offset,l,b,c,j);o=null;++m;return e()}else{var p=i[m];q=p.minv.block;h.data.slice(q,p.maxv.block+65536-q).fetch(function(s){o=unbgzf(s,p.maxv.block-p.minv.block+1);return e()})}}var h=this;a=this.chrToIndex[a];if(a==undefined)return d([]);var j=this.indexToChr[a],i;if(a===undefined)i=[];else(i=this.blocksForRange(a,b,c))||d(null,"Error in index fetch");var l=
[],m=0,o;e()};TabixFile.prototype.readRecords=function(a,b,c,d,e,h){a:for(;;){for(var j="";b<a.length;){var i=a[b++];if(i==10){i=j.split("\t");if(i[this.colSeq-1]==h){var l=parseInt(i[this.colStart-1]),m=l;if(this.colEnd>0)m=parseInt(i[this.colEnd-1]);this.format&65536&&++l;l<=e&&m>=d&&c.push(j)}continue a}else j+=String.fromCharCode(i)}return}};
function TabixFeatureSource(a){FeatureSourceBase.call(this);this.readiness="Connecting";this.source=a;this.tabixHolder=new Awaited;var b=this;if(a.payload=="vcf")this.parser=new VCFParser;else throw"Unsuported tabix payload "+a.payload;var c;if(this.source.blob){a=new BlobFetchable(this.source.blob);c=new BlobFetchable(this.source.indexBlob)}else{a=new URLFetchable(this.source.uri,{credentials:this.source.credentials});c=new URLFetchable(this.source.indexURI||this.source.uri+".tbi",{credentials:this.source.credentials})}connectTabix(a,
c,function(d){b.tabixHolder.provide(d);b.readiness=null;b.notifyReadiness()})}TabixFeatureSource.prototype=Object.create(FeatureSourceBase.prototype);TabixFeatureSource.prototype.fetch=function(a,b,c,d,e,h,j){var i=this;i.busy++;i.notifyActivity();this.tabixHolder.await(function(l){l.fetch(a,b,c,function(m){i.busy--;i.notifyActivity();for(var o=[],q=0;q<m.length;++q){var p=i.parser.parse(m[q]);p&&o.push(p)}j(null,o,1E9)})})};
TabixFeatureSource.prototype.getDefaultFIPs=function(a){this.parser&&this.parser.getDefaultFIPs&&this.parser.getDefaultFIPs(a)};
TabixFeatureSource.prototype.getStyleSheet=function(a){var b=new DASStylesheet,c=new DASStyle;c.glyph="__INSERTION";c.BUMP="yes";c.LABEL="no";c.FGCOLOR="rgb(50,80,255)";c.BGCOLOR="#888888";c.STROKECOLOR="black";b.pushStyle({type:"insertion"},null,c);c=new DASStyle;c.glyph="PLIMSOLL";c.BUMP="yes";c.LABEL="no";c.FGCOLOR="rgb(255, 60, 60)";c.BGCOLOR="#888888";c.STROKECOLOR="black";b.pushStyle({type:"deletion"},null,c);c=new DASStyle;c.glyph="PLIMSOLL";c.BUMP="yes";c.LABEL="no";c.FGCOLOR="rgb(50,80,255)";
c.BGCOLOR="#888888";c.STROKECOLOR="black";b.pushStyle({type:"default"},null,c);return a(b)};function VCFParser(){}
VCFParser.prototype.parse=function(a){var b=a.split("\t");a=new DASFeature;a.segment=b[0];a.id=b[2];a.refAllele=b[3];a.altAlleles=b[4].split(",");a.min=parseInt(b[1]);a.max=a.min+a.refAllele.length-1;b=a.altAlleles[0];var c=a.refAllele;if(b.length>c.length){a.type="insertion";if(b.indexOf(c)==0){a.insertion=b.substr(c.length);a.min+=c.length;a.max=a.min-1}else a.insertion=b}else a.type=b.length<c.length?"deletion":"substitution";return a};
VCFParser.prototype.getDefaultFIPs=function(a){a(function(b,c){c.add("Ref. allele",b.refAllele);c.add("Alt. alleles",b.altAlleles.join(","))})};dalliance_registerSourceAdapterFactory("tabix",function(a){return{features:new TabixFeatureSource(a)}});
var MAX_WBITS=15,DEF_WBITS=MAX_WBITS,MAX_MEM_LEVEL=9,MANY=1440,BMAX=15,PRESET_DICT=32,Z_NO_FLUSH=0,Z_PARTIAL_FLUSH=1,Z_SYNC_FLUSH=2,Z_FULL_FLUSH=3,Z_FINISH=4,Z_DEFLATED=8,Z_OK=0,Z_STREAM_END=1,Z_NEED_DICT=2,Z_ERRNO=-1,Z_STREAM_ERROR=-2,Z_DATA_ERROR=-3,Z_MEM_ERROR=-4,Z_BUF_ERROR=-5,Z_VERSION_ERROR=-6,METHOD=0,FLAG=1,DICT4=2,DICT3=3,DICT2=4,DICT1=5,DICT0=6,BLOCKS=7,CHECK4=8,CHECK3=9,CHECK2=10,CHECK1=11,DONE=12,BAD=13,inflate_mask=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],
IB_TYPE=0,IB_LENS=1,IB_STORED=2,IB_TABLE=3,IB_BTREE=4,IB_DTREE=5,IB_CODES=6,IB_DRY=7,IB_DONE=8,IB_BAD=9,fixed_bl=9,fixed_bd=5,fixed_tl=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,
7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,
9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,
125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,
82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,
8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,
0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,
9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],fixed_td=[80,
5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],cplens=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],cplext=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],cpdist=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,
129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],cpdext=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];function ZStream(){}ZStream.prototype.inflateInit=function(a,b){a||(a=DEF_WBITS);if(b)b=false;this.istate=new Inflate;return this.istate.inflateInit(this,b?-a:a)};ZStream.prototype.inflate=function(a){if(this.istate==null)return Z_STREAM_ERROR;return this.istate.inflate(this,a)};
ZStream.prototype.inflateEnd=function(){if(this.istate==null)return Z_STREAM_ERROR;var a=istate.inflateEnd(this);this.istate=null;return a};ZStream.prototype.inflateSync=function(){return istate.inflateSync(this)};ZStream.prototype.inflateSetDictionary=function(a,b){return istate.inflateSetDictionary(this,a,b)};function Inflate(){this.was=[0]}
Inflate.prototype.inflateReset=function(a){if(a==null||a.istate==null)return Z_STREAM_ERROR;a.total_in=a.total_out=0;a.msg=null;a.istate.mode=a.istate.nowrap!=0?BLOCKS:METHOD;a.istate.blocks.reset(a,null);return Z_OK};Inflate.prototype.inflateEnd=function(a){this.blocks!=null&&this.blocks.free(a);this.blocks=null;return Z_OK};
Inflate.prototype.inflateInit=function(a,b){this.blocks=a.msg=null;nowrap=0;if(b<0){b=-b;nowrap=1}if(b<8||b>15){this.inflateEnd(a);return Z_STREAM_ERROR}this.wbits=b;a.istate.blocks=new InfBlocks(a,a.istate.nowrap!=0?null:this,1<<b);this.inflateReset(a);return Z_OK};
Inflate.prototype.inflate=function(a,b){var c,d;if(a==null||a.istate==null||a.next_in==null)return Z_STREAM_ERROR;b=b==Z_FINISH?Z_BUF_ERROR:Z_OK;for(c=Z_BUF_ERROR;;)switch(a.istate.mode){case METHOD:if(a.avail_in==0)return c;c=b;a.avail_in--;a.total_in++;if(((a.istate.method=a.next_in[a.next_in_index++])&15)!=Z_DEFLATED){a.istate.mode=BAD;a.msg="unknown compression method";a.istate.marker=5;break}if((a.istate.method>>4)+8>a.istate.wbits){a.istate.mode=BAD;a.msg="invalid window size";a.istate.marker=
5;break}a.istate.mode=FLAG;case FLAG:if(a.avail_in==0)return c;c=b;a.avail_in--;a.total_in++;d=a.next_in[a.next_in_index++]&255;if(((a.istate.method<<8)+d)%31!=0){a.istate.mode=BAD;a.msg="incorrect header check";a.istate.marker=5;break}if((d&PRESET_DICT)==0){a.istate.mode=BLOCKS;break}a.istate.mode=DICT4;case DICT4:if(a.avail_in==0)return c;c=b;a.avail_in--;a.total_in++;a.istate.need=(a.next_in[a.next_in_index++]&255)<<24&4278190080;a.istate.mode=DICT3;case DICT3:if(a.avail_in==0)return c;c=b;a.avail_in--;
a.total_in++;a.istate.need+=(a.next_in[a.next_in_index++]&255)<<16&16711680;a.istate.mode=DICT2;case DICT2:if(a.avail_in==0)return c;c=b;a.avail_in--;a.total_in++;a.istate.need+=(a.next_in[a.next_in_index++]&255)<<8&65280;a.istate.mode=DICT1;case DICT1:if(a.avail_in==0)return c;a.avail_in--;a.total_in++;a.istate.need+=a.next_in[a.next_in_index++]&255;a.adler=a.istate.need;a.istate.mode=DICT0;return Z_NEED_DICT;case DICT0:a.istate.mode=BAD;a.msg="need dictionary";a.istate.marker=0;return Z_STREAM_ERROR;
case BLOCKS:c=a.istate.blocks.proc(a,c);if(c==Z_DATA_ERROR){a.istate.mode=BAD;a.istate.marker=0;break}if(c==Z_OK)c=b;if(c!=Z_STREAM_END)return c;c=b;a.istate.blocks.reset(a,a.istate.was);if(a.istate.nowrap!=0){a.istate.mode=DONE;break}a.istate.mode=CHECK4;case CHECK4:if(a.avail_in==0)return c;c=b;a.avail_in--;a.total_in++;a.istate.need=(a.next_in[a.next_in_index++]&255)<<24&4278190080;a.istate.mode=CHECK3;case CHECK3:if(a.avail_in==0)return c;c=b;a.avail_in--;a.total_in++;a.istate.need+=(a.next_in[a.next_in_index++]&
255)<<16&16711680;a.istate.mode=CHECK2;case CHECK2:if(a.avail_in==0)return c;c=b;a.avail_in--;a.total_in++;a.istate.need+=(a.next_in[a.next_in_index++]&255)<<8&65280;a.istate.mode=CHECK1;case CHECK1:if(a.avail_in==0)return c;c=b;a.avail_in--;a.total_in++;a.istate.need+=a.next_in[a.next_in_index++]&255;if(a.istate.was[0]!=a.istate.need){a.istate.mode=BAD;a.msg="incorrect data check";a.istate.marker=5;break}a.istate.mode=DONE;case DONE:return Z_STREAM_END;case BAD:return Z_DATA_ERROR;default:return Z_STREAM_ERROR}};
Inflate.prototype.inflateSetDictionary=function(a,b,c){var d=0,e=c;if(a==null||a.istate==null||a.istate.mode!=DICT0)return Z_STREAM_ERROR;if(a._adler.adler32(1,b,0,c)!=a.adler)return Z_DATA_ERROR;a.adler=a._adler.adler32(0,null,0,0);if(e>=1<<a.istate.wbits){e=(1<<a.istate.wbits)-1;d=c-e}a.istate.blocks.set_dictionary(b,d,e);a.istate.mode=BLOCKS;return Z_OK};var mark=[0,0,255,255];
Inflate.prototype.inflateSync=function(a){var b,c,d;if(a==null||a.istate==null)return Z_STREAM_ERROR;if(a.istate.mode!=BAD){a.istate.mode=BAD;a.istate.marker=0}if((b=a.avail_in)==0)return Z_BUF_ERROR;c=a.next_in_index;for(d=a.istate.marker;b!=0&&d<4;){if(a.next_in[c]==mark[d])d++;else d=a.next_in[c]!=0?0:4-d;c++;b--}a.total_in+=c-a.next_in_index;a.next_in_index=c;a.avail_in=b;a.istate.marker=d;if(d!=4)return Z_DATA_ERROR;b=a.total_in;c=a.total_out;this.inflateReset(a);a.total_in=b;a.total_out=c;a.istate.mode=
BLOCKS;return Z_OK};Inflate.prototype.inflateSyncPoint=function(a){if(a==null||a.istate==null||a.istate.blocks==null)return Z_STREAM_ERROR;return a.istate.blocks.sync_point()};var INFBLOCKS_BORDER=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];
function InfBlocks(a,b,c){this.hufts=new Int32Array(MANY*3);this.window=new Uint8Array(c);this.end=c;this.checkfn=b;this.mode=IB_TYPE;this.reset(a,null);this.index=this.table=this.left=0;this.blens=null;this.bb=new Int32Array(1);this.tb=new Int32Array(1);this.codes=new InfCodes;this.check=this.write=this.read=this.bitb=this.bitk=this.last=0;this.inftree=new InfTree}
InfBlocks.prototype.reset=function(a,b){if(b)b[0]=this.check;this.mode==IB_CODES&&this.codes.free(a);this.mode=IB_TYPE;this.read=this.write=this.bitb=this.bitk=0;if(this.checkfn)a.adler=this.check=a._adler.adler32(0,null,0,0)};
InfBlocks.prototype.proc=function(a,b){var c,d,e,h,j,i,l;h=a.next_in_index;j=a.avail_in;d=this.bitb;e=this.bitk;i=this.write;for(l=i<this.read?this.read-i-1:this.end-i;;)switch(this.mode){case IB_TYPE:for(;e<3;){if(j!=0)b=Z_OK;else{this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b)}j--;d|=(a.next_in[h++]&255)<<e;e+=8}c=d&7;this.last=c&1;switch(c>>>1){case 0:d>>>=3;e-=3;c=e&7;d>>>=c;e-=c;this.mode=IB_LENS;break;case 1:var m=
new Int32Array(1),o=new Int32Array(1),q=[],p=[];inflate_trees_fixed(m,o,q,p,a);this.codes.init(m[0],o[0],q[0],0,p[0],0,a);d>>>=3;e-=3;this.mode=IB_CODES;break;case 2:d>>>=3;e-=3;this.mode=IB_TABLE;break;case 3:d>>>=3;e-=3;this.mode=BAD;a.msg="invalid block type";b=Z_DATA_ERROR;this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b)}break;case IB_LENS:for(;e<32;){if(j!=0)b=Z_OK;else{this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=
h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b)}j--;d|=(a.next_in[h++]&255)<<e;e+=8}if((~d>>>16&65535)!=(d&65535)){this.mode=BAD;a.msg="invalid stored block lengths";b=Z_DATA_ERROR;this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b)}this.left=d&65535;d=e=0;this.mode=this.left!=0?IB_STORED:this.last!=0?IB_DRY:IB_TYPE;break;case IB_STORED:if(j==0){this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=
h-a.next_in_index;a.next_in_index=h;write=i;return this.inflate_flush(a,b)}if(l==0){if(i==end&&read!=0){i=0;l=i<this.read?this.read-i-1:this.end-i}if(l==0){this.write=i;b=this.inflate_flush(a,b);i=this.write;l=i<this.read?this.read-i-1:this.end-i;if(i==this.end&&this.read!=0){i=0;l=i<this.read?this.read-i-1:this.end-i}if(l==0){this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b)}}}b=Z_OK;c=this.left;if(c>j)c=j;if(c>l)c=l;
arrayCopy(a.next_in,h,window,i,c);h+=c;j-=c;i+=c;l-=c;if((this.left-=c)!=0)break;this.mode=this.last!=0?IB_DRY:IB_TYPE;break;case IB_TABLE:for(;e<14;){if(j!=0)b=Z_OK;else{this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b)}j--;d|=(a.next_in[h++]&255)<<e;e+=8}this.table=c=d&16383;if((c&31)>29||(c>>5&31)>29){this.mode=IB_BAD;a.msg="too many length or distance symbols";b=Z_DATA_ERROR;this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=
h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b)}c=258+(c&31)+(c>>5&31);if(this.blens==null||this.blens.length<c)this.blens=new Int32Array(c);else for(l=0;l<c;l++)this.blens[l]=0;d>>>=14;e-=14;this.index=0;mode=IB_BTREE;case IB_BTREE:for(;this.index<4+(this.table>>>10);){for(;e<3;){if(j!=0)b=Z_OK;else{this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b)}j--;d|=(a.next_in[h++]&255)<<e;e+=8}this.blens[INFBLOCKS_BORDER[this.index++]]=
d&7;d>>>=3;e-=3}for(;this.index<19;)this.blens[INFBLOCKS_BORDER[this.index++]]=0;this.bb[0]=7;c=this.inftree.inflate_trees_bits(this.blens,this.bb,this.tb,this.hufts,a);if(c!=Z_OK){b=c;if(b==Z_DATA_ERROR){this.blens=null;this.mode=IB_BAD}this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;write=i;return this.inflate_flush(a,b)}this.index=0;this.mode=IB_DTREE;case IB_DTREE:for(;;){c=this.table;if(!(this.index<258+(c&31)+(c>>5&31)))break;for(c=this.bb[0];e<c;){if(j!=
0)b=Z_OK;else{this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b)}j--;d|=(a.next_in[h++]&255)<<e;e+=8}c=this.hufts[(this.tb[0]+(d&inflate_mask[c]))*3+1];o=this.hufts[(this.tb[0]+(d&inflate_mask[c]))*3+2];if(o<16){d>>>=c;e-=c;this.blens[this.index++]=o}else{l=o==18?7:o-14;for(m=o==18?11:3;e<c+l;){if(j!=0)b=Z_OK;else{this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,
b)}j--;d|=(a.next_in[h++]&255)<<e;e+=8}d>>>=c;e-=c;m+=d&inflate_mask[l];d>>>=l;e-=l;l=this.index;c=this.table;if(l+m>258+(c&31)+(c>>5&31)||o==16&&l<1){this.blens=null;this.mode=IB_BAD;a.msg="invalid bit length repeat";b=Z_DATA_ERROR;this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b)}o=o==16?this.blens[l-1]:0;do this.blens[l++]=o;while(--m!=0);this.index=l}}this.tb[0]=-1;m=new Int32Array(1);o=new Int32Array(1);q=new Int32Array(1);
p=new Int32Array(1);m[0]=9;o[0]=6;c=this.table;c=this.inftree.inflate_trees_dynamic(257+(c&31),1+(c>>5&31),this.blens,m,o,q,p,this.hufts,a);if(c!=Z_OK){if(c==Z_DATA_ERROR){this.blens=null;this.mode=BAD}b=c;this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b)}this.codes.init(m[0],o[0],this.hufts,q[0],this.hufts,p[0],a);this.mode=IB_CODES;case IB_CODES:this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=
h;this.write=i;if((b=this.codes.proc(this,a,b))!=Z_STREAM_END)return this.inflate_flush(a,b);b=Z_OK;this.codes.free(a);h=a.next_in_index;j=a.avail_in;d=this.bitb;e=this.bitk;i=this.write;l=i<this.read?this.read-i-1:this.end-i;if(this.last==0){this.mode=IB_TYPE;break}this.mode=IB_DRY;case IB_DRY:this.write=i;b=this.inflate_flush(a,b);i=this.write;if(this.read!=this.write){this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b)}mode=
DONE;case IB_DONE:b=Z_STREAM_END;this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b);case IB_BAD:b=Z_DATA_ERROR;this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b);default:b=Z_STREAM_ERROR;this.bitb=d;this.bitk=e;a.avail_in=j;a.total_in+=h-a.next_in_index;a.next_in_index=h;this.write=i;return this.inflate_flush(a,b)}};
InfBlocks.prototype.free=function(a){this.reset(a,null);this.hufts=this.window=null};InfBlocks.prototype.set_dictionary=function(a,b,c){arrayCopy(a,b,window,0,c);this.read=this.write=c};InfBlocks.prototype.sync_point=function(){return this.mode==IB_LENS};
InfBlocks.prototype.inflate_flush=function(a,b){var c,d,e;d=a.next_out_index;e=this.read;c=(e<=this.write?this.write:this.end)-e;if(c>a.avail_out)c=a.avail_out;if(c!=0&&b==Z_BUF_ERROR)b=Z_OK;a.avail_out-=c;a.total_out+=c;if(this.checkfn!=null)a.adler=this.check=a._adler.adler32(this.check,this.window,e,c);arrayCopy(this.window,e,a.next_out,d,c);d+=c;e+=c;if(e==this.end){e=0;if(this.write==this.end)this.write=0;c=this.write-e;if(c>a.avail_out)c=a.avail_out;if(c!=0&&b==Z_BUF_ERROR)b=Z_OK;a.avail_out-=
c;a.total_out+=c;if(this.checkfn!=null)a.adler=this.check=a._adler.adler32(this.check,this.window,e,c);arrayCopy(this.window,e,a.next_out,d,c);d+=c;e+=c}a.next_out_index=d;this.read=e;return b};var IC_START=0,IC_LEN=1,IC_LENEXT=2,IC_DIST=3,IC_DISTEXT=4,IC_COPY=5,IC_LIT=6,IC_WASH=7,IC_END=8,IC_BADCODE=9;function InfCodes(){}InfCodes.prototype.init=function(a,b,c,d,e,h){this.mode=IC_START;this.lbits=a;this.dbits=b;this.ltree=c;this.ltree_index=d;this.dtree=e;this.dtree_index=h;this.tree=null};
InfCodes.prototype.proc=function(a,b,c){var d,e,h=0,j=0,i=0,l,m,o;i=b.next_in_index;l=b.avail_in;h=a.bitb;j=a.bitk;m=a.write;for(o=m<a.read?a.read-m-1:a.end-m;;)switch(this.mode){case IC_START:if(o>=258&&l>=10){a.bitb=h;a.bitk=j;b.avail_in=l;b.total_in+=i-b.next_in_index;b.next_in_index=i;a.write=m;c=this.inflate_fast(this.lbits,this.dbits,this.ltree,this.ltree_index,this.dtree,this.dtree_index,a,b);i=b.next_in_index;l=b.avail_in;h=a.bitb;j=a.bitk;m=a.write;o=m<a.read?a.read-m-1:a.end-m;if(c!=Z_OK){this.mode=
c==Z_STREAM_END?IC_WASH:IC_BADCODE;break}}this.need=this.lbits;this.tree=this.ltree;this.tree_index=this.ltree_index;this.mode=IC_LEN;case IC_LEN:for(d=this.need;j<d;){if(l!=0)c=Z_OK;else{a.bitb=h;a.bitk=j;b.avail_in=l;b.total_in+=i-b.next_in_index;b.next_in_index=i;a.write=m;return a.inflate_flush(b,c)}l--;h|=(b.next_in[i++]&255)<<j;j+=8}d=(this.tree_index+(h&inflate_mask[d]))*3;h>>>=this.tree[d+1];j-=this.tree[d+1];e=this.tree[d];if(e==0){this.lit=this.tree[d+2];this.mode=IC_LIT;break}if((e&16)!=
0){this.get=e&15;this.len=this.tree[d+2];this.mode=IC_LENEXT;break}if((e&64)==0){this.need=e;this.tree_index=d/3+this.tree[d+2];break}if((e&32)!=0){this.mode=IC_WASH;break}this.mode=IC_BADCODE;b.msg="invalid literal/length code";c=Z_DATA_ERROR;a.bitb=h;a.bitk=j;b.avail_in=l;b.total_in+=i-b.next_in_index;b.next_in_index=i;a.write=m;return a.inflate_flush(b,c);case IC_LENEXT:for(d=this.get;j<d;){if(l!=0)c=Z_OK;else{a.bitb=h;a.bitk=j;b.avail_in=l;b.total_in+=i-b.next_in_index;b.next_in_index=i;a.write=
m;return a.inflate_flush(b,c)}l--;h|=(b.next_in[i++]&255)<<j;j+=8}this.len+=h&inflate_mask[d];h>>=d;j-=d;this.need=this.dbits;this.tree=this.dtree;this.tree_index=this.dtree_index;this.mode=IC_DIST;case IC_DIST:for(d=this.need;j<d;){if(l!=0)c=Z_OK;else{a.bitb=h;a.bitk=j;b.avail_in=l;b.total_in+=i-b.next_in_index;b.next_in_index=i;a.write=m;return a.inflate_flush(b,c)}l--;h|=(b.next_in[i++]&255)<<j;j+=8}d=(this.tree_index+(h&inflate_mask[d]))*3;h>>=this.tree[d+1];j-=this.tree[d+1];e=this.tree[d];if((e&
16)!=0){this.get=e&15;this.dist=this.tree[d+2];this.mode=IC_DISTEXT;break}if((e&64)==0){this.need=e;this.tree_index=d/3+this.tree[d+2];break}this.mode=IC_BADCODE;b.msg="invalid distance code";c=Z_DATA_ERROR;a.bitb=h;a.bitk=j;b.avail_in=l;b.total_in+=i-b.next_in_index;b.next_in_index=i;a.write=m;return a.inflate_flush(b,c);case IC_DISTEXT:for(d=this.get;j<d;){if(l!=0)c=Z_OK;else{a.bitb=h;a.bitk=j;b.avail_in=l;b.total_in+=i-b.next_in_index;b.next_in_index=i;a.write=m;return a.inflate_flush(b,c)}l--;
h|=(b.next_in[i++]&255)<<j;j+=8}this.dist+=h&inflate_mask[d];h>>=d;j-=d;this.mode=IC_COPY;case IC_COPY:for(d=m-this.dist;d<0;)d+=a.end;for(;this.len!=0;){if(o==0){if(m==a.end&&a.read!=0){m=0;o=m<a.read?a.read-m-1:a.end-m}if(o==0){a.write=m;c=a.inflate_flush(b,c);m=a.write;o=m<a.read?a.read-m-1:a.end-m;if(m==a.end&&a.read!=0){m=0;o=m<a.read?a.read-m-1:a.end-m}if(o==0){a.bitb=h;a.bitk=j;b.avail_in=l;b.total_in+=i-b.next_in_index;b.next_in_index=i;a.write=m;return a.inflate_flush(b,c)}}}a.window[m++]=
a.window[d++];o--;if(d==a.end)d=0;this.len--}this.mode=IC_START;break;case IC_LIT:if(o==0){if(m==a.end&&a.read!=0){m=0;o=m<a.read?a.read-m-1:a.end-m}if(o==0){a.write=m;c=a.inflate_flush(b,c);m=a.write;o=m<a.read?a.read-m-1:a.end-m;if(m==a.end&&a.read!=0){m=0;o=m<a.read?a.read-m-1:a.end-m}if(o==0){a.bitb=h;a.bitk=j;b.avail_in=l;b.total_in+=i-b.next_in_index;b.next_in_index=i;a.write=m;return a.inflate_flush(b,c)}}}c=Z_OK;a.window[m++]=this.lit;o--;this.mode=IC_START;break;case IC_WASH:if(j>7){j-=8;
l++;i--}a.write=m;c=a.inflate_flush(b,c);m=a.write;if(a.read!=a.write){a.bitb=h;a.bitk=j;b.avail_in=l;b.total_in+=i-b.next_in_index;b.next_in_index=i;a.write=m;return a.inflate_flush(b,c)}this.mode=IC_END;case IC_END:c=Z_STREAM_END;a.bitb=h;a.bitk=j;b.avail_in=l;b.total_in+=i-b.next_in_index;b.next_in_index=i;a.write=m;return a.inflate_flush(b,c);case IC_BADCODE:c=Z_DATA_ERROR;a.bitb=h;a.bitk=j;b.avail_in=l;b.total_in+=i-b.next_in_index;b.next_in_index=i;a.write=m;return a.inflate_flush(b,c);default:c=
Z_STREAM_ERROR;a.bitb=h;a.bitk=j;b.avail_in=l;b.total_in+=i-b.next_in_index;b.next_in_index=i;a.write=m;return a.inflate_flush(b,c)}};InfCodes.prototype.free=function(){};
InfCodes.prototype.inflate_fast=function(a,b,c,d,e,h,j,i){var l,m,o,q,p,s,r,t,v,u,x,z;s=i.next_in_index;r=i.avail_in;q=j.bitb;p=j.bitk;t=j.write;v=t<j.read?j.read-t-1:j.end-t;a=inflate_mask[a];u=inflate_mask[b];do{for(;p<20;){r--;q|=(i.next_in[s++]&255)<<p;p+=8}l=q&a;m=c;o=d;z=(o+l)*3;if((b=m[z])==0){q>>=m[z+1];p-=m[z+1];j.window[t++]=m[z+2];v--}else{do{q>>=m[z+1];p-=m[z+1];if((b&16)!=0){b&=15;x=m[z+2]+(q&inflate_mask[b]);q>>=b;for(p-=b;p<15;){r--;q|=(i.next_in[s++]&255)<<p;p+=8}l=q&u;m=e;o=h;z=(o+
l)*3;b=m[z];do{q>>=m[z+1];p-=m[z+1];if((b&16)!=0){for(b&=15;p<b;){r--;q|=(i.next_in[s++]&255)<<p;p+=8}l=m[z+2]+(q&inflate_mask[b]);q>>=b;p-=b;v-=x;if(t>=l){l=t-l;j.window[t++]=j.window[l++];j.window[t++]=j.window[l++];x-=2}else{l=t-l;do l+=j.end;while(l<0);b=j.end-l;if(x>b){x-=b;if(t-l>0&&b>t-l){do j.window[t++]=j.window[l++];while(--b!=0)}else{arrayCopy(j.window,l,j.window,t,b);t+=b}l=0}}do j.window[t++]=j.window[l++];while(--x!=0);break}else if((b&64)==0){l+=m[z+2];l+=q&inflate_mask[b];z=(o+l)*
3;b=m[z]}else{i.msg="invalid distance code";x=i.avail_in-r;x=p>>3<x?p>>3:x;r+=x;s-=x;p-=x<<3;j.bitb=q;j.bitk=p;i.avail_in=r;i.total_in+=s-i.next_in_index;i.next_in_index=s;j.write=t;return Z_DATA_ERROR}}while(1);break}if((b&64)==0){l+=m[z+2];l+=q&inflate_mask[b];z=(o+l)*3;if((b=m[z])==0){q>>=m[z+1];p-=m[z+1];j.window[t++]=m[z+2];v--;break}}else if((b&32)!=0){x=i.avail_in-r;x=p>>3<x?p>>3:x;r+=x;s-=x;p-=x<<3;j.bitb=q;j.bitk=p;i.avail_in=r;i.total_in+=s-i.next_in_index;i.next_in_index=s;j.write=t;return Z_STREAM_END}else{i.msg=
"invalid literal/length code";x=i.avail_in-r;x=p>>3<x?p>>3:x;r+=x;s-=x;p-=x<<3;j.bitb=q;j.bitk=p;i.avail_in=r;i.total_in+=s-i.next_in_index;i.next_in_index=s;j.write=t;return Z_DATA_ERROR}}while(1)}}while(v>=258&&r>=10);x=i.avail_in-r;x=p>>3<x?p>>3:x;r+=x;s-=x;p-=x<<3;j.bitb=q;j.bitk=p;i.avail_in=r;i.total_in+=s-i.next_in_index;i.next_in_index=s;j.write=t;return Z_OK};function InfTree(){}
InfTree.prototype.huft_build=function(a,b,c,d,e,h,j,i,l,m,o){var q,p,s,r,t,v,u,x,z;v=0;p=c;do{this.c[a[b+v]]++;v++;p--}while(p!=0);if(this.c[0]==c){j[0]=-1;i[0]=0;return Z_OK}t=i[0];for(s=1;s<=BMAX;s++)if(this.c[s]!=0)break;r=s;if(t<s)t=s;for(p=BMAX;p!=0;p--)if(this.c[p]!=0)break;m=p;if(t>p)t=p;i[0]=t;for(i=1<<s;s<p;s++,i<<=1)if((i-=this.c[s])<0)return Z_DATA_ERROR;if((i-=this.c[p])<0)return Z_DATA_ERROR;this.c[p]+=i;this.x[1]=s=0;v=1;for(u=2;--p!=0;){this.x[u]=s+=this.c[v];u++;v++}v=p=0;do{if((s=
a[b+v])!=0)this.v[this.x[s]++]=p;v++}while(++p<c);c=this.x[m];v=this.x[0]=p=0;b=-1;x=-t;for(z=u=this.u[0]=0;r<=m;r++)for(a=this.c[r];a--!=0;){for(;r>x+t;){b++;x+=t;z=m-x;z=z>t?t:z;if((q=1<<(s=r-x))>a+1){q-=a+1;u=r;if(s<z)for(;++s<z;){if((q<<=1)<=this.c[++u])break;q-=this.c[u]}}z=1<<s;if(this.hn[0]+z>MANY)return Z_DATA_ERROR;this.u[b]=u=this.hn[0];this.hn[0]+=z;if(b!=0){this.x[b]=p;this.r[0]=s;this.r[1]=t;s=p>>>x-t;this.r[2]=u-this.u[b-1]-s;arrayCopy(this.r,0,l,(this.u[b-1]+s)*3,3)}else j[0]=u}this.r[1]=
r-x;if(v>=c)this.r[0]=192;else if(o[v]<d){this.r[0]=this.v[v]<256?0:96;this.r[2]=this.v[v++]}else{this.r[0]=h[this.v[v]-d]+16+64;this.r[2]=e[this.v[v++]-d]}q=1<<r-x;for(s=p>>>x;s<z;s+=q)arrayCopy(this.r,0,l,(u+s)*3,3);for(s=1<<r-1;(p&s)!=0;s>>>=1)p^=s;p^=s;for(s=(1<<x)-1;(p&s)!=this.x[b];){b--;x-=t;s=(1<<x)-1}}return i!=0&&m!=1?Z_BUF_ERROR:Z_OK};
InfTree.prototype.inflate_trees_bits=function(a,b,c,d,e){this.initWorkArea(19);this.hn[0]=0;a=this.huft_build(a,0,19,19,null,null,c,b,d,this.hn,this.v);if(a==Z_DATA_ERROR)e.msg="oversubscribed dynamic bit lengths tree";else if(a==Z_BUF_ERROR||b[0]==0){e.msg="incomplete dynamic bit lengths tree";a=Z_DATA_ERROR}return a};
InfTree.prototype.inflate_trees_dynamic=function(a,b,c,d,e,h,j,i,l){this.initWorkArea(288);this.hn[0]=0;h=this.huft_build(c,0,a,257,cplens,cplext,h,d,i,this.hn,this.v);if(h!=Z_OK||d[0]==0){if(h==Z_DATA_ERROR)l.msg="oversubscribed literal/length tree";else if(h!=Z_MEM_ERROR){l.msg="incomplete literal/length tree";h=Z_DATA_ERROR}return h}this.initWorkArea(288);h=this.huft_build(c,a,b,0,cpdist,cpdext,j,e,i,this.hn,this.v);if(h!=Z_OK||e[0]==0&&a>257){if(h==Z_DATA_ERROR)l.msg="oversubscribed distance tree";
else if(h==Z_BUF_ERROR){l.msg="incomplete distance tree";h=Z_DATA_ERROR}else if(h!=Z_MEM_ERROR){l.msg="empty distance tree with lengths";h=Z_DATA_ERROR}return h}return Z_OK};function inflate_trees_fixed(a,b,c,d){a[0]=fixed_bl;b[0]=fixed_bd;c[0]=fixed_tl;d[0]=fixed_td;return Z_OK}
InfTree.prototype.initWorkArea=function(a){if(this.hn==null){this.hn=new Int32Array(1);this.v=new Int32Array(a);this.c=new Int32Array(BMAX+1);this.r=new Int32Array(3);this.u=new Int32Array(BMAX);this.x=new Int32Array(BMAX+1)}if(this.v.length<a)this.v=new Int32Array(a);for(var b=0;b<a;b++)this.v[b]=0;for(b=0;b<BMAX+1;b++)this.c[b]=0;for(b=0;b<3;b++)this.r[b]=0;arrayCopy(this.c,0,this.u,0,BMAX);arrayCopy(this.c,0,this.x,0,BMAX+1)};
var testArray=new Uint8Array(1),hasSubarray=typeof testArray.subarray==="function",hasSlice=false;function arrayCopy(a,b,c,d,e){if(e!=0){if(a){if(!c)throw"Undef dest";}else throw"Undef src";if(b==0&&e==a.length)arrayCopy_fast(a,c,d);else if(hasSubarray)arrayCopy_fast(a.subarray(b,b+e),c,d);else a.BYTES_PER_ELEMENT==1&&e>100?arrayCopy_fast(new Uint8Array(a.buffer,a.byteOffset+b,e),c,d):arrayCopy_slow(a,b,c,d,e)}}function arrayCopy_slow(a,b,c,d,e){for(var h=0;h<e;++h)c[d+h]=a[b+h]}
function arrayCopy_fast(a,b,c){b.set(a,c)}var ADLER_BASE=65521,ADLER_NMAX=5552;
function adler32(a,b,c,d){if(b==null)return 1;var e=a&65535;a=a>>16&65535;for(var h;d>0;){h=d<ADLER_NMAX?d:ADLER_NMAX;for(d-=h;h>=16;){e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;e+=b[c++]&255;a+=e;h-=16}if(h!=0){do{e+=b[c++]&255;a+=e}while(--h!=0)}e%=ADLER_BASE;
a%=ADLER_BASE}return a<<16|e}
function jszlib_inflate_buffer(a,b,c,d){a=b?new Uint8Array(a,b,c):new Uint8Array(a);c=new ZStream;c.inflateInit(DEF_WBITS,true);c.next_in=a;c.next_in_index=0;c.avail_in=a.length;a=[];for(var e=0;;){var h=new Uint8Array(32E3);c.next_out=h;c.next_out_index=0;c.avail_out=h.length;var j=c.inflate(Z_NO_FLUSH);if(j!=Z_OK&&j!=Z_STREAM_END&&j!=Z_BUF_ERROR)throw c.msg;if(c.avail_out!=0){var i=new Uint8Array(h.length-c.avail_out);arrayCopy(h,0,i,0,h.length-c.avail_out);h=i}a.push(h);e+=h.length;if(j==Z_STREAM_END||
j==Z_BUF_ERROR)break}if(d)d[0]=(b||0)+c.next_in_index;if(a.length==1)return a[0].buffer;else{b=new Uint8Array(e);for(c=d=0;c<a.length;++c){e=a[c];arrayCopy(e,0,b,d,e.length);d+=e.length}return b.buffer}}
(function(){function a(){p.call(document.querySelectorAll("input[type=range]"),c);(new MutationObserver(function(r){r.forEach(function(t){t.addedNodes&&p.call(t.addedNodes,function(v){b(v);v.childElementCount&&p.call(v.querySelectorAll("input"),b)})})})).observe(document,{childList:true,subtree:true})}function b(r){r.localName=="input"&&r.type!="range"&&r.getAttribute("type")=="range"&&c(r)}function c(r){function t(T){var E=(parseFloat(getComputedStyle(this,0).width)-l.width)/Z;if(E){G+=(T.clientX-
L)/E;L=T.clientX;D=true;this.value=G}}function v(){this.removeEventListener("mousemove",t,true);this.removeEventListener("mouseup",v,true)}function u(){if(!O)this.style.boxShadow=!i?"0 0 0 2px #fb0":"inset 0 0 20px rgba(0,127,255,.1), 0 0 1px rgba(0,127,255,.4)"}function x(T){return!isNaN(T)&&+T==parseFloat(T)}function z(){M=x(r.min)?+r.min:0;S=x(r.max)?+r.max:100;if(S<M)S=M>100?M:100;aa=x(r.step)&&r.step>0?+r.step:1;Z=S-M;H(true)}function H(T){if(!C&&!A)W=r.getAttribute("value");x(W)||(W=(M+S)/2);
W=Math.round((W-M)/aa)*aa+M;if(W<M)W=M;else if(W>S)W=M+~~(Z/aa)*aa;D&&W!=B&&r.dispatchEvent(s);D=false;if(!(!T&&W==B)){B=W;d(r,{background:"-moz-element(#__sliderthumb__) "+(Z?(W-M)/Z*100:0)+"% no-repeat, "+m})}}var C,A,D,O,B,G,L,M,S,aa,Z,W=r.value;if(!j){j=document.body.appendChild(document.createElement("hr"));d(j,{"-moz-appearance":i?"scale-horizontal":"scalethumb-horizontal",display:"block",visibility:"visible",opacity:1,position:"fixed",top:"-999999px"});document.mozSetImageElement("__sliderthumb__",
j)}var da=function(){return""+W};r.__defineGetter__("value",da);r.__defineSetter__("value",function T(E){W=""+E;C=true;H();delete r.value;r.value=W;r.__defineGetter__("value",da);r.__defineSetter__("value",T)});r.__defineGetter__("type",function(){return"range"});["min","max","step"].forEach(function(T){if(r.hasAttribute(T))A=true;r.__defineGetter__(T,function(){return this.hasAttribute(T)?this.getAttribute(T):""});r.__defineSetter__(T,function(E){E===null?this.removeAttribute(T):this.setAttribute(T,
E)})});r.readOnly=true;d(r,o);z();(new MutationObserver(function(T){T.forEach(function(E){if(E.attributeName!="value"){z();A=true}else if(!C){W=r.getAttribute("value");H()}})})).observe(r,q);r.addEventListener("mousedown",function(T){O=true;setTimeout(function(){O=false},0);if(!(T.button||!Z)){var E=(parseFloat(getComputedStyle(this,0).width)-l.width)/Z;if(E){var J=T.clientX-this.getBoundingClientRect().left-l.width/2-(W-M)*E;if(Math.abs(J)>l.radius){D=true;this.value-=-J/E}G=W;L=T.clientX;this.addEventListener("mousemove",
t,true);this.addEventListener("mouseup",v,true)}}},true);r.addEventListener("keydown",function(T){if(T.keyCode>36&&T.keyCode<41){u.call(this);D=true;this.value=W+(T.keyCode==38||T.keyCode==39?aa:-aa)}},true);r.addEventListener("focus",u,true);r.addEventListener("blur",function(){this.style.boxShadow=""},true)}function d(r,t){for(var v in t)r.style.setProperty(v,t[v],"important")}var e=document.createElement("input");try{e.type="range";if(e.type=="range")return}catch(h){return}e.style.background="linear-gradient(red, red)";
if(!(!e.style.backgroundImage||!("MozAppearance"in e.style)||!document.mozSetImageElement||!this.MutationObserver)){var j,i=navigator.platform=="MacIntel",l={radius:i?9:6,width:i?22:12,height:i?16:20},m="linear-gradient(transparent "+(i?"6px, #999 6px, #999 7px, #ccc 8px, #bbb 9px, #bbb 10px, transparent 10px":"9px, #999 9px, #bbb 10px, #fff 11px, transparent 11px")+", transparent)",o={"min-width":l.width+"px","min-height":l.height+"px","max-height":l.height+"px",padding:"0 0 "+(i?"2px":"1px"),border:0,
"border-radius":0,cursor:"default","text-indent":"-999999px"},q={attributes:true,attributeFilter:["min","max","step","value"]},p=Array.prototype.forEach,s=document.createEvent("HTMLEvents");s.initEvent("change",true,false);document.readyState=="loading"?document.addEventListener("DOMContentLoaded",a,true):a()}})();
