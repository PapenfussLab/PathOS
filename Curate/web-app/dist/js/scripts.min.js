var PathOS=PathOS||{};PathOS.version="PathOS.js build: 16th of September 2019",PathOS.application=application||"/PathOS",PathOS.data={load:function(e,t){var a=t||{};return localStorage[`PathOS${PathOS.application}-${e}`]&&(a=JSON.parse(localStorage[`PathOS${PathOS.application}-${e}`])),a},save:function(e,t){localStorage[`PathOS${PathOS.application}-${e}`]=JSON.stringify(t)},clear:function(e){delete localStorage[`PathOS${PathOS.application}-${e}`]},clean:function(){delete localStorage[`PathOS${PathOS.application}-history`],delete localStorage[`PathOS${PathOS.application}-modules`]}},PathOS.criteria={acmgClasses:{0:"Unclassified",1:"C1: Not pathogenic",2:"C2: Unlikely pathogenic",3:"C3: Unknown pathogenicity (Level A)",4:"C3: Unknown pathogenicity (Level B)",5:"C3: Unknown pathogenicity",6:"C3: Unknown pathogenicity (Level C)",7:"C4: Likely pathogenic",8:"C5: Pathogenic"},drawAcmg:function(e,t){const a=d3.select("#"+e).html("").append("div"),n=t.text||"Unclassified";let o=t.classes||"";o+="Unclassified"==n?" cv-Unclassified":" cv-C"+n.slice(1,2),o+=" bordered-classification",a.classed(o,!0).text(n)},drawAmp:function(e,t){const a=d3.select("#"+e).html("").append("div"),n=t.text||"Unclassified";let o=t.classes||"";o+=" amp-"+n.replace(" ","-"),o+=" bordered-classification",a.classed(o,!0).text(n)},drawOverall:function(e,t){const a=d3.select("#"+e).html("").append("div"),n=t.text||"Unclassified";let o=t.classes||"";o+=" "+{Unclassified:"overall-Unclassified","CS: Clinically Significant":"overall-CS","UCS: Unclear Clinical Significance":"overall-UCS","NCS: Not Clinically Significant":"overall-NCS"}[n],o+=" bordered-classification",a.classed(o,!0).text(n)}},PathOS.formatDate=function(e){return e?new Date(e).toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric"}):"No date in system"},PathOS.graphSpace=function(e){const t=this;t.toBeLoaded=null,t.graphs=[];const a=e.div,n=a.append("div").classed("infoBar",!0);n.append("h1").text(e.title);const o=n.append("table"),i=o.append("thead").append("tr");i.append("th").text("Sample"),i.append("th").text("Type"),i.append("th").text("Intersect"),i.append("th").text("Action");const s=o.append("tbody");a.append("div").classed("workspace",!0);const r=a.append("div").classed("tabs",!0),l=a.append("div").classed("graphdiv",!0).append("svg").attr("viewBox","0 0 800 600").append("g").attrs({width:800,height:600});function c(e){console.log(e),e.data.intersect.text("N/A"),e.data.action.text("N/A").on("click",null).style("color","").style("background",""),t.graphs.forEach((function(t){t.init(e),t.hideGraph()})),t.currentGraph.showGraph()}l.append("rect").attrs({width:800,height:600,fill:"white",stroke:"black","stroke-width":"2px"}),this.control=null,this.samples=[],this.currentGraph=null,this.applyData=function(a){t.toBeLoaded=a.length,t.color=d3.scaleOrdinal(e.colours).domain(a.map(e=>e.name)),s.selectAll("tr").data(a).enter().append("tr").each((function(e){const a=d3.select(this).attr("id","tr-"+e.name);a.append("td").text(e.name),a.append("td").text(e.type);let n=a.append("td").text("?");const i=a.append("td").classed("action",!0),s=i.append("img").style("width","46px").attr("src",`${PathOS.application}/dist/images/pathos_logo_animated.svg`);d3.tsv(e.tsv_url,(function(a){s.remove();let r=new p({id:e.name,info:e,data:a,intersect:n,td:i,action:i,color:t.color(e.name),values:a.map((function(e){return{region:e.Region,coverage:e["Mean coverage"]}}))});t.samples.push(r),"control"===e.type&&(t.control=r),--t.toBeLoaded<=0&&($("#loadingCharts").remove(),t.control?c(t.control):o.selectAll("td:last-child").text("Control?").on("click.pickControl",(function(e){$("#tr-"+e.id).insertBefore(".infoBar table tbody tr:first-child"),o.selectAll("td:last-child").text("Loaded!").on("click.pickControl",null),t.control=r,c(t.control)})))}))}))},this.addGraph=function(e){let a=new d(e);t.graphs.push(a),t.currentGraph||(t.currentGraph=a)};const d=function(e){const a=this;this.id=e.id,this.name=e.name,this.displayedData=displayedData={},r.append("div").classed("tab",!0).append("a").attr("href","#linegraph").on("click",(function(){a.showGraph()})).text(e.name);let n=l.append("g").classed("graph",!0).attr("id","graph-"+e.id);this.margin=margin={top:20,right:20,bottom:30,left:50},this.width=800-margin.left-margin.right,this.height=600-margin.top-margin.bottom,this.g=g=n.append("g").attr("transform","translate("+margin.left+" "+margin.top+")"),this.xAxis=g.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+this.height+")"),this.xLabel=this.xAxis.append("text").style("text-anchor","middle").style("font-size","16px").attr("x",this.width/2).attr("y",6).attr("dy","0.9em").attr("fill","#000"),this.yAxis=g.append("g").attr("class","axis axis--y"),this.yLabel=this.yAxis.append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy","0.71em").attr("fill","#000"),this.scatterNodes=scatterNodes=g.append("g").classed("scatterNodes",!0);var o=g.append("g");o.append("rect").attrs({x:0,y:-(this.margin.top-1),width:this.width+this.margin.right-1,height:this.margin.top-1,fill:"white"}),this.yBounds=function(){let e=-100,t=100;const a=this.displayedData;return Object.keys(a).forEach((function(n){e=a[n].reduce((e,t)=>Math.min(e,t)),t=a[n].reduce((e,t)=>Math.max(e,t))})),[e,t]},this.expand=function(){console.log("expanding..."),a.y.domain(a.yBounds()),a.yAxis.transition().duration(750).call(d3.axisLeft(a.y)),i.text("").on("click",a.collapse),a.repaint()},this.collapse=function(){console.log("collapsing..."),a.y.domain(a.defaultYdomain),a.yAxis.transition().duration(750).call(d3.axisLeft(a.y)),i.text("").on("click",a.expand),a.repaint()},this.repaint=function(){console.log("Repainting..."),d3.select("#linegraph .control path").transition().duration(750).attr("d",(function(e){return line(e.values)})),this.scatterNodes.selectAll(".sample circle").transition().duration(750).attr("cy",(function(e){return a.y(e)}))};var i=o.append("g").style("text-anchor","middle").style("font-size","20px").style("transform","translate("+this.width/2+"px, 0)").style("cursor","pointer").append("text").classed("fa",!0).text("").on("click",a.expand);this.showGraph=function(){t.currentGraph&&t.currentGraph.hideGraph(),t.currentGraph=this,this.g.style("display","inherit")},this.hideGraph=function(){this.g.style("display","none")},this.add=e.add,this.init=e.init},p=function(e){this.data=e,e.action.text("Loaded!").datum(e).style("cursor","pointer").style("user-select","none").style("color",e.color).on("click",h)};function h(e){var a=d3.select(this);a.classed("loaded")?(a.classed("loaded",!1),a.styles({background:"none",color:t.color(e.id)}),t.removeSample(e.id)):(a.classed("loaded",!0),a.styles({background:t.color(e.id),color:"black"}),t.control&&t.graphs.forEach((function(t){t.add(e)})))}this.removeSample=function(e){delete displayedData[e];var t=d3.selectAll(".svg-"+e);t.selectAll("circle").transition().duration(500).attr("r",0).remove(),setTimeout((function(){t.remove()}),600)}},PathOS.escapeHtml=function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};return String(e).replace(/[&<>"'`=\/]/g,(function(e){return t[e]}))},PathOS.module=function(e){PathOS.modules.map[e.name]={data:e,object:this};var t=d3.select("#"+e.name);t.empty()&&(t=this.div=d3.select("#sidebar").append("div").classed("module",!0).attr("id",e.name));var a=t.select(".moduletitle");function n(e){var t="";e.title.toLowerCase().indexOf("seqrun")>=0||e.title.toLowerCase().indexOf("show sequencing run")>=0?t="Seqrun":e.title.toLowerCase().indexOf("pubmed")>=0?t="Pubmed":e.title.toLowerCase().indexOf("sequenced variants list")>=0||e.title.toLowerCase().indexOf("edit report")>=0||e.title.toLowerCase().indexOf("show sequenced samples")>=0||e.title.toLowerCase().indexOf("sequenced samples list")>=0?t="SeqSample":e.title.toLowerCase().indexOf("curvar")>=0||e.title.toLowerCase().indexOf("curated variants list")>=0?t="CurVariant":e.title.toLowerCase().indexOf("patient")>=0&&(t="PatSample");var a=d.append("tr");a.append("td").append("a").attr("href",e.url).text(e.title).classed(t,!0),a.append("td").text(PathOS.timeSince(e.time))}if(a.empty()?(a=t.append("table").classed("moduletitle",!0).append("tr")).append("td").classed("modulelabel",!0).datum(e).on("click",this.toggle).append("a").attr("href","#"+e.name).append("h1").text(e.title):a.select("td").classed("modulelabel",!0).datum(e).on("click",this.toggle),a.insert("td","td").datum(e).on("click",this.toggle).append("a").attr("href","#"+e.name).append("i").classed("fa fa-minus-square minimise",!0),e.type){var o=t.append("div").classed("content",!0);switch(e.type){case"changelog":Object.keys(e.data).forEach((function(t){o.append("h4").text(t).styles({margin:"0 5px"});var a=o.append("ul");e.data[t].forEach((function(e){a.append("li").text(e)}))}));break;case"tags":var i=a.append("td").attr("id","tags_edit_button").on("click",(function(){$("#tags").toggleClass("editing"),$("#tags_edit_button i").toggleClass("fa-pencil-square-o"),$("#tags_edit_button i").toggleClass("fa-pencil-square")})).append("a").attr("href","#"+e.name);i.append("span").html("(Editing)&nbsp;"),i.append("i").classed("button fa fa-pencil-square-o",!0),a.append("td").append("a").attr("href","#"+e.name).append("i").classed("fa fa-times",!0).style("padding-bottom","1px").on("click",(function(t){d3.select("#"+e.name).style("display","none"),e.closeModule()})),d3.select("#tags").style("display","none");var s=o.append("table").append("thead").append("tr").classed("row",!0);s.append("th").text(e.data.object),s.append("th").text("").attr("id","object_id").style("text-align","right");var r=o.append("div").classed("outlined-box tags_field",!0).attr("id","moduleTagBox").on("click",(function(){$("#tag_text_area").focus()}));e.data.tags.forEach((function(e){PathOS.tags.drawTag(r,e,!0)})),r.append("textarea").attr("id","tag_text_area").attr("placeholder","Enter Tags Here"),$("#tag_text_area").autocomplete({source:e.data.availableTags}),$("body").on("keydown",(function(e){if(e&&e.keyCode&&13==e.keyCode&&$(document.activeElement).is("#tag_text_area")){var t=$("#tag_text_area").val().trim();$("#tag_text_area").val(""),t&&""!==t&&PathOS.tags.current_object&&PathOS.tags.addTag(r,t)}else if(e&&e.keyCode&&8==e.keyCode&&$(document.activeElement).is("#tag_text_area")&&""===$("#tag_text_area").val()&&0!==$("#moduleTagBox.tags_field .tagdiv:last").length)if($("#moduleTagBox.tags_field .tagdiv:last").hasClass("deleteFlag")){var a=d3.select($("#moduleTagBox.tags_field .tagdiv:last")[0]).datum();if(confirm('Remove tag "'+a.label+'" from this object?')){var n={type:PathOS.controller,objid:PathOS.tags.current_object,tagid:a.id};$.ajax({type:"DELETE",url:`${PathOS.application}/tag/removeLink?${$.param(n)}`,error:function(e){alert("You are currently logged out, please refresh the page and log back in.")},success:function(e){"fail"!=e&&($(".tag-"+a.id).remove(),reloadGrid&&reloadGrid())},cache:!1,contentType:!1,processData:!1})}}else $("#moduleTagBox.tags_field .tagdiv:last").toggleClass("deleteFlag").on("click",(function(){var e=d3.select($("#moduleTagBox.tags_field .tagdiv:last")[0]).datum(),t={type:PathOS.controller,objid:PathOS.tags.current_object,tagid:e.id};$.ajax({type:"DELETE",url:`${PathOS.application}/tag/removeLink?${$.param(t)}`,error:function(e){alert("You are currently logged out, please refresh the page and log back in.")},success:function(t){"fail"!=t&&($(".tag-"+e.id).remove(),reloadGrid&&reloadGrid())},cache:!1,contentType:!1,processData:!1})}))}));break;case"history":var l=o.append("table"),c=l.append("thead").append("tr"),d=l.append("tbody");c.append("th").text("Page"),c.append("th").text("T"),e.data.forEach(n),d.append("span").append("a").attr("href","#").text("See more").on("click",(function(){PathOS.history.more().forEach(n),$(this).remove()}));break;case"established":o.remove();break;default:var p=o.append("ul").style("clip","rect(0px, 1000px, 0px, 0px)");e.data instanceof Array?e.data.forEach((function(e){p.append("li").html(e)})):Object.keys(e.data).forEach((function(t){p.append("li").html(t+": "+e.data[t])}))}}(t.classed("hide")||e.hide)&&(t.classed("hide",!1),this.toggle(e.name))},PathOS.module.prototype.toggle=function(e){d3.event&&d3.event.preventDefault();var t="string"==typeof e?e:d3.select(this).datum().name,a="#"+t;$(a).toggleClass("hidden"),$(a+" i.minimise").toggleClass("fa-minus-square"),$(a+" i.minimise").toggleClass("fa-plus-square");var n=$(a).height();d3.select(a).classed("hidden")?(d3.select(a).style("min-height","1px"),PathOS.user&&(PathOS.modules.settings[PathOS.user].hide[t]=!0,PathOS.data.save("modules",PathOS.modules.settings))):(d3.select(a).style("min-height",n+"px"),PathOS.user&&(delete PathOS.modules.settings[PathOS.user].hide[t],PathOS.data.save("modules",PathOS.modules.settings)))},PathOS.module.prototype.data=function(){var e=d3.select(this).datum();console.log(e)},PathOS.history={json:[],add:function(e){PathOS.history.json.forEach((function(t,a){t.title==e.title&&PathOS.history.json.splice(a,1)})),PathOS.history.json.push(e),PathOS.history.json.length>50&&(PathOS.history.json=PathOS.history.json.slice(20)),PathOS.data.save("history",PathOS.history.json)},clear:function(){PathOS.history.json=[],PathOS.data.clear("history")},show:function(e){var t=PathOS.history.json,a=e||10;return(t.length<a?t:t.slice(t.length-a)).reverse()},more:function(){var e=PathOS.history.json;return(e.length<50?e:e.slice(e.length-50)).reverse().slice(10)},init:function(){PathOS.history.json=PathOS.data.load("history",[])}},menuItems=[{category:"Sample page",type:"boolean",title:"Compressed view",description:"Use a compressed version of the Sequenced Sample Page.",field:"compressedView"},{category:"Sample page",type:"dropdown",title:"Number of Sequenced Variants to show",options:[20,100,200,1e3],description:"Default number of Sequenced Variants to load per page on the datagrid.",field:"svlistRows"},{category:"Sample page",type:"dragAndDrop",title:"Sequenced Variants Sorting priority",options:{acmgCurVariant:"ACMG in current Clinical Context",allCuratedVariants:"ACMG in all Clinical Contexts",ampCurVariant:"AMP classifcation",overallCurVariant:"Clinical Significance",reportable:"Reportable"},description:"What values should the Sequenced Variants be sorted on for you?",field:"sortPriority"},{category:"Home page",type:"number",title:"Latest Sequenced Runs",description:"How many sequenced runs should be shown on the home page?",field:"numberOfSeqruns",default:10},{category:"Home page",type:"panels",title:"Panel Groups",description:"Which panels do you want to see on your home page?"},{category:"Seqrun page",type:"boolean",title:"New Heatmap",description:"Use the new D3 based heatmap.",field:"d3heatmap"},{category:"History",type:"button",title:"Clear History",description:"Clear recently visited PathOS pages.",action:PathOS.history.clear},{category:"Help",type:"links",links:[{title:"Jira",url:"https://atlassian.petermac.org.au/jira/secure/Dashboard.jspa"},{title:"Confluence",url:"https://atlassian.petermac.org.au/confluence/display/PVS/PathOS+Variant+System"}]}],PathOS.modules={menuVisible:!1,settings:{},map:{},init:function(e){PathOS.modules.settings=PathOS.data.load("modules"),PathOS.controller=e.controller,PathOS.action=e.action,e.user&&(PathOS.user=e.user,PathOS.username=e.username,PathOS.modules.settings[PathOS.user]?(Object.keys(PathOS.modules.settings[PathOS.user].hide).forEach((function(e){document.getElementById(e)&&!d3.select("#"+e).classed("hidden")&&(PathOS.modules.map[e]?PathOS.modules.map[e].object.toggle(e):d3.select("#"+e).classed("hide",!0))})),PathOS.modules.settings[PathOS.user].sidebar[window.location.pathname]&&("show"==PathOS.modules.settings[PathOS.user].sidebar[window.location.pathname]?(d3.select("#wrapper").classed("toggled",!1),d3.select("#sidebar-toggle i").classed("fa-chevron-left",!1),d3.select("#sidebar-toggle i").classed("fa-chevron-right",!0)):"hide"==PathOS.modules.settings[PathOS.user].sidebar[window.location.pathname]&&(d3.select("#wrapper").classed("toggled",!0),d3.select("#sidebar-toggle i").classed("fa-chevron-left",!0),d3.select("#sidebar-toggle i").classed("fa-chevron-right",!1)))):(PathOS.modules.settings[PathOS.user]={sidebar:{},hide:{},svlistIGV:"ask"},PathOS.data.save("modules",PathOS.modules.settings))),d3.select("#sidebar-footer").append("span").append("a").attr("href","#").on("click",(function(){PathOS.modules.menuVisible?PathOS.modules.menu.hide():PathOS.modules.menu.show()})).append("i").attr("class","fa-lg fa fa-cog").attr("aria-hidden","true")},menu:{show:function(){var e=PathOS.overlay.init();e.attr("id","PathOS-options"),e.append("div").attr("id","mmHeader").append("h1").text("PathOS Options"),$.ajax({url:`${PathOS.application}/preferences/fetchPreferences`,error:function(e){alert("You are currently logged out, please refresh the page and log back in.")},success:function(t){if(preferences=t.preferences,PathOS.user){var a="";e.append("table").attr("id","menuItems").selectAll("tr").data(menuItems).enter().append("tr").each((function(e,t){var n=d3.select(this);a==e.category?n.append("td"):n.append("td").text(e.category),a=e.category;var o=n.append("td");switch(o.append("h3").text(e.title),e.type){case"boolean":var i=!1;preferences&&preferences[e.field]&&(i=preferences[e.field]);var s=o.append("div").classed("checkbox-div",!0);s.append("input").attrs({type:"checkbox",id:e.field}).property("checked",i),s.append("label").attrs({for:e.field}).text(e.description);break;case"dropdown":var r=o.append("select").attr("id",e.field);o.append("p").text(e.description),e.options.forEach((function(t){var a=r.append("option").attr("value",t).text(t);preferences&&t==preferences[e.field]&&a.attr("selected",!0)}));break;case"dragAndDrop":console.log(preferences);var l=o.append("ol").attr("id","draggable-sortPriority"),c=preferences.sortPriority||"acmgCurVariant,allCuratedVariants,ampCurVariant,overallCurVariant,reportable";c=c.split(","),console.log(c),c.forEach((function(t){l.append("li").classed("ui-state-default ui-sortable-handle",!0).datum(t).append("span").text(e.options[t])})),$("#draggable-sortPriority").sortable().disableSelection();break;case"number":var d=e.default;preferences&&preferences[e.field]&&(d=preferences[e.field]),o.append("p").text(e.description),o.append("input").attr("id",e.field).style("width","150px").attr("value",d);break;case"button":o.append("input").classed("menuButton",!0).attr("type","button").attr("value",e.description).on("click",e.action);break;case"links":e.links.forEach((function(e){o.append("a").attrs({target:"_blank",href:e.url}).text(e.title)}));break;case"panels":var p="";preferences&&preferences.panelList&&(p=preferences.panelList);var h=o.append("div");h.append("p").text("Panels being shown: ").append("span").datum(p).text(p?p.split(",").join(", "):"All panels.").attr("id","previousPanels"),h.append("a").attrs({id:"lookUpPanelButton",href:"#lookupPanels"}).on("click",(function(e){h.remove(),$.ajax({url:`${PathOS.application}/Panel/fetchAllData`,error:function(e){alert("You are currently logged out, please refresh the page and log back in.")},success:function(e){var t={};e.forEach((function(e){var a={manifest:e[0],group:e[1],description:e[2]};t[a.group]=t[a.group]||[],t[a.group].push(a)}));var a=Object.keys(t).sort();o.append("div").attr("id","panelMenu").selectAll("div.panelSelector").data(a).enter().append("div").classed("panelSelector",!0).each((function(e,a){var n=d3.select(this);n.attr("id",`panelSelectorDiv-${a}`);var o=t[e].sort((e,t)=>t.manifest-e.manifest),i=n.append("span").classed("panelGroupHeader",!0);i.append("input").attrs({type:"checkbox",id:"panelSelector-"+a}).on("change",(function(e){var t=d3.select(this).property("checked");n.selectAll("input[type='checkbox']").property("checked",t)})),i.append("label").attrs({for:"panelSelector-"+a}).text(e);var s=n.append("div").attr("id",`panelSelectorManifests-${a}`);o.forEach((function(e,t){var n=s.append("span").attr("title",e.description),o=n.append("input").attrs({type:"checkbox",class:"manifestCheckbox",id:`manifest-${a}-${t}`}).datum(e.manifest).on("change",(function(e){if(d3.select(this).property("checked")){var t=!1;s.selectAll("input[type='checkbox']").each((function(e){d3.select(this).property("checked")||(t=!0)})),t||i.select("input[type='checkbox']").property("checked",!0)}else i.select("input[type='checkbox']").property("checked",!1)}));if(p.indexOf(e.manifest)>=0){o.property("checked",!0);var r=!1;s.selectAll("input[type='checkbox']").each((function(e){d3.select(this).property("checked")||(r=!0)})),r||i.select("input[type='checkbox']").property("checked",!0)}n.append("label").attrs({for:`manifest-${a}-${t}`}).text(e.manifest)}))}))}})})).text("Look up panels")}}));var n=e.append("div").attr("id","saveAndReset");n.append("a").attrs({id:"menuSaveButton",href:"#save"}).text("Save").on("click",(function(e){var t="";d3.select("#previousPanels").data()[0]?t=d3.select("#previousPanels").data()[0]:""===d3.select("#previousPanels").data()[0]||d3.select("#panelMenu").datum()&&(t=d3.selectAll(".manifestCheckbox:checked").data().join());var a={panelList:t,numberOfSeqruns:$("#numberOfSeqruns").val(),svlistRows:$("#svlistRows").val(),sortPriority:d3.selectAll("#draggable-sortPriority li").data().join(","),compressedView:$("#compressedView").is(":checked"),d3heatmap:$("#d3heatmap").is(":checked")};$.ajax({url:`${PathOS.application}/preferences/saveSettings`,type:"POST",success:function(e){alert("Preferences saved, reloading window."),location.reload()},error:function(e){console.error(e),alert("You are currently logged out, please refresh the page and log back in.")},contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(a)})})),n.append("a").attrs({id:"menuResetBUtton",href:"#reset"}).text("Reset Settings").on("click",(function(e){$.ajax({url:`${PathOS.application}/preferences/deleteSettings`,success:function(e){alert("Your preferences have been reset."),location.reload()},error:function(e){console.error(e),alert("You are currently logged out, please refresh the page and log back in.")}})}))}else{var o=e.append("div").attr("id","pathos-menu-links").classed("row",!0).append("p").text("Links to: ");o.append("a").attr("href","https://atlassian.petermac.org.au/jira/secure/Dashboard.jspa").text("Jira"),o.append("span").text(" - "),o.append("a").attr("href","https://atlassian.petermac.org.au/confluence/display/PVS/PathOS+Variant+System").text("Confluence"),o.append("span").text(" - "),o.append("a").attr("href","http://pathos.co/help").text("Help")}}})}}},PathOS.svlist={evidence:{pathAloneTruncating:"Truncating variant (nonsense, frameshift, canonical splice site, initiation codon) in a known tumour suppressor gene",pathAloneKnown:"Same missense change as a previously established pathogenic variant",pathStrongFunction:"Well-established in vitro or in vivo functional studies support a deleterious effect on the gene or gene product",pathStrongCase:"Case-control studies show enrichment in cases",pathStrongCoseg:"<b>For familial cancer only:</b> Proband's family study shows co-segregation with cancer",pathSupportHotspot:"Located near a known mutational hot-spot or within a well-characterised functional domain",pathSupportGene:"Occurs in a gene with high clinical specificity and sensitivity for the cancer",pathSupportInsilico:"Multiple types of computational evidence support a deleterious effect on the gene or gene product (PolyPhen, SIFT, Mutation Taster ,conservation, evolution, splicing)",pathSupportSpectrum:"Type of variant fits known mutation spectrum for the gene",pathSupportGmaf:"Absent from ESP and 1000 Genomes data, or frequency is below highest global minor allele frequency (GMAF) expected for autosomal dominant disease (0.4%)",pathSupportIndel:"In-frame deletion/insertion in a well characterised functional domain",pathSupportNovelMissense:"Novel missense change at an amino acid where a different missense change is pathogenic",pathSupportLsdb:"Noted as pathogenic in a curated locus specific database",pathSupportCoseg:"<b>For familial cancer only:</b> Proband's family study shows co-segregation with disease",benignAloneGmaf:"Exists in ESP and 1000 Genomes >= 0.4% GMAF",benignAloneHealthy:"<b>For familial cancer only:</b> For a fully penetrant cancer syndrome, observed in a healthy adult individual",benignStrongFunction:"Well-established in vitro or in vivo functional studies shows no deleterious effect on protein function or splicing",benignStrongCase:"Case control studies show comparable frequencies",benignStrongCoseg:"<b>For familial cancer only:</b> Variant fails to co-segregate with disease in a family study",benignSupportVariable:"Located in a region without a characterised function or away from known mutation hot-spots",benignSupportInsilico:"Multiple types of computational evidence suggest no impact on gene or gene product (PolyPhen, SIFT, Mutation Taster, conservation, evolution, splicing)",benignSupportSpectrum:"Type of variant does not fit known mutation spectrum for the gene",benignSupportLsdb:"Noted as benign in a curated locus specific database",benignSupportPath:"<b>For familial cancer only:</b> For a fully penetrant cancer syndrome, observed with another pathogenic variant in the same individual"},acmgCriteria:{PVS1:"Null Variants",PS1:"Established Pathogenic Variant",PS2:"Confirmed de novo variant",PS3:"Functional studies support damaging effect",PS4:"Enrichment in cases",PM1:"Mutational hotspot/functional domain",PM2:"Absent from population studies",PM3:"Detected <i>in trans</i>",PM4:"Protein length changes",PM5:"Novel missense change",PM6:"Assumed de novo",PP1:"Cosegregation with disease",PP2:"Missense variants are a common mechanism of disease",PP3:"Computational evidence shows deleterious effect",PP4:"Patient's phentoype/family history highly specific for the disease",PP5:"Sources report as pathogenic",BA1:"In population studies >5%",BS1:"High allele frequency",BS2:"Observed in a healthy adult",BS3:"Functional studies show no damaging effect",BS4:"Lacking segregation",BP1:"Does not fit mutational spectrum",BP2:"Observed with another pathogenic variant",BP3:"In-frame deletions/insertions in a region without a known function",BP4:"Computational evidence shows no impact",BP5:"Alternate molecular basis for disease",BP6:"Sources report as benign",BP7:"Predicted as benign synonymous variant"},ampCriteria:{},ccc:function(e,t){var a=!1;return null===e||null===t?null===e&&null===t&&(a=!0):e.id==t.id&&(a=!0),a}},PathOS.overlay={init:function(e){var t=(e=e||{}).styles||{},a=e.attrs||{},n=d3.select("body").append("div").attr("id","overlay").on("click",PathOS.overlay.close).append("div").on("click",(function(){d3.event.stopPropagation()})).attr("id","overlay-dialog-box").attrs(a).styles(t).classed("outlined-box",!0).classed("container",!0);n.append("a").attr("href","#closeOverlay").on("click",PathOS.overlay.close).append("i").classed("fa fa-close fa-lg",!0);var o=n.append("div");return o.append("div").attr("id","overlay_loading").append("img").classed("loading_logo",!0).attr("src",`${PathOS.application}/dist/images/pathos_logo_animated.svg`),PathOS.hotkeys.off(),$("body").on("keydown",(function(e){!e||!e.keyCode||27!=e.keyCode||$(document.activeElement).is("input")||$(document.activeElement).is("textarea")||e.altKey||e.metaKey||e.ctrlKey||PathOS.overlay.close()})),e&&e.callback?e.callback(PathOS.overlay.loaded):PathOS.overlay.loaded(),o},loaded:function(){d3.select("#overlay_loading").remove()},close:function(){d3.select("#overlay").remove(),d3.select("#overlay-dialog-box").remove(),PathOS.hotkeys.init()},drawTable:function(e,t,a){e.select("table").remove();var n=e.append("table").attr("id",a).classed("infoTable",!0).append("tbody");Object.keys(t).forEach((function(e){var a=n.append("tr");a.append("td").html(e).classed("property-label",!0),a.append("td").html(t[e]).classed("property-value",!0)}))}},PathOS.curVariant={init:function(e){console.log("Drawing a cur variant?"),console.log(e)}},PathOS.variant={viewer:function(e){console.log("loading variant viewer",e);var t=e.hgvsg||"",a=e.svid||null,n=e.contextCode||"",o={overlay:PathOS.overlay.init()};o.overlay.attrs({id:"variantViewer"}),o.title=o.overlay.append("h1").text("Variant: "+t),o.info={row:o.overlay.append("div").classed("row",!0)},o.info.left=o.info.row.append("div").classed("col-xs-6",!0),o.info.right=o.info.row.append("div").classed("col-xs-6",!0),o.info.leftTable=o.info.left.append("table").classed("infoTable",!0),o.info.hgvs=o.info.leftTable.append("tr"),o.info.hgvsTitle=o.info.hgvs.append("td").text("HGVS"),o.info.hgvsTd=o.info.hgvs.append("td").text(t),o.info.gene=o.info.leftTable.append("tr"),o.info.gene.append("td").text("Gene"),o.info.gene.append("td").classed("geneTd",!0).text("No gene"),o.info.samples=o.info.leftTable.append("tr"),o.info.samples.append("td").text("Samples"),o.info.sampleTd=o.info.samples.append("td").text("No samples"),o.tabs=o.overlay.append("div").attrs({id:"overlay-tabs"}).append("fieldset"),o.tabs.append("input").attrs({id:"overlay-acmg-radio",name:"overlayRadio",type:"radio",checked:!0}),o.tabs.append("input").attrs({id:"overlay-amp-radio",name:"overlayRadio",type:"radio"}),o.tabs.append("input").attrs({id:"overlay-legacy-radio",name:"overlayRadio",type:"radio"}),o.tabs.append("label").attrs({for:"overlay-acmg-radio"}).append("span").text("ACMG Variants"),o.tabs.append("label").attrs({for:"overlay-amp-radio"}).append("span").text("AMP Variants"),o.tabs.append("label").attrs({class:"hidden",for:"overlay-legacy-radio"}).append("span").text("Legacy Variants"),o.cv={row:o.tabs.append("div").classed("row",!0).attr("id","cv-list")},o.cv.table=o.cv.row.append("table"),o.cv.thead=o.cv.table.append("thead").append("tr"),o.cv.thead.append("th").styles({"padding-left":0,width:"10px"}),o.cv.thead.append("th").text("Context").styles({padding:"2px",width:"15%"}),o.cv.thead.append("th").text("Report Description"),o.cv.thead.append("th").classed("overlay-acmg-column",!0).text("ACMG Evidence"),o.cv.thead.append("th").classed("overlay-acmg-column",!0).text("ACMG Classification"),o.cv.thead.append("th").classed("overlay-amp-column",!0).text("AMP Evidence"),o.cv.thead.append("th").classed("overlay-amp-column",!0).text("AMP Classification"),o.cv.thead.append("th").classed("overlay-legacy-column",!0).text("Legacy Evidence"),o.cv.thead.append("th").classed("overlay-legacy-column",!0).text("Legacy Classification"),o.cv.tbody=o.cv.table.append("tbody"),""!==t?PathOS.variant.doHgvsgStuff(o,t,n):a&&$.ajax(`${PathOS.application}/seqVariant/lookUpSV/${a}`,{error:function(e){console.log("error",e),PathOS.overlay.close(),alert("You are currently logged out, please refresh the page and log back in.")},success:function(e){PathOS.variant.drawSV(o,e),PathOS.variant.doHgvsgStuff(o,e.hgvsg,e.contextCode)}})},doHgvsgStuff:function(e,t,a){e.title.text("Variant: "+t),PathOS.variant.drawCVs(e,t,a),$.ajax(`${PathOS.application}/seqVariant/countSVs/?hgvsg=${t}`,{error:function(e){console.log("error",e),PathOS.overlay.close(),alert("You are currently logged out, please refresh the page and log back in.")},success:function(a){e.info.sampleTd.html(""),e.info.sampleTd.append("a").attrs({target:"_blank",href:`${PathOS.application}/search?q=${t}`}).text(a+" samples")}})},drawSV:function(e,t){console.log(e),console.log(t);var a=e.info.hgvsTd.append("ul").attrs({id:"hgvs-list"}).classed("showList",!0),n=e.info.hgvsTitle.html("").append("a").attrs({href:"#hgvs"}).on("click",(function(e){$("#hgvs-list").toggleClass("showList"),$("#hgvsToggle").toggleClass("toggle"),$("#hgvsToggle").toggleClass("toggled")})).append("span");n.append("i").attr("id","hgvsToggle").classed("fa toggled",!0),n.append("p").text("HGVS"),a.append("li").text(t.sv.hgvsg),a.append("li").text("HGVSg: "+t.sv.hgvsg),a.append("li").text("HGVSc: "+t.sv.hgvsc),a.append("li").text("HGVSp: "+t.sv.hgvsp);var o={Sample:t.sv.sampleName,"Clinical Context":t.cc,Consequences:t.sv.consequence,"Variant Caller":t.sv.varcaller,"Amplicon Count":t.sv.numamps,"Amplicon Bias":t.sv.ampbias,"Variant Frequency":t.sv.varFreq,"Variant Depth":t.sv.varDepth,"Panel Var %":d3.format(".4")(t.sv.varPanelPct)+"%",dbSNP:t.sv.dbsnp,"GMAF %":t.sv.gmaf,"ESP %":t.sv.esp,"ExAC %":t.sv.exac,Cosmic:t.sv.cosmic?`<a target='_blank' href='${PathOS.application}/seqVariant/cosmicAction?id=${t.sv.id}' title='${t.sv.cosmicOccurs}'>COSM${t.sv.cosmic}</a>`:"",Exon:t.sv.exon,Cytoband:t.sv.cytoband,"CADD Raw":d3.format("(.2f")(t.sv.cadd),"CADD Scaled":d3.format("(.2f")(t.sv.cadd_phred)};PathOS.overlay.drawTable(e.info.right,o,"svInfoTable");var i=d3.select("#svInfoTable tbody tr td"),s=i.html();(n=i.html("").append("a").attrs({href:"#toggleSvInfoTable"}).on("click",(function(e){$("#svInfoTable").toggleClass("showDetails"),$("#sampleToggle").toggleClass("toggle"),$("#sampleToggle").toggleClass("toggled")})).append("span")).append("i").attr("id","sampleToggle").classed("fa toggle",!0),n.append("p").text(s)},drawCVs:function(e,t,a){$.ajax(`${PathOS.application}/curVariant/allCurVariantsFor?hgvsg=${t}`,{error:function(e){console.log("error",e),PathOS.overlay.close(),alert("You are currently logged out, please refresh the page and log back in.")},success:function(t){e.info.gene.select(".geneTd").text(t.gene),t.curVariants&&t.curVariants.length>0&&t.curVariants.forEach((function(t){var n=null;(n="Generic"==t.contextCode?e.cv.tbody.insert("tr","tr"):e.cv.tbody.append("tr")).attrs({class:"cvRow-"+t.contextCode}),a==t.contextCode&&n.classed("expand",!0),n.append("td").styles({"padding-left":"5px",cursor:"pointer"}).on("click",(function(){$(".cvRow-"+t.contextCode).toggleClass("expand")})).append("i").attrs({class:"fa toggle","aria-hidden":"true"}),PathOS.variant.addCVrow(n,t)}))}})},addCVrow:function(e,t){e.append("td").append("a").attrs({target:"_blank",href:`${PathOS.application}/curVariant/show?id=${t.id}`}).text(t.context),e.append("td").classed("description",!0).append("textarea").text(t.reportDesc);var a="";if(t.acmgEvidence&&t.acmgEvidence.acmgJustification)try{a=JSON.parse(t.acmgEvidence.acmgJustification).acmgJustification}catch(e){a=t.acmgEvidence.acmgJustification}e.append("td").classed("description overlay-acmg-column",!0).append("textarea").text(a);var n=e.append("td").classed("evidence-td overlay-acmg-column",!0),o=t.pmClass.split(":")[0];n.append("p").text(t.pmClass).classed("cvlabel cv-"+o,!0);var i=n.append("ul").attr("id","evidence-list-"+t.id).classed("evidence-list",!0);t.acmgEvidence&&Object.keys(PathOS.svlist.acmgCriteria).forEach((function(e){"yes"==t.acmgEvidence[e]&&i.append("li").html(`<b>${e}:</b> ${PathOS.svlist.acmgCriteria[e]}`)}));var s="";if(t.ampEvidence&&t.ampEvidence.ampJustification)try{s=JSON.parse(t.ampEvidence.ampJustification).ampJustification}catch(e){s=t.ampEvidence.ampJustification}e.append("td").classed("description overlay-amp-column",!0).append("textarea").text(s);var r=e.append("td").classed("overlay-amp-column",!0);try{r.text(JSON.stringify(t.ampEvidence)).style("word-break","break-all");var l=[],c="";"unset"!=t.ampEvidence.diagnosisRating&&(c="Diagnosis Rating is "+t.ampEvidence.diagnosisRating,"unset"!=t.ampEvidence.diagnosisCategory&&(c+=" and "+t.ampEvidence.diagnosisCategory),l.push(c)),"unset"!=t.ampEvidence.prognosisRating&&(c="Prognosis Rating is "+t.ampEvidence.prognosisRating,"unset"!=t.ampEvidence.diagnosisCategory&&(c+=" and "+t.ampEvidence.prognosisCategory),l.push(c)),"unset"!=t.ampEvidence.therapeuticRating&&(c="Therapeutic Rating is "+t.ampEvidence.therapeuticRating,"unset"!=t.ampEvidence.diagnosisCategory&&(c+=" and "+t.ampEvidence.therapeuticCategory),l.push(c)),r.html("").append("ul").classed("evidence-list",!0).selectAll("li").data(l).enter().each((function(e){d3.select(this).append("li").text(e)}))}catch(e){console.log("Error adding AMP evidence text",e)}if(t.legacyEvidence){d3.select('label[for="overlay-legacy-radio"]').classed("hidden",!1);var d="";t.legacyEvidence.justification&&(d=t.legacyEvidence.justification),e.append("td").classed("description overlay-legacy-column",!0).append("textarea").text(d);var p=e.append("td").classed("evidence-td overlay-legacy-column",!0);o=t.legacyEvidence.evidenceClass.split(":")[0],p.append("p").text(t.pmClass).classed("cvlabel cv-"+o,!0);var h=p.append("ul").attr("id","evidence-list-"+t.id).classed("evidence-list",!0);t.legacyEvidence&&Object.keys(PathOS.svlist.evidence).forEach((function(e){t.legacyEvidence[e]&&h.append("li").html(PathOS.svlist.evidence[e])}))}}},PathOS.buildBlock=function(e,t){t.forEach((function(t){var a=e.append("p");t.link&&""!==t.link?(a.append("span").classed("bold",!0).text(t.title+": "),a.html(a.html()+'<a href="'+t.link+'">'+t.words+"</a>")):(a.append("span").classed("bold",!0).text(t.title+": "),a.html(a.html()+t.words))}))},PathOS.classify=function(e){return e.toLowerCase().replace(" ","-")},PathOS.params=function(){var e={};return window.location.search.substring(1).split("&").forEach((function(t){if(t.indexOf("=")>0){var a=t.split("="),n=a[0],o=decodeURIComponent(a[1].replace(/\+/g," "));e[n]=o}})),e},PathOS.evidence={benignAloneGmaf:"Benign Stand-alone Gmaf",benignAloneHealthy:"Benign Stand-alone Healthy",benignStrongCase:"Benign Stand-alone Strong-case",benignStrongCoseg:"Benign Stand-alone Coseg",benignStrongFunction:"Benign Strong Function",benignSupportInsilico:"Benign Support Insilico",benignSupportLsdb:"Benign Support Local Sequence Database",benignSupportPath:"Benign Support Pathology",benignSupportSpectrum:"Benign Support Spectrum",benignSupportVariable:"Benign Support Variable",pathAloneKnown:"Pathology Stand-alone Known",pathAloneTruncating:"Pathology Stand-alone Truncating",pathStrongCase:"Pathology Strong Case",pathStrongCoseg:"Pathology Strong Coseg",pathStrongFunction:"Pathology Strong Function",pathSupportCoseg:"Pathology Support Coseg",pathSupportGene:"Pathology Support Gene",pathSupportGmaf:"Pathology Support Gmaf",pathSupportHotspot:"Pathology Support Hotspot",pathSupportIndel:"Pathology Support Indel",pathSupportInsilico:"Pathology Support Insilico",pathSupportLsdb:"Pathology Support Local Sequence Database",pathSupportNovelMissense:"Pathology Support Novel Missense",pathSupportSpectrum:"Pathology Support Spectrum"},PathOS.hotkeys={keys:{27:function(){d3.selectAll(".tagdiv .tooltip.edit").classed("edit",!1)}},add:function(e,t){this.keys[e]=t},off:function(){$("body").off("keydown")},init:function(){var e=this.keys;$("body").on("keydown",(function(t){!(t&&t.keyCode&&e[t.keyCode])||$(document.activeElement).is("input")||$(document.activeElement).is("textarea")||t.altKey||t.metaKey||t.ctrlKey||e[t.keyCode]()}))},testMode:function(){var e=this.keys;$("body").on("keydown",(function(t){!t||!t.keyCode||$(document.activeElement).is("input")||t.altKey||t.metaKey||t.ctrlKey||(console.log("You pushed: "+t.keyCode),e[t.keyCode]&&(console.log("It has this function:"),console.log(e[t.keyCode])))}))}},PathOS.timeSince=function(e){var t="",a=parseInt(e)||Date.parse(e),n=Date.now()-a;return a>0&&(t=n<6e4?Math.floor(n/1e3)+"s":n<36e5?Math.floor(n/6e4)+"m":n<864e5?Math.floor(n/36e5)+"h":n<6048e5?Math.floor(n/864e5)+"d":Math.floor(n/6048e5)+"w"),t},PathOS.addOption=function(e,t,a,n){var o=e.append("label");o.append("input").attr("class","option").attr("id","option-"+a).attr("type","checkbox"),o.html(o.html()+" "+t+"<br>"),o.on("change",(function(){$("."+a).toggleClass(a+"-toggle"),localStorage[PatHOS.application+a+"-option"]=document.getElementById("option-"+a).checked})),n?void 0!==localStorage[PatHOS.application+a+"-option"]&&!0!==localStorage[PatHOS.application+a+"-option"]&&"true"!=localStorage[PatHOS.application+a+"-option"]||(o.select("input").attr("checked",n),d3.selectAll("."+a).classed(a+"-toggle",!0)):(void 0!==localStorage[PatHOS.application+a+"-option"]&&!0===localStorage[PatHOS.application+a+"-option"]||"true"==localStorage[PatHOS.application+a+"-option"])&&(o.select("input").attr("checked",!0),d3.selectAll("."+a).classed(a+"-toggle",!0))},PathOS.safety={change:!1,saved:!1,init:function(){$("textarea,input").keyup((function(){PathOS.safety.change=!0})),$(".savebutton").on("click",(function(){PathOS.safety.saved=!0})),window.onbeforeunload=function(){if(PathOS.safety.change&&!PathOS.saftey.saved)return"Testing"}}},PathOS.tags={current_object:!1,update_object:function(e){PathOS.tags.current_object=e;var t={type:PathOS.controller,id:e};t.type&&e&&$.ajax({type:"GET",url:`${PathOS.application}/tag/fetchTags?${$.param(t)}`,error:function(e){console.log("error",e),alert("You are currently logged out, please refresh the page and log back in.")},success:function(e){console.log(e),e.error?console.log("There was an error."):(d3.select("#tags").style("display",""),$("#object_id").text(e.name),d3.selectAll("#tags .tagdiv").remove(),e.tags?e.tags.forEach((function(e){PathOS.tags.drawTag(d3.select("#tags .outlined-box"),e,!0)})):PathOS.tags.nullObject(d3.select("#tags .outlined-box")))},cache:!1,contentType:!1,processData:!1})},buildModule:function(e){console.log("Building tags module.");new PathOS.module({name:"tags",title:"Tags",type:"tags",data:e,closeModule:e.closeModule})},nullObject:function(e){e.insert("div",":first-child").classed("tagdiv",!0).append("label").text("You cannot add tags to it."),e.insert("div",":first-child").classed("tagdiv",!0).append("label").text("Sorry, this object has not be saved.")},drawTagById:function(e,t,a){$.ajax(`${PathOS.application}/Tag/lookUp?id=${t}`,{error:function(e){alert("You are currently logged out, please refresh the page and log back in.")},success:function(t){PathOS.tags.drawTag(e,t,a)}})},drawTag:function(e,t,a){if("fail"==t)alert("Sorry, you cannot set a reserved smart tag");else{var n=t.isAuto?e.insert("div",":first-child"):e.insert("div","textarea");n.attr("class","tagdiv tag-"+t.id).datum(t).classed("isAuto",t.isAuto).on("click",(function(e){var t=this;if(!e.isAuto&&d3.select("#tags").classed("editing")){var a={type:PathOS.controller,objid:PathOS.tags.current_object,tagid:e.id};$.ajax({type:"DELETE",url:`${PathOS.application}/tag/removeLink?${$.param(a)}`,error:function(e){alert("You are currently logged out, please refresh the page and log back in.")},success:function(e){"fail"!=e&&($(t).remove(),reloadGrid&&reloadGrid())},cache:!1,contentType:!1,processData:!1})}else d3.select(t).select(".tooltip").classed("dismiss",!0)})),n.append("span").text(t.label);var o=t.description||"Enter Description Here.",i=n.append("div").classed("tooltip outlined-box",!0);i.append("button").text("Search").on("click",(function(e){d3.event.stopPropagation(),window.location.href=`${PathOS.application}/search?q=${e.label}`})),i.append("button").text("View").on("click",(function(e){d3.event.stopPropagation(),window.location.href=`${PathOS.application}/Tag/Show/${e.id}`})),i.append("button").text("Edit").on("click",(function(e){})),i.append("i").classed("fa fa-close fa-lg",!0).on("click",(function(){d3.event.stopPropagation(),i.classed("edit",!1)})),a&&i.append("i").classed("fa fa-trash fa-lg",!0).on("click",(function(){if(d3.event.stopPropagation(),confirm('Remove tag "'+t.label+'" from this object?')){var e={type:PathOS.controller,objid:PathOS.tags.current_object,tagid:t.id};$.ajax({type:"DELETE",url:`${PathOS.application}/tag/removeLink?${$.param(e)}`,error:function(e){alert("You are currently logged out, please refresh the page and log back in.")},success:function(e){"fail"!=e&&($(".tag-"+t.id).remove(),reloadGrid&&reloadGrid())},cache:!1,contentType:!1,processData:!1})}})),i.append("i").classed("fa fa-check fa-lg",!0).on("click",(function(){d3.event.stopPropagation(),i.classed("dismiss",!1)})),i.append("p").classed("tt_description",!0).text(o),i.append("input").attr("value",o).on("keydown",(function(){var e=d3.event;if(e&&e.keyCode&&13==e.keyCode){var a={description:$(this).val(),id:t.id};$.ajax(`${PathOS.application}/Tag/putDescription?${$.param(a)}`,{error:function(e){alert("You are currently logged out, please refresh the page and log back in.")},success:function(){$(".tag-"+t.id+" input").val(a.description),$(".tag-"+t.id+" p").text(a.description),i.classed("edit",!1),i.classed("dismiss",!0),reloadGrid&&reloadGrid()}})}})),i.on("click",(function(e){d3.event.stopPropagation(),i.classed("edit",!0)}))}},addTag:function(e,t,a,n){if(void 0===a&&(a=PathOS.controller),void 0===n&&(n=PathOS.tags.current_object),a&&t&&n){var o={type:a,id:n,tag:t,user:PathOS.user};$.ajax({type:"POST",url:`${PathOS.application}/tag/addTag?${$.param(o)}`,error:function(e){alert("You are currently logged out, please refresh the page and log back in.")},success:function(t){"string"==typeof t?alert(t):e.select(".tag-"+t.id).empty()&&(PathOS.tags.drawTag(e,t,!0),$("#tag_text_area").val(""),reloadGrid&&reloadGrid())},cache:!1,contentType:!1,processData:!1})}else console.log("We don't have a controller, tag or id."),console.log(a),console.log(t),console.log(n)}},PathOS.printQC=function(e){var t=e.div.append("h4").classed("flag",!0);e.authorised?e.passfailFlag?t.text("QC Passed").classed("passed",!0):e.passfailFlag||t.text("QC Failed"):t.text("QC Not Set").classed("unknown",!0)},PathOS.urlExists=function(e,t){const a=new XMLHttpRequest;if(!t)return a.open("HEAD",e,!1),a.send(),404!=a.status;a.onloadend=function(e){t(404!=e.currentTarget.status)},a.open("HEAD",e),a.send()},PathOS.igv={loaded:!1,options:{},init:function(e,t,a,n,o,i){console.log("Running IGV init");var s=t+a+".bai",r=t+a+".bam",l=t+a+".vcf",c=t.split("Pathology")[0],d=c+"Panels/"+n+"/Amplicon.bed",p=c+"Panels/"+n+"/Amplicon.tsv";PathOS.igv.div=e,PathOS.igv.options={locus:"17:7,579,423-7,579,856",showNavigation:!0,showCenterGuide:!0,genome:"hg19",tracks:[{name:"VCF",url:l,type:"vcf",label:"VCF: "+a,order:-10001},new PathOS.igv.BAM(s,r,a,o),{name:n,url:d,indexURL:p,displayMode:"EXPANDED",order:-9998},{url:`${PathOS.application}/igv/hg19-RefSeqGenes.gtf.gz`,indexURL:`${PathOS.application}/igv/hg19-RefSeqGenes.gtf.gz.tbi`,name:"hg19 - Gencode v24",format:"gtf",order:-9997,visibilityWindow:1e7}]},PathOS.urlExists(s)&&PathOS.urlExists(r)?(console.log("IGV.js init has found bams"),PathOS.igv.search(i)):confirm("There are missing BAMS. Continue?")?PathOS.igv.search(i):(console.log("Aborting IGV.js"),d3.select("#igvDiv").append("h1").text("Error: BAM files missing").styles({"text-align":"center",color:"red"}))},search:function(e){PathOS.igv.loaded?igv.browser.search(e):(PathOS.igv.loaded=!0,PathOS.igv.options.locus=e,igv.createBrowser(PathOS.igv.div,PathOS.igv.options),$("#footer-message").remove())},addDirectBAM:function(e,t,a){if(a=a||2500,t=t||"",e){var n=e.slice(0,e.length-4)+".bai",o=new PathOS.igv.BAM(n,e,sample,a);PathOS.igv.loaded?igv.browser.loadTrack(o):PathOS.igv.options.tracks?(PathOS.igv.options.tracks.push(o),PathOS.notes.add(t+" BAM added to IGV.js")):alert("Please initialise IGV.js")}else alert("There was an error, url not found.")},addBAM:function(e,t,a){if(e&&t){var n=t+e+".bai",o=t+e+".bam";if(PathOS.urlExists(n)&&PathOS.urlExists(o)){var i=new PathOS.igv.BAM(n,o,e,a);PathOS.igv.loaded?igv.browser.loadTrack(i):PathOS.igv.options.tracks.push(i)}else console.log("BAM file not found",o),alert("Warning, BAM file not found")}else alert("There was an error, data not found.")},BAM:function(e,t,a,n){return n=n||2500,this.indexURL=e,this.url=t,this.label=a,this.type="bam",this.alignmentRowHeight=1,this.maxRows=99999,this.order=-1e4,this.height=500,this.autoHeight=!0,this.samplingDepth=n,this.colorBy="strand",this.negStrandColor="rgb(150, 150, 230)",this.posStrandColor="rgb(230, 150, 150)",this.deletionColor="black",this.skippedColor="rgb(150, 170, 170)",this}},PathOS.pubmed={drawReferences:function(e,t){var a=d3.select(`#${t}`);function n(e,t){t.pmids.length>0&&(a.append("h2").text(e.charAt(0).toUpperCase()+e.slice(1)),a.append("ul").selectAll("li").data(t.citations).enter().append("li").each((function(e,a){const n=d3.select(this),o=t.pmids[a];e?(n.append("h3").text(t.titles[a]),n.append("p").text(e),n.append("a").attr("href",`${PathOS.application}/pubmed?pmid=${o}`).text(`[PMID: ${o}]`)):n.attr("id",`pubmed-${o}`).text(`Article [PMID: ${o}] not found in PathOS database, `).append("a").attrs({class:"newPubmedArticle",href:"#lookUpNewArticle",onclick:`PathOS.pubmed.lookUpNewArticle(${o})`}).text("click here to find it.")})))}$.ajax({url:`${PathOS.application}/curVariant/citations/${e}`,success:function(e){console.log(e),n("Report Description",e.report),a.append("h2").text("ACMG"),Object.keys(e.evidence.acmg).forEach((function(t){n(t,e.evidence.acmg[t])})),a.append("h2").text("AMP"),Object.keys(e.evidence.amp).forEach((function(t){n(t,e.evidence.amp[t])})),n("Archive",e.evidence.archive.evidence)}})},findCitations:function(e){for(var t,a=/\[PMID: (\d+)(?:, (\d+))*\]/g,n=[];null!==(t=a.exec(e));)n=n.concat(t[1].split(", "));return n},applyHighlight:function(e){$("textarea."+e).highlightWithinTextarea((function(){return/\[PMID: \d+(, \d+)*\]/g}))},lookUpNewArticle:function(e){console.log("Hey, we're looking for [PMID: %d]",e);var t=d3.select("#pubmed-"+e).html("");t.append("img").classed("loading_logo",!0).attr("src",`${PathOS.application}/dist/images/pathos_logo_animated.svg`),$.ajax({url:`${PathOS.application}/Pubmed/fetch_pmid?pmid=${e}`,complete:function(a){if(t.select("img.loading_logo").remove(),a.status&&200==a.status){var n=a.responseJSON.citation,o=a.responseJSON.title;t.append("h3").text(o),t.append("p").text(n);var i=t.append("a").attrs({href:"#add_pmid"}).text("Save [PMID: "+e+"]").classed("newPubmedArticle",!0).on("click",(function(){$.ajax({url:`${PathOS.application}/Pubmed/add_pmid?pmid=${e}`,complete:function(t){t&&t.status&&500==t.status&&"saved"==t.responseText?PathOS.notes.addError("Error saving PMID, please try again later."):(PathOS.notes.add("Saved Pubmed Article: "+o),i.classed("newPubmedArticle",!1).text("[PMID: "+e+"]").attr("href",`${PathOS.application}/pubmed?pmid=${e}`))}})}))}else t.html("Error, couldn't look up PMID. Please refresh page and try again later."),PathOS.notes.addError("Couldn't look up PMID.")}})}},PathOS.notes={init:function(){PathOS.notes.refresh(),d3.select("#notifications thead").on("click",(function(){$("#notifications").toggleClass("shrink")})),$("body").on("click",PathOS.notes.hide),$("#notifications").on("click",(function(e){e.stopPropagation()})),$("#notifications a").on("click",(function(e){e.stopPropagation()})),PathOS.hotkeys.add(220,(function(){$("#notifications").toggleClass("shrink"),$("#notifications").removeClass("peek"),PathOS.notes.refresh()})),d3.selectAll("#notifications tbody tr").classed("read",!0)},hide:function(){$("#notifications").addClass("shrink"),$("#notifications").removeClass("peek"),PathOS.notes.refresh()},data:PathOS.data.load("notes",[]),load:function(){PathOS.notes.data=PathOS.data.load("notes",[])},save:function(e){PathOS.notes.data=e||d3.selectAll(".notification").data(),PathOS.data.save("notes",PathOS.notes.data)},addError:function(e){PathOS.notes.add({type:"error",message:e})},add:function(e){(e="object"==typeof e?e:{message:e}).type=e.type||"message",e.page=document.title,e.url=window.location.href,e.time=Date.now(),d3.select("#notifications").classed("peek",!0),PathOS.notes.data.unshift(e),PathOS.notes.save(PathOS.notes.data.slice(0,5)),PathOS.notes.refresh(),d3.select("#notifications .notification").classed("read",!1),setTimeout((function(){d3.select("#notifications").classed("peek",!1)}),2e3)},refresh:function(){PathOS.notes.load();var e=d3.select("#notifications tbody").selectAll("tr").data(PathOS.notes.data,(function(e){return e.time}));e.enter().append("tr").classed("notification",!0).each((function(e){var t=d3.select(this).on("click",(function(e){d3.select(this).classed("read",!0),e.read=d3.select(this).classed("read"),PathOS.notes.save()})),a=t.append("td").text(e.message);a.append("br"),a.append("a").attrs({href:e.url}).text(e.page),a.append("span").classed("timePassed",!0);var n=t.append("td").append("i").classed("fa",!0).attrs({"aria-hidden":!0});"error"==e.type?(t.classed("error",!0),n.classed("fa-exclamation-triangle",!0)):(t.classed("warning",!0),n.classed("fa-sticky-note",!0))})).merge(e).each((function(e){d3.select(this).select(".timePassed").text(PathOS.timeSince(e.time)+" ago")})),e.exit().remove()},markAllAsRead:function(){d3.selectAll(".notification").classed("read",(function(e){return e.read=!0,!0})),PathOS.notes.save()},clearNotes:function(){PathOS.notes.save([]),PathOS.notes.refresh()},open:function(){d3.select("#notifications").classed("shrink",!1)},latestIsUnread:function(){return!!PathOS.notes.data[0]&&!PathOS.notes.data[0].read}},PathOS.init=function(e){PathOS.modules.init(e),PathOS.hotkeys.init(),PathOS.history.init()};