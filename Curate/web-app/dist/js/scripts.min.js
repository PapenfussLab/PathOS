var PathOS=PathOS||{};PathOS.version="PathOS.js build: 26th of May 2016",PathOS.data={load:function(t,e){var a=e||{};return localStorage["PathOS-"+t]&&(a=JSON.parse(localStorage["PathOS-"+t])),a},save:function(t,e){localStorage["PathOS-"+t]=JSON.stringify(e)},clear:function(t){delete localStorage["PathOS-"+t]},clean:function(){delete localStorage["PathOS-history"],delete localStorage.PathOSHistory,delete localStorage["PathOS-modules"]}},PathOS.module=function(t){function e(t){var e="";t.title.toLowerCase().indexOf("seqrun")>=0?e="Seqrun":t.title.toLowerCase().indexOf("pubmed")>=0?e="Pubmed":t.title.toLowerCase().indexOf("sequenced variants list")>=0?e="SeqSample":t.title.toLowerCase().indexOf("curvar")>=0?e="CurVariant":t.title.toLowerCase().indexOf("patient")>=0&&(e="PatSample");var a=p.append("tr");a.append("td").append("a").attr("href",t.url).text(t.title).classed(e,!0),a.append("td").text(PathOS.timeSince(t.time))}var a=this;PathOS.modules.map[t.name]={data:t,object:a};var o=d3.select("#"+t.name);null===o[0][0]&&(o=this.div=d3.select("#sidebar").append("div").classed("module",!0).attr("id",t.name));var n=o.select(".moduletitle");if(null===n[0][0]?(n=o.append("table").classed("moduletitle",!0).append("tr"),n.append("td").classed("modulelabel",!0).datum(t).on("click",a.toggle).append("a").attr({href:"#"+t.name}).append("h1").text(t.title)):n.select("td").classed("modulelabel",!0).datum(t).on("click",a.toggle),n.insert("td","td").datum(t).on("click",a.toggle).append("a").attr({href:"#"+t.name}).append("i").classed("fa fa-minus-square minimise",!0),t.type){var s=o.append("div").classed("content",!0);switch(t.type){case"tags":var i=n.append("td").attr({id:"tags_edit_button"}).on("click",function(){$("#tags").toggleClass("editing"),$("#tags_edit_button i").toggleClass("fa-pencil-square-o"),$("#tags_edit_button i").toggleClass("fa-pencil-square")}).append("a").attr({href:"#"+t.name});i.append("span").html("(Editing)&nbsp;"),i.append("i").classed("button fa fa-pencil-square-o",!0),n.append("td").append("a").attr({href:"#"+t.name}).append("i").classed("fa fa-times",!0).style("padding-bottom","1px").on("click",function(e){d3.select("#"+t.name).style("display","none"),t.closeModule()}),d3.select("#tags").style("display","none");var l=s.append("table").append("thead").append("tr").classed("row",!0);l.append("th").text(t.data.object),l.append("th").text("").attr("id","object_id").style("text-align","right");var d=s.append("div").classed("fb-box tags_field",!0).attr("id","moduleTagBox").on("click",function(){$("#tag_text_area").focus()});t.data.tags.forEach(function(t){PathOS.tags.drawTag(d,t,!0)}),$(d.append("textarea").attr({id:"tag_text_area",placeholder:"Enter Tags Here"})).autocomplete({source:t.data.availableTags}),$("body").on("keydown",function(t){if(t&&t.keyCode&&13==t.keyCode&&$(document.activeElement).is("#tag_text_area")){var e=$("#tag_text_area").val().trim();$("#tag_text_area").val(""),e&&""!==e&&PathOS.tags.current_object&&PathOS.tags.addTag(d,e)}else if(t&&t.keyCode&&8==t.keyCode&&$(document.activeElement).is("#tag_text_area")&&""===$("#tag_text_area").val()&&0!==$("#moduleTagBox.tags_field .tagdiv:last").length)if($("#moduleTagBox.tags_field .tagdiv:last").hasClass("deleteFlag")){var a=d3.select($("#moduleTagBox.tags_field .tagdiv:last")[0]).datum();if(confirm('Remove tag "'+a.label+'" from this object?')){var o={type:PathOS.controller,objid:PathOS.tags.current_object,tagid:a.id};$.ajax({type:"DELETE",url:"/PathOS/tag/removeLink?"+$.param(o),success:function(t){"fail"!=t&&$(".tag-"+a.id).remove()},cache:!1,contentType:!1,processData:!1})}}else $("#moduleTagBox.tags_field .tagdiv:last").toggleClass("deleteFlag").on("click",function(){var t=d3.select($("#moduleTagBox.tags_field .tagdiv:last")[0]).datum(),e={type:PathOS.controller,objid:PathOS.tags.current_object,tagid:t.id};$.ajax({type:"DELETE",url:"/PathOS/tag/removeLink?"+$.param(e),success:function(e){"fail"!=e&&$(".tag-"+t.id).remove()},cache:!1,contentType:!1,processData:!1})})});break;case"history":var r=s.append("table"),c=r.append("thead").append("tr"),p=r.append("tbody");c.append("th").text("Page"),c.append("th").text("T"),t.data.forEach(e),p.append("span").append("a").attr({href:"#"}).text("See more").on("click",function(){PathOS.history.more().forEach(e),$(this).remove()});break;case"established":s.remove();break;default:var h=s.append("ul").style({clip:"rect(0px, 1000px, 0px, 0px)"});t.data instanceof Array?t.data.forEach(function(t){h.append("li").html(t)}):Object.keys(t.data).forEach(function(e){h.append("li").html(e+": "+t.data[e])})}}(o.classed("hide")||t.hide)&&(o.classed("hide",!1),a.toggle(t.name))},PathOS.module.prototype.toggle=function(t){d3.event&&d3.event.preventDefault();var e="string"==typeof t?t:d3.select(this).datum().name,a="#"+e;$(a).toggleClass("hidden"),$(a+" i.minimise").toggleClass("fa-minus-square"),$(a+" i.minimise").toggleClass("fa-plus-square");var o=$(a).height();d3.select(a).classed("hidden")?(d3.select(a).style("min-height","1px"),PathOS.user&&(PathOS.modules.settings[PathOS.user].hide[e]=!0,PathOS.data.save("modules",PathOS.modules.settings))):(d3.select(a).style("min-height",o+"px"),PathOS.user&&(delete PathOS.modules.settings[PathOS.user].hide[e],PathOS.data.save("modules",PathOS.modules.settings)))},PathOS.module.prototype.data=function(){var t=d3.select(this).datum();console.log(t)},PathOS.modules={menuVisible:!1,settings:{},map:{},init:function(t){console.log("loading module settings"),PathOS.modules.settings=PathOS.data.load("modules"),PathOS.controller=t.controller,PathOS.action=t.action,t.user&&(PathOS.user=t.user,PathOS.modules.settings[PathOS.user]?(Object.keys(PathOS.modules.settings[PathOS.user].hide).forEach(function(t){document.getElementById(t)&&!d3.select("#"+t).classed("hidden")&&(PathOS.modules.map[t]?PathOS.modules.map[t].object.toggle(t):d3.select("#"+t).classed("hide",!0))}),PathOS.modules.settings[PathOS.user].sidebar[window.location.pathname]&&("show"==PathOS.modules.settings[PathOS.user].sidebar[window.location.pathname]?(d3.select("#wrapper").classed("toggled",!1),d3.select("#sidebar-toggle i").classed("fa-chevron-left",!1),d3.select("#sidebar-toggle i").classed("fa-chevron-right",!0)):"hide"==PathOS.modules.settings[PathOS.user].sidebar[window.location.pathname]&&(d3.select("#wrapper").classed("toggled",!0),d3.select("#sidebar-toggle i").classed("fa-chevron-left",!0),d3.select("#sidebar-toggle i").classed("fa-chevron-right",!1)))):(PathOS.modules.settings[PathOS.user]={sidebar:{},hide:{}},PathOS.data.save("modules",PathOS.modules.settings))),d3.select("#sidebar-footer").append("span").append("a").attr({href:"#"}).on("click",function(t){PathOS.modules.menuVisible?PathOS.modules.menu.hide():PathOS.modules.menu.show()}).append("i").attr({"class":"fa-lg fa fa-cog","aria-hidden":!0})},menu:{show:function(){console.log("showing settings!");var t=d3.select("body").append("div").attr({id:"overlay"}).on("click",PathOS.modules.menu.hide).append("div").on("click",function(){d3.event.stopPropagation()}).attr({id:"moduleMenu","class":"fb-box"});t.append("a").attr("href","#").on("click",PathOS.modules.menu.hide).append("i").classed("fa fa-close fa-lg",!0),header=t.append("div").attr({id:"mmHeader"}).append("h1").text("Put a menu here, when we have options that need to be set.").append("p").text("Or maybe some help info or something? I dunno."),header.append("p").append("a").attr({href:"https://115.146.86.118/jira/secure/Dashboard.jspa"}).text("Here, have a link to Jira."),header.append("p").append("a").attr("href","https://115.146.86.118/confluence/display/PVS/Path-OS+Variant+System").text("And here's one for Confluence."),PathOS.hotkeys.off(),$("body").on("keydown",function(t){!t||!t.keyCode||27!=t.keyCode||$(document.activeElement).is("input")||$(document.activeElement).is("textarea")||t.altKey||t.metaKey||t.ctrlKey||PathOS.modules.menu.hide()})},hide:function(){console.log("hiding settings!"),d3.select("#overlay").remove(),PathOS.hotkeys.init()}}},PathOS.buildBlock=function(t,e){e.forEach(function(e){var a=t.append("p");e.link&&""!==e.link?(a.append("span").classed("bold",!0).text(e.title+": "),a.html(a.html()+'<a href="'+e.link+'">'+e.words+"</a>")):(a.append("span").classed("bold",!0).text(e.title+": "),a.html(a.html()+e.words))})},PathOS.classify=function(t){return t.toLowerCase().replace(" ","-")},PathOS.params=function(){params={};var t=window.location.search.substring(1),e=t.split("&");return e.forEach(function(t){if(t.indexOf("=")>0){var e=t.split("=");params[e[0]]=e[1].indexOf(",")>=0?e[1].split(","):e[1]}}),params},PathOS.evidence={benignAloneGmaf:"Benign Stand-alone Gmaf",benignAloneHealthy:"Benign Stand-alone Healthy",benignStrongCase:"Benign Stand-alone Strong-case",benignStrongCoseg:"Benign Stand-alone Coseg",benignStrongFunction:"Benign Strong Function",benignSupportInsilico:"Benign Support Insilico",benignSupportLsdb:"Benign Support Local Sequence Database",benignSupportPath:"Benign Support Pathology",benignSupportSpectrum:"Benign Support Spectrum",benignSupportVariable:"Benign Support Variable",pathAloneKnown:"Pathology Stand-alone Known",pathAloneTruncating:"Pathology Stand-alone Truncating",pathStrongCase:"Pathology Strong Case",pathStrongCoseg:"Pathology Strong Coseg",pathStrongFunction:"Pathology Strong Function",pathSupportCoseg:"Pathology Support Coseg",pathSupportGene:"Pathology Support Gene",pathSupportGmaf:"Pathology Support Gmaf",pathSupportHotspot:"Pathology Support Hotspot",pathSupportIndel:"Pathology Support Indel",pathSupportInsilico:"Pathology Support Insilico",pathSupportLsdb:"Pathology Support Local Sequence Database",pathSupportNovelMissense:"Pathology Support Novel Missense",pathSupportSpectrum:"Pathology Support Spectrum"},PathOS.hotkeys={keys:{27:function(){d3.selectAll(".tagdiv .tooltip.edit").classed("edit",!1)}},add:function(t,e){this.keys[t]=e},off:function(){$("body").off("keydown")},init:function(){var t=this.keys;$("body").on("keydown",function(e){!(e&&e.keyCode&&t[e.keyCode])||$(document.activeElement).is("input")||$(document.activeElement).is("textarea")||e.altKey||e.metaKey||e.ctrlKey||t[e.keyCode]()})},testMode:function(){var t=this.keys;$("body").on("keydown",function(e){!e||!e.keyCode||$(document.activeElement).is("input")||e.altKey||e.metaKey||e.ctrlKey||(console.log("You pushed: "+e.keyCode),t[e.keyCode]&&(console.log("It has this function:"),console.log(t[e.keyCode])))})}};var months=["Jan","Feb","Mar","Apr","May","June","July","Aug","Sept","Oct","Nov","Dec"];PathOS.date=function(t,e){var a="";if(Date.parse(t)>0){var o=t.split("T")[0].split("-");a=e&&"full"==e?o[2]+" "+months[parseInt(o[1])-1]+" "+o[0]:o[2]+" "+months[parseInt(o[1])-1]}return a},PathOS.timeSince=function(t){var e="",a=Date.parse(t),o=Date.now(),n=o-a;return a>0&&(e=n<36e5?Math.floor(n/6e4)+"m":n<864e5?Math.floor(n/36e5)+"h":Math.floor(n/864e5)+"d"),e},PathOS.addOption=function(t,e,a,o){var n=t.append("label");n.append("input").attr({"class":"option",id:"option-"+a,type:"checkbox"}),n.html(n.html()+" "+e+"<br>"),n.on("change",function(){$("."+a).toggleClass(a+"-toggle"),localStorage[a+"-option"]=document.getElementById("option-"+a).checked}),o?"undefined"!=typeof localStorage[a+"-option"]&&localStorage[a+"-option"]!==!0&&"true"!=localStorage[a+"-option"]||(n.select("input").attr("checked",o),d3.selectAll("."+a).classed(a+"-toggle",!0)):("undefined"!=typeof localStorage[a+"-option"]&&localStorage[a+"-option"]===!0||"true"==localStorage[a+"-option"])&&(n.select("input").attr("checked",!0),d3.selectAll("."+a).classed(a+"-toggle",!0))},PathOS.history={json:[],add:function(t){PathOS.history.json.forEach(function(e,a){e.title==t.title&&PathOS.history.json.splice(a,1)}),PathOS.history.json.push(t),PathOS.history.json.length>50&&(PathOS.history.json=PathOS.history.json.slice(20)),PathOS.data.save("history",PathOS.history.json),localStorage.PathOSHistory=JSON.stringify(PathOS.history.json)},clear:function(){PathOS.history.json=[],PathOS.data.clear("history")},show:function(t){var e=PathOS.history.json,a=t||10;return(e.length<a?e:e.slice(e.length-a)).reverse()},more:function(){var t=PathOS.history.json,e=50;return(t.length<e?t:t.slice(t.length-e)).reverse().slice(10)},init:function(){PathOS.history.json=PathOS.data.load("history",[])}},PathOS.safety={change:!1,saved:!1,init:function(){$("textarea,input").keyup(function(){PathOS.safety.change=!0}),$(".savebutton").on("click",function(){PathOS.safety.saved=!0}),window.onbeforeunload=function(){if(PathOS.safety.change&&!PathOS.saftey.saved)return"Testing"}}},PathOS.tags={current_object:!1,update_object:function(t){PathOS.tags.current_object=t;var e={type:PathOS.controller,id:t};e.type&&t&&$.ajax({type:"GET",url:"/PathOS/tag/getTags?"+$.param(e),success:function(t){console.log(t),d3.select("#tags").style("display",""),$("#object_id").text(t.name),d3.selectAll("#tags .tagdiv").remove(),t.tags?t.tags.forEach(function(t){PathOS.tags.drawTag(d3.select("#tags .fb-box"),t,!0)}):PathOS.tags.nullObject(d3.select("#tags .fb-box"))},cache:!1,contentType:!1,processData:!1})},buildModule:function(t){console.log("Building tags module.");new PathOS.module({name:"tags",title:"Tags",type:"tags",data:t,closeModule:t.closeModule})},nullObject:function(t){t.insert("div",":first-child").classed("tagdiv",!0).append("label").text("You cannot add tags to it."),t.insert("div",":first-child").classed("tagdiv",!0).append("label").text("Sorry, this object has not be saved.")},drawTagById:function(t,e,a){$.ajax("/PathOS/Tag/lookUp?id="+e,{success:function(e){PathOS.tags.drawTag(t,e,a)}})},drawTag:function(t,e,a){if("fail"==e)alert("Sorry, you cannot set a reserved smart tag");else{var o=e.isAuto?t.insert("div",":first-child"):t.insert("div","textarea");o.attr({"class":"tagdiv tag-"+e.id}).datum(e).classed("isAuto",e.isAuto).on("click",function(t){var e=this;if(!t.isAuto&&d3.select("#tags").classed("editing")){var a={type:PathOS.controller,objid:PathOS.tags.current_object,tagid:t.id};$.ajax({type:"DELETE",url:"/PathOS/tag/removeLink?"+$.param(a),success:function(t){"fail"!=t&&$(e).remove()},cache:!1,contentType:!1,processData:!1})}else d3.select(e).select(".tooltip").classed("dismiss",!0)}),o.append("span").attr({}).text(e.label);var n=e.description||"Enter Description Here.",s=o.append("div").classed("tooltip fb-box",!0);s.append("button").text("Search").on("click",function(t){d3.event.stopPropagation(),window.location.href="/PathOS/search?q="+t.label}),s.append("button").text("View").on("click",function(t){d3.event.stopPropagation(),window.location.href="/PathOS/Tag/Show/"+t.id}),s.append("button").text("Edit").on("click",function(t){}),s.append("i").classed("fa fa-close fa-lg",!0).on("click",function(){d3.event.stopPropagation(),s.classed("edit",!1)}),a&&s.append("i").classed("fa fa-trash fa-lg",!0).on("click",function(){if(d3.event.stopPropagation(),confirm('Remove tag "'+e.label+'" from this object?')){var t={type:PathOS.controller,objid:PathOS.tags.current_object,tagid:e.id};$.ajax({type:"DELETE",url:"/PathOS/tag/removeLink?"+$.param(t),success:function(t){"fail"!=t&&$(".tag-"+e.id).remove()},cache:!1,contentType:!1,processData:!1})}}),s.append("i").classed("fa fa-check fa-lg",!0).on("click",function(){d3.event.stopPropagation(),s.classed("dismiss",!1)}),s.append("p").classed("tt_description",!0).text(n),s.append("input").attr({value:n}).on("keydown",function(){var t=d3.event;if(t&&t.keyCode&&13==t.keyCode){var a={description:$(this).val(),id:e.id};$.ajax("/PathOS/Tag/putDescription?"+$.param(a),{success:function(){$(".tag-"+e.id+" input").val(a.description),$(".tag-"+e.id+" p").text(a.description),s.classed("edit",!1),s.classed("dismiss",!0)}})}}),s.on("click",function(t){d3.event.stopPropagation(),s.classed("edit",!0)})}},addTag:function(t,e,a,o){if("undefined"==typeof a&&(a=PathOS.controller),"undefined"==typeof o&&(o=PathOS.tags.current_object),a&&e&&o){var n={type:a,id:o,tag:e,user:PathOS.user};$.ajax({type:"POST",url:"/PathOS/tag/addTag?"+$.param(n),success:function(e){"string"==typeof e?alert(e):null===t.select(".tag-"+e.id)[0][0]&&(PathOS.tags.drawTag(t,e,!0),$("#tag_text_area").val(""))},cache:!1,contentType:!1,processData:!1})}else console.log("We don't have a controller, tag or id."),console.log(a),console.log(e),console.log(o)}},PathOS.printQC=function(t){var e=t.div.append("h4").classed("flag",!0);null===t.authorised?e.text("QC Not Set").classed("unknown",!0):t.passfailFlag?e.text("QC Passed").classed("passed",!0):t.passfailFlag||e.text("QC Failed")},PathOS.igv={loaded:!1,options:{},init:function(t,e,a,o,n){var s=e+a+".bai",i=e+a+".bam",l=e+a+".vcf",d=e.split("Pathology")[0],r=d+"Panels/"+o+"/Amplicon.bed",c=d+"Panels/"+o+"/Amplicon.tsv";PathOS.igv.div=t,PathOS.igv.options={showKaryo:"hide",showNavigation:!0,reference:{fastaURL:"//dn7ywbm9isq8j.cloudfront.net/genomes/seq/hg19/hg19.fasta",indexFile:"/PathOS/igv/hg19.fasta.fai",cytobandURL:"/PathOS/igv/cytoBand.txt",order:-9999},tracks:[{url:l,type:"vcf",label:"VCF: "+a,order:-10001},new PathOS.igv.BAM(s,i,a,n),{name:o,url:r,indexURL:c,displayMode:"EXPANDED",order:-9998},{url:"/PathOS/igv/hg19-RefSeqGenes.gtf.gz",indexURL:"/PathOS/igv/hg19-RefSeqGenes.gtf.gz.tbi",name:"hg19 - Gencode v24",format:"gtf",order:-9997,visibilityWindow:1e7}]}},search:function(t){PathOS.igv.loaded||(PathOS.igv.loaded=!0,igv.createBrowser(PathOS.igv.div,PathOS.igv.options),$("#footer-message").remove()),igv.browser.search(t)},addBAM:function(t,e,a){if(t&&e){var o=e+t+".bai",n=e+t+".bam",s=new PathOS.igv.BAM(o,n,t,a);PathOS.igv.loaded?igv.browser.loadTrack(s):PathOS.igv.options.tracks.push(s)}else alert("There was an error, data not found.")},BAM:function(t,e,a,o){return o=o||2500,this.indexURL=t,this.url=e,this.label=a,this.type="bam",this.alignmentRowHeight=1,this.maxRows=99999,this.order=-1e4,this.height=500,this.autoHeight=!0,this.samplingDepth=o,this.colorBy="strand",this.negStrandColor="rgb(150, 150, 230)",this.posStrandColor="rgb(230, 150, 150)",this.deletionColor="black",this.skippedColor="rgb(150, 170, 170)",this}},PathOS.init=function(t){PathOS.modules.init(t),PathOS.hotkeys.init(),PathOS.history.init()};